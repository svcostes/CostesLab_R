---
title: "DNA damage correction"
---

```{r}
require('lattice')
require('ggplot2')
require('polynom')
require('plyr')
require('reshape2')
require('stringr')
require('dplyr')
library('proj4')
require('ggalt')
library(IDPmisc)
library(plotly)
require('sva')
library(devtools)
library(ggbiplot)
require('rlist')
require('gridExtra')
```


```{r}
setwd(getwd())

theme_set(theme_bw(base_size = 12)) ## For prettier graphs
theme_update(plot.title = element_text(hjust = 0.5))

### initializes doses in Gy
low_dose_Fe = 0.3 
low_dose_Ar = 0.18 
low_dose_Si = 0.11 
low_dose_Gamma = 0.1

high_dose_Fe = 0.82 
high_dose_Ar = 0.5 
high_dose_Si = 0.29 
high_dose_Gamma = 1
```


```{r}
##################################################################################################
##################################################################################################
############################## Finsam's ComBat modified Function #################################
##################################################################################################
##################################################################################################

sva.class2Model <- function(classes) {
  return(model.matrix(~factor(classes)))
}


modefunc <- function(x) {
  return(as.numeric(names(sort(-table(x)))[1]))
}

mono <- function(lfdr){
  .Call("monotone", as.numeric(lfdr), PACKAGE="sva")
}

edge.lfdr <- function(p, trunc=TRUE, monotone=TRUE, transf=c("probit", "logit"), adj=1.5, eps=10^-8, lambda=0.8, ...) {
  pi0 <- mean(p >= lambda)/(1 - lambda)
  pi0 <- min(pi0, 1)
  
  n <- length(p)
  transf <- match.arg(transf)
  
  if(transf=="probit") {
    p <- pmax(p, eps)
    p <- pmin(p, 1-eps)
    x <- qnorm(p)
    myd <- density(x, adjust=adj)
    mys <- smooth.spline(x=myd$x, y=myd$y)
    y <- predict(mys, x)$y
    lfdr <- pi0*dnorm(x)/y
  }
  
  if(transf=="logit") {
    x <- log((p+eps)/(1-p+eps))
    myd <- density(x, adjust=adj)
    mys <- smooth.spline(x=myd$x, y=myd$y)
    y <- predict(mys, x)$y
    dx <- exp(x) / (1+exp(x))^2
    lfdr <- pi0 * dx/y
  }
  
  if(trunc) {
    lfdr[lfdr > 1] <- 1
  }
  if(monotone) {	
    lfdr <- lfdr[order(p)]
    lfdr <- mono(lfdr)
    lfdr <- lfdr[rank(p)]
  }
  
  return(lfdr)
}



# Trims the data of extra columns, note your array names cannot be named 'X' or start with 'X.'
trim.dat <- function(dat){
  tmp <- strsplit(colnames(dat),'\\.')
  tr <- NULL
  for (i in 1:length(tmp)) {
    tr <- c(tr, tmp[[i]][1] != 'X')
  }
  tr
}

# Following four find empirical hyper-prior values
aprior <- function(gamma.hat) {
  m <- mean(gamma.hat)
  s2 <- var(gamma.hat)
  (2*s2 + m^2) / s2
}

bprior <- function(gamma.hat){
  m <- mean(gamma.hat)
  s2 <- var(gamma.hat)
  (m*s2 + m^3) / s2
}

postmean <- function(g.hat,g.bar,n,d.star,t2){
  (t2*n*g.hat + d.star*g.bar) / (t2*n + d.star)
}

postvar <- function(sum2,n,a,b){
  (.5*sum2 + b) / (n/2 + a - 1)
}

# Inverse gamma distribution density function. (Note: does not do any bounds checking on arguments)
dinvgamma <- function (x, shape, rate = 1/scale, scale = 1) {
  # PDF taken from https://en.wikipedia.org/wiki/Inverse-gamma_distribution
  # Note: alpha = shape, beta = rate
  stopifnot(shape > 0)
  stopifnot(rate > 0)
  ifelse(x <= 0, 0, ((rate ^ shape) / gamma(shape)) * x ^ (-shape - 1) * exp(-rate/x))
}

# Pass in entire data set, the design matrix for the entire data, the batch means, the batch variances, priors (m, t2, a, b), columns of the data  matrix for the batch. Uses the EM to find the parametric batch adjustments

it.sol  <- function(sdat,g.hat,d.hat,g.bar,t2,a,b,conv=.0001){
  n <- rowSums(!is.na(sdat))
  g.old <- g.hat
  d.old <- d.hat
  change <- 1
  count <- 0
  while(change>conv){
    g.new <- postmean(g.hat, g.bar, n, d.old, t2)
    sum2 <- rowSums((sdat - g.new %*% t(rep(1,ncol(sdat))))^2, na.rm=TRUE)
    d.new <- postvar(sum2, n, a, b)
    change <- max(abs(g.new-g.old) / g.old, abs(d.new-d.old) / d.old)
    g.old <- g.new
    d.old <- d.new
    count <- count+1
  }
  ## cat("This batch took", count, "iterations until convergence\n")
  adjust <- rbind(g.new, d.new)
  rownames(adjust) <- c("g.star","d.star")
  adjust
}

## likelihood function used below
L <- function(x,g.hat,d.hat){
  prod(dnorm(x, g.hat, sqrt(d.hat)))
}

## Monte Carlo integration functions
int.eprior <- function(sdat, g.hat, d.hat){
  g.star <- d.star <- NULL
  r <- nrow(sdat)
  for(i in 1:r){
    g <- g.hat[-i]
    d <- d.hat[-i]		
    x <- sdat[i,!is.na(sdat[i,])]
    n <- length(x)
    j <- numeric(n)+1
    dat <- matrix(as.numeric(x), length(g), n, byrow=TRUE)
    resid2 <- (dat-g)^2
    sum2 <- resid2 %*% j
    LH <- 1/(2*pi*d)^(n/2)*exp(-sum2/(2*d))
    LH[LH=="NaN"]=0
    g.star <- c(g.star, sum(g*LH)/sum(LH))
    d.star <- c(d.star, sum(d*LH)/sum(LH))
    ## if(i%%1000==0){cat(i,'\n')}
  }
  adjust <- rbind(g.star,d.star)
  rownames(adjust) <- c("g.star","d.star")
  adjust	
} 

## fits the L/S model in the presence of missing data values

Beta.NA <- function(y,X){
  des <- X[!is.na(y),]
  y1 <- y[!is.na(y)]
  B <- solve(crossprod(des), crossprod(des, y1))
  B
}

################################################################################################
################################################################################################
################################################################################################

ComBat_save <- function(dat, batch, mod = NULL, par.prior = TRUE, prior.plots = FALSE,
                   mean.only = FALSE, ref.batch = NULL, BPPARAM = bpparam("SerialParam")) {
  if(length(dim(batch))>1){
    stop("This version of ComBat only allows one batch variable")
  }  ## to be updated soon!  
  
  ## coerce dat into a matrix
  dat <- as.matrix(dat)
  
  ## find genes with zero variance in any of the batches
  batch <- as.factor(batch)
  zero.rows.lst <- lapply(levels(batch), function(batch_level){
    if(sum(batch==batch_level)>1){
      return(which(apply(dat[, batch==batch_level], 1, function(x){var(x)==0})))
    }else{
      return(which(rep(1,3)==2))
    }
  })
  zero.rows <- Reduce(union, zero.rows.lst)
  keep.rows <- setdiff(1:nrow(dat), zero.rows)
  
  if (length(zero.rows) > 0) {
    cat(sprintf("Found %d genes with uniform expression within a single batch (all zeros); these will not be adjusted for batch.\n", length(zero.rows)))
    # keep a copy of the original data matrix and remove zero var rows
    dat.orig <- dat
    dat <- dat[keep.rows, ]
  }
  
  ## make batch a factor and make a set of indicators for batch
  if(any(table(batch)==1)){mean.only=TRUE}
  if(mean.only==TRUE){
    message("Using the 'mean only' version of ComBat")
  }
  
  batchmod <- model.matrix(~-1+batch)  
  if (!is.null(ref.batch)){
    ## check for reference batch, check value, and make appropriate changes
    if (!(ref.batch%in%levels(batch))) {
      stop("reference level ref.batch is not one of the levels of the batch variable")
    }
    message("Using batch =",ref.batch, "as a reference batch (this batch won't change)")
    ref <- which(levels(as.factor(batch))==ref.batch) # find the reference
    batchmod[,ref] <- 1
  } else {
    ref <- NULL
  }
  message("Found", nlevels(batch), "batches")
  
  ## A few other characteristics on the batches
  n.batch <- nlevels(batch)
  batches <- list()
  for (i in 1:n.batch) {
    batches[[i]] <- which(batch == levels(batch)[i])
  } # list of samples in each batch  
  n.batches <- sapply(batches, length)
  if(any(n.batches==1)){
    mean.only=TRUE
    message("Note: one batch has only one sample, setting mean.only=TRUE")
  }
  n.array <- sum(n.batches)
  ## combine batch variable and covariates
  design <- cbind(batchmod,mod)
  
  ## check for intercept in covariates, and drop if present
  check <- apply(design, 2, function(x) all(x == 1))
  if(!is.null(ref)){
    check[ref] <- FALSE
  } ## except don't throw away the reference batch indicator
  design <- as.matrix(design[,!check])
  
  ## Number of covariates or covariate levels
  message("Adjusting for", ncol(design)-ncol(batchmod), 'covariate(s) or covariate level(s)')
  
  ## Check if the design is confounded
  if(qr(design)$rank < ncol(design)) {
    ## if(ncol(design)<=(n.batch)){stop("Batch variables are redundant! Remove one or more of the batch variables so they are no longer confounded")}
    if(ncol(design)==(n.batch+1)) {
      stop("The covariate is confounded with batch! Remove the covariate and rerun ComBat")
    }
    if(ncol(design)>(n.batch+1)) {
      if((qr(design[,-c(1:n.batch)])$rank<ncol(design[,-c(1:n.batch)]))){
        stop('The covariates are confounded! Please remove one or more of the covariates so the design is not confounded')
      } else {
        stop("At least one covariate is confounded with batch! Please remove confounded covariates and rerun ComBat")
      }
    }
  }
  
  ## Check for missing values
  NAs <- any(is.na(dat))
  if(NAs){
    message(c('Found',sum(is.na(dat)),'Missing Data Values'), sep=' ')}
  ## print(dat[1:2,])
  
  ##Standardize Data across genes
  message('Standardizing Data across genes')
  if (!NAs){
    B.hat <- solve(crossprod(design), tcrossprod(t(design), as.matrix(dat)))
  } else { 
    B.hat <- apply(dat, 1, Beta.NA, design) # FIXME
  }
  
  ## change grand.mean for ref batch
  if(!is.null(ref.batch)){
    grand.mean <- t(B.hat[ref, ])
  } else {
    grand.mean <- crossprod(n.batches/n.array, B.hat[1:n.batch,])
  }
  
  ## change var.pooled for ref batch
  if (!NAs){
    if(!is.null(ref.batch)) {
      ref.dat <- dat[, batches[[ref]]]
      var.pooled <- ((ref.dat-t(design[batches[[ref]], ] %*% B.hat))^2) %*% rep(1/n.batches[ref],n.batches[ref]) # FIXME
    } else {
      var.pooled <- ((dat-t(design %*% B.hat))^2) %*% rep(1/n.array,n.array) # FIXME
    }
  } else {
    if(!is.null(ref.batch)) {
      ref.dat <- dat[, batches[[ref]]]
      var.pooled <- rowVars(ref.dat-t(design[batches[[ref]], ]%*%B.hat), na.rm=TRUE)
    } else {
      var.pooled <- rowVars(dat-t(design %*% B.hat), na.rm=TRUE)
    }
  }
  
  stand.mean <- t(grand.mean) %*% t(rep(1,n.array)) # FIXME
  if(!is.null(design)){
    tmp <- design
    tmp[,c(1:n.batch)] <- 0
    stand.mean <- stand.mean+t(tmp %*% B.hat) #FIXME
  }  
  s.data <- (dat-stand.mean)/(sqrt(var.pooled) %*% t(rep(1,n.array))) # FIXME
  
  ##Get regression batch effect parameters
  message("Fitting L/S model and finding priors")
  batch.design <- design[, 1:n.batch]
  if (!NAs){
    gamma.hat <- solve(crossprod(batch.design), tcrossprod(t(batch.design),
                                                           as.matrix(s.data)))
  } else{
    gamma.hat <- apply(s.data, 1, Beta.NA, batch.design) # FIXME
  }
  delta.hat <- NULL
  for (i in batches){
    if(mean.only==TRUE) {
      delta.hat <- rbind(delta.hat,rep(1,nrow(s.data))) 
    } else {
      delta.hat <- rbind(delta.hat, rowVars(s.data[,i], na.rm=TRUE))
    }
  }
  
  ##Find Priors
  gamma.bar <- rowMeans(gamma.hat)
  t2 <- rowVars(gamma.hat)
  a.prior <- apply(delta.hat, 1, aprior) # FIXME 
  b.prior <- apply(delta.hat, 1, bprior) # FIXME
  
  ## Plot empirical and parametric priors
  
  if (prior.plots && par.prior) {
    old_pars <- par(no.readonly = TRUE)
    on.exit(par(old_pars))
    par(mfrow=c(2,2))
    
    ## Top left
    tmp <- density(gamma.hat[1,])
    plot(tmp,  type='l', main=expression(paste("Density Plot of First Batch ",  hat(gamma))))
    xx <- seq(min(tmp$x), max(tmp$x), length=100)
    lines(xx,dnorm(xx,gamma.bar[1],sqrt(t2[1])), col=2)
    
    ## Top Right
    qqnorm(gamma.hat[1,], main=expression(paste("Normal Q-Q Plot of First Batch ", hat(gamma))))
    qqline(gamma.hat[1,], col=2)
    
    ## Bottom Left
    tmp <- density(delta.hat[1,])
    xx <- seq(min(tmp$x), max(tmp$x), length=100)
    tmp1 <- list(x=xx, y=dinvgamma(xx, a.prior[1], b.prior[1]))
    plot(tmp, typ="l", ylim=c(0, max(tmp$y, tmp1$y)),
         main=expression(paste("Density Plot of First Batch ", hat(delta))))
    lines(tmp1, col=2)
    
    ## Bottom Right
    invgam <- 1/qgamma(1-ppoints(ncol(delta.hat)), a.prior[1], b.prior[1])
    qqplot(invgam, delta.hat[1,],
           main=expression(paste("Inverse Gamma Q-Q Plot of First Batch ", hat(delta))),
           ylab="Sample Quantiles", xlab="Theoretical Quantiles")
    lines(c(0, max(invgam)), c(0, max(invgam)), col=2)
  }
  
  ## Find EB batch adjustments
  
  gamma.star <- delta.star <- matrix(NA, nrow=n.batch, ncol=nrow(s.data))
  if (par.prior) {
    message("Finding parametric adjustments")
    results <- bplapply(1:n.batch, function(i) {
      if (mean.only) {
        gamma.star <- postmean(gamma.hat[i,], gamma.bar[i], 1, 1, t2[i])
        delta.star <- rep(1, nrow(s.data))
      }
      else {
        temp <- it.sol(s.data[, batches[[i]]], gamma.hat[i, ],
                       delta.hat[i, ], gamma.bar[i], t2[i], a.prior[i],
                       b.prior[i])
        gamma.star <- temp[1, ]
        delta.star <- temp[2, ]
      }
      list(gamma.star=gamma.star, delta.star=delta.star)
    }, BPPARAM = BPPARAM)
    for (i in 1:n.batch) {
      gamma.star[i,] <- results[[i]]$gamma.star
      delta.star[i,] <- results[[i]]$delta.star
    }
  }
  else {
    message("Finding nonparametric adjustments")
    results <- bplapply(1:n.batch, function(i) {
      if (mean.only) {
        delta.hat[i, ] = 1
      }
      temp <- int.eprior(as.matrix(s.data[, batches[[i]]]),
                         gamma.hat[i, ], delta.hat[i, ])
      list(gamma.star=temp[1,], delta.star=temp[2,])
    }, BPPARAM = BPPARAM)
    for (i in 1:n.batch) {
      gamma.star[i,] <- results[[i]]$gamma.star
      delta.star[i,] <- results[[i]]$delta.star
    }
  }
  
  if(!is.null(ref.batch)){
    gamma.star[ref,] <- 0  ## set reference batch mean equal to 0
    delta.star[ref,] <- 1  ## set reference batch variance equal to 1
  }
  
  ## Normalize the Data ###
  message("Adjusting the Data\n")
  
  bayesdata <- s.data
  j <- 1
  for (i in batches){
    ## DEBUG LINES
    samples_umrr <- bayesdata[,i]
    sub_umrr <- t(batch.design[i,]%*%gamma.star)
    ##
    bayesdata[,i] <- (bayesdata[,i]-t(batch.design[i,]%*%gamma.star))/(sqrt(delta.star[j,])%*%t(rep(1,n.batches[j]))) # FIXME
    j <- j+1
  }
  
  bayesdata <- (bayesdata*(sqrt(var.pooled)%*%t(rep(1,n.array))))+stand.mean # FIXME
  
  ## Do not change ref batch at all in reference version
  if(!is.null(ref.batch)){
    bayesdata[, batches[[ref]]] <- dat[, batches[[ref]]]
  }
  
  ## put genes with 0 variance in any batch back in data
  if (length(zero.rows) > 0) {
    dat.orig[keep.rows, ] <- bayesdata
    bayesdata <- dat.orig
  }
  
  ## EXTRACT
  gamma.star.out <- gamma.star
  delta.star.out <- delta.star
  colnames(gamma.star.out) <- rownames(s.data)
  colnames(delta.star.out) <- rownames(s.data)
  combat_save_out <- list("data"=bayesdata, "gamma"=gamma.star.out, "delta"=delta.star.out)
  
  # return(bayesdata)
  return(combat_save_out)
}

ComBat_custom <- function(dat, batch, custom.gamma, custom.delta, mod = NULL, par.prior = TRUE, prior.plots = FALSE,
                        mean.only = FALSE, ref.batch = NULL, BPPARAM = bpparam("SerialParam")) {
  if(length(dim(batch))>1){
    stop("This version of ComBat only allows one batch variable")
  }  ## to be updated soon!  
  
  ## coerce dat into a matrix
  dat <- as.matrix(dat)
  
  ## find genes with zero variance in any of the batches
  batch <- as.factor(batch)
  zero.rows.lst <- lapply(levels(batch), function(batch_level){
    if(sum(batch==batch_level)>1){
      return(which(apply(dat[, batch==batch_level], 1, function(x){var(x)==0})))
    }else{
      return(which(rep(1,3)==2))
    }
  })
  zero.rows <- Reduce(union, zero.rows.lst)
  keep.rows <- setdiff(1:nrow(dat), zero.rows)
  
  if (length(zero.rows) > 0) {
    cat(sprintf("Found %d genes with uniform expression within a single batch (all zeros); these will not be adjusted for batch.\n", length(zero.rows)))
    # keep a copy of the original data matrix and remove zero var rows
    dat.orig <- dat
    dat <- dat[keep.rows, ]
  }
  
  ## make batch a factor and make a set of indicators for batch
  if(any(table(batch)==1)){mean.only=TRUE}
  if(mean.only==TRUE){
    message("Using the 'mean only' version of ComBat")
  }
  
  batchmod <- model.matrix(~-1+batch)  
  if (!is.null(ref.batch)){
    ## check for reference batch, check value, and make appropriate changes
    if (!(ref.batch%in%levels(batch))) {
      stop("reference level ref.batch is not one of the levels of the batch variable")
    }
    message("Using batch =",ref.batch, "as a reference batch (this batch won't change)")
    ref <- which(levels(as.factor(batch))==ref.batch) # find the reference
    batchmod[,ref] <- 1
  } else {
    ref <- NULL
  }
  message("Found", nlevels(batch), "batches")
  
  ## A few other characteristics on the batches
  n.batch <- nlevels(batch)
  batches <- list()
  for (i in 1:n.batch) {
    batches[[i]] <- which(batch == levels(batch)[i])
  } # list of samples in each batch  
  n.batches <- sapply(batches, length)
  if(any(n.batches==1)){
    mean.only=TRUE
    message("Note: one batch has only one sample, setting mean.only=TRUE")
  }
  n.array <- sum(n.batches)
  ## combine batch variable and covariates
  design <- cbind(batchmod,mod)
  
  ## check for intercept in covariates, and drop if present
  check <- apply(design, 2, function(x) all(x == 1))
  if(!is.null(ref)){
    check[ref] <- FALSE
  } ## except don't throw away the reference batch indicator
  design <- as.matrix(design[,!check])
  
  ## Number of covariates or covariate levels
  message("Adjusting for", ncol(design)-ncol(batchmod), 'covariate(s) or covariate level(s)')
  
  ## Check if the design is confounded
  if(qr(design)$rank < ncol(design)) {
    ## if(ncol(design)<=(n.batch)){stop("Batch variables are redundant! Remove one or more of the batch variables so they are no longer confounded")}
    if(ncol(design)==(n.batch+1)) {
      stop("The covariate is confounded with batch! Remove the covariate and rerun ComBat")
    }
    if(ncol(design)>(n.batch+1)) {
      if((qr(design[,-c(1:n.batch)])$rank<ncol(design[,-c(1:n.batch)]))){
        stop('The covariates are confounded! Please remove one or more of the covariates so the design is not confounded')
      } else {
        stop("At least one covariate is confounded with batch! Please remove confounded covariates and rerun ComBat")
      }
    }
  }
  
  ## Check for missing values
  NAs <- any(is.na(dat))
  if(NAs){
    message(c('Found',sum(is.na(dat)),'Missing Data Values'), sep=' ')}
  ## print(dat[1:2,])
  
  ##Standardize Data across genes
  message('Standardizing Data across genes')
  if (!NAs){
    B.hat <- solve(crossprod(design), tcrossprod(t(design), as.matrix(dat)))
  } else { 
    B.hat <- apply(dat, 1, Beta.NA, design) # FIXME
  }
  
  ## change grand.mean for ref batch
  if(!is.null(ref.batch)){
    grand.mean <- t(B.hat[ref, ])
  } else {
    grand.mean <- crossprod(n.batches/n.array, B.hat[1:n.batch,])
  }
  
  ## change var.pooled for ref batch
  if (!NAs){
    if(!is.null(ref.batch)) {
      ref.dat <- dat[, batches[[ref]]]
      var.pooled <- ((ref.dat-t(design[batches[[ref]], ] %*% B.hat))^2) %*% rep(1/n.batches[ref],n.batches[ref]) # FIXME
    } else {
      var.pooled <- ((dat-t(design %*% B.hat))^2) %*% rep(1/n.array,n.array) # FIXME
    }
  } else {
    if(!is.null(ref.batch)) {
      ref.dat <- dat[, batches[[ref]]]
      var.pooled <- rowVars(ref.dat-t(design[batches[[ref]], ]%*%B.hat), na.rm=TRUE)
    } else {
      var.pooled <- rowVars(dat-t(design %*% B.hat), na.rm=TRUE)
    }
  }
  
  stand.mean <- t(grand.mean) %*% t(rep(1,n.array)) # FIXME
  if(!is.null(design)){
    tmp <- design
    tmp[,c(1:n.batch)] <- 0
    stand.mean <- stand.mean+t(tmp %*% B.hat) #FIXME
  }  
  s.data <- (dat-stand.mean)/(sqrt(var.pooled) %*% t(rep(1,n.array))) # FIXME
  
  ##Get regression batch effect parameters
  message("Fitting L/S model and finding priors")
  batch.design <- design[, 1:n.batch]
  if (!NAs){
    gamma.hat <- solve(crossprod(batch.design), tcrossprod(t(batch.design),
                                                           as.matrix(s.data)))
  } else{
    gamma.hat <- apply(s.data, 1, Beta.NA, batch.design) # FIXME
  }
  delta.hat <- NULL
  for (i in batches){
    if(mean.only==TRUE) {
      delta.hat <- rbind(delta.hat,rep(1,nrow(s.data))) 
    } else {
      delta.hat <- rbind(delta.hat, rowVars(s.data[,i], na.rm=TRUE))
    }
  }
  
  ##Find Priors
  gamma.bar <- rowMeans(gamma.hat)
  t2 <- rowVars(gamma.hat)
  a.prior <- apply(delta.hat, 1, aprior) # FIXME 
  b.prior <- apply(delta.hat, 1, bprior) # FIXME
  
  ## Plot empirical and parametric priors
  if (prior.plots && par.prior) {
    old_pars <- par(no.readonly = TRUE)
    on.exit(par(old_pars))
    par(mfrow=c(2,2))
    
    ## Top left
    tmp <- density(gamma.hat[1,])
    plot(tmp,  type='l', main=expression(paste("Density Plot of First Batch ",  hat(gamma))))
    xx <- seq(min(tmp$x), max(tmp$x), length=100)
    lines(xx,dnorm(xx,gamma.bar[1],sqrt(t2[1])), col=2)
    
    ## Top Right
    qqnorm(gamma.hat[1,], main=expression(paste("Normal Q-Q Plot of First Batch ", hat(gamma))))
    qqline(gamma.hat[1,], col=2)
    
    ## Bottom Left
    tmp <- density(delta.hat[1,])
    xx <- seq(min(tmp$x), max(tmp$x), length=100)
    tmp1 <- list(x=xx, y=dinvgamma(xx, a.prior[1], b.prior[1]))
    plot(tmp, typ="l", ylim=c(0, max(tmp$y, tmp1$y)),
         main=expression(paste("Density Plot of First Batch ", hat(delta))))
    lines(tmp1, col=2)
    
    ## Bottom Right
    invgam <- 1/qgamma(1-ppoints(ncol(delta.hat)), a.prior[1], b.prior[1])
    qqplot(invgam, delta.hat[1,],
           main=expression(paste("Inverse Gamma Q-Q Plot of First Batch ", hat(delta))),
           ylab="Sample Quantiles", xlab="Theoretical Quantiles")
    lines(c(0, max(invgam)), c(0, max(invgam)), col=2)
  }
  
  ## Find EB batch adjustments
  gamma.star <- delta.star <- matrix(NA, nrow=n.batch, ncol=nrow(s.data))
  if (par.prior) {
    message("Finding parametric adjustments")
    results <- bplapply(1:n.batch, function(i) {
      if (mean.only) {
        gamma.star <- postmean(gamma.hat[i,], gamma.bar[i], 1, 1, t2[i])
        delta.star <- rep(1, nrow(s.data))
      }
      else {
        temp <- it.sol(s.data[, batches[[i]]], gamma.hat[i, ],
                       delta.hat[i, ], gamma.bar[i], t2[i], a.prior[i],
                       b.prior[i])
        gamma.star <- temp[1, ]
        delta.star <- temp[2, ]
      }
      list(gamma.star=gamma.star, delta.star=delta.star)
    }, BPPARAM = BPPARAM)
    for (i in 1:n.batch) {
      gamma.star[i,] <- results[[i]]$gamma.star
      delta.star[i,] <- results[[i]]$delta.star
    }
  }
  else {
    message("Finding nonparametric adjustments")
    results <- bplapply(1:n.batch, function(i) {
      if (mean.only) {
        delta.hat[i, ] = 1
      }
      temp <- int.eprior(as.matrix(s.data[, batches[[i]]]),
                         gamma.hat[i, ], delta.hat[i, ])
      list(gamma.star=temp[1,], delta.star=temp[2,])
    }, BPPARAM = BPPARAM)
    for (i in 1:n.batch) {
      gamma.star[i,] <- results[[i]]$gamma.star
      delta.star[i,] <- results[[i]]$delta.star
    }
  }
  
  if(!is.null(ref.batch)){
    gamma.star[ref,] <- 0  ## set reference batch mean equal to 0
    delta.star[ref,] <- 1  ## set reference batch variance equal to 1
  }
  
  ## Normalize the Data ###
  message("Adjusting the Data\n")
  
  bayesdata <- s.data
  
  
  ## CREATE BLANKS
  ## gamma is additive, delta is multiplicative
  gamma.star.blank <- gamma.star
  colnames(gamma.star.blank) <- rownames(s.data)
  gamma.star.blank[] <- 0
  delta.star.blank <- delta.star
  colnames(delta.star.blank) <- rownames(s.data)
  delta.star.blank[] <- 1
  
  ## Replace matching columns
  # Select indices, omit nans
  gamma_indices1_with_nan <- match(colnames(custom.gamma), colnames(gamma.star.blank))
  gamma_indices1 <- na.omit(gamma_indices1_with_nan)
  gamma_indices2_with_nan <- match(colnames(gamma.star.blank), colnames(custom.gamma)) # GETS NEEDED INDICES TO INDEX FROM CUSTOM
  gamma_indices2 <- na.omit(gamma_indices2_with_nan)
  
  delta_indices1_with_nan <- match(colnames(custom.delta), colnames(delta.star.blank))
  delta_indices1 <- na.omit(delta_indices1_with_nan)
  delta_indices2_with_nan <- match(colnames(delta.star.blank), colnames(custom.delta)) # GETS NEEDED INDICES TO INDEX FROM CUSTOM
  delta_indices2 <- na.omit(delta_indices2_with_nan)
  
  # Replace
  gamma.star.blank[,gamma_indices1] <- custom.gamma[,gamma_indices2]
  delta.star.blank[,delta_indices1] <- custom.delta[,delta_indices2]
  
  j <- 1
  for (i in batches){
    ## DEBUG LINES
    #samples_run <- bayesdata[,i]
    #sub_run <- t(batch.design[i,]%*%gamma.star)
    ##
    bayesdata[,i] <- (bayesdata[,i]-t(batch.design[i,]%*%gamma.star.blank))/(sqrt(delta.star.blank[j,])%*%t(rep(1,n.batches[j]))) # FIXME
    j <- j+1
  }
  
  bayesdata <- (bayesdata*(sqrt(var.pooled)%*%t(rep(1,n.array))))+stand.mean # FIXME
  
  ## Do not change ref batch at all in reference version
  if(!is.null(ref.batch)){
    bayesdata[, batches[[ref]]] <- dat[, batches[[ref]]]
  }
  
  ## put genes with 0 variance in any batch back in data
  if (length(zero.rows) > 0) {
    dat.orig[keep.rows, ] <- bayesdata
    bayesdata <- dat.orig
  }
  
  # combat_save_out <- list("data"=bayesdata, "gamma"=gamma.star, "delta"=delta.star)
  
  return(bayesdata)
  # return(combat_save_out)
}

```




```{r}
##################################################################################################
######################################### Read RIF DATA ##########################################
##################################################################################################


#### Read DNA damage data BNL19A
gamma_plate_nums_19A = c(433, 435, 437, 439, 441, 444, 445, 447, 449, 451, 453, 455, 457, 459, 461, 463, 465, 467, 469, 471, 473, 475, 477,479)
gamma_plate_count_19A = length(gamma_plate_nums_19A)
ar_plate_nums_19A = c(481, 483, 485, 487, 489, 491, 493, 495, 497, 499, 501, 503, 505, 507, 509, 511, 513, 515, 517, 519, 521, 523, 525,527)
ar_plate_count_19A = length(ar_plate_nums_19A)
si_plate_nums_19A = c(577, 579, 581, 583, 585, 587, 589, 591, 593, 595, 597, 599, 601, 603, 605,607, 609, 611, 613,615, 617, 619, 621, 623)
si_plate_count_19A = length(si_plate_nums_19A)
fe_plate_nums_19A = c(529, 531, 533, 535, 537, 539, 541, 543, 545, 547, 549, 551, 553, 555, 557, 559, 561, 563, 565, 567, 569, 571, 573,575)
fe_plate_count_19A = length(fe_plate_nums_19A)
gamma_si_fe_ar_plate_nums_19A = c(gamma_plate_nums_19A, si_plate_nums_19A, fe_plate_nums_19A, ar_plate_nums_19A)
gamma_si_fe_ar_plate_count_19A = length(gamma_si_fe_ar_plate_nums_19A)


#### Read first file
foci_gamma_first_19A = data.frame(Plate = gamma_plate_nums_19A[1], Plate_well = paste(gamma_plate_nums_19A[1], read.table(paste("average_well/BNL19A/average_well_P", gamma_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("average_well/BNL19A/average_well_P", gamma_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE))

gamma_table_19A=foci_gamma_first_19A

foci_si_first_19A = data.frame(Plate = si_plate_nums_19A[1], Plate_well = paste(si_plate_nums_19A[1], read.table(paste("average_well/BNL19A/average_well_P", si_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("average_well/BNL19A/average_well_P", si_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE))

si_table_19A=foci_si_first_19A

foci_ar_first_19A = data.frame(Plate = ar_plate_nums_19A[1], Plate_well = paste(ar_plate_nums_19A[1], read.table(paste("average_well/BNL19A/average_well_P", ar_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("average_well/BNL19A/average_well_P", ar_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE))

ar_table_19A=foci_ar_first_19A

foci_fe_first_19A = data.frame(Plate = fe_plate_nums_19A[1], Plate_well = paste(fe_plate_nums_19A[1], read.table(paste("average_well/BNL19A/average_well_P", fe_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("average_well/BNL19A/average_well_P", fe_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE))

fe_table_19A=foci_fe_first_19A


#### Read all the other files and combine them into a single giant file with ALL the plates and ALL the wells
for(ii in 2:gamma_plate_count_19A){
  temp_gamma_filename = paste('average_well/BNL19A/average_well_P', gamma_plate_nums_19A[ii],'.txt', sep="")
  temp_gamma_table = data.frame(Plate = gamma_plate_nums_19A[ii], Plate_well = paste(gamma_plate_nums_19A[ii], read.table(paste('average_well/BNL19A/average_well_P', gamma_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('average_well/BNL19A/average_well_P', gamma_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE))
  gamma_table_19A = rbind(gamma_table_19A, temp_gamma_table)
}

for(ii in 2:si_plate_count_19A){
  temp_si_filename = paste('average_well/BNL19A/average_well_P', si_plate_nums_19A[ii],'.txt', sep="")
  temp_si_table = data.frame(Plate = si_plate_nums_19A[ii], Plate_well = paste(si_plate_nums_19A[ii], read.table(paste('average_well/BNL19A/average_well_P', si_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('average_well/BNL19A/average_well_P', si_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE))
  si_table_19A = rbind(si_table_19A, temp_si_table)
}

for(ii in 2:ar_plate_count_19A){
  temp_ar_filename = paste('average_well/BNL19A/average_well_P', ar_plate_nums_19A[ii],'.txt', sep="")
  temp_ar_table = data.frame(Plate = ar_plate_nums_19A[ii], Plate_well = paste(ar_plate_nums_19A[ii], read.table(paste('average_well/BNL19A/average_well_P', ar_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('average_well/BNL19A/average_well_P', ar_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE))
  ar_table_19A = rbind(ar_table_19A, temp_ar_table)
  }

for(ii in 2:fe_plate_count_19A){
  temp_fe_filename = paste('average_well/BNL19A/average_well_P', fe_plate_nums_19A[ii],'.txt', sep="")
  temp_fe_table = data.frame(Plate = fe_plate_nums_19A[ii], Plate_well = paste(fe_plate_nums_19A[ii], read.table(paste('average_well/BNL19A/average_well_P', fe_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('average_well/BNL19A/average_well_P', fe_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE))
  fe_table_19A = rbind(fe_table_19A, temp_fe_table)
  }


#### Read DNA damage data BNL18B: we compare HT and CD7 on a few gamma plates
ar_plate_nums_18B = c(381,382,383,386,387,390,391,394,395,396,399,400,402)
ar_plate_count_18B = length(ar_plate_nums_18B)
gamma_plate_nums_18B_HT = c(637, 645, 654,653)
gamma_plate_count_18B_HT = length(gamma_plate_nums_18B_HT)
gamma_plate_nums_18B_CD7 = c(637, 645, 653)
gamma_plate_count_18B_CD7 = length(gamma_plate_nums_18B_CD7)
si_plate_nums_18B = c(333,337,341,345,349,353,342,338,347,346,350,334,354)  
si_plate_count_18B = length(si_plate_nums_18B)
fe_plate_nums_18B = c(355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,372,373,374,375,376,377,378)
fe_plate_count_18B = length(fe_plate_nums_18B)
fe_ar_plate_nums_18B = c(fe_plate_nums_18B, ar_plate_nums_18B)
fe_ar_plate_count_18B = length(fe_ar_plate_nums_18B)

#### Read first file
foci_ar_first_18B = data.frame(Plate = ar_plate_nums_18B[1], Plate_well = paste(ar_plate_nums_18B[1], read.table(paste("average_well/BNL18B/average_well_P", ar_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("average_well/BNL18B/average_well_P", ar_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE))

ar_table_18B=foci_ar_first_18B

foci_gamma_first_18B_CD7 = data.frame(Plate = gamma_plate_nums_18B_CD7[1], Plate_well = paste(gamma_plate_nums_18B_CD7[1], read.table(paste("average_well/BNL18B/CD7_average_well_P", gamma_plate_nums_18B_CD7[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("average_well/BNL18B/CD7_average_well_P", gamma_plate_nums_18B_CD7[1],'.txt', sep=""), sep="\t", header = TRUE))
gamma_table_18B_CD7=foci_gamma_first_18B_CD7

foci_gamma_first_18B_HT = data.frame(Plate = gamma_plate_nums_18B_HT[1], Plate_well = paste(gamma_plate_nums_18B_HT[1], read.table(paste("average_well/BNL18B/HT_average_well_P", gamma_plate_nums_18B_HT[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("average_well/BNL18B/HT_average_well_P", gamma_plate_nums_18B_HT[1],'.txt', sep=""), sep="\t", header = TRUE))
gamma_table_18B_HT=foci_gamma_first_18B_HT

foci_si_first_18B = data.frame(Plate = si_plate_nums_18B[1], Plate_well = paste(si_plate_nums_18B[1], read.table(paste("average_well/BNL18B/average_well_P", si_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("average_well/BNL18B/average_well_P", si_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE))

si_table_18B=foci_si_first_18B

foci_fe_first_18B = data.frame(Plate = fe_plate_nums_18B[1], Plate_well = paste(fe_plate_nums_18B[1], read.table(paste("average_well/BNL18B/average_well_P", fe_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("average_well/BNL18B/average_well_P", fe_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE))

fe_table_18B=foci_fe_first_18B


#### Read all the other files and combine them into a single giant file with ALL the plates and ALL the wells
for(ii in 2:ar_plate_count_18B){
  temp_ar_filename = paste('average_well/BNL18B/average_well_P', ar_plate_nums_18B[ii],'.txt', sep="")
  temp_ar_table = data.frame(Plate = ar_plate_nums_18B[ii], Plate_well = paste(ar_plate_nums_18B[ii], read.table(paste('average_well/BNL18B/average_well_P', ar_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('average_well/BNL18B/average_well_P', ar_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE))
  ar_table_18B = rbind(ar_table_18B, temp_ar_table)
  }

for(ii in 2:si_plate_count_18B){
  temp_si_filename = paste('average_well/BNL18B/average_well_P', si_plate_nums_18B[ii],'.txt', sep="")
  temp_si_table = data.frame(Plate = si_plate_nums_18B[ii], Plate_well = paste(si_plate_nums_18B[ii], read.table(paste('average_well/BNL18B/average_well_P', si_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('average_well/BNL18B/average_well_P', si_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE))
  si_table_18B = rbind(si_table_18B, temp_si_table)
  }

for(ii in 2:fe_plate_count_18B){
  temp_fe_filename = paste('average_well/BNL18B/average_well_P', fe_plate_nums_18B[ii],'.txt', sep="")
  temp_fe_table = data.frame(Plate = fe_plate_nums_18B[ii], Plate_well = paste(fe_plate_nums_18B[ii], read.table(paste('average_well/BNL18B/average_well_P', fe_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('average_well/BNL18B/average_well_P', fe_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE))
  fe_table_18B = rbind(fe_table_18B, temp_fe_table)
  }

for(ii in 2:gamma_plate_count_18B_CD7){
  temp_gamma_filename = paste("average_well/BNL18B/CD7_average_well_P", gamma_plate_nums_18B_CD7[ii],'.txt', sep="")
  temp_gamma_table_CD7 = data.frame(Plate = gamma_plate_nums_18B_CD7[ii], Plate_well = paste(gamma_plate_nums_18B_CD7[ii], read.table(paste("average_well/BNL18B/CD7_average_well_P", gamma_plate_nums_18B_CD7[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("average_well/BNL18B/CD7_average_well_P", gamma_plate_nums_18B_CD7[ii],'.txt', sep=""), sep="\t", header = TRUE))
  gamma_table_18B_CD7 = rbind(gamma_table_18B_CD7, temp_gamma_table_CD7)
}

for(ii in 2:gamma_plate_count_18B_HT){
  temp_gamma_filename = paste("average_well/BNL18B/HT_average_well_P", gamma_plate_nums_18B_HT[ii],'.txt', sep="")
  temp_gamma_table_HT = data.frame(Plate = gamma_plate_nums_18B_HT[ii], Plate_well = paste(gamma_plate_nums_18B_HT[ii], read.table(paste("average_well/BNL18B/HT_average_well_P", gamma_plate_nums_18B_HT[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("average_well/BNL18B/HT_average_well_P", gamma_plate_nums_18B_HT[ii],'.txt', sep=""), sep="\t", header = TRUE))
  gamma_table_18B_HT = rbind(gamma_table_18B_HT, temp_gamma_table_HT)
}

#### We combine 18B and 19A data
ar_table = rbind(ar_table_18B, ar_table_19A)
fe_table = rbind(fe_table_18B, fe_table_19A)
si_table = rbind(si_table_18B, si_table_19A)
gamma_table_CD7 = rbind(gamma_table_18B_CD7, gamma_table_19A)
gamma_table_HT = rbind(gamma_table_18B_HT, gamma_table_19A)

#### add duplicate info
Plate_Duplicate <- read.csv('Plate_Duplicate.csv', header = TRUE, sep = ";")
colnames(Plate_Duplicate)[colnames(Plate_Duplicate)=="Ã¯..Plate_number"]<-"Plate_number"
Plate_Duplicate$Run=NULL
ar_table=merge(ar_table, Plate_Duplicate, by.x="Plate", by.y="Plate_number", all.x = TRUE)
fe_table=merge(fe_table, Plate_Duplicate, by.x="Plate", by.y="Plate_number", all.x = TRUE)
si_table=merge(si_table, Plate_Duplicate, by.x="Plate", by.y="Plate_number", all.x = TRUE)
gamma_table_CD7=merge(gamma_table_CD7, Plate_Duplicate, by.x="Plate", by.y="Plate_number", all.x = TRUE)
gamma_table_HT=merge(gamma_table_HT, Plate_Duplicate, by.x="Plate", by.y="Plate_number", all.x = TRUE)

#### add plate metadata
plate_meta = read.csv('Plate_metadata.csv', sep = ",", header = TRUE)
fe_table_w_plate_meta = merge(fe_table, plate_meta, by.x = 'Plate', by.y = 'Plate_number', all.x = TRUE, all.y = FALSE)
ar_table_w_plate_meta = merge(ar_table, plate_meta, by.x = 'Plate', by.y = 'Plate_number', all.x = TRUE, all.y = FALSE)
si_table_w_plate_meta = merge(si_table, plate_meta, by.x = 'Plate', by.y = 'Plate_number', all.x = TRUE, all.y = FALSE)
gamma_table_w_plate_meta_CD7 = merge(gamma_table_CD7, plate_meta, by.x = 'Plate', by.y = 'Plate_number', all.x = TRUE, all.y = FALSE)
gamma_table_w_plate_meta_HT = merge(gamma_table_HT, plate_meta, by.x = 'Plate', by.y = 'Plate_number', all.x = TRUE, all.y = FALSE)

## Wells are different based on sample sets, so we need to make an extra column for Set_Well, and then add well metadata based on it.
fe_table_w_plate_meta$Run_set_well = paste(fe_table_w_plate_meta$Run, fe_table_w_plate_meta$Sample_sets, fe_table_w_plate_meta$Well, sep = "_")
ar_table_w_plate_meta$Run_set_well = paste(ar_table_w_plate_meta$Run, ar_table_w_plate_meta$Sample_sets, ar_table_w_plate_meta$Well, sep = "_")
si_table_w_plate_meta$Run_set_well = paste(si_table_w_plate_meta$Run, si_table_w_plate_meta$Sample_sets, si_table_w_plate_meta$Well, sep = "_")
gamma_table_w_plate_meta_CD7$Run_set_well = paste(gamma_table_w_plate_meta_CD7$Run, gamma_table_w_plate_meta_CD7$Sample_sets, gamma_table_w_plate_meta_CD7$Well, sep = "_")
gamma_table_w_plate_meta_HT$Run_set_well = paste(gamma_table_w_plate_meta_HT$Run, gamma_table_w_plate_meta_HT$Sample_sets, gamma_table_w_plate_meta_HT$Well, sep = "_")

## create column run_set 
fe_table_w_plate_meta$Run_set = paste(fe_table_w_plate_meta$Run, fe_table_w_plate_meta$Sample_sets, sep = "_")
ar_table_w_plate_meta$Run_set = paste(ar_table_w_plate_meta$Run, ar_table_w_plate_meta$Sample_sets, sep = "_")
si_table_w_plate_meta$Run_set = paste(si_table_w_plate_meta$Run, si_table_w_plate_meta$Sample_sets, sep = "_")
gamma_table_w_plate_meta_CD7$Run_set = paste(gamma_table_w_plate_meta_CD7$Run, gamma_table_w_plate_meta_CD7$Sample_sets, sep = "_")
gamma_table_w_plate_meta_HT$Run_set = paste(gamma_table_w_plate_meta_HT$Run, gamma_table_w_plate_meta_HT$Sample_sets, sep = "_")

#### Set low bar. This is arbitrary! We will ask for at least 50 imaged nuclei per well to consider that well. 
low_bar = 50
fe_filt = fe_table_w_plate_meta[fe_table_w_plate_meta$num_nuc > (low_bar-1),]
ar_filt = ar_table_w_plate_meta[ar_table_w_plate_meta$num_nuc > (low_bar-1),]
si_filt = si_table_w_plate_meta[si_table_w_plate_meta$num_nuc > (low_bar-1),]
gamma_filt_CD7 = gamma_table_w_plate_meta_CD7[gamma_table_w_plate_meta_CD7$num_nuc > (low_bar-1),]
gamma_filt_HT = gamma_table_w_plate_meta_HT[gamma_table_w_plate_meta_HT$num_nuc > (low_bar-1),]

#### Truncate dataframe to only include the columns of interest
col_trunc = c("Run_set_well", "avg_nfoci", "avg_foci_no_outl", "Dose_Fluence", "Timepoint", "Duplicate", 'Run_set', 'Staining_date','Plate')
fe_trunc = fe_filt[,colnames(fe_filt) %in% col_trunc]
ar_trunc = ar_filt[,colnames(ar_filt) %in% col_trunc]
si_trunc = si_filt[,colnames(si_filt) %in% col_trunc]
gamma_trunc_CD7 = gamma_filt_CD7[,colnames(gamma_filt_CD7) %in% col_trunc]
gamma_trunc_HT = gamma_filt_HT[,colnames(gamma_filt_HT) %in% col_trunc]

### Now we average A and B duplicates
fe_trunc = ddply(fe_trunc, .(Dose_Fluence, Timepoint, Run_set_well, Run_set), summarise, avg_nfoci = mean(avg_nfoci), avg_foci_no_outl = mean(avg_foci_no_outl))
ar_trunc = ddply(ar_trunc, .(Dose_Fluence, Timepoint, Run_set_well, Run_set), summarise, avg_nfoci = mean(avg_nfoci), avg_foci_no_outl = mean(avg_foci_no_outl))
si_trunc = ddply(si_trunc, .(Dose_Fluence, Timepoint, Run_set_well, Run_set), summarise, avg_nfoci = mean(avg_nfoci), avg_foci_no_outl = mean(avg_foci_no_outl))
gamma_trunc_CD7 = ddply(gamma_trunc_CD7, .(Dose_Fluence, Timepoint, Run_set_well, Run_set), summarise, avg_nfoci = mean(avg_nfoci), avg_foci_no_outl = mean(avg_foci_no_outl))
gamma_trunc_HT = ddply(gamma_trunc_HT, .(Dose_Fluence, Timepoint, Run_set_well, Run_set), summarise, avg_nfoci = mean(avg_nfoci), avg_foci_no_outl = mean(avg_foci_no_outl))

#### Now we combine all ions in a single matrix

## For Fe:
fe_reshaped_1 <- dcast(fe_trunc, Run_set_well + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_nfoci'))
colnames(fe_reshaped_1)[colnames(fe_reshaped_1) == "0"] = "avg_nfoci_0"
colnames(fe_reshaped_1)[colnames(fe_reshaped_1) == "1.1"] = "avg_nfoci_low_dose"
colnames(fe_reshaped_1)[colnames(fe_reshaped_1) == "3"] = "avg_nfoci_high_dose"

fe_reshaped_2 <- dcast(fe_trunc, Run_set_well+ Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_foci_no_outl'))
colnames(fe_reshaped_2)[colnames(fe_reshaped_2) == "0"] = "avg_foci_no_outl_0"
colnames(fe_reshaped_2)[colnames(fe_reshaped_2) == "1.1"] = "avg_foci_no_outl_low_dose"
colnames(fe_reshaped_2)[colnames(fe_reshaped_2) == "3"] = "avg_foci_no_outl_high_dose"
 
fe_reshaped = full_join(fe_reshaped_1, fe_reshaped_2, by=c("Run_set_well", "Run_set", "Timepoint"))

## For Ar:
ar_reshaped_1 <- dcast(ar_trunc, Run_set_well+ Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_nfoci'))
colnames(ar_reshaped_1)[colnames(ar_reshaped_1) == "0"] = "avg_nfoci_0"
colnames(ar_reshaped_1)[colnames(ar_reshaped_1) == "1.1"] = "avg_nfoci_low_dose"
colnames(ar_reshaped_1)[colnames(ar_reshaped_1) == "3"] = "avg_nfoci_high_dose"

ar_reshaped_2 <- dcast(ar_trunc, Run_set_well+ Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_foci_no_outl'))
colnames(ar_reshaped_2)[colnames(ar_reshaped_2) == "0"] = "avg_foci_no_outl_0"
colnames(ar_reshaped_2)[colnames(ar_reshaped_2) == "1.1"] = "avg_foci_no_outl_low_dose"
colnames(ar_reshaped_2)[colnames(ar_reshaped_2) == "3"] = "avg_foci_no_outl_high_dose"
 
ar_reshaped = full_join(ar_reshaped_1, ar_reshaped_2, by=c("Run_set_well", "Run_set", "Timepoint"))

## For Si:
si_reshaped_1 <- dcast(si_trunc, Run_set_well + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_nfoci'))
colnames(si_reshaped_1)[colnames(si_reshaped_1) == "0"] = "avg_nfoci_0"
colnames(si_reshaped_1)[colnames(si_reshaped_1) == "1.1"] = "avg_nfoci_low_dose"
colnames(si_reshaped_1)[colnames(si_reshaped_1) == "3"] = "avg_nfoci_high_dose"

si_reshaped_2 <- dcast(si_trunc, Run_set_well + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_foci_no_outl'))
colnames(si_reshaped_2)[colnames(si_reshaped_2) == "0"] = "avg_foci_no_outl_0"
colnames(si_reshaped_2)[colnames(si_reshaped_2) == "1.1"] = "avg_foci_no_outl_low_dose"
colnames(si_reshaped_2)[colnames(si_reshaped_2) == "3"] = "avg_foci_no_outl_high_dose"
 
si_reshaped = full_join(si_reshaped_1, si_reshaped_2, by=c("Run_set_well", "Run_set", "Timepoint"))

## For Gamma CD7:
dose= gamma_trunc_CD7$Dose_Fluence
dose=unique(dose)
print(dose)
gamma_reshaped_1 <- dcast(gamma_trunc_CD7, Run_set_well + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_nfoci'))
colnames(gamma_reshaped_1)[colnames(gamma_reshaped_1) == "0"] = "avg_nfoci_0"
colnames(gamma_reshaped_1)[colnames(gamma_reshaped_1) == "0.1"] = "avg_nfoci_low_dose"
colnames(gamma_reshaped_1)[colnames(gamma_reshaped_1) == "1"] = "avg_nfoci_high_dose"

gamma_reshaped_2 <- dcast(gamma_trunc_CD7, Run_set_well + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_foci_no_outl'))
colnames(gamma_reshaped_2)[colnames(gamma_reshaped_2) == "0"] = "avg_foci_no_outl_0"
colnames(gamma_reshaped_2)[colnames(gamma_reshaped_2) == "0.1"] = "avg_foci_no_outl_low_dose"
colnames(gamma_reshaped_2)[colnames(gamma_reshaped_2) == "1"] = "avg_foci_no_outl_high_dose"
 
gamma_reshaped_CD7 = full_join(gamma_reshaped_1, gamma_reshaped_2, by=c("Run_set_well", "Run_set", "Timepoint"))

## For Gamma HT:
dose= gamma_trunc_HT$Dose_Fluence
dose=unique(dose)
print(dose)
gamma_reshaped_1 <- dcast(gamma_trunc_HT, Run_set_well + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_nfoci'))
colnames(gamma_reshaped_1)[colnames(gamma_reshaped_1) == "0"] = "avg_nfoci_0"
colnames(gamma_reshaped_1)[colnames(gamma_reshaped_1) == "0.1"] = "avg_nfoci_low_dose"
colnames(gamma_reshaped_1)[colnames(gamma_reshaped_1) == "1"] = "avg_nfoci_high_dose"

gamma_reshaped_2 <- dcast(gamma_trunc_HT, Run_set_well + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_foci_no_outl'))
colnames(gamma_reshaped_2)[colnames(gamma_reshaped_2) == "0"] = "avg_foci_no_outl_0"
colnames(gamma_reshaped_2)[colnames(gamma_reshaped_2) == "0.1"] = "avg_foci_no_outl_low_dose"
colnames(gamma_reshaped_2)[colnames(gamma_reshaped_2) == "1"] = "avg_foci_no_outl_high_dose"
 
gamma_reshaped_HT = full_join(gamma_reshaped_1, gamma_reshaped_2, by=c("Run_set_well", "Run_set", "Timepoint"))

#### Add info radiation type + Combine in one table 
fe_reshaped$Radiation_type = "Fe"
ar_reshaped$Radiation_type = "Ar"
si_reshaped$Radiation_type = "Si"
gamma_reshaped_CD7$Radiation_type = "Gamma"
gamma_reshaped_HT$Radiation_type = "Gamma"

all_RIF=bind_rows(fe_reshaped, ar_reshaped)
all_RIF=bind_rows(all_RIF, si_reshaped)
all_RIF_CD7=bind_rows(all_RIF, gamma_reshaped_CD7)
all_RIF_HT=bind_rows(all_RIF, gamma_reshaped_HT)

##### Now we add well metadata
well_meta = read.csv('Well_metadata.csv', sep = ",", header = TRUE)
all_RIF_Raw_CD7 = merge(all_RIF_CD7, well_meta, by.x = 'Run_set_well', by.y = 'Run_set_well', all.x = TRUE)
all_RIF_Raw_HT = merge(all_RIF_HT, well_meta, by.x = 'Run_set_well', by.y = 'Run_set_well', all.x = TRUE)
```

```{r}
# Choose either CD7 or HT data for gamma
all_RIF_Raw = all_RIF_Raw_CD7
Subject_metadata_save=all_RIF_Raw[,grepl("Sample_ID|Age|Gender|BMI", colnames(all_RIF_Raw))]
```

```{r Plot raw data for initial check-up}

### Gamma
raw_gamma <- all_RIF_Raw[all_RIF_Raw$Radiation_type=="Gamma",]
raw_gamma_0 <- raw_gamma[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_0", colnames(raw_gamma))]
raw_gamma_0$dose = 0
colnames(raw_gamma_0)[colnames(raw_gamma_0)=="avg_nfoci_0"]<-"avg_nfoci"
raw_gamma_LD <- raw_gamma[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_low_dose", colnames(raw_gamma))]
raw_gamma_LD$dose = low_dose_Gamma
colnames(raw_gamma_LD)[colnames(raw_gamma_LD)=="avg_nfoci_low_dose"]<-"avg_nfoci"
raw_gamma_HD <- raw_gamma[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_high_dose", colnames(raw_gamma))]
raw_gamma_HD$dose = high_dose_Gamma
colnames(raw_gamma_HD)[colnames(raw_gamma_HD)=="avg_nfoci_high_dose"]<-"avg_nfoci"
raw_gamma <- rbind(raw_gamma_0,raw_gamma_LD,raw_gamma_HD)
raw_gamma$Timepoint = factor(raw_gamma$Timepoint, levels = c("4h", "24h"))

raw_data_plot_gamma <- ggplot(raw_gamma, aes(x=Run_set, y=avg_nfoci)) + geom_boxplot(aes(fill=as.factor(dose))) + facet_grid(. ~ Timepoint) + ggtitle("Gamma") + ylim(0,6)

### Silicon
raw_si <- all_RIF_Raw[all_RIF_Raw$Radiation_type=="Si",]
raw_si_0 <- raw_si[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_0", colnames(raw_si))]
raw_si_0$dose = 0
colnames(raw_si_0)[colnames(raw_si_0)=="avg_nfoci_0"]<-"avg_nfoci"
raw_si_LD <- raw_si[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_low_dose", colnames(raw_si))]
raw_si_LD$dose = low_dose_Si
colnames(raw_si_LD)[colnames(raw_si_LD)=="avg_nfoci_low_dose"]<-"avg_nfoci"
raw_si_HD <- raw_si[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_high_dose", colnames(raw_si))]
raw_si_HD$dose = high_dose_Si
colnames(raw_si_HD)[colnames(raw_si_HD)=="avg_nfoci_high_dose"]<-"avg_nfoci"
raw_si <- rbind(raw_si_0,raw_si_LD,raw_si_HD)
raw_si$Timepoint = factor(raw_si$Timepoint, levels = c("4h", "24h"))

raw_data_plot_si <- ggplot(raw_si, aes(x=Run_set, y=avg_nfoci)) + geom_boxplot(aes(fill=as.factor(dose))) + facet_grid(. ~ Timepoint) + ggtitle("Si") + ylim(0,6)

### Argon
raw_ar <- all_RIF_Raw[all_RIF_Raw$Radiation_type=="Ar",]
raw_ar_0 <- raw_ar[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_0", colnames(raw_ar))]
raw_ar_0$dose = 0
colnames(raw_ar_0)[colnames(raw_ar_0)=="avg_nfoci_0"]<-"avg_nfoci"
raw_ar_LD <- raw_ar[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_low_dose", colnames(raw_ar))]
raw_ar_LD$dose = low_dose_Ar
colnames(raw_ar_LD)[colnames(raw_ar_LD)=="avg_nfoci_low_dose"]<-"avg_nfoci"
raw_ar_HD <- raw_ar[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_high_dose", colnames(raw_ar))]
raw_ar_HD$dose = high_dose_Ar
colnames(raw_ar_HD)[colnames(raw_ar_HD)=="avg_nfoci_high_dose"]<-"avg_nfoci"
raw_ar <- rbind(raw_ar_0,raw_ar_LD,raw_ar_HD)
raw_ar$Timepoint = factor(raw_ar$Timepoint, levels = c("4h", "24h"))

raw_data_plot_ar <- ggplot(raw_ar, aes(x=Run_set, y=avg_nfoci)) + geom_boxplot(aes(fill=as.factor(dose))) + facet_grid(. ~ Timepoint) + ggtitle("Ar") + ylim(0,6)

### Iron
raw_fe <- all_RIF_Raw[all_RIF_Raw$Radiation_type=="Fe",]
raw_fe_0 <- raw_fe[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_0", colnames(raw_fe))]
raw_fe_0$dose = 0
colnames(raw_fe_0)[colnames(raw_fe_0)=="avg_nfoci_0"]<-"avg_nfoci"
raw_fe_LD <- raw_fe[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_low_dose", colnames(raw_fe))]
raw_fe_LD$dose = low_dose_Fe
colnames(raw_fe_LD)[colnames(raw_fe_LD)=="avg_nfoci_low_dose"]<-"avg_nfoci"
raw_fe_HD <- raw_fe[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_high_dose", colnames(raw_fe))]
raw_fe_HD$dose = high_dose_Fe
colnames(raw_fe_HD)[colnames(raw_fe_HD)=="avg_nfoci_high_dose"]<-"avg_nfoci"
raw_fe <- rbind(raw_fe_0,raw_fe_LD,raw_fe_HD)
raw_fe$Timepoint = factor(raw_fe$Timepoint, levels = c("4h", "24h"))

raw_data_plot_fe <- ggplot(raw_fe, aes(x=Run_set, y=avg_nfoci)) + geom_boxplot(aes(fill=as.factor(dose))) + facet_grid(. ~ Timepoint) + ggtitle("Fe") + ylim(0,6)
```

```{r}
### Find individuals with similar 0Gy values between gamma and Fe, at 4h and at 24h

Gamma_4h <- all_RIF_Raw[all_RIF_Raw$Radiation_type=="Gamma" & all_RIF_Raw$Timepoint=="4h" & all_RIF_Raw$Sample_ID > 1213,]
Gamma_4h <- Gamma_4h[,grepl("Sample_ID|avg_nfoci_0", colnames(Gamma_4h))]
colnames(Gamma_4h)[colnames(Gamma_4h)=="avg_nfoci_0"] <- "avg_nfoci_0_gamma"
Fe_4h <- all_RIF_Raw[all_RIF_Raw$Radiation_type=="Fe" & all_RIF_Raw$Timepoint=="4h" & all_RIF_Raw$Sample_ID > 1213,]
Fe_4h <- Fe_4h[,grepl("Sample_ID|avg_nfoci_0", colnames(Fe_4h))]
colnames(Fe_4h)[colnames(Fe_4h)=="avg_nfoci_0"] <- "avg_nfoci_0_fe"
Gamma_Fe_4h <- merge(Gamma_4h, Fe_4h, by="Sample_ID", all=FALSE)
Gamma_Fe_4h$diff_4h <- Gamma_Fe_4h$avg_nfoci_0_fe - Gamma_Fe_4h$avg_nfoci_0_gamma
Gamma_Fe_4h<-Gamma_Fe_4h[order(Gamma_Fe_4h$diff_4h),]

Gamma_24h <- all_RIF_Raw[all_RIF_Raw$Radiation_type=="Gamma" & all_RIF_Raw$Timepoint=="24h" & all_RIF_Raw$Sample_ID > 1213,]
Gamma_24h <- Gamma_24h[,grepl("Sample_ID|avg_nfoci_0", colnames(Gamma_24h))]
colnames(Gamma_24h)[colnames(Gamma_24h)=="avg_nfoci_0"] <- "avg_nfoci_0_gamma"
Fe_24h <- all_RIF_Raw[all_RIF_Raw$Radiation_type=="Fe" & all_RIF_Raw$Timepoint=="24h" & all_RIF_Raw$Sample_ID > 1213,]
Fe_24h <- Fe_24h[,grepl("Sample_ID|avg_nfoci_0", colnames(Fe_24h))]
colnames(Fe_24h)[colnames(Fe_24h)=="avg_nfoci_0"] <- "avg_nfoci_0_fe"
Gamma_Fe_24h <- merge(Gamma_24h, Fe_24h, by="Sample_ID", all=FALSE)
Gamma_Fe_24h$diff_24h <- Gamma_Fe_24h$avg_nfoci_0_fe - Gamma_Fe_24h$avg_nfoci_0_gamma
Gamma_Fe_24h<-Gamma_Fe_24h[order(Gamma_Fe_24h$diff_24h),]

Gamma_Fe <- merge(Gamma_Fe_4h[,grepl("Sample_ID|diff_4h", colnames(Gamma_Fe_4h))],Gamma_Fe_24h[,grepl("Sample_ID|diff_24h", colnames(Gamma_Fe_24h))],by="Sample_ID")
Gamma_Fe$sum <- Gamma_Fe$diff_4h + Gamma_Fe$diff_24h
Gamma_Fe<-Gamma_Fe[order(Gamma_Fe$sum),]

select_ID <- na.omit(Gamma_Fe[abs(Gamma_Fe$diff_4h) < 0.1 & abs(Gamma_Fe$diff_24h) < 0.1,])

IDs <- select_ID$Sample_ID
Rad <- c("Gamma","Fe")
select <- all_RIF_Raw[all_RIF_Raw$Sample_ID %in% IDs & all_RIF_Raw$Radiation_type %in% Rad,]
select_0 <- select[,grepl("Sample_ID|Timepoint|Radiation_type|avg_nfoci_0", colnames(select))]
colnames(select_0)[colnames(select_0) == "avg_nfoci_0"] = "avg_nfoci"
select_0$dose = "control"
select_LD <- select[,grepl("Sample_ID|Timepoint|Radiation_type|avg_nfoci_low_dose", colnames(select))]
colnames(select_LD)[colnames(select_LD) == "avg_nfoci_low_dose"] = "avg_nfoci"
select_LD$dose = "low dose"
select_HD <- select[,grepl("Sample_ID|Timepoint|Radiation_type|avg_nfoci_high_dose", colnames(select))]
colnames(select_HD)[colnames(select_HD) == "avg_nfoci_high_dose"] = "avg_nfoci"
select_HD$dose = "high dose"
select_all <- rbind(select_0,select_LD,select_HD)

select_gamma_4h <- select_all[select_all$Radiation_type == "Gamma" & select_all$Timepoint == "4h",]
select_gamma_4h$dose = factor(select_gamma_4h$dose, levels = c("control", "low dose","high dose"))
gamma_4h <- ggplot(select_gamma_4h, aes(x=dose, y=avg_nfoci)) + geom_point() + facet_grid(. ~ Sample_ID) + ggtitle("Gamma 4h")

select_gamma_24h <- select_all[select_all$Radiation_type == "Gamma" & select_all$Timepoint == "24h",]
select_gamma_24h$dose = factor(select_gamma_24h$dose, levels = c("control", "low dose","high dose"))
gamma_24h <- ggplot(select_gamma_24h, aes(x=dose, y=avg_nfoci)) + geom_point() + facet_grid(. ~ Sample_ID) + ggtitle("Gamma 24h")

select_fe_4h <- select_all[select_all$Radiation_type == "Fe" & select_all$Timepoint == "4h",]
select_fe_4h$dose = factor(select_fe_4h$dose, levels = c("control", "low dose","high dose"))
fe_4h <- ggplot(select_fe_4h, aes(x=dose, y=avg_nfoci)) + geom_point() + facet_grid(. ~ Sample_ID) + ggtitle("Fe 4h")

select_fe_24h <- select_all[select_all$Radiation_type == "Fe" & select_all$Timepoint == "24h",]
select_fe_24h$dose = factor(select_fe_24h$dose, levels = c("control", "low dose","high dose"))
fe_24h <- ggplot(select_fe_24h, aes(x=dose, y=avg_nfoci)) + geom_point() + facet_grid(. ~ Sample_ID) + ggtitle("Fe 24h")
```

```{r}
#############################################################################################################################
###################################################Correction################################################################
#############################################################################################################################

### Step1: 0Gy samples-------------------------------------------------------------------------------------------------------------------

#### add batch number by run & set 
Raw_pc = all_RIF_Raw 
Raw_pc$Run_set_batch[Raw_pc$Run_set=="Run_18B_Set_1"] <- 1
Raw_pc$Run_set_batch[Raw_pc$Run_set=="Run_18B_Set_2"] <- 2
Raw_pc$Run_set_batch[Raw_pc$Run_set=="Run_19A_Set_1"] <- 3
Raw_pc$Run_set_batch[Raw_pc$Run_set=="Run_19A_Set_2"] <- 4
Raw_pc$Run_set_batch[Raw_pc$Run_set=="Run_19A_Set_3"] <- 5
Raw_pc$Run_set_batch[Raw_pc$Run_set=="Run_19A_Set_4"] <- 6
Raw_pc$Run_set_batch[Raw_pc$Run_set=="Run_19C_Set_1"] <- 7
Raw_pc$Run_set_batch[Raw_pc$Run_set=="Run_19C_Set_2"] <- 8

## add batch number by radiation
Raw_pc$Radiation_Batch[Raw_pc$Radiation_type=="Fe"] <- 1
Raw_pc$Radiation_Batch[Raw_pc$Radiation_type=="Ar"] <- 2
Raw_pc$Radiation_Batch[Raw_pc$Radiation_type=="Si"] <- 3
Raw_pc$Radiation_Batch[Raw_pc$Radiation_type=="Gamma"] <- 4

###### for each run & set we apply Finsam's function, separating 4h and 24h time points, with radiation as a batch effect variable 

Correction_factors_gamma_4h = array(NaN,dim=c(4,2,6))
Correction_factors_delta_4h = array(NaN,dim=c(4,2,6))
Correction_factors_gamma_24h = array(NaN,dim=c(4,2,6))
Correction_factors_delta_24h = array(NaN,dim=c(4,2,6))

for (i in 1:6){
  #4h timepoint
  Run_set = Raw_pc %>% filter(Raw_pc$Run_set_batch == i & Raw_pc$Timepoint == "4h")
  metadata_save=Run_set[,grep("Sample_ID|Run_set_well|Run_set|Radiation_type|Timepoint|Age|BMI|Gender|BMI_group|CMV|Collection_Date",colnames(Run_set))]
  metadata=Run_set[,grep("Sample_ID|Age|BMI|Gender",colnames(Run_set))]
  edata_control=Run_set[,grep("avg_nfoci_0|avg_foci_no_outl_0",colnames(Run_set))]
  edata_control=t(edata_control)
  modcombat = model.matrix(~1, data= metadata) 
  Batch_C= Run_set$Radiation_Batch
  Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)

  Run_Set_Corrected_Controls_temp = t(Modified_ComBat$data)
  assign(paste("Corrected_Controls_4h_batch",i,sep=""),cbind(Run_Set_Corrected_Controls_temp, metadata_save))

  tmp = Modified_ComBat$gamma
  if (i == 2){tmp <- rbind(tmp,c(NA,NA))} #because we don't have data for gamma irradiation 24h set 2 BNL18B yet
  Correction_factors_gamma_4h[,,i] = tmp
  
  tmp = Modified_ComBat$delta
  if (i == 2){tmp <- rbind(tmp,c(NA,NA))} #because we don't have data for gamma irradiation 24h set 2 BNL18B yet
  Correction_factors_delta_4h[,,i] = tmp
  
  #24h timepoint
  Run_set = Raw_pc %>% filter(Raw_pc$Run_set_batch == i & Raw_pc$Timepoint == "24h")
  metadata_save=Run_set[,grep("Sample_ID|Run_set_well|Run_set|Radiation_type|Timepoint|Age|BMI|Gender|BMI_group|CMV|Collection_Date",colnames(Run_set))]
  metadata=Run_set[,grep("Sample_ID|Age|BMI|Gender",colnames(Run_set))]
  edata_control=Run_set[,grep("avg_nfoci_0|avg_foci_no_outl_0",colnames(Run_set))]
  edata_control=t(edata_control)
  modcombat = model.matrix(~1, data= metadata) 
  Batch_C= Run_set$Radiation_Batch
  Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)

  Run_Set_Corrected_Controls_temp = t(Modified_ComBat$data)
  assign(paste("Corrected_Controls_24h_batch",i,sep=""),cbind(Run_Set_Corrected_Controls_temp, metadata_save))

  tmp = Modified_ComBat$gamma
  if (i == 1 | i == 2){tmp <- rbind(tmp,c(NA,NA))} #because we don't have data for gamma irradiation 24h BNL18B yet
  Correction_factors_gamma_24h[,,i] = tmp
  
  tmp = Modified_ComBat$delta
  if (i == 1 | i == 2){tmp <- rbind(tmp,c(NA,NA))} #because we don't have data for gamma irradiation 24h BNL18B yet
  Correction_factors_delta_24h[,,i] = tmp
} 

######### regroup corrected controls 
Corrected_controls= bind_rows(Corrected_Controls_4h_batch1,Corrected_Controls_4h_batch2,Corrected_Controls_4h_batch3,Corrected_Controls_4h_batch4,Corrected_Controls_4h_batch5,Corrected_Controls_4h_batch6,Corrected_Controls_24h_batch1,Corrected_Controls_24h_batch2,Corrected_Controls_24h_batch3,Corrected_Controls_24h_batch4,Corrected_Controls_24h_batch5,Corrected_Controls_24h_batch6)

colnames(Corrected_controls)[colnames(Corrected_controls)=="avg_nfoci_0"] <- "avg_nfoci_0_corr"
Corrected_controls_tmp = Corrected_controls[,grep("Sample_ID|Radiation_type|Timepoint|avg_nfoci_0_corr",colnames(Corrected_controls))]
Raw_pc <- merge(Raw_pc,Corrected_controls_tmp,by=c("Sample_ID","Timepoint","Radiation_type"),all=FALSE)


#graphs to check correction setp1 of 0Gy samples-----------------------------------------------------------------------------------------------------

Raw_pc$Timepoint = factor(Raw_pc$Timepoint, levels = c("4h", "24h"))
Raw_pc$Radiation_type = factor(Raw_pc$Radiation_type, levels = c("Gamma", "Si","Ar","Fe"))
raw_data <- ggplot(Raw_pc, aes(x=Run_set, y=avg_nfoci_0)) + geom_boxplot(aes(fill=Radiation_type)) + facet_grid(. ~ Timepoint) + ylim(0,6)

Corrected_controls$Timepoint = factor(Corrected_controls$Timepoint, levels = c("4h", "24h"))
Corrected_controls$Radiation_type = factor(Corrected_controls$Radiation_type, levels = c("Gamma", "Si","Ar","Fe"))
corrected_data <- ggplot(Corrected_controls, aes(x=Run_set, y=avg_nfoci_0_corr)) + geom_boxplot(aes(fill=Radiation_type)) + facet_grid(. ~ Timepoint) + ylim(0,6)
#----------------------------------------------------------------------------------------------------------------------------------------------------



### Step1: all samples-------------------------------------------------------------------------------------------------------------------

rad <- c("Fe","Ar","Si","Gamma")

for (i in 1:6){ #screen for run & set
  for (r in 1:4){ #screen for radiation type
    
  #4h timepoint
  Run_set_4h = Raw_pc %>% filter(Raw_pc$Run_set_batch == i & Raw_pc$Timepoint == "4h" & Raw_pc$Radiation_type == rad[r])
  
  mu_0Gy = mean(NaRV.omit(Run_set_4h$avg_nfoci_0))
  mu_0Gy_corr = mean(NaRV.omit(Run_set_4h$avg_nfoci_0_corr))
  sd_0Gy = sd(NaRV.omit(Run_set_4h$avg_nfoci_0))
  sd_0Gy_corr = sd(NaRV.omit(Run_set_4h$avg_nfoci_0_corr))
  
  Run_set_4h$avg_nfoci_LD_corr <- (Run_set_4h$avg_nfoci_low_dose+mu_0Gy_corr-mu_0Gy)*(sd_0Gy_corr/sd_0Gy)
  Run_set_4h$avg_nfoci_HD_corr <- (Run_set_4h$avg_nfoci_high_dose+mu_0Gy_corr-mu_0Gy)*(sd_0Gy_corr/sd_0Gy)
  
  #24h timepoint
  Run_set_24h = Raw_pc %>% filter(Raw_pc$Run_set_batch == i & Raw_pc$Timepoint == "24h" & Raw_pc$Radiation_type == rad[r])
  
  mu_0Gy = mean(NaRV.omit(Run_set_24h$avg_nfoci_0))
  mu_0Gy_corr = mean(NaRV.omit(Run_set_24h$avg_nfoci_0_corr))
  sd_0Gy = sd(NaRV.omit(Run_set_24h$avg_nfoci_0))
  sd_0Gy_corr = sd(NaRV.omit(Run_set_24h$avg_nfoci_0_corr))
  
  Run_set_24h$avg_nfoci_LD_corr <- (Run_set_24h$avg_nfoci_low_dose+mu_0Gy_corr-mu_0Gy)*(sd_0Gy_corr/sd_0Gy)
  Run_set_24h$avg_nfoci_HD_corr <- (Run_set_24h$avg_nfoci_high_dose+mu_0Gy_corr-mu_0Gy)*(sd_0Gy_corr/sd_0Gy)
  
  assign(paste("Corrected_batch",i,rad[r],sep="_"),rbind(Run_set_4h,Run_set_24h))
  }
} 

Corrected_all <- rbind(Corrected_batch_1_Ar,Corrected_batch_1_Fe,Corrected_batch_1_Gamma,Corrected_batch_1_Si,Corrected_batch_2_Ar,Corrected_batch_2_Fe,Corrected_batch_2_Gamma,Corrected_batch_2_Si,Corrected_batch_3_Ar,Corrected_batch_3_Fe,Corrected_batch_3_Gamma,Corrected_batch_3_Si,Corrected_batch_4_Ar,Corrected_batch_4_Fe,Corrected_batch_4_Gamma,Corrected_batch_4_Si,Corrected_batch_5_Ar,Corrected_batch_5_Fe,Corrected_batch_5_Gamma,Corrected_batch_5_Si,Corrected_batch_6_Ar,Corrected_batch_6_Fe,Corrected_batch_6_Gamma,Corrected_batch_6_Si)

#graphs to check correction step1 of irradiated samples------------------------------------------------------------------------------------------------

### Gamma
corr_gamma <- Corrected_all[Corrected_all$Radiation_type=="Gamma",]
corr_gamma_0 <- corr_gamma[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_0_corr", colnames(corr_gamma))]
corr_gamma_0$dose = 0
colnames(corr_gamma_0)[colnames(corr_gamma_0)=="avg_nfoci_0_corr"]<-"avg_nfoci_corr"
corr_gamma_LD <- corr_gamma[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_LD_corr", colnames(corr_gamma))]
corr_gamma_LD$dose = low_dose_Gamma
colnames(corr_gamma_LD)[colnames(corr_gamma_LD)=="avg_nfoci_LD_corr"]<-"avg_nfoci_corr"
corr_gamma_HD <- corr_gamma[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_HD_corr", colnames(corr_gamma))]
corr_gamma_HD$dose = high_dose_Gamma
colnames(corr_gamma_HD)[colnames(corr_gamma_HD)=="avg_nfoci_HD_corr"]<-"avg_nfoci_corr"
corr_gamma = rbind(corr_gamma_0,corr_gamma_LD,corr_gamma_HD)
corr_gamma$Timepoint = factor(corr_gamma$Timepoint, levels = c("4h", "24h"))

corr_data_plot_gamma <- ggplot(corr_gamma, aes(x=Run_set, y=avg_nfoci_corr)) + geom_boxplot(aes(fill=as.factor(dose))) + facet_grid(. ~ Timepoint) + ggtitle("Gamma") + ylim(0,6)

### Silicon
corr_si <- Corrected_all[Corrected_all$Radiation_type=="Si",]
corr_si_0 <- corr_si[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_0_corr", colnames(corr_si))]
corr_si_0$dose = 0
colnames(corr_si_0)[colnames(corr_si_0)=="avg_nfoci_0_corr"]<-"avg_nfoci_corr"
corr_si_LD <- corr_si[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_LD_corr", colnames(corr_si))]
corr_si_LD$dose = low_dose_Si
colnames(corr_si_LD)[colnames(corr_si_LD)=="avg_nfoci_LD_corr"]<-"avg_nfoci_corr"
corr_si_HD <- corr_si[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_HD_corr", colnames(corr_si))]
corr_si_HD$dose = high_dose_Si
colnames(corr_si_HD)[colnames(corr_si_HD)=="avg_nfoci_HD_corr"]<-"avg_nfoci_corr"
corr_si = rbind(corr_si_0,corr_si_LD,corr_si_HD)
corr_si$Timepoint = factor(corr_si$Timepoint, levels = c("4h", "24h"))

corr_data_plot_si <- ggplot(corr_si, aes(x=Run_set, y=avg_nfoci_corr)) + geom_boxplot(aes(fill=as.factor(dose))) + facet_grid(. ~ Timepoint) + ggtitle("Si") + ylim(0,6)

### Argon
corr_ar <- Corrected_all[Corrected_all$Radiation_type=="Ar",]
corr_ar_0 <- corr_ar[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_0_corr", colnames(corr_ar))]
corr_ar_0$dose = 0
colnames(corr_ar_0)[colnames(corr_ar_0)=="avg_nfoci_0_corr"]<-"avg_nfoci_corr"
corr_ar_LD <- corr_ar[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_LD_corr", colnames(corr_ar))]
corr_ar_LD$dose = low_dose_Ar
colnames(corr_ar_LD)[colnames(corr_ar_LD)=="avg_nfoci_LD_corr"]<-"avg_nfoci_corr"
corr_ar_HD <- corr_ar[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_HD_corr", colnames(corr_ar))]
corr_ar_HD$dose = high_dose_Ar
colnames(corr_ar_HD)[colnames(corr_ar_HD)=="avg_nfoci_HD_corr"]<-"avg_nfoci_corr"
corr_ar = rbind(corr_ar_0,corr_ar_LD,corr_ar_HD)
corr_ar$Timepoint = factor(corr_ar$Timepoint, levels = c("4h", "24h"))

corr_data_plot_ar <- ggplot(corr_ar, aes(x=Run_set, y=avg_nfoci_corr)) + geom_boxplot(aes(fill=as.factor(dose))) + facet_grid(. ~ Timepoint) + ggtitle("Ar") + ylim(0,6)

### Iron
corr_fe <- Corrected_all[Corrected_all$Radiation_type=="Fe",]
corr_fe_0 <- corr_fe[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_0_corr", colnames(corr_fe))]
corr_fe_0$dose = 0
colnames(corr_fe_0)[colnames(corr_fe_0)=="avg_nfoci_0_corr"]<-"avg_nfoci_corr"
corr_fe_LD <- corr_fe[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_LD_corr", colnames(corr_fe))]
corr_fe_LD$dose = low_dose_Fe
colnames(corr_fe_LD)[colnames(corr_fe_LD)=="avg_nfoci_LD_corr"]<-"avg_nfoci_corr"
corr_fe_HD <- corr_fe[,grepl("Sample_ID|Run_set|Timepoint|avg_nfoci_HD_corr", colnames(corr_fe))]
corr_fe_HD$dose = high_dose_Fe
colnames(corr_fe_HD)[colnames(corr_fe_HD)=="avg_nfoci_HD_corr"]<-"avg_nfoci_corr"
corr_fe = rbind(corr_fe_0,corr_fe_LD,corr_fe_HD)
corr_fe$Timepoint = factor(corr_fe$Timepoint, levels = c("4h", "24h"))

corr_data_plot_fe <- ggplot(corr_fe, aes(x=Run_set, y=avg_nfoci_corr)) + geom_boxplot(aes(fill=as.factor(dose))) + facet_grid(. ~ Timepoint) + ggtitle("Fe") + ylim(0,6)
#----------------------------------------------------------------------------------------------------------------------------------------------------


#### The correction may generate negative value => we fix those negative value to 0 
Corrected_DNA_Damage$avg_nfoci_0[Corrected_DNA_Damage$avg_nfoci_0 < 0] <- 0 
Corrected_DNA_Damage$avg_nfoci_low_dose[Corrected_DNA_Damage$avg_nfoci_low_dose < 0] <-  0 
Corrected_DNA_Damage$avg_nfoci_high_dose[Corrected_DNA_Damage$avg_nfoci_high_dose < 0] <-  0 
```

```{r}
#Corrected_DNA_Damage_HT= Corrected_DNA_Damage
Corrected_DNA_Damage_CD7= Corrected_DNA_Damage
```

```{r}
### Correction Step 2 
### Now we calculate the Z-score only on the 10p that overlapp in 18B and 19A
# Select the 10 people that overlap in these two run
Subject_18BS2_19AS1 = c(1214, 1215,1216,1217,1218,1219,1220,1221,1222,1223)
RIF_correct_19A_18B_10p = Corrected_DNA_Damage %>% filter(Corrected_DNA_Damage$Sample_ID %in% Subject_18BS2_19AS1 )

#### Z-score for 19A
Samp_19A_10p = RIF_correct_19A_18B_10p %>% filter(RIF_correct_19A_18B_10p$Run_set =="Run_19A_Set_1")

## For Controls 
Controls_19A= Samp_19A_10p
Controls_19A$avg_nfoci_low_dose=NULL
Controls_19A$avg_nfoci_high_dose=NULL
Controls_19A$nfoci_high_dose_norm=NULL 
Controls_19A$nfoci_low_dose_norm=NULL 
#
### 4h 
control_19A_4h = Controls_19A %>% filter(Controls_19A$Timepoint=="4h")
#
control_19A_4h_Fe = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Fe")
control_19A_4h_Ar = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Ar")
control_19A_4h_Si = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Si")
control_19A_4h_Gamma = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Gamma")
### 24h 
control_19A_24h = Controls_19A %>% filter(Controls_19A$Timepoint=="24h")
#
control_19A_24h_Fe = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Fe")
control_19A_24h_Ar = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Ar")
control_19A_24h_Si = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Si")
control_19A_24h_Gamma = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_ref_19A_Cont_Fe_4h = mean(NaRV.omit(control_19A_4h_Fe$avg_nfoci_0))
Mean_ref_19A_Cont_Ar_4h = mean(NaRV.omit(control_19A_4h_Ar$avg_nfoci_0))
Mean_ref_19A_Cont_Si_4h = mean(NaRV.omit(control_19A_4h_Si$avg_nfoci_0))
Mean_ref_19A_Cont_Gamma_4h = mean(NaRV.omit(control_19A_4h_Gamma$avg_nfoci_0))
# 24h
Mean_ref_19A_Cont_Fe_24h = mean(NaRV.omit(control_19A_24h_Fe$avg_nfoci_0))
Mean_ref_19A_Cont_Ar_24h = mean(NaRV.omit(control_19A_24h_Ar$avg_nfoci_0))
Mean_ref_19A_Cont_Si_24h = mean(NaRV.omit(control_19A_24h_Si$avg_nfoci_0))
Mean_ref_19A_Cont_Gamma_24h = mean(NaRV.omit(control_19A_24h_Gamma$avg_nfoci_0))
####### sd
# 4h
Std_ref_19A_Cont_Fe_4h = sd(NaRV.omit(control_19A_4h_Fe$avg_nfoci_0))
Std_ref_19A_Cont_Ar_4h = sd(NaRV.omit(control_19A_4h_Ar$avg_nfoci_0))
Std_ref_19A_Cont_Si_4h = sd(NaRV.omit(control_19A_4h_Si$avg_nfoci_0))
Std_ref_19A_Cont_Gamma_4h = sd(NaRV.omit(control_19A_4h_Gamma$avg_nfoci_0))
# 24h
Std_ref_19A_Cont_Fe_24h = sd(NaRV.omit(control_19A_24h_Fe$avg_nfoci_0))
Std_ref_19A_Cont_Ar_24h = sd(NaRV.omit(control_19A_24h_Ar$avg_nfoci_0))
Std_ref_19A_Cont_Si_24h = sd(NaRV.omit(control_19A_24h_Si$avg_nfoci_0))
Std_ref_19A_Cont_Gamma_24h = sd(NaRV.omit(control_19A_24h_Gamma$avg_nfoci_0))
#
#
## For Low dose irradiated samples
LD_19A= Samp_19A_10p
LD_19A$avg_nfoci_0=NULL
LD_19A$avg_nfoci_high_dose=NULL
LD_19A$nfoci_high_dose_norm=NULL 
LD_19A$nfoci_low_dose_norm=NULL 
LD_19A$nfoci_0=NULL 
#
### 4h 
LD_19A_4h = LD_19A %>% filter(LD_19A$Timepoint=="4h")
#
LD_19A_4h_Fe = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Fe")
LD_19A_4h_Ar = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Ar")
LD_19A_4h_Si = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Si")
LD_19A_4h_Gamma = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Gamma")
### 24h 
LD_19A_24h = LD_19A %>% filter(LD_19A$Timepoint=="24h")
#
LD_19A_24h_Fe = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Fe")
LD_19A_24h_Ar = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Ar")
LD_19A_24h_Si = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Si")
LD_19A_24h_Gamma = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_ref_19A_LD_Fe_4h = mean(NaRV.omit(LD_19A_4h_Fe$avg_nfoci_low_dose))
Mean_ref_19A_LD_Ar_4h = mean(NaRV.omit(LD_19A_4h_Ar$avg_nfoci_low_dose))
Mean_ref_19A_LD_Si_4h = mean(NaRV.omit(LD_19A_4h_Si$avg_nfoci_low_dose))
Mean_ref_19A_LD_Gamma_4h = mean(NaRV.omit(LD_19A_4h_Gamma$avg_nfoci_low_dose))
# 24h
Mean_ref_19A_LD_Fe_24h = mean(NaRV.omit(LD_19A_24h_Fe$avg_nfoci_low_dose))
Mean_ref_19A_LD_Ar_24h = mean(NaRV.omit(LD_19A_24h_Ar$avg_nfoci_low_dose))
Mean_ref_19A_LD_Si_24h = mean(NaRV.omit(LD_19A_24h_Si$avg_nfoci_low_dose))
Mean_ref_19A_LD_Gamma_24h = mean(NaRV.omit(LD_19A_24h_Gamma$avg_nfoci_low_dose))
####### sd
# 4h
Std_ref_19A_LD_Fe_4h = sd(NaRV.omit(LD_19A_4h_Fe$avg_nfoci_low_dose))
Std_ref_19A_LD_Ar_4h = sd(NaRV.omit(LD_19A_4h_Ar$avg_nfoci_low_dose))
Std_ref_19A_LD_Si_4h = sd(NaRV.omit(LD_19A_4h_Si$avg_nfoci_low_dose))
Std_ref_19A_LD_Gamma_4h = sd(NaRV.omit(LD_19A_4h_Gamma$avg_nfoci_low_dose))
# 24h
Std_ref_19A_LD_Fe_24h = sd(NaRV.omit(LD_19A_24h_Fe$avg_nfoci_low_dose))
Std_ref_19A_LD_Ar_24h = sd(NaRV.omit(LD_19A_24h_Ar$avg_nfoci_low_dose))
Std_ref_19A_LD_Si_24h = sd(NaRV.omit(LD_19A_24h_Si$avg_nfoci_low_dose))
Std_ref_19A_LD_Gamma_24h = sd(NaRV.omit(LD_19A_24h_Gamma$avg_nfoci_low_dose))
#
#
## For high dose irradiated samples
HD_19A= Samp_19A_10p
HD_19A$avg_nfoci_0=NULL
HD_19A$avg_nfoci_low_dose=NULL
HD_19A$nfoci_low_dose_norm=NULL 
HD_19A$nfoci_high_dose_norm=NULL 
HD_19A$nfoci_0=NULL 
#
### 4h 
HD_19A_4h = HD_19A %>% filter(HD_19A$Timepoint=="4h")
#
HD_19A_4h_Fe = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Fe")
HD_19A_4h_Ar = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Ar")
HD_19A_4h_Si = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Si")
HD_19A_4h_Gamma = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Gamma")
### 24h 
HD_19A_24h = HD_19A %>% filter(HD_19A$Timepoint=="24h")
#
HD_19A_24h_Fe = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Fe")
HD_19A_24h_Ar = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Ar")
HD_19A_24h_Si = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Si")
HD_19A_24h_Gamma = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_ref_19A_HD_Fe_4h = mean(NaRV.omit(HD_19A_4h_Fe$avg_nfoci_high_dose))
Mean_ref_19A_HD_Ar_4h = mean(NaRV.omit(HD_19A_4h_Ar$avg_nfoci_high_dose))
Mean_ref_19A_HD_Si_4h = mean(NaRV.omit(HD_19A_4h_Si$avg_nfoci_high_dose))
Mean_ref_19A_HD_Gamma_4h = mean(NaRV.omit(HD_19A_4h_Gamma$avg_nfoci_high_dose))
# 24h
Mean_ref_19A_HD_Fe_24h = mean(NaRV.omit(HD_19A_24h_Fe$avg_nfoci_high_dose))
Mean_ref_19A_HD_Ar_24h = mean(NaRV.omit(HD_19A_24h_Ar$avg_nfoci_high_dose))
Mean_ref_19A_HD_Si_24h = mean(NaRV.omit(HD_19A_24h_Si$avg_nfoci_high_dose))
Mean_ref_19A_HD_Gamma_24h = mean(NaRV.omit(HD_19A_24h_Gamma$avg_nfoci_high_dose))
####### sd
# 4h
Std_ref_19A_HD_Fe_4h = sd(NaRV.omit(HD_19A_4h_Fe$avg_nfoci_high_dose))
Std_ref_19A_HD_Ar_4h = sd(NaRV.omit(HD_19A_4h_Ar$avg_nfoci_high_dose))
Std_ref_19A_HD_Si_4h = sd(NaRV.omit(HD_19A_4h_Si$avg_nfoci_high_dose))
Std_ref_19A_HD_Gamma_4h = sd(NaRV.omit(HD_19A_4h_Gamma$avg_nfoci_high_dose))
# 24h
Std_ref_19A_HD_Fe_24h = sd(NaRV.omit(HD_19A_24h_Fe$avg_nfoci_high_dose))
Std_ref_19A_HD_Ar_24h = sd(NaRV.omit(HD_19A_24h_Ar$avg_nfoci_high_dose))
Std_ref_19A_HD_Si_24h = sd(NaRV.omit(HD_19A_24h_Si$avg_nfoci_high_dose))
Std_ref_19A_HD_Gamma_24h = sd(NaRV.omit(HD_19A_24h_Gamma$avg_nfoci_high_dose))
#
#### Z-score for 18B
Samp_18B_10p = RIF_correct_19A_18B_10p %>% filter(RIF_correct_19A_18B_10p$Run_set =="Run_18B_Set_2")
#
## For Controls 
Controls_18B= Samp_18B_10p
Controls_18B$avg_nfoci_low_dose=NULL
Controls_18B$avg_nfoci_high_dose=NULL
Controls_18B$nfoci_high_dose_norm=NULL 
Controls_18B$nfoci_low_dose_norm=NULL 
#
### 4h 
control_18B_4h = Controls_18B %>% filter(Controls_18B$Timepoint=="4h")
#
control_18B_4h_Fe = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Fe")
control_18B_4h_Ar = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Ar")
control_18B_4h_Si = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Si")
control_18B_4h_Gamma = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Gamma")
### 24h 
control_18B_24h = Controls_18B %>% filter(Controls_18B$Timepoint=="24h")
#
control_18B_24h_Fe = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Fe")
control_18B_24h_Ar = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Ar")
control_18B_24h_Si = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Si")
control_18B_24h_Gamma = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_ref_18B_Cont_Fe_4h = mean(NaRV.omit(control_18B_4h_Fe$avg_nfoci_0))
Mean_ref_18B_Cont_Ar_4h = mean(NaRV.omit(control_18B_4h_Ar$avg_nfoci_0))
Mean_ref_18B_Cont_Si_4h = mean(NaRV.omit(control_18B_4h_Si$avg_nfoci_0))
Mean_ref_18B_Cont_Gamma_4h = mean(NaRV.omit(control_18B_4h_Gamma$avg_nfoci_0))
# 24h
Mean_ref_18B_Cont_Fe_24h = mean(NaRV.omit(control_18B_24h_Fe$avg_nfoci_0))
Mean_ref_18B_Cont_Ar_24h = mean(NaRV.omit(control_18B_24h_Ar$avg_nfoci_0))
Mean_ref_18B_Cont_Si_24h = mean(NaRV.omit(control_18B_24h_Si$avg_nfoci_0))
Mean_ref_18B_Cont_Gamma_24h = mean(NaRV.omit(control_18B_24h_Gamma$avg_nfoci_0))
####### sd
# 4h
Std_ref_18B_Cont_Fe_4h = sd(NaRV.omit(control_18B_4h_Fe$avg_nfoci_0))
Std_ref_18B_Cont_Ar_4h = sd(NaRV.omit(control_18B_4h_Ar$avg_nfoci_0))
Std_ref_18B_Cont_Si_4h = sd(NaRV.omit(control_18B_4h_Si$avg_nfoci_0))
Std_ref_18B_Cont_Gamma_4h = sd(NaRV.omit(control_18B_4h_Gamma$avg_nfoci_0))
# 24h
Std_ref_18B_Cont_Fe_24h = sd(NaRV.omit(control_18B_24h_Fe$avg_nfoci_0))
Std_ref_18B_Cont_Ar_24h = sd(NaRV.omit(control_18B_24h_Ar$avg_nfoci_0))
Std_ref_18B_Cont_Si_24h = sd(NaRV.omit(control_18B_24h_Si$avg_nfoci_0))
Std_ref_18B_Cont_Gamma_24h = sd(NaRV.omit(control_18B_24h_Gamma$avg_nfoci_0))
#
#
## For Low dose irradiated samples
LD_18B= Samp_18B_10p
LD_18B$avg_nfoci_0=NULL
LD_18B$avg_nfoci_high_dose=NULL
LD_18B$nfoci_high_dose_norm=NULL 
LD_18B$nfoci_low_dose_norm=NULL 
LD_18B$nfoci_0=NULL 
#
### 4h 
LD_18B_4h = LD_18B %>% filter(LD_18B$Timepoint=="4h")
#
LD_18B_4h_Fe = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Fe")
LD_18B_4h_Ar = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Ar")
LD_18B_4h_Si = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Si")
LD_18B_4h_Gamma = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Gamma")
### 24h 
LD_18B_24h = LD_18B %>% filter(LD_18B$Timepoint=="24h")
#
LD_18B_24h_Fe = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Fe")
LD_18B_24h_Ar = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Ar")
LD_18B_24h_Si = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Si")
LD_18B_24h_Gamma = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_ref_18B_LD_Fe_4h = mean(NaRV.omit(LD_18B_4h_Fe$avg_nfoci_low_dose))
Mean_ref_18B_LD_Ar_4h = mean(NaRV.omit(LD_18B_4h_Ar$avg_nfoci_low_dose))
Mean_ref_18B_LD_Si_4h = mean(NaRV.omit(LD_18B_4h_Si$avg_nfoci_low_dose))
Mean_ref_18B_LD_Gamma_4h = mean(NaRV.omit(LD_18B_4h_Gamma$avg_nfoci_low_dose))
# 24h
Mean_ref_18B_LD_Fe_24h = mean(NaRV.omit(LD_18B_24h_Fe$avg_nfoci_low_dose))
Mean_ref_18B_LD_Ar_24h = mean(NaRV.omit(LD_18B_24h_Ar$avg_nfoci_low_dose))
Mean_ref_18B_LD_Si_24h = mean(NaRV.omit(LD_18B_24h_Si$avg_nfoci_low_dose))
Mean_ref_18B_LD_Gamma_24h = mean(NaRV.omit(LD_18B_24h_Gamma$avg_nfoci_low_dose))
####### sd
# 4h
Std_ref_18B_LD_Fe_4h = sd(NaRV.omit(LD_18B_4h_Fe$avg_nfoci_low_dose))
Std_ref_18B_LD_Ar_4h = sd(NaRV.omit(LD_18B_4h_Ar$avg_nfoci_low_dose))
Std_ref_18B_LD_Si_4h = sd(NaRV.omit(LD_18B_4h_Si$avg_nfoci_low_dose))
Std_ref_18B_LD_Gamma_4h = sd(NaRV.omit(LD_18B_4h_Gamma$avg_nfoci_low_dose))
# 24h
Std_ref_18B_LD_Fe_24h = sd(NaRV.omit(LD_18B_24h_Fe$avg_nfoci_low_dose))
Std_ref_18B_LD_Ar_24h = sd(NaRV.omit(LD_18B_24h_Ar$avg_nfoci_low_dose))
Std_ref_18B_LD_Si_24h = sd(NaRV.omit(LD_18B_24h_Si$avg_nfoci_low_dose))
Std_ref_18B_LD_Gamma_24h = sd(NaRV.omit(LD_18B_24h_Gamma$avg_nfoci_low_dose))
#
#
## For high dose irradiated samples
HD_18B= Samp_18B_10p
HD_18B$avg_nfoci_0=NULL
HD_18B$avg_nfoci_low_dose=NULL
HD_18B$nfoci_low_dose_norm=NULL 
HD_18B$nfoci_high_dose_norm=NULL 
HD_18B$nfoci_0=NULL 
#
### 4h 
HD_18B_4h = HD_18B %>% filter(HD_18B$Timepoint=="4h")
#
HD_18B_4h_Fe = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Fe")
HD_18B_4h_Ar = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Ar")
HD_18B_4h_Si = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Si")
HD_18B_4h_Gamma = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Gamma")
### 24h 
HD_18B_24h = HD_18B %>% filter(HD_18B$Timepoint=="24h")
#
HD_18B_24h_Fe = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Fe")
HD_18B_24h_Ar = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Ar")
HD_18B_24h_Si = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Si")
HD_18B_24h_Gamma = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_ref_18B_HD_Fe_4h = mean(NaRV.omit(HD_18B_4h_Fe$avg_nfoci_high_dose))
Mean_ref_18B_HD_Ar_4h = mean(NaRV.omit(HD_18B_4h_Ar$avg_nfoci_high_dose))
Mean_ref_18B_HD_Si_4h = mean(NaRV.omit(HD_18B_4h_Si$avg_nfoci_high_dose))
Mean_ref_18B_HD_Gamma_4h = mean(NaRV.omit(HD_18B_4h_Gamma$avg_nfoci_high_dose))
# 24h
Mean_ref_18B_HD_Fe_24h = mean(NaRV.omit(HD_18B_24h_Fe$avg_nfoci_high_dose))
Mean_ref_18B_HD_Ar_24h = mean(NaRV.omit(HD_18B_24h_Ar$avg_nfoci_high_dose))
Mean_ref_18B_HD_Si_24h = mean(NaRV.omit(HD_18B_24h_Si$avg_nfoci_high_dose))
Mean_ref_18B_HD_Gamma_24h = mean(NaRV.omit(HD_18B_24h_Gamma$avg_nfoci_high_dose))
####### sd
# 4h
Std_ref_18B_HD_Fe_4h = sd(NaRV.omit(HD_18B_4h_Fe$avg_nfoci_high_dose))
Std_ref_18B_HD_Ar_4h = sd(NaRV.omit(HD_18B_4h_Ar$avg_nfoci_high_dose))
Std_ref_18B_HD_Si_4h = sd(NaRV.omit(HD_18B_4h_Si$avg_nfoci_high_dose))
Std_ref_18B_HD_Gamma_4h = sd(NaRV.omit(HD_18B_4h_Gamma$avg_nfoci_high_dose))
# 24h
Std_ref_18B_HD_Fe_24h = sd(NaRV.omit(HD_18B_24h_Fe$avg_nfoci_high_dose))
Std_ref_18B_HD_Ar_24h = sd(NaRV.omit(HD_18B_24h_Ar$avg_nfoci_high_dose))
Std_ref_18B_HD_Si_24h = sd(NaRV.omit(HD_18B_24h_Si$avg_nfoci_high_dose))
Std_ref_18B_HD_Gamma_24h = sd(NaRV.omit(HD_18B_24h_Gamma$avg_nfoci_high_dose))

### Now we do the zscore correction on all 18B and 19A
Subject_18BS2_19AS1 = c(1214, 1215,1216,1217,1218,1219,1220,1221,1222,1223)
#
Run_18B = c("Run_18B_Set_2", "Run_18B_Set_1")
Run_19A = c("Run_19A_Set_1", "Run_19A_Set_2", "Run_19A_Set_3", "Run_19A_Set_4")
#
Samp_18B_allp = Corrected_DNA_Damage %>% filter(Corrected_DNA_Damage$Run_set %in% Run_18B)
Samp_19A_allp = Corrected_DNA_Damage %>% filter(Corrected_DNA_Damage$Run_set %in% Run_19A)
#
## For Controls 
Controls_allp_18B= Samp_18B_allp
Controls_allp_18B$avg_nfoci_low_dose=NULL
Controls_allp_18B$avg_nfoci_high_dose=NULL
Controls_allp_18B$nfoci_low_dose_norm=NULL
Controls_allp_18B$nfoci_high_dose_norm=NULL
#
### 4h 
control_allp_18B_4h = Controls_allp_18B %>% filter(Controls_allp_18B$Timepoint=="4h")
#
control_allp_18B_4h_Fe = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Fe")
control_allp_18B_4h_Ar = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Ar")
control_allp_18B_4h_Si = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Si")
control_allp_18B_4h_Gamma = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Gamma")
### 24h 
control_allp_18B_24h = Controls_allp_18B %>% filter(Controls_allp_18B$Timepoint=="24h")
#
control_allp_18B_24h_Fe = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Fe")
control_allp_18B_24h_Ar = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Ar")
control_allp_18B_24h_Si = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Si")
control_allp_18B_24h_Gamma = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Gamma")

## z-score correction
# 4h
control_allp_18B_4h_Fe$avg_nfoci_0 = ((((control_allp_18B_4h_Fe$avg_nfoci_0 - Mean_ref_18B_Cont_Fe_4h)/Std_ref_18B_Cont_Fe_4h)
                                      *Std_ref_19A_Cont_Fe_4h) + Mean_ref_19A_Cont_Fe_4h)
                                          
control_allp_18B_4h_Ar$avg_nfoci_0 = ((((control_allp_18B_4h_Ar$avg_nfoci_0 - Mean_ref_18B_Cont_Ar_4h)/Std_ref_18B_Cont_Ar_4h)
                                      *Std_ref_19A_Cont_Ar_4h) + Mean_ref_19A_Cont_Ar_4h) 

control_allp_18B_4h_Si$avg_nfoci_0 = ((((control_allp_18B_4h_Si$avg_nfoci_0 - Mean_ref_18B_Cont_Si_4h)/Std_ref_18B_Cont_Si_4h)
                                      *Std_ref_19A_Cont_Si_4h) + Mean_ref_19A_Cont_Si_4h)
                                          
control_allp_18B_4h_Gamma$avg_nfoci_0 = ((((control_allp_18B_4h_Gamma$avg_nfoci_0 - Mean_ref_18B_Cont_Gamma_4h)/Std_ref_18B_Cont_Gamma_4h)
                                      *Std_ref_19A_Cont_Gamma_4h) + Mean_ref_19A_Cont_Gamma_4h)

# 24h
control_allp_18B_24h_Fe$avg_nfoci_0 = ((((control_allp_18B_24h_Fe$avg_nfoci_0 - Mean_ref_18B_Cont_Fe_24h)/Std_ref_18B_Cont_Fe_24h)
                                      *Std_ref_19A_Cont_Fe_24h) + Mean_ref_19A_Cont_Fe_24h)
                                          
control_allp_18B_24h_Ar$avg_nfoci_0 = ((((control_allp_18B_24h_Ar$avg_nfoci_0 - Mean_ref_18B_Cont_Ar_24h)/Std_ref_18B_Cont_Ar_24h)
                                      *Std_ref_19A_Cont_Ar_24h) + Mean_ref_19A_Cont_Ar_24h) 

control_allp_18B_24h_Si$avg_nfoci_0 = ((((control_allp_18B_24h_Si$avg_nfoci_0 - Mean_ref_18B_Cont_Si_24h)/Std_ref_18B_Cont_Si_24h)
                                     *Std_ref_19A_Cont_Si_24h) + Mean_ref_19A_Cont_Si_24h)
                                          
control_allp_18B_24h_Gamma$avg_nfoci_0 = ((((control_allp_18B_24h_Gamma$avg_nfoci_0 - Mean_ref_18B_Cont_Gamma_24h)/Std_ref_18B_Cont_Gamma_24h)
                                      *Std_ref_19A_Cont_Gamma_24h) + Mean_ref_19A_Cont_Gamma_24h)


## For Low dose irradiated samples
LD_allp_18B= Samp_18B_allp
LD_allp_18B$avg_nfoci_0=NULL
LD_allp_18B$avg_nfoci_high_dose=NULL
LD_allp_18B$nfoci_low_dose_norm=NULL
LD_allp_18B$nfoci_high_dose_norm=NULL
#
### 4h 
LD_allp_18B_4h = LD_allp_18B %>% filter(LD_allp_18B$Timepoint=="4h")
#
LD_allp_18B_4h_Fe = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Fe")
LD_allp_18B_4h_Ar = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Ar")
LD_allp_18B_4h_Si = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Si")
LD_allp_18B_4h_Gamma = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Gamma")
### 24h 
LD_allp_18B_24h = LD_allp_18B %>% filter(LD_allp_18B$Timepoint=="24h")
#
LD_allp_18B_24h_Fe = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Fe")
LD_allp_18B_24h_Ar = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Ar")
LD_allp_18B_24h_Si = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Si")
LD_allp_18B_24h_Gamma = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Gamma")

## z-score correction
# 4h
LD_allp_18B_4h_Fe$avg_nfoci_low_dose = ((((LD_allp_18B_4h_Fe$avg_nfoci_low_dose -Mean_ref_18B_LD_Fe_4h)/Std_ref_18B_LD_Fe_4h)
                                         *Std_ref_19A_LD_Fe_4h) + Mean_ref_19A_LD_Fe_4h)

LD_allp_18B_4h_Ar$avg_nfoci_low_dose = ((((LD_allp_18B_4h_Ar$avg_nfoci_low_dose -Mean_ref_18B_LD_Ar_4h)/Std_ref_18B_LD_Ar_4h)
                                         *Std_ref_19A_LD_Ar_4h) + Mean_ref_19A_LD_Ar_4h)

LD_allp_18B_4h_Si$avg_nfoci_low_dose = ((((LD_allp_18B_4h_Si$avg_nfoci_low_dose -Mean_ref_18B_LD_Si_4h)/Std_ref_18B_LD_Si_4h)
                                         *Std_ref_19A_LD_Si_4h) + Mean_ref_19A_LD_Si_4h)
                                            
LD_allp_18B_4h_Gamma$avg_nfoci_low_dose = ((((LD_allp_18B_4h_Gamma$avg_nfoci_low_dose -Mean_ref_18B_LD_Gamma_4h)/Std_ref_18B_LD_Gamma_4h)
                                         *Std_ref_19A_LD_Gamma_4h) + Mean_ref_19A_LD_Gamma_4h)


# 24h
LD_allp_18B_24h_Fe$avg_nfoci_low_dose = ((((LD_allp_18B_24h_Fe$avg_nfoci_low_dose -Mean_ref_18B_LD_Fe_24h)/Std_ref_18B_LD_Fe_24h)
                                         *Std_ref_19A_LD_Fe_24h) + Mean_ref_19A_LD_Fe_24h)

LD_allp_18B_24h_Ar$avg_nfoci_low_dose = ((((LD_allp_18B_24h_Ar$avg_nfoci_low_dose -Mean_ref_18B_LD_Ar_24h)/Std_ref_18B_LD_Ar_24h)
                                         *Std_ref_19A_LD_Ar_24h) + Mean_ref_19A_LD_Ar_24h)

LD_allp_18B_24h_Si$avg_nfoci_low_dose = ((((LD_allp_18B_24h_Si$avg_nfoci_low_dose -Mean_ref_18B_LD_Si_24h)/Std_ref_18B_LD_Si_24h)
                                         *Std_ref_19A_LD_Si_24h) + Mean_ref_19A_LD_Si_24h)
                                            
LD_allp_18B_24h_Gamma$avg_nfoci_low_dose = ((((LD_allp_18B_24h_Gamma$avg_nfoci_low_dose -Mean_ref_18B_LD_Gamma_24h)/Std_ref_18B_LD_Gamma_24h)
                                       *Std_ref_19A_LD_Gamma_24h) + Mean_ref_19A_LD_Gamma_24h)

## For high dose irradiated samples
HD_allp_18B= Samp_18B_allp
HD_allp_18B$avg_nfoci_0=NULL
HD_allp_18B$avg_nfoci_low_dose=NULL
HD_allp_18B$nfoci_low_dose_norm=NULL
HD_allp_18B$nfoci_high_dose_norm=NULL
#
### 4h 
HD_allp_18B_4h = HD_allp_18B %>% filter(HD_allp_18B$Timepoint=="4h")
#
HD_allp_18B_4h_Fe = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Fe")
HD_allp_18B_4h_Ar = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Ar")
HD_allp_18B_4h_Si = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Si")
HD_allp_18B_4h_Gamma = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Gamma")
### 24h 
HD_allp_18B_24h = HD_allp_18B %>% filter(HD_allp_18B$Timepoint=="24h")
#
HD_allp_18B_24h_Fe = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Fe")
HD_allp_18B_24h_Ar = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Ar")
HD_allp_18B_24h_Si = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Si")
HD_allp_18B_24h_Gamma = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Gamma")

## z-score correction
# 4h
HD_allp_18B_4h_Fe$avg_nfoci_high_dose= ((((HD_allp_18B_4h_Fe$avg_nfoci_high_dose -Mean_ref_18B_HD_Fe_4h)/Std_ref_18B_HD_Fe_4h)
                                         *Std_ref_19A_HD_Fe_4h) + Mean_ref_19A_HD_Fe_4h)

HD_allp_18B_4h_Ar$avg_nfoci_high_dose= ((((HD_allp_18B_4h_Ar$avg_nfoci_high_dose -Mean_ref_18B_HD_Ar_4h)/Std_ref_18B_HD_Ar_4h)
                                         *Std_ref_19A_HD_Ar_4h) + Mean_ref_19A_HD_Ar_4h)

HD_allp_18B_4h_Si$avg_nfoci_high_dose= ((((HD_allp_18B_4h_Si$avg_nfoci_high_dose -Mean_ref_18B_HD_Si_4h)/Std_ref_18B_HD_Si_4h)
                                         *Std_ref_19A_HD_Si_4h) + Mean_ref_19A_HD_Si_4h)

HD_allp_18B_4h_Gamma$avg_nfoci_high_dose= ((((HD_allp_18B_4h_Gamma$avg_nfoci_high_dose -Mean_ref_18B_HD_Gamma_4h)/Std_ref_18B_HD_Gamma_4h)
                                        *Std_ref_19A_HD_Gamma_4h) + Mean_ref_19A_HD_Gamma_4h)
                                          

# 24h
HD_allp_18B_24h_Fe$avg_nfoci_high_dose= ((((HD_allp_18B_24h_Fe$avg_nfoci_high_dose -Mean_ref_18B_HD_Fe_24h)/Std_ref_18B_HD_Fe_24h)
                                         *Std_ref_19A_HD_Fe_24h) + Mean_ref_19A_HD_Fe_24h)

HD_allp_18B_24h_Ar$avg_nfoci_high_dose= ((((HD_allp_18B_24h_Ar$avg_nfoci_high_dose -Mean_ref_18B_HD_Ar_24h)/Std_ref_18B_HD_Ar_24h)
                                         *Std_ref_19A_HD_Ar_24h) + Mean_ref_19A_HD_Ar_24h)

HD_allp_18B_24h_Si$avg_nfoci_high_dose= ((((HD_allp_18B_24h_Si$avg_nfoci_high_dose -Mean_ref_18B_HD_Si_24h)/Std_ref_18B_HD_Si_24h)
                                         *Std_ref_19A_HD_Si_24h) + Mean_ref_19A_HD_Si_24h)

HD_allp_18B_24h_Gamma$avg_nfoci_high_dose= ((((HD_allp_18B_24h_Gamma$avg_nfoci_high_dose -Mean_ref_18B_HD_Gamma_24h)/Std_ref_18B_HD_Gamma_24h)
                                             *Std_ref_19A_HD_Gamma_24h) + Mean_ref_19A_HD_Gamma_24h)




### Now we regroup everything
## regroup 18B

Cont_18B_All_rad= bind_rows(control_allp_18B_4h_Fe,  control_allp_18B_24h_Fe, 
                             control_allp_18B_4h_Ar,  control_allp_18B_24h_Ar,
                             control_allp_18B_4h_Si,  control_allp_18B_24h_Si,
                            control_allp_18B_4h_Gamma,  control_allp_18B_24h_Gamma)

LD_18B_All_rad= bind_rows(LD_allp_18B_4h_Fe,  LD_allp_18B_24h_Fe, 
                          LD_allp_18B_4h_Ar,  LD_allp_18B_24h_Ar,
                          LD_allp_18B_4h_Si,  LD_allp_18B_24h_Si,
                          LD_allp_18B_4h_Gamma,  LD_allp_18B_24h_Gamma)

 HD_18B_All_rad= bind_rows(HD_allp_18B_4h_Fe,  HD_allp_18B_24h_Fe, 
                           HD_allp_18B_4h_Ar,  HD_allp_18B_24h_Ar,
                           HD_allp_18B_4h_Si,  HD_allp_18B_24h_Si,
                           HD_allp_18B_4h_Gamma,  HD_allp_18B_24h_Gamma)


Control_18B_meta_use= Cont_18B_All_rad[,grepl("Sample_ID|Plate|Duplicate|Run_set|Timepoint|Radiation_type|avg",colnames(Cont_18B_All_rad))]
#
LD_control_18B=merge(LD_18B_All_rad, Control_18B_meta_use, by=c("Sample_ID", "Duplicate", "Run_set", "Timepoint", "Radiation_type") )
colnames(LD_control_18B)[colnames(LD_control_18B)=="avg_nfoci_low_dose"]<- "RIF"
LD_control_18B$Dose_relative="Low dose"
#
HD_control_18B=merge(HD_18B_All_rad, Control_18B_meta_use, by=c("Sample_ID", "Duplicate", "Run_set", "Timepoint", "Radiation_type") )
colnames(HD_control_18B)[colnames(HD_control_18B)=="avg_nfoci_high_dose"]<- "RIF"
HD_control_18B$Dose_relative="High dose"
#
Cont_18B_All_rad$RIF = Cont_18B_All_rad$avg_nfoci_0
Cont_18B_All_rad$Dose_relative = "0 Gy control"

LD_HD_18B=bind_rows(LD_control_18B, HD_control_18B, Cont_18B_All_rad)



#19A was used as reference: data were not modified. We format the table to fit the same structure as 18B
Samp_19A_allp_LD = Samp_19A_allp
Samp_19A_allp_LD$avg_nfoci_high_dose = NULL
Samp_19A_allp_LD$nfoci_high_dose_norm=NULL
Samp_19A_allp_LD$nfoci_low_dose_norm=NULL
colnames(Samp_19A_allp_LD)[colnames(Samp_19A_allp_LD)=="avg_nfoci_low_dose"]<- "RIF"
Samp_19A_allp_LD$Dose_relative="Low dose"

Samp_19A_allp_HD = Samp_19A_allp
Samp_19A_allp_HD$avg_nfoci_low_dose = NULL
Samp_19A_allp_HD$nfoci_high_dose_norm=NULL
Samp_19A_allp_HD$nfoci_low_dose_norm=NULL
colnames(Samp_19A_allp_HD)[colnames(Samp_19A_allp_HD)=="avg_nfoci_high_dose"]<- "RIF"
Samp_19A_allp_HD$Dose_relative="High dose"


Samp_19A_allp_cont = Samp_19A_allp
Samp_19A_allp_cont$avg_nfoci_low_dose = NULL
Samp_19A_allp_cont$avg_nfoci_high_dose = NULL
Samp_19A_allp_cont$nfoci_high_dose_norm=NULL
Samp_19A_allp_cont$nfoci_low_dose_norm=NULL
Samp_19A_allp_cont$RIF = Samp_19A_allp_cont$avg_nfoci_0
Samp_19A_allp_cont$Dose_relative="0 Gy control"


Samp_plot_19A_allp= bind_rows(Samp_19A_allp_LD, Samp_19A_allp_HD, Samp_19A_allp_cont)

################### regroup 18B and 19A 
All_18B_19A = bind_rows(LD_HD_18B, Samp_plot_19A_allp)
```

```{r}
#Corrected_step_1_and_2_HT = All_18B_19A
Corrected_step_1_and_2_CD7 = All_18B_19A

```


```{r}
####### Comparison CD7 VS HT

### After step 1 
# Reformate HT
Corrected_DNA_Damage_HT = Corrected_DNA_Damage_HT %>% filter(Corrected_DNA_Damage_HT$Plate %in% gamma_plate_nums_18B_HT)
Corrected_DNA_Damage_HT_C = Corrected_DNA_Damage_HT[,grepl("Sample_ID|avg_nfoci_0|Plate",colnames(Corrected_DNA_Damage_HT))]
colnames(Corrected_DNA_Damage_HT_C)[colnames(Corrected_DNA_Damage_HT_C) == "avg_nfoci_0"] = "avg_nfoci_HT"
Corrected_DNA_Damage_HT_LD = Corrected_DNA_Damage_HT[,grepl("Sample_ID|avg_nfoci_low|Plate",colnames(Corrected_DNA_Damage_HT))]
colnames(Corrected_DNA_Damage_HT_LD)[colnames(Corrected_DNA_Damage_HT_LD) == "avg_nfoci_low_dose"] = "avg_nfoci_HT"
Corrected_DNA_Damage_HT_HD= Corrected_DNA_Damage_HT[,grepl("Sample_ID|avg_nfoci_high|Plate",colnames(Corrected_DNA_Damage_HT))]
colnames(Corrected_DNA_Damage_HT_HD)[colnames(Corrected_DNA_Damage_HT_HD) == "avg_nfoci_high_dose"] = "avg_nfoci_HT"
#
DD_HT = unique(NaRV.omit(bind_rows(Corrected_DNA_Damage_HT_C, Corrected_DNA_Damage_HT_LD, Corrected_DNA_Damage_HT_HD)))

# Reformate CD7
Corrected_DNA_Damage_CD7 = Corrected_DNA_Damage_CD7 %>% filter(Corrected_DNA_Damage_CD7$Plate %in% gamma_plate_nums_18B_CD7)
Corrected_DNA_Damage_CD7_C = Corrected_DNA_Damage_CD7[,grepl("Sample_ID|avg_nfoci_0|Plate",colnames(Corrected_DNA_Damage_CD7))]
colnames(Corrected_DNA_Damage_CD7_C)[colnames(Corrected_DNA_Damage_CD7_C) == "avg_nfoci_0"] = "avg_nfoci_CD7"
Corrected_DNA_Damage_CD7_LD = Corrected_DNA_Damage_CD7[,grepl("Sample_ID|avg_nfoci_low|Plate",colnames(Corrected_DNA_Damage_CD7))]
colnames(Corrected_DNA_Damage_CD7_LD)[colnames(Corrected_DNA_Damage_CD7_LD) == "avg_nfoci_low_dose"] = "avg_nfoci_CD7"
Corrected_DNA_Damage_CD7_HD= Corrected_DNA_Damage_CD7[,grepl("Sample_ID|avg_nfoci_high|Plate",colnames(Corrected_DNA_Damage_CD7))]
colnames(Corrected_DNA_Damage_CD7_HD)[colnames(Corrected_DNA_Damage_CD7_HD) == "avg_nfoci_high_dose"] = "avg_nfoci_CD7"
#
DD_CD7 = unique(NaRV.omit(bind_rows(Corrected_DNA_Damage_CD7_C, Corrected_DNA_Damage_CD7_LD, Corrected_DNA_Damage_CD7_HD)))
#
Corrected_DNA_Damage_HT_CD7 = merge(DD_CD7, DD_HT,by="Sample_ID")


Graph_CD7_vs_HT_correction_step_1 <- ggplot(Corrected_DNA_Damage_HT_CD7, aes(x=avg_nfoci_HT, y=avg_nfoci_CD7)) + geom_point()
Graph_CD7_vs_HT_correction_step_1
ggsave("Step_1_correction_CD7_vs_HT",Graph_CD7_vs_HT_correction_step_1 )


### After step 1 and 2
Corrected_step_2_HT = Corrected_step_1_and_2_HT[,grepl("Sample_ID|RIF|Plate.x",colnames(Corrected_step_1_and_2_HT))]
colnames(Corrected_step_2_HT)[colnames(Corrected_step_2_HT) == "RIF"] = "avg_nfoci_HT"

Corrected_step_2_CD7 = Corrected_step_1_and_2_CD7[,grepl("Sample_ID|RIF|Plate",colnames(Corrected_step_1_and_2_CD7))]
colnames(Corrected_step_2_CD7)[colnames(Corrected_step_2_CD7) == "RIF"] = "avg_nfoci_CD7"

Corrected_step_1_and_2_HT_CD7 = merge(Corrected_step_2_HT, Corrected_step_2_CD7, by="Sample_ID")

Graph_CD7_vs_HT_correction_step_1_and_2 <- ggplot(Corrected_step_1_and_2_HT_CD7, aes(x=avg_nfoci_HT, y=avg_nfoci_CD7)) + geom_point()
Graph_CD7_vs_HT_correction_step_1_and_2

ggsave("Step_1_and_2_correction_CD7_vs_HT",Graph_CD7_vs_HT_correction_step_1_and_2)



```


