---
title: "Baseline_correction"
author: "Margaux P."
date: "15/04/2020"
---

```{r}
library(devtools)
library(ggbiplot)
require('lattice')
require('ggplot2')
require('corrplot')
require('plyr')
require('stringr')
require('rlist')
library(IDPmisc)
library(corpcor)
library('sva')
library(dplyr)
library(RColorBrewer)
library(knitr)
```

```{r}
setwd(getwd())
baseline <- read.csv('Baseline_with_metadata.csv', header = TRUE, sep = ";", quote = "\"", dec = ".")
baseline$CMV=NULL
baseline=NaRV.omit(baseline)


## each plate is associate with its duplicate number 
plate_metadata <- read.csv('Baseline_plate_metadata.csv', header = TRUE, sep = ";", quote = "\"", dec = ".")
baseline=merge(baseline, plate_metadata, by.x='Plate' , by.y='Plate_number')

```

```{r}
## we split data depending on duplicates A and B 

## If experiment performed in triplicates, need to create an additionnal table "Baseline_C"

Baseline_A=baseline
Baseline_B=baseline

Baseline_A$Duplicates[Baseline_A$Duplicates== 'B'] <- NA
Baseline_B$Duplicates[Baseline_B$Duplicates== 'A'] <- NA

Baseline_A=NaRV.omit(Baseline_A)
Baseline_B=NaRV.omit(Baseline_B)

```

```{r}
## Duplicates A
Baseline_metadata_save_A=Baseline_A[ , grepl( "Sample_ID|date|BMI_group|Plate" , names(Baseline_A) ) ]
Baseline_A$BMI_group=NULL
Baseline_metadata_A=Baseline_A[ , grepl( "Sample_ID|BMI|Plate" , names(Baseline_A) ) ]


#create argument for ComBat for duplicates A
edata <-Baseline_A[ , grepl( "avg_nfoci|avg_foci" , names(Baseline_A) ) ]
edata=NaRV.omit(edata)
edata=t(edata)
pheno= Baseline_A[ , grepl( "Age|Gender|BMI" , names(Baseline_A) ) ]
Batch_baseline= Baseline_A$date

modcombat = model.matrix(~1, data=pheno) 
combat_edata = ComBat(edata, batch=Batch_baseline, mod=modcombat)
combat_edata_t=t(combat_edata)
combat_edata_t=data.frame(combat_edata_t)

pheno_sample_id= cbind(Sample_ID = Baseline_metadata_A$Sample_ID, pheno)
Baseline_corrected_A = cbind(Sample_ID = Baseline_metadata_A$Sample_ID, combat_edata_t)
Baseline_corrected_A = merge (pheno_sample_id, Baseline_corrected_A, by.x ="Sample_ID", by.y ="Sample_ID")
Baseline_corrected_A = merge (Baseline_metadata_save_A, Baseline_corrected_A, by.x ="Sample_ID", by.y ="Sample_ID")

## Duplicates B
Baseline_metadata_save_B=Baseline_B[ , grepl( "Sample_ID|date|BMI_group|Plate" , names(Baseline_B) ) ]
Baseline_B$BMI_group=NULL
Baseline_metadata_B=Baseline_B[ , grepl( "Sample_ID|BMI|Plate" , names(Baseline_B) ) ]

#create argument for ComBat for duplicates B
edata <-Baseline_B[ , grepl( "avg_nfoci|avg_foci" , names(Baseline_B) ) ]
edata=NaRV.omit(edata)
edata=t(edata)
pheno= Baseline_B[ , grepl( "Age|Gender|BMI" , names(Baseline_B) ) ]
Batch_baseline= Baseline_B$date

modcombat = model.matrix(~1, data=pheno) 
combat_edata = ComBat(edata, batch=Batch_baseline, mod=modcombat)
combat_edata_t=t(combat_edata)
combat_edata_t=data.frame(combat_edata_t)

pheno_sample_id= cbind(Sample_ID = Baseline_metadata_B$Sample_ID, pheno)
Baseline_corrected_B = cbind(Sample_ID = Baseline_metadata_B$Sample_ID, combat_edata_t)
Baseline_corrected_B = merge (pheno_sample_id, Baseline_corrected_B, by.x ="Sample_ID", by.y ="Sample_ID")
Baseline_corrected_B = merge (Baseline_metadata_save_B, Baseline_corrected_B, by.x ="Sample_ID", by.y ="Sample_ID")

```

```{r}
# we save as a csv file the corrected baseline  for duplicate A and B & the metadata associated in the same file 
Baseline_Corrected=bind_rows(Baseline_corrected_A, Baseline_corrected_B)
write.csv(Baseline_Corrected, "Baseline_with_Correction.csv")
```

