---
title: "Batch Effect Correction and Full Analysis"
output: html_notebook
---


```{r}
require('lattice')
require('ggplot2')
require('polynom')
##require('ggpubr')
require('plyr')
require('reshape2')
##require('cowplot')
require('stringr')
##require('ggforce')
require('dplyr')
#install.packages('proj4')
library('proj4')
require('ggalt')
library(IDPmisc)
library(plotly)
require('sva')
library(devtools)
#install_github("vqv/ggbiplot")
library(ggbiplot)
require('rlist')
require('gridExtra')
library(readxl)
#install.packages("here")
library(here)
```

```{r}
setwd(getwd())

theme_set(theme_bw(base_size = 12)) ## For prettier graphs
theme_update(plot.title = element_text(hjust = 0.5))

### dose en Gy
low_dose_Fe = 0.3 
low_dose_Ar = 0.18 
low_dose_Si = 0.11 
low_dose_Gamma = 0.1

high_dose_Fe = 0.82 
high_dose_Ar = 0.5 
high_dose_Si = 0.29 
high_dose_Gamma = 1
```

```{r}
##################################################################################################
##################################################################################################
############################## Finsam's ComBat modified Function #################################
##################################################################################################
##################################################################################################

sva.class2Model <- function(classes) {
  return(model.matrix(~factor(classes)))
}


modefunc <- function(x) {
  return(as.numeric(names(sort(-table(x)))[1]))
}

mono <- function(lfdr){
  .Call("monotone", as.numeric(lfdr), PACKAGE="sva")
}

edge.lfdr <- function(p, trunc=TRUE, monotone=TRUE, transf=c("probit", "logit"), adj=1.5, eps=10^-8, lambda=0.8, ...) {
  pi0 <- mean(p >= lambda)/(1 - lambda)
  pi0 <- min(pi0, 1)
  
  n <- length(p)
  transf <- match.arg(transf)
  
  if(transf=="probit") {
    p <- pmax(p, eps)
    p <- pmin(p, 1-eps)
    x <- qnorm(p)
    myd <- density(x, adjust=adj)
    mys <- smooth.spline(x=myd$x, y=myd$y)
    y <- predict(mys, x)$y
    lfdr <- pi0*dnorm(x)/y
  }
  
  if(transf=="logit") {
    x <- log((p+eps)/(1-p+eps))
    myd <- density(x, adjust=adj)
    mys <- smooth.spline(x=myd$x, y=myd$y)
    y <- predict(mys, x)$y
    dx <- exp(x) / (1+exp(x))^2
    lfdr <- pi0 * dx/y
  }
  
  if(trunc) {
    lfdr[lfdr > 1] <- 1
  }
  if(monotone) {	
    lfdr <- lfdr[order(p)]
    lfdr <- mono(lfdr)
    lfdr <- lfdr[rank(p)]
  }
  
  return(lfdr)
}



# Trims the data of extra columns, note your array names cannot be named 'X' or start with 'X.'
trim.dat <- function(dat){
  tmp <- strsplit(colnames(dat),'\\.')
  tr <- NULL
  for (i in 1:length(tmp)) {
    tr <- c(tr, tmp[[i]][1] != 'X')
  }
  tr
}

# Following four find empirical hyper-prior values
aprior <- function(gamma.hat) {
  m <- mean(gamma.hat)
  s2 <- var(gamma.hat)
  (2*s2 + m^2) / s2
}

bprior <- function(gamma.hat){
  m <- mean(gamma.hat)
  s2 <- var(gamma.hat)
  (m*s2 + m^3) / s2
}

postmean <- function(g.hat,g.bar,n,d.star,t2){
  (t2*n*g.hat + d.star*g.bar) / (t2*n + d.star)
}

postvar <- function(sum2,n,a,b){
  (.5*sum2 + b) / (n/2 + a - 1)
}

# Inverse gamma distribution density function. (Note: does not do any bounds checking on arguments)
dinvgamma <- function (x, shape, rate = 1/scale, scale = 1) {
  # PDF taken from https://en.wikipedia.org/wiki/Inverse-gamma_distribution
  # Note: alpha = shape, beta = rate
  stopifnot(shape > 0)
  stopifnot(rate > 0)
  ifelse(x <= 0, 0, ((rate ^ shape) / gamma(shape)) * x ^ (-shape - 1) * exp(-rate/x))
}

# Pass in entire data set, the design matrix for the entire data, the batch means, the batch variances, priors (m, t2, a, b), columns of the data  matrix for the batch. Uses the EM to find the parametric batch adjustments

it.sol  <- function(sdat,g.hat,d.hat,g.bar,t2,a,b,conv=.0001){
  n <- rowSums(!is.na(sdat))
  g.old <- g.hat
  d.old <- d.hat
  change <- 1
  count <- 0
  while(change>conv){
    g.new <- postmean(g.hat, g.bar, n, d.old, t2)
    sum2 <- rowSums((sdat - g.new %*% t(rep(1,ncol(sdat))))^2, na.rm=TRUE)
    d.new <- postvar(sum2, n, a, b)
    change <- max(abs(g.new-g.old) / g.old, abs(d.new-d.old) / d.old)
    g.old <- g.new
    d.old <- d.new
    count <- count+1
  }
  ## cat("This batch took", count, "iterations until convergence\n")
  adjust <- rbind(g.new, d.new)
  rownames(adjust) <- c("g.star","d.star")
  adjust
}

## likelihood function used below
L <- function(x,g.hat,d.hat){
  prod(dnorm(x, g.hat, sqrt(d.hat)))
}

## Monte Carlo integration functions
int.eprior <- function(sdat, g.hat, d.hat){
  g.star <- d.star <- NULL
  r <- nrow(sdat)
  for(i in 1:r){
    g <- g.hat[-i]
    d <- d.hat[-i]		
    x <- sdat[i,!is.na(sdat[i,])]
    n <- length(x)
    j <- numeric(n)+1
    dat <- matrix(as.numeric(x), length(g), n, byrow=TRUE)
    resid2 <- (dat-g)^2
    sum2 <- resid2 %*% j
    LH <- 1/(2*pi*d)^(n/2)*exp(-sum2/(2*d))
    LH[LH=="NaN"]=0
    g.star <- c(g.star, sum(g*LH)/sum(LH))
    d.star <- c(d.star, sum(d*LH)/sum(LH))
    ## if(i%%1000==0){cat(i,'\n')}
  }
  adjust <- rbind(g.star,d.star)
  rownames(adjust) <- c("g.star","d.star")
  adjust	
} 

## fits the L/S model in the presence of missing data values

Beta.NA <- function(y,X){
  des <- X[!is.na(y),]
  y1 <- y[!is.na(y)]
  B <- solve(crossprod(des), crossprod(des, y1))
  B
}

################################################################################################
################################################################################################
################################################################################################

ComBat_save <- function(dat, batch, mod = NULL, par.prior = TRUE, prior.plots = FALSE,
                   mean.only = FALSE, ref.batch = NULL, BPPARAM = bpparam("SerialParam")) {
  if(length(dim(batch))>1){
    stop("This version of ComBat only allows one batch variable")
  }  ## to be updated soon!  
  
  ## coerce dat into a matrix
  dat <- as.matrix(dat)
  
  ## find genes with zero variance in any of the batches
  batch <- as.factor(batch)
  zero.rows.lst <- lapply(levels(batch), function(batch_level){
    if(sum(batch==batch_level)>1){
      return(which(apply(dat[, batch==batch_level], 1, function(x){var(x)==0})))
    }else{
      return(which(rep(1,3)==2))
    }
  })
  zero.rows <- Reduce(union, zero.rows.lst)
  keep.rows <- setdiff(1:nrow(dat), zero.rows)
  
  if (length(zero.rows) > 0) {
    cat(sprintf("Found %d genes with uniform expression within a single batch (all zeros); these will not be adjusted for batch.\n", length(zero.rows)))
    # keep a copy of the original data matrix and remove zero var rows
    dat.orig <- dat
    dat <- dat[keep.rows, ]
  }
  
  ## make batch a factor and make a set of indicators for batch
  if(any(table(batch)==1)){mean.only=TRUE}
  if(mean.only==TRUE){
    message("Using the 'mean only' version of ComBat")
  }
  
  batchmod <- model.matrix(~-1+batch)  
  if (!is.null(ref.batch)){
    ## check for reference batch, check value, and make appropriate changes
    if (!(ref.batch%in%levels(batch))) {
      stop("reference level ref.batch is not one of the levels of the batch variable")
    }
    message("Using batch =",ref.batch, "as a reference batch (this batch won't change)")
    ref <- which(levels(as.factor(batch))==ref.batch) # find the reference
    batchmod[,ref] <- 1
  } else {
    ref <- NULL
  }
  message("Found", nlevels(batch), "batches")
  
  ## A few other characteristics on the batches
  n.batch <- nlevels(batch)
  batches <- list()
  for (i in 1:n.batch) {
    batches[[i]] <- which(batch == levels(batch)[i])
  } # list of samples in each batch  
  n.batches <- sapply(batches, length)
  if(any(n.batches==1)){
    mean.only=TRUE
    message("Note: one batch has only one sample, setting mean.only=TRUE")
  }
  n.array <- sum(n.batches)
  ## combine batch variable and covariates
  design <- cbind(batchmod,mod)
  
  ## check for intercept in covariates, and drop if present
  check <- apply(design, 2, function(x) all(x == 1))
  if(!is.null(ref)){
    check[ref] <- FALSE
  } ## except don't throw away the reference batch indicator
  design <- as.matrix(design[,!check])
  
  ## Number of covariates or covariate levels
  message("Adjusting for", ncol(design)-ncol(batchmod), 'covariate(s) or covariate level(s)')
  
  ## Check if the design is confounded
  if(qr(design)$rank < ncol(design)) {
    ## if(ncol(design)<=(n.batch)){stop("Batch variables are redundant! Remove one or more of the batch variables so they are no longer confounded")}
    if(ncol(design)==(n.batch+1)) {
      stop("The covariate is confounded with batch! Remove the covariate and rerun ComBat")
    }
    if(ncol(design)>(n.batch+1)) {
      if((qr(design[,-c(1:n.batch)])$rank<ncol(design[,-c(1:n.batch)]))){
        stop('The covariates are confounded! Please remove one or more of the covariates so the design is not confounded')
      } else {
        stop("At least one covariate is confounded with batch! Please remove confounded covariates and rerun ComBat")
      }
    }
  }
  
  ## Check for missing values
  NAs <- any(is.na(dat))
  if(NAs){
    message(c('Found',sum(is.na(dat)),'Missing Data Values'), sep=' ')}
  ## print(dat[1:2,])
  
  ##Standardize Data across genes
  message('Standardizing Data across genes')
  if (!NAs){
    B.hat <- solve(crossprod(design), tcrossprod(t(design), as.matrix(dat)))
  } else { 
    B.hat <- apply(dat, 1, Beta.NA, design) # FIXME
  }
  
  ## change grand.mean for ref batch
  if(!is.null(ref.batch)){
    grand.mean <- t(B.hat[ref, ])
  } else {
    grand.mean <- crossprod(n.batches/n.array, B.hat[1:n.batch,])
  }
  
  ## change var.pooled for ref batch
  if (!NAs){
    if(!is.null(ref.batch)) {
      ref.dat <- dat[, batches[[ref]]]
      var.pooled <- ((ref.dat-t(design[batches[[ref]], ] %*% B.hat))^2) %*% rep(1/n.batches[ref],n.batches[ref]) # FIXME
    } else {
      var.pooled <- ((dat-t(design %*% B.hat))^2) %*% rep(1/n.array,n.array) # FIXME
    }
  } else {
    if(!is.null(ref.batch)) {
      ref.dat <- dat[, batches[[ref]]]
      var.pooled <- rowVars(ref.dat-t(design[batches[[ref]], ]%*%B.hat), na.rm=TRUE)
    } else {
      var.pooled <- rowVars(dat-t(design %*% B.hat), na.rm=TRUE)
    }
  }
  
  stand.mean <- t(grand.mean) %*% t(rep(1,n.array)) # FIXME
  if(!is.null(design)){
    tmp <- design
    tmp[,c(1:n.batch)] <- 0
    stand.mean <- stand.mean+t(tmp %*% B.hat) #FIXME
  }  
  s.data <- (dat-stand.mean)/(sqrt(var.pooled) %*% t(rep(1,n.array))) # FIXME
  
  ##Get regression batch effect parameters
  message("Fitting L/S model and finding priors")
  batch.design <- design[, 1:n.batch]
  if (!NAs){
    gamma.hat <- solve(crossprod(batch.design), tcrossprod(t(batch.design),
                                                           as.matrix(s.data)))
  } else{
    gamma.hat <- apply(s.data, 1, Beta.NA, batch.design) # FIXME
  }
  delta.hat <- NULL
  for (i in batches){
    if(mean.only==TRUE) {
      delta.hat <- rbind(delta.hat,rep(1,nrow(s.data))) 
    } else {
      delta.hat <- rbind(delta.hat, rowVars(s.data[,i], na.rm=TRUE))
    }
  }
  
  ##Find Priors
  gamma.bar <- rowMeans(gamma.hat)
  t2 <- rowVars(gamma.hat)
  a.prior <- apply(delta.hat, 1, aprior) # FIXME 
  b.prior <- apply(delta.hat, 1, bprior) # FIXME
  
  ## Plot empirical and parametric priors
  
  if (prior.plots && par.prior) {
    old_pars <- par(no.readonly = TRUE)
    on.exit(par(old_pars))
    par(mfrow=c(2,2))
    
    ## Top left
    tmp <- density(gamma.hat[1,])
    plot(tmp,  type='l', main=expression(paste("Density Plot of First Batch ",  hat(gamma))))
    xx <- seq(min(tmp$x), max(tmp$x), length=100)
    lines(xx,dnorm(xx,gamma.bar[1],sqrt(t2[1])), col=2)
    
    ## Top Right
    qqnorm(gamma.hat[1,], main=expression(paste("Normal Q-Q Plot of First Batch ", hat(gamma))))
    qqline(gamma.hat[1,], col=2)
    
    ## Bottom Left
    tmp <- density(delta.hat[1,])
    xx <- seq(min(tmp$x), max(tmp$x), length=100)
    tmp1 <- list(x=xx, y=dinvgamma(xx, a.prior[1], b.prior[1]))
    plot(tmp, typ="l", ylim=c(0, max(tmp$y, tmp1$y)),
         main=expression(paste("Density Plot of First Batch ", hat(delta))))
    lines(tmp1, col=2)
    
    ## Bottom Right
    invgam <- 1/qgamma(1-ppoints(ncol(delta.hat)), a.prior[1], b.prior[1])
    qqplot(invgam, delta.hat[1,],
           main=expression(paste("Inverse Gamma Q-Q Plot of First Batch ", hat(delta))),
           ylab="Sample Quantiles", xlab="Theoretical Quantiles")
    lines(c(0, max(invgam)), c(0, max(invgam)), col=2)
  }
  
  ## Find EB batch adjustments
  
  gamma.star <- delta.star <- matrix(NA, nrow=n.batch, ncol=nrow(s.data))
  if (par.prior) {
    message("Finding parametric adjustments")
    results <- bplapply(1:n.batch, function(i) {
      if (mean.only) {
        gamma.star <- postmean(gamma.hat[i,], gamma.bar[i], 1, 1, t2[i])
        delta.star <- rep(1, nrow(s.data))
      }
      else {
        temp <- it.sol(s.data[, batches[[i]]], gamma.hat[i, ],
                       delta.hat[i, ], gamma.bar[i], t2[i], a.prior[i],
                       b.prior[i])
        gamma.star <- temp[1, ]
        delta.star <- temp[2, ]
      }
      list(gamma.star=gamma.star, delta.star=delta.star)
    }, BPPARAM = BPPARAM)
    for (i in 1:n.batch) {
      gamma.star[i,] <- results[[i]]$gamma.star
      delta.star[i,] <- results[[i]]$delta.star
    }
  }
  else {
    message("Finding nonparametric adjustments")
    results <- bplapply(1:n.batch, function(i) {
      if (mean.only) {
        delta.hat[i, ] = 1
      }
      temp <- int.eprior(as.matrix(s.data[, batches[[i]]]),
                         gamma.hat[i, ], delta.hat[i, ])
      list(gamma.star=temp[1,], delta.star=temp[2,])
    }, BPPARAM = BPPARAM)
    for (i in 1:n.batch) {
      gamma.star[i,] <- results[[i]]$gamma.star
      delta.star[i,] <- results[[i]]$delta.star
    }
  }
  
  if(!is.null(ref.batch)){
    gamma.star[ref,] <- 0  ## set reference batch mean equal to 0
    delta.star[ref,] <- 1  ## set reference batch variance equal to 1
  }
  
  ## Normalize the Data ###
  message("Adjusting the Data\n")
  
  bayesdata <- s.data
  j <- 1
  for (i in batches){
    ## DEBUG LINES
    samples_umrr <- bayesdata[,i]
    sub_umrr <- t(batch.design[i,]%*%gamma.star)
    ##
    bayesdata[,i] <- (bayesdata[,i]-t(batch.design[i,]%*%gamma.star))/(sqrt(delta.star[j,])%*%t(rep(1,n.batches[j]))) # FIXME
    j <- j+1
  }
  
  bayesdata <- (bayesdata*(sqrt(var.pooled)%*%t(rep(1,n.array))))+stand.mean # FIXME
  
  ## Do not change ref batch at all in reference version
  if(!is.null(ref.batch)){
    bayesdata[, batches[[ref]]] <- dat[, batches[[ref]]]
  }
  
  ## put genes with 0 variance in any batch back in data
  if (length(zero.rows) > 0) {
    dat.orig[keep.rows, ] <- bayesdata
    bayesdata <- dat.orig
  }
  
  ## EXTRACT
  gamma.star.out <- gamma.star
  delta.star.out <- delta.star
  colnames(gamma.star.out) <- rownames(s.data)
  colnames(delta.star.out) <- rownames(s.data)
  combat_save_out <- list("data"=bayesdata, "gamma"=gamma.star.out, "delta"=delta.star.out)
  
  # return(bayesdata)
  return(combat_save_out)
}

ComBat_custom <- function(dat, batch, custom.gamma, custom.delta, mod = NULL, par.prior = TRUE, prior.plots = FALSE,
                        mean.only = FALSE, ref.batch = NULL, BPPARAM = bpparam("SerialParam")) {
  if(length(dim(batch))>1){
    stop("This version of ComBat only allows one batch variable")
  }  ## to be updated soon!  
  
  ## coerce dat into a matrix
  dat <- as.matrix(dat)
  
  ## find genes with zero variance in any of the batches
  batch <- as.factor(batch)
  zero.rows.lst <- lapply(levels(batch), function(batch_level){
    if(sum(batch==batch_level)>1){
      return(which(apply(dat[, batch==batch_level], 1, function(x){var(x)==0})))
    }else{
      return(which(rep(1,3)==2))
    }
  })
  zero.rows <- Reduce(union, zero.rows.lst)
  keep.rows <- setdiff(1:nrow(dat), zero.rows)
  
  if (length(zero.rows) > 0) {
    cat(sprintf("Found %d genes with uniform expression within a single batch (all zeros); these will not be adjusted for batch.\n", length(zero.rows)))
    # keep a copy of the original data matrix and remove zero var rows
    dat.orig <- dat
    dat <- dat[keep.rows, ]
  }
  
  ## make batch a factor and make a set of indicators for batch
  if(any(table(batch)==1)){mean.only=TRUE}
  if(mean.only==TRUE){
    message("Using the 'mean only' version of ComBat")
  }
  
  batchmod <- model.matrix(~-1+batch)  
  if (!is.null(ref.batch)){
    ## check for reference batch, check value, and make appropriate changes
    if (!(ref.batch%in%levels(batch))) {
      stop("reference level ref.batch is not one of the levels of the batch variable")
    }
    message("Using batch =",ref.batch, "as a reference batch (this batch won't change)")
    ref <- which(levels(as.factor(batch))==ref.batch) # find the reference
    batchmod[,ref] <- 1
  } else {
    ref <- NULL
  }
  message("Found", nlevels(batch), "batches")
  
  ## A few other characteristics on the batches
  n.batch <- nlevels(batch)
  batches <- list()
  for (i in 1:n.batch) {
    batches[[i]] <- which(batch == levels(batch)[i])
  } # list of samples in each batch  
  n.batches <- sapply(batches, length)
  if(any(n.batches==1)){
    mean.only=TRUE
    message("Note: one batch has only one sample, setting mean.only=TRUE")
  }
  n.array <- sum(n.batches)
  ## combine batch variable and covariates
  design <- cbind(batchmod,mod)
  
  ## check for intercept in covariates, and drop if present
  check <- apply(design, 2, function(x) all(x == 1))
  if(!is.null(ref)){
    check[ref] <- FALSE
  } ## except don't throw away the reference batch indicator
  design <- as.matrix(design[,!check])
  
  ## Number of covariates or covariate levels
  message("Adjusting for", ncol(design)-ncol(batchmod), 'covariate(s) or covariate level(s)')
  
  ## Check if the design is confounded
  if(qr(design)$rank < ncol(design)) {
    ## if(ncol(design)<=(n.batch)){stop("Batch variables are redundant! Remove one or more of the batch variables so they are no longer confounded")}
    if(ncol(design)==(n.batch+1)) {
      stop("The covariate is confounded with batch! Remove the covariate and rerun ComBat")
    }
    if(ncol(design)>(n.batch+1)) {
      if((qr(design[,-c(1:n.batch)])$rank<ncol(design[,-c(1:n.batch)]))){
        stop('The covariates are confounded! Please remove one or more of the covariates so the design is not confounded')
      } else {
        stop("At least one covariate is confounded with batch! Please remove confounded covariates and rerun ComBat")
      }
    }
  }
  
  ## Check for missing values
  NAs <- any(is.na(dat))
  if(NAs){
    message(c('Found',sum(is.na(dat)),'Missing Data Values'), sep=' ')}
  ## print(dat[1:2,])
  
  ##Standardize Data across genes
  message('Standardizing Data across genes')
  if (!NAs){
    B.hat <- solve(crossprod(design), tcrossprod(t(design), as.matrix(dat)))
  } else { 
    B.hat <- apply(dat, 1, Beta.NA, design) # FIXME
  }
  
  ## change grand.mean for ref batch
  if(!is.null(ref.batch)){
    grand.mean <- t(B.hat[ref, ])
  } else {
    grand.mean <- crossprod(n.batches/n.array, B.hat[1:n.batch,])
  }
  
  ## change var.pooled for ref batch
  if (!NAs){
    if(!is.null(ref.batch)) {
      ref.dat <- dat[, batches[[ref]]]
      var.pooled <- ((ref.dat-t(design[batches[[ref]], ] %*% B.hat))^2) %*% rep(1/n.batches[ref],n.batches[ref]) # FIXME
    } else {
      var.pooled <- ((dat-t(design %*% B.hat))^2) %*% rep(1/n.array,n.array) # FIXME
    }
  } else {
    if(!is.null(ref.batch)) {
      ref.dat <- dat[, batches[[ref]]]
      var.pooled <- rowVars(ref.dat-t(design[batches[[ref]], ]%*%B.hat), na.rm=TRUE)
    } else {
      var.pooled <- rowVars(dat-t(design %*% B.hat), na.rm=TRUE)
    }
  }
  
  stand.mean <- t(grand.mean) %*% t(rep(1,n.array)) # FIXME
  if(!is.null(design)){
    tmp <- design
    tmp[,c(1:n.batch)] <- 0
    stand.mean <- stand.mean+t(tmp %*% B.hat) #FIXME
  }  
  s.data <- (dat-stand.mean)/(sqrt(var.pooled) %*% t(rep(1,n.array))) # FIXME
  
  ##Get regression batch effect parameters
  message("Fitting L/S model and finding priors")
  batch.design <- design[, 1:n.batch]
  if (!NAs){
    gamma.hat <- solve(crossprod(batch.design), tcrossprod(t(batch.design),
                                                           as.matrix(s.data)))
  } else{
    gamma.hat <- apply(s.data, 1, Beta.NA, batch.design) # FIXME
  }
  delta.hat <- NULL
  for (i in batches){
    if(mean.only==TRUE) {
      delta.hat <- rbind(delta.hat,rep(1,nrow(s.data))) 
    } else {
      delta.hat <- rbind(delta.hat, rowVars(s.data[,i], na.rm=TRUE))
    }
  }
  
  ##Find Priors
  gamma.bar <- rowMeans(gamma.hat)
  t2 <- rowVars(gamma.hat)
  a.prior <- apply(delta.hat, 1, aprior) # FIXME 
  b.prior <- apply(delta.hat, 1, bprior) # FIXME
  
  ## Plot empirical and parametric priors
  if (prior.plots && par.prior) {
    old_pars <- par(no.readonly = TRUE)
    on.exit(par(old_pars))
    par(mfrow=c(2,2))
    
    ## Top left
    tmp <- density(gamma.hat[1,])
    plot(tmp,  type='l', main=expression(paste("Density Plot of First Batch ",  hat(gamma))))
    xx <- seq(min(tmp$x), max(tmp$x), length=100)
    lines(xx,dnorm(xx,gamma.bar[1],sqrt(t2[1])), col=2)
    
    ## Top Right
    qqnorm(gamma.hat[1,], main=expression(paste("Normal Q-Q Plot of First Batch ", hat(gamma))))
    qqline(gamma.hat[1,], col=2)
    
    ## Bottom Left
    tmp <- density(delta.hat[1,])
    xx <- seq(min(tmp$x), max(tmp$x), length=100)
    tmp1 <- list(x=xx, y=dinvgamma(xx, a.prior[1], b.prior[1]))
    plot(tmp, typ="l", ylim=c(0, max(tmp$y, tmp1$y)),
         main=expression(paste("Density Plot of First Batch ", hat(delta))))
    lines(tmp1, col=2)
    
    ## Bottom Right
    invgam <- 1/qgamma(1-ppoints(ncol(delta.hat)), a.prior[1], b.prior[1])
    qqplot(invgam, delta.hat[1,],
           main=expression(paste("Inverse Gamma Q-Q Plot of First Batch ", hat(delta))),
           ylab="Sample Quantiles", xlab="Theoretical Quantiles")
    lines(c(0, max(invgam)), c(0, max(invgam)), col=2)
  }
  
  ## Find EB batch adjustments
  gamma.star <- delta.star <- matrix(NA, nrow=n.batch, ncol=nrow(s.data))
  if (par.prior) {
    message("Finding parametric adjustments")
    results <- bplapply(1:n.batch, function(i) {
      if (mean.only) {
        gamma.star <- postmean(gamma.hat[i,], gamma.bar[i], 1, 1, t2[i])
        delta.star <- rep(1, nrow(s.data))
      }
      else {
        temp <- it.sol(s.data[, batches[[i]]], gamma.hat[i, ],
                       delta.hat[i, ], gamma.bar[i], t2[i], a.prior[i],
                       b.prior[i])
        gamma.star <- temp[1, ]
        delta.star <- temp[2, ]
      }
      list(gamma.star=gamma.star, delta.star=delta.star)
    }, BPPARAM = BPPARAM)
    for (i in 1:n.batch) {
      gamma.star[i,] <- results[[i]]$gamma.star
      delta.star[i,] <- results[[i]]$delta.star
    }
  }
  else {
    message("Finding nonparametric adjustments")
    results <- bplapply(1:n.batch, function(i) {
      if (mean.only) {
        delta.hat[i, ] = 1
      }
      temp <- int.eprior(as.matrix(s.data[, batches[[i]]]),
                         gamma.hat[i, ], delta.hat[i, ])
      list(gamma.star=temp[1,], delta.star=temp[2,])
    }, BPPARAM = BPPARAM)
    for (i in 1:n.batch) {
      gamma.star[i,] <- results[[i]]$gamma.star
      delta.star[i,] <- results[[i]]$delta.star
    }
  }
  
  if(!is.null(ref.batch)){
    gamma.star[ref,] <- 0  ## set reference batch mean equal to 0
    delta.star[ref,] <- 1  ## set reference batch variance equal to 1
  }
  
  ## Normalize the Data ###
  message("Adjusting the Data\n")
  
  bayesdata <- s.data
  
  
  ## CREATE BLANKS
  ## gamma is additive, delta is multiplicative
  gamma.star.blank <- gamma.star
  colnames(gamma.star.blank) <- rownames(s.data)
  gamma.star.blank[] <- 0
  delta.star.blank <- delta.star
  colnames(delta.star.blank) <- rownames(s.data)
  delta.star.blank[] <- 1
  
  ## Replace matching columns
  # Select indices, omit nans
  gamma_indices1_with_nan <- match(colnames(custom.gamma), colnames(gamma.star.blank))
  gamma_indices1 <- na.omit(gamma_indices1_with_nan)
  gamma_indices2_with_nan <- match(colnames(gamma.star.blank), colnames(custom.gamma)) # GETS NEEDED INDICES TO INDEX FROM CUSTOM
  gamma_indices2 <- na.omit(gamma_indices2_with_nan)
  
  delta_indices1_with_nan <- match(colnames(custom.delta), colnames(delta.star.blank))
  delta_indices1 <- na.omit(delta_indices1_with_nan)
  delta_indices2_with_nan <- match(colnames(delta.star.blank), colnames(custom.delta)) # GETS NEEDED INDICES TO INDEX FROM CUSTOM
  delta_indices2 <- na.omit(delta_indices2_with_nan)
  
  # Replace
  gamma.star.blank[,gamma_indices1] <- custom.gamma[,gamma_indices2]
  delta.star.blank[,delta_indices1] <- custom.delta[,delta_indices2]
  
  j <- 1
  for (i in batches){
    ## DEBUG LINES
    #samples_run <- bayesdata[,i]
    #sub_run <- t(batch.design[i,]%*%gamma.star)
    ##
    bayesdata[,i] <- (bayesdata[,i]-t(batch.design[i,]%*%gamma.star.blank))/(sqrt(delta.star.blank[j,])%*%t(rep(1,n.batches[j]))) # FIXME
    j <- j+1
  }
  
  bayesdata <- (bayesdata*(sqrt(var.pooled)%*%t(rep(1,n.array))))+stand.mean # FIXME
  
  ## Do not change ref batch at all in reference version
  if(!is.null(ref.batch)){
    bayesdata[, batches[[ref]]] <- dat[, batches[[ref]]]
  }
  
  ## put genes with 0 variance in any batch back in data
  if (length(zero.rows) > 0) {
    dat.orig[keep.rows, ] <- bayesdata
    bayesdata <- dat.orig
  }
  
  # combat_save_out <- list("data"=bayesdata, "gamma"=gamma.star, "delta"=delta.star)
  
  return(bayesdata)
  # return(combat_save_out)
}

```



```{r}

#### OLD CORRECTION: 1) correction between runs and sets and 2) correction between radiation type within each run and set. 
## The new correction using z-score is detailed in the following chunk

# ##################################################################################################
# ################################ Read RIF DATA + Correction ######################################
# ##################################################################################################
# 
# 
# #### Read DNA damage data BNL19A
# gamma_plate_nums_19A = c(433, 435, 437, 439, 441, 444, 445, 447, 449, 451, 453, 455, 457, 459, 461, 463, 465, 467, 469, 471, 473, 475, 477,479)
# gamma_plate_count_19A = length(gamma_plate_nums_19A)
# ar_plate_nums_19A = c(481, 483, 485, 487, 489, 491, 493, 495, 497, 499, 501, 503, 505, 507, 509, 511, 513, 515, 517, 519, 521, 523, 525,527)
# ar_plate_count_19A = length(ar_plate_nums_19A)
# si_plate_nums_19A = c(577, 579, 581, 583, 585, 587, 589, 591, 593, 595, 597, 599, 601, 603, 605,607, 609, 611, 613,615, 617, 619, 621, 623)
# si_plate_count_19A = length(si_plate_nums_19A)
# fe_plate_nums_19A = c(529, 531, 533, 535, 537, 539, 541, 543, 545, 547, 549, 551, 553, 555, 557, 559, 561, 563, 565, 567, 569, 571, 573,575)
# fe_plate_count_19A = length(fe_plate_nums_19A)
# gamma_si_fe_ar_plate_nums_19A = c(gamma_plate_nums_19A, si_plate_nums_19A, fe_plate_nums_19A, ar_plate_nums_19A)
# gamma_si_fe_ar_plate_count_19A = length(gamma_si_fe_ar_plate_nums_19A)
# 
# 
# #### Read first file
# foci_gamma_first_19A = data.frame(Plate = gamma_plate_nums_19A[1], Plate_well = paste(gamma_plate_nums_19A[1], read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", gamma_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", gamma_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE))
# 
# gamma_table_19A=foci_gamma_first_19A
# 
# foci_si_first_19A = data.frame(Plate = si_plate_nums_19A[1], Plate_well = paste(si_plate_nums_19A[1], read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", si_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", si_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE))
# 
# si_table_19A=foci_si_first_19A
# 
# foci_ar_first_19A = data.frame(Plate = ar_plate_nums_19A[1], Plate_well = paste(ar_plate_nums_19A[1], read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", ar_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", ar_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE))
# 
# ar_table_19A=foci_ar_first_19A
# 
# foci_fe_first_19A = data.frame(Plate = fe_plate_nums_19A[1], Plate_well = paste(fe_plate_nums_19A[1], read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", fe_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", fe_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE))
# 
# fe_table_19A=foci_fe_first_19A
# 
# 
# #### Read all the other files and combine them into a single giant file with ALL the plates and ALL the wells
# for(ii in 2:gamma_plate_count_19A){
#   temp_gamma_filename = paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', gamma_plate_nums_19A[ii],'.txt', sep="")
#   temp_gamma_table = data.frame(Plate = gamma_plate_nums_19A[ii], Plate_well = paste(gamma_plate_nums_19A[ii], read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', gamma_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', gamma_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE))
#   gamma_table_19A = rbind(gamma_table_19A, temp_gamma_table)
# }
# 
# for(ii in 2:si_plate_count_19A){
#   temp_si_filename = paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', si_plate_nums_19A[ii],'.txt', sep="")
#   temp_si_table = data.frame(Plate = si_plate_nums_19A[ii], Plate_well = paste(si_plate_nums_19A[ii], read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', si_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', si_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE))
#   si_table_19A = rbind(si_table_19A, temp_si_table)
# }
# 
# for(ii in 2:ar_plate_count_19A){
#   temp_ar_filename = paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', ar_plate_nums_19A[ii],'.txt', sep="")
#   temp_ar_table = data.frame(Plate = ar_plate_nums_19A[ii], Plate_well = paste(ar_plate_nums_19A[ii], read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', ar_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', ar_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE))
#   ar_table_19A = rbind(ar_table_19A, temp_ar_table)
#   }
# 
# for(ii in 2:fe_plate_count_19A){
#   temp_fe_filename = paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', fe_plate_nums_19A[ii],'.txt', sep="")
#   temp_fe_table = data.frame(Plate = fe_plate_nums_19A[ii], Plate_well = paste(fe_plate_nums_19A[ii], read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', fe_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', fe_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE))
#   fe_table_19A = rbind(fe_table_19A, temp_fe_table)
#   }
# 
# 
# #### Read DNA damage data BNL18B
# ar_plate_nums_18B = c(381,382,383,386,387,390,391,394,395,396,399,400,402)
# ar_plate_count_18B = length(ar_plate_nums_18B)
# si_plate_nums_18B = c(333,337,341,345,349,353)  
# si_plate_count_18B = length(si_plate_nums_18B)
# fe_plate_nums_18B = c(355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,372,373,374,375,376,377,378)
# fe_plate_count_18B = length(fe_plate_nums_18B)
# fe_ar_plate_nums_18B = c(fe_plate_nums_18B, ar_plate_nums_18B)
# fe_ar_plate_count_18B = length(fe_ar_plate_nums_18B)
# 
# #### Read first file
# foci_ar_first_18B = data.frame(Plate = ar_plate_nums_18B[1], Plate_well = paste(ar_plate_nums_18B[1], read.table(paste("BNL18B-ProcessedFile/Ar-BNL_18B-reimaged/average_well_P", ar_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("BNL18B-ProcessedFile/Ar-BNL_18B-reimaged/average_well_P", ar_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE))
# 
# ar_table_18B=foci_ar_first_18B
# 
# foci_si_first_18B = data.frame(Plate = si_plate_nums_18B[1], Plate_well = paste(si_plate_nums_18B[1], read.table(paste("BNL18B-ProcessedFile/Si-BNL_18B-reimaged/average_well_P", si_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("BNL18B-ProcessedFile/Si-BNL_18B-reimaged/average_well_P", si_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE))
# 
# si_table_18B=foci_si_first_18B
# 
# foci_fe_first_18B = data.frame(Plate = fe_plate_nums_18B[1], Plate_well = paste(fe_plate_nums_18B[1], read.table(paste("BNL18B-ProcessedFile/Fe-BNL_18B-reprocessed/average_well_P", fe_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("BNL18B-ProcessedFile/Fe-BNL_18B-reprocessed/average_well_P", fe_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE))
# 
# fe_table_18B=foci_fe_first_18B
# 
# #### Read all the other files and combine them into a single giant file with ALL the plates and ALL the wells
# for(ii in 2:ar_plate_count_18B){
#   temp_ar_filename = paste('BNL18B-ProcessedFile/Ar-BNL_18B-reimaged/average_well_P', ar_plate_nums_18B[ii],'.txt', sep="")
#   temp_ar_table = data.frame(Plate = ar_plate_nums_18B[ii], Plate_well = paste(ar_plate_nums_18B[ii], read.table(paste('BNL18B-ProcessedFile/Ar-BNL_18B-reimaged/average_well_P', ar_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('BNL18B-ProcessedFile/Ar-BNL_18B-reimaged/average_well_P', ar_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE))
#   ar_table_18B = rbind(ar_table_18B, temp_ar_table)
#   }
# 
# for(ii in 2:si_plate_count_18B){
#   temp_si_filename = paste('BNL18B-ProcessedFile/Si-BNL_18B-reimaged/average_well_P', si_plate_nums_18B[ii],'.txt', sep="")
#   temp_si_table = data.frame(Plate = si_plate_nums_18B[ii], Plate_well = paste(si_plate_nums_18B[ii], read.table(paste('BNL18B-ProcessedFile/Si-BNL_18B-reimaged/average_well_P', si_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('BNL18B-ProcessedFile/Si-BNL_18B-reimaged/average_well_P', si_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE))
#   si_table_18B = rbind(si_table_18B, temp_si_table)
#   }
# 
# for(ii in 2:fe_plate_count_18B){
#   temp_fe_filename = paste('BNL18B-ProcessedFile/Fe-BNL_18B-reprocessed/average_well_P', fe_plate_nums_18B[ii],'.txt', sep="")
#   temp_fe_table = data.frame(Plate = fe_plate_nums_18B[ii], Plate_well = paste(fe_plate_nums_18B[ii], read.table(paste('BNL18B-ProcessedFile/Fe-BNL_18B-reprocessed/average_well_P', fe_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('BNL18B-ProcessedFile/Fe-BNL_18B-reprocessed/average_well_P', fe_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE))
#   fe_table_18B = rbind(fe_table_18B, temp_fe_table)
#   }
# 
# #### We combine 18B and 19A data
# ar_table = rbind(ar_table_18B, ar_table_19A)
# fe_table = rbind(fe_table_18B, fe_table_19A)
# si_table = rbind(si_table_18B, si_table_19A)
# gamma_table = gamma_table_19A
# 
# 
# #### add duplicate info
# Plate_Duplicate <- read.csv('Plate_Duplicate.csv', header = TRUE, sep = ";", quote = "\"", dec = ".")
# Plate_Duplicate$Run=NULL
# ar_table=merge(ar_table, Plate_Duplicate, by.x="Plate", by.y="Plate_number", all.x = TRUE)
# fe_table=merge(fe_table, Plate_Duplicate, by.x="Plate", by.y="Plate_number", all.x = TRUE)
# si_table=merge(si_table, Plate_Duplicate, by.x="Plate", by.y="Plate_number", all.x = TRUE)
# gamma_table=merge(gamma_table, Plate_Duplicate, by.x="Plate", by.y="Plate_number", all.x = TRUE)
# 
# 
# 
# #### Now we will add plate metadata
# plate_meta = read.csv('Plate_metadata.csv', sep = ",", header = TRUE)
# fe_table_w_plate_meta = merge(fe_table, plate_meta, by.x = 'Plate', by.y = 'Plate_number', all.x = TRUE, all.y = FALSE)
# ar_table_w_plate_meta = merge(ar_table, plate_meta, by.x = 'Plate', by.y = 'Plate_number', all.x = TRUE, all.y = FALSE)
# si_table_w_plate_meta = merge(si_table, plate_meta, by.x = 'Plate', by.y = 'Plate_number', all.x = TRUE, all.y = FALSE)
# gamma_table_w_plate_meta = merge(gamma_table, plate_meta, by.x = 'Plate', by.y = 'Plate_number', all.x = TRUE, all.y = FALSE)
# 
# ## Wells are different based on sample sets, so we need to make an extra column for Set_Well, and then add well metadata based on it.
# fe_table_w_plate_meta$Run_set_well = paste(fe_table_w_plate_meta$Run, fe_table_w_plate_meta$Sample_sets, fe_table_w_plate_meta$Well, sep = "_")
# ar_table_w_plate_meta$Run_set_well = paste(ar_table_w_plate_meta$Run, ar_table_w_plate_meta$Sample_sets, ar_table_w_plate_meta$Well, sep = "_")
# si_table_w_plate_meta$Run_set_well = paste(si_table_w_plate_meta$Run, si_table_w_plate_meta$Sample_sets, si_table_w_plate_meta$Well, sep = "_")
# gamma_table_w_plate_meta$Run_set_well = paste(gamma_table_w_plate_meta$Run, gamma_table_w_plate_meta$Sample_sets, gamma_table_w_plate_meta$Well, sep = "_")
# 
# ## create column run_set 
# fe_table_w_plate_meta$Run_set = paste(fe_table_w_plate_meta$Run, fe_table_w_plate_meta$Sample_sets, sep = "_")
# ar_table_w_plate_meta$Run_set = paste(ar_table_w_plate_meta$Run, ar_table_w_plate_meta$Sample_sets, sep = "_")
# si_table_w_plate_meta$Run_set = paste(si_table_w_plate_meta$Run, si_table_w_plate_meta$Sample_sets, sep = "_")
# gamma_table_w_plate_meta$Run_set = paste(gamma_table_w_plate_meta$Run, gamma_table_w_plate_meta$Sample_sets, sep = "_")
# 
# #### Set low bar. This is arbitrary! We will ask for at least 50 imaged nuclei per well to consider that well. 
# low_bar = 50
# fe_filt = fe_table_w_plate_meta[fe_table_w_plate_meta$num_nuc > (low_bar-1),]
# ar_filt = ar_table_w_plate_meta[ar_table_w_plate_meta$num_nuc > (low_bar-1),]
# si_filt = si_table_w_plate_meta[si_table_w_plate_meta$num_nuc > (low_bar-1),]
# gamma_filt = gamma_table_w_plate_meta[gamma_table_w_plate_meta$num_nuc > (low_bar-1),]
# 
# #### Truncate dataframe to only include the columns of interest
# col_trunc = c("Run_set_well", "avg_nfoci", "avg_foci_no_outl", "Dose_Fluence", "Timepoint", "Duplicate", 'Run_set', 'Staining_date')
# fe_trunc = fe_filt[,colnames(fe_filt) %in% col_trunc]
# 
# col_trunc = c("Run_set_well", "avg_nfoci", "avg_foci_no_outl", "Dose_Fluence", "Timepoint", "Duplicate", 'Run_set', 'Staining_date')
# ar_trunc = ar_filt[,colnames(ar_filt) %in% col_trunc]
# 
# col_trunc = c("Run_set_well", "avg_nfoci", "avg_foci_no_outl", "Dose_Fluence", "Timepoint", "Duplicate", 'Run_set', 'Staining_date')
# si_trunc = si_filt[,colnames(si_filt) %in% col_trunc]
# 
# col_trunc = c("Run_set_well", "avg_nfoci", "avg_foci_no_outl", "Dose_Fluence", "Timepoint", "Duplicate", 'Run_set', 'Staining_date')
# gamma_trunc = gamma_filt[,colnames(gamma_filt) %in% col_trunc]
# 
# 
# #### Now we combine all ions in a single matrix
# 
# ## For Fe:
# fe_reshaped_1 <- dcast(fe_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_nfoci'))
# colnames(fe_reshaped_1)[colnames(fe_reshaped_1) == "0"] = "avg_nfoci_0"
# colnames(fe_reshaped_1)[colnames(fe_reshaped_1) == "1.1"] = "avg_nfoci_low_dose"
# colnames(fe_reshaped_1)[colnames(fe_reshaped_1) == "3"] = "avg_nfoci_high_dose"
# 
# fe_reshaped_2 <- dcast(fe_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_foci_no_outl'))
# colnames(fe_reshaped_2)[colnames(fe_reshaped_2) == "0"] = "avg_foci_no_outl_0"
# colnames(fe_reshaped_2)[colnames(fe_reshaped_2) == "1.1"] = "avg_foci_no_outl_low_dose"
# colnames(fe_reshaped_2)[colnames(fe_reshaped_2) == "3"] = "avg_foci_no_outl_high_dose"
#  
# fe_reshaped = full_join(fe_reshaped_1, fe_reshaped_2, by=c("Run_set_well", "Duplicate", "Staining_date", "Run_set", "Timepoint"))
# 
# ## For Ar:
# ar_reshaped_1 <- dcast(ar_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_nfoci'))
# colnames(ar_reshaped_1)[colnames(ar_reshaped_1) == "0"] = "avg_nfoci_0"
# colnames(ar_reshaped_1)[colnames(ar_reshaped_1) == "1.1"] = "avg_nfoci_low_dose"
# colnames(ar_reshaped_1)[colnames(ar_reshaped_1) == "3"] = "avg_nfoci_high_dose"
# 
# ar_reshaped_2 <- dcast(ar_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_foci_no_outl'))
# colnames(ar_reshaped_2)[colnames(ar_reshaped_2) == "0"] = "avg_foci_no_outl_0"
# colnames(ar_reshaped_2)[colnames(ar_reshaped_2) == "1.1"] = "avg_foci_no_outl_low_dose"
# colnames(ar_reshaped_2)[colnames(ar_reshaped_2) == "3"] = "avg_foci_no_outl_high_dose"
#  
# ar_reshaped = full_join(ar_reshaped_1, ar_reshaped_2, by=c("Run_set_well", "Duplicate", "Staining_date", "Run_set", "Timepoint"))
# 
# ## For Si:
# si_reshaped_1 <- dcast(si_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_nfoci'))
# colnames(si_reshaped_1)[colnames(si_reshaped_1) == "0"] = "avg_nfoci_0"
# colnames(si_reshaped_1)[colnames(si_reshaped_1) == "1.1"] = "avg_nfoci_low_dose"
# colnames(si_reshaped_1)[colnames(si_reshaped_1) == "3"] = "avg_nfoci_high_dose"
# 
# si_reshaped_2 <- dcast(si_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_foci_no_outl'))
# colnames(si_reshaped_2)[colnames(si_reshaped_2) == "0"] = "avg_foci_no_outl_0"
# colnames(si_reshaped_2)[colnames(si_reshaped_2) == "1.1"] = "avg_foci_no_outl_low_dose"
# colnames(si_reshaped_2)[colnames(si_reshaped_2) == "3"] = "avg_foci_no_outl_high_dose"
#  
# si_reshaped = full_join(si_reshaped_1, si_reshaped_2, by=c("Run_set_well", "Duplicate", "Staining_date", "Run_set", "Timepoint"))
# 
# ## For Gamma:
# gamma_reshaped_1 <- dcast(gamma_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_nfoci'))
# colnames(gamma_reshaped_1)[colnames(gamma_reshaped_1) == "0"] = "avg_nfoci_0"
# colnames(gamma_reshaped_1)[colnames(gamma_reshaped_1) == "0.1"] = "avg_nfoci_low_dose"
# colnames(gamma_reshaped_1)[colnames(gamma_reshaped_1) == "1"] = "avg_nfoci_high_dose"
# 
# gamma_reshaped_2 <- dcast(gamma_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_foci_no_outl'))
# colnames(gamma_reshaped_2)[colnames(gamma_reshaped_2) == "0"] = "avg_foci_no_outl_0"
# colnames(gamma_reshaped_2)[colnames(gamma_reshaped_2) == "0.1"] = "avg_foci_no_outl_low_dose"
# colnames(gamma_reshaped_2)[colnames(gamma_reshaped_2) == "1"] = "avg_foci_no_outl_high_dose"
#  
# gamma_reshaped = full_join(gamma_reshaped_1, gamma_reshaped_2, by=c("Run_set_well", "Duplicate", "Staining_date", "Run_set", "Timepoint"))
# 
# #### Add info radiation type + Combine in one table 
# fe_reshaped$Radiation_type = "Fe"
# ar_reshaped$Radiation_type = "Ar"
# si_reshaped$Radiation_type = "Si"
# gamma_reshaped$Radiation_type = "Gamma"
# 
# all_RIF=bind_rows(fe_reshaped, ar_reshaped)
# all_RIF=bind_rows(all_RIF, si_reshaped)
# all_RIF=bind_rows(all_RIF, gamma_reshaped)
# 
# 
# ##### Now we add well metadata
# well_meta = read.csv('Well_metadata.csv', sep = ",", header = TRUE)
# all_RIF_Raw = merge(all_RIF, well_meta, by.x = 'Run_set_well', by.y = 'Run_set_well', all.x = TRUE)
# 
# Subject_metadata_save=all_RIF_Raw[,grepl("Sample_ID|Age|Gender|BMI", colnames(all_RIF_Raw))]
# 
# 
# #########################################  Correction ############################################
# ##################################################################################################
# 
# #### we add the Batch numerotation 
# Run_set_batch <- read.csv('Run_set_batch.csv', header = TRUE, sep = ";", quote = "\"", dec = ".")
# 
# Raw_DD_with_metadata=merge(all_RIF_Raw, Run_set_batch, by="Run_set",all.x = TRUE)
# Raw_DD_with_metadata$CMV=NULL
# Raw_DD_with_metadata$Run_set_well=NULL
# Raw_DD_with_metadata$X=NULL
# 
# colnames(Raw_DD_with_metadata)[colnames(Raw_DD_with_metadata)=="Batch"] = "Run_set_batch"
# 
# ## Add column radiation_batch 
# Raw_DD_with_metadata$Radiation_Batch= Raw_DD_with_metadata$Radiation_type
# Raw_DD_with_metadata$Radiation_Batch[Raw_DD_with_metadata$Radiation_Batch=="Fe"] <- 1
# Raw_DD_with_metadata$Radiation_Batch[Raw_DD_with_metadata$Radiation_Batch=="Ar"] <- 2
# Raw_DD_with_metadata$Radiation_Batch[Raw_DD_with_metadata$Radiation_Batch=="Si"] <- 3
# Raw_DD_with_metadata$Radiation_Batch[Raw_DD_with_metadata$Radiation_Batch=="Gamma"] <- 4
# 
# metadata_save = Raw_DD_with_metadata[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender",colnames(Raw_DD_with_metadata))]
# 
# ### We focus here on control samples and create batch variable per radiation type to apply successively Finsam's function with Run and set as the batch variable and then Radiation type as the batch variable 
# 
# ##############################################################
# ################### Run & set correction (on controls samples)
# ##############################################################
# ## Arguments 
# # here radiation type is not in the covariates since we expect all controls to have the same value independently of the radiation type 
# metadata=Raw_DD_with_metadata[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Raw_DD_with_metadata))]
# metadata$BMI_group=NULL
# 
# edata_control=Raw_DD_with_metadata[,grep("avg_nfoci_0|avg_foci_no_outl_0",colnames(Raw_DD_with_metadata))]
# edata_control=t(edata_control)
# 
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Raw_DD_with_metadata$Run_set_batch
# 
# ## Run Finsam's function
# Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# 
# Run_Set_Corrected_Controls = Modified_ComBat$data
# Gamma_factor_Run_set_correction= Modified_ComBat$gamma
# Delta_factor_Run_set_correction= Modified_ComBat$delta
# 
# ##################################################################################
# ################### Radiation correction within each Run_Set (on controls samples)
# ##################################################################################
# 
# # To know how many "Run and set" values we have 
# #Run_set_list = Raw_DD_with_metadata[, grepl("Run", colnames(Raw_DD_with_metadata))]
# #Run_set_list=unique(Run_set_list)
# #print(Run_set_list)
# 
# Run_Set_Corrected_Controls=t(Run_Set_Corrected_Controls)
# Run_Set_Corrected_Controls= cbind(Run_Set_Corrected_Controls, metadata_save)
# 
# ## In this case we have 6 different "Run and set" values, when additional radiation responses will be added need to add lines for respective Run_Set new values 
# Run_set_1 = Run_Set_Corrected_Controls %>% filter(Run_Set_Corrected_Controls$Run_set_batch == 1)
# Run_set_2 = Run_Set_Corrected_Controls %>% filter(Run_Set_Corrected_Controls$Run_set_batch == 2)
# Run_set_3 = Run_Set_Corrected_Controls %>% filter(Run_Set_Corrected_Controls$Run_set_batch == 3)
# Run_set_4 = Run_Set_Corrected_Controls %>% filter(Run_Set_Corrected_Controls$Run_set_batch == 4)
# Run_set_5 = Run_Set_Corrected_Controls %>% filter(Run_Set_Corrected_Controls$Run_set_batch == 5)
# Run_set_6 = Run_Set_Corrected_Controls %>% filter(Run_Set_Corrected_Controls$Run_set_batch == 6)
# 
# # for each run and set value we apply Finsam's function with radiation as a batch effect variable 
# 
# ##### Run_set_1
# metadata_save_1=Run_set_1[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_1))]
# metadata=Run_set_1[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_1))]
# metadata$BMI_group=NULL
# edata_control=Run_set_1[,grep("avg_nfoci_0|avg_foci_no_outl_0",colnames(Run_set_1))]
# edata_control=t(edata_control)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Run_set_1$Radiation_Batch
# ## Run Finsam's function
# Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Run_Set_1_Corrected_Controls = Modified_ComBat$data
# Run_Set_1_Corrected_Controls=t(Run_Set_1_Corrected_Controls)
# Run_Set_1_Corrected_Controls=cbind(Run_Set_1_Corrected_Controls, metadata_save_1)
# #
# Gamma_factor_Run_set_1= Modified_ComBat$gamma
# Delta_factor_Run_set_1= Modified_ComBat$delta
# 
# 
# ##### Run_set_2
# metadata_save_2=Run_set_2[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_2))]
# metadata=Run_set_2[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_2))]
# metadata$BMI_group=NULL
# edata_control=Run_set_2[,grep("avg_nfoci_0|avg_foci_no_outl_0",colnames(Run_set_2))]
# edata_control=t(edata_control)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Run_set_2$Radiation_Batch
# ## Run Finsam's function
# Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Run_Set_2_Corrected_Controls = Modified_ComBat$data
# Run_Set_2_Corrected_Controls=t(Run_Set_2_Corrected_Controls)
# Run_Set_2_Corrected_Controls=cbind(Run_Set_2_Corrected_Controls, metadata_save_2)
# #
# Gamma_factor_Run_set_2= Modified_ComBat$gamma
# Delta_factor_Run_set_2= Modified_ComBat$delta
# 
# 
# ##### Run_set_3
# metadata_save_3=Run_set_3[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_3))]
# metadata=Run_set_3[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_3))]
# metadata$BMI_group=NULL
# edata_control=Run_set_3[,grep("avg_nfoci_0|avg_foci_no_outl_0",colnames(Run_set_3))]
# edata_control=t(edata_control)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Run_set_3$Radiation_Batch
# ## Run Finsam's function
# Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Run_Set_3_Corrected_Controls = Modified_ComBat$data
# Run_Set_3_Corrected_Controls=t(Run_Set_3_Corrected_Controls)
# Run_Set_3_Corrected_Controls=cbind(Run_Set_3_Corrected_Controls, metadata_save_3)
# #
# Gamma_factor_Run_set_3= Modified_ComBat$gamma
# Delta_factor_Run_set_3= Modified_ComBat$delta
# 
# ##### Run_set_4
# metadata_save_4=Run_set_4[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_4))]
# metadata=Run_set_4[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_4))]
# metadata$BMI_group=NULL
# edata_control=Run_set_4[,grep("avg_nfoci_0|avg_foci_no_outl_0",colnames(Run_set_4))]
# edata_control=t(edata_control)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Run_set_4$Radiation_Batch
# ## Run Finsam's function
# Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Run_Set_4_Corrected_Controls = Modified_ComBat$data
# Run_Set_4_Corrected_Controls=t(Run_Set_4_Corrected_Controls)
# Run_Set_4_Corrected_Controls=cbind(Run_Set_4_Corrected_Controls, metadata_save_4)
# #
# Gamma_factor_Run_set_4= Modified_ComBat$gamma
# Delta_factor_Run_set_4= Modified_ComBat$delta
# 
# ##### Run_set_5
# metadata_save_5=Run_set_5[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_5))]
# metadata=Run_set_5[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_5))]
# metadata$BMI_group=NULL
# edata_control=Run_set_5[,grep("avg_nfoci_0|avg_foci_no_outl_0",colnames(Run_set_5))]
# edata_control=t(edata_control)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Run_set_5$Radiation_Batch
# ## Run Finsam's function
# Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Run_Set_5_Corrected_Controls = Modified_ComBat$data
# Run_Set_5_Corrected_Controls=t(Run_Set_5_Corrected_Controls)
# Run_Set_5_Corrected_Controls=cbind(Run_Set_5_Corrected_Controls, metadata_save_5)
# #
# Gamma_factor_Run_set_5= Modified_ComBat$gamma
# Delta_factor_Run_set_5= Modified_ComBat$delta
# 
# ##### Run_set_6
# metadata_save_6=Run_set_6[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_6))]
# metadata=Run_set_6[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_6))]
# metadata$BMI_group=NULL
# edata_control=Run_set_6[,grep("avg_nfoci_0|avg_foci_no_outl_0",colnames(Run_set_6))]
# edata_control=t(edata_control)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Run_set_6$Radiation_Batch
# ## Run Finsam's function
# Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Run_Set_6_Corrected_Controls = Modified_ComBat$data
# Run_Set_6_Corrected_Controls=t(Run_Set_6_Corrected_Controls)
# Run_Set_6_Corrected_Controls=cbind(Run_Set_6_Corrected_Controls, metadata_save_6)
# #
# Gamma_factor_Run_set_6= Modified_ComBat$gamma
# Delta_factor_Run_set_6= Modified_ComBat$delta
# 
# ######### regroup corrected controls 
# Corrected_controls= bind_rows(Run_Set_1_Corrected_Controls, Run_Set_2_Corrected_Controls,
#                               Run_Set_3_Corrected_Controls,Run_Set_4_Corrected_Controls,
#                               Run_Set_5_Corrected_Controls,Run_Set_6_Corrected_Controls)
# Corrected_controls$Rad_dose_Gy = 0
# Corrected_controls$Run_set_batch=NULL
# Corrected_controls$Radiation_Batch=NULL
# 
# ##############################################################
# ################# Run & set correction (on Irradiated samples)
# ##############################################################
# 
# # just like we did for controls, firstly we correct by run and set and then by radiation type within each run and set
# 
# ######## we separate low and high dose to include the dose in Gy as a covariate
# 
# ################################ Low dose ######################################
# Raw_low_dose_irradiated_samples=Raw_DD_with_metadata[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|avg_foci_no_outl_low_dose|avg_nfoci_low_dose",colnames(Raw_DD_with_metadata))]
# 
# Raw_low_dose_irradiated_samples$Rad_dose_Gy = Raw_low_dose_irradiated_samples$Radiation_type
# Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Fe"] <- low_dose_Fe
# Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Ar"] <- low_dose_Ar
# Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Si"] <- low_dose_Si
# Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Gamma"] <- low_dose_Gamma
# 
# Raw_low_dose_irradiated_samples=Raw_low_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|avg_foci_no_outl_low_dose|avg_nfoci_low_dose|Rad_dose_Gy",colnames(Raw_low_dose_irradiated_samples))]
# 
# metadata_save = Raw_low_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Rad_dose",colnames(Raw_low_dose_irradiated_samples))]
# 
# 
# ############## Run and set correction 
# #create arguments
# metadata=Raw_low_dose_irradiated_samples[,grep("Sample_ID|Timepoint|Rad_dose_Gy|Age|BMI|Gender",colnames(Raw_low_dose_irradiated_samples))]
# metadata$BMI_group=NULL
# edata_low_dose_responses=Raw_low_dose_irradiated_samples[,grep("avg_nfoci_low|avg_foci_no_outl_low",colnames(Raw_low_dose_irradiated_samples))]
# edata_irradiation_responses=t(edata_low_dose_responses)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Raw_low_dose_irradiated_samples$Run_set_batch
# 
# # Gamma and delta factor used here are those from "ComBat save" function apply to Raw controls and with Run and set as batch variable
# Run_combat_custom <- ComBat_custom(dat=edata_irradiation_responses, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_correction, custom.delta=Delta_factor_Run_set_correction, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Low_dose_run_set_corrected_response=t(Run_combat_custom)
# Low_dose_run_set_corrected_response=cbind(Low_dose_run_set_corrected_response, metadata_save)
# 
# ################### Now, for each run and set value we correct by radiation
# # Mentioned before, but here too lines must be added for each new Run_set irradiated/imaged samples considered in future analysis
# Irradiated_Responses_Run_set_1 = Low_dose_run_set_corrected_response %>% filter(Low_dose_run_set_corrected_response$Run_set_batch == 1)
# Irradiated_Responses_Run_set_2 = Low_dose_run_set_corrected_response %>% filter(Low_dose_run_set_corrected_response$Run_set_batch == 2)
# Irradiated_Responses_Run_set_3 = Low_dose_run_set_corrected_response %>% filter(Low_dose_run_set_corrected_response$Run_set_batch == 3)
# Irradiated_Responses_Run_set_4 = Low_dose_run_set_corrected_response %>% filter(Low_dose_run_set_corrected_response$Run_set_batch == 4)
# Irradiated_Responses_Run_set_5 = Low_dose_run_set_corrected_response %>% filter(Low_dose_run_set_corrected_response$Run_set_batch == 5)
# Irradiated_Responses_Run_set_6 = Low_dose_run_set_corrected_response %>% filter(Low_dose_run_set_corrected_response$Run_set_batch == 6)
# 
# 
# ##### Run_set_1
# # create arguments 
# metadata_save_1=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
# metadata=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
# metadata$BMI_group=NULL
# edata_Irradiated=Irradiated_Responses_Run_set_1[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_1))]
# edata_Irradiated=t(edata_Irradiated)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Irradiated_Responses_Run_set_1$Radiation_Batch
# ### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
# Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_1, custom.delta=Delta_factor_Run_set_1, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Rad_Corrected_Irrad_Samples_Run_Set_1 = t(Combat_custom_Rad_correction)
# Rad_Corrected_Irrad_Samples_Run_Set_1=cbind(Rad_Corrected_Irrad_Samples_Run_Set_1, metadata_save_1)
# 
# 
# ##### Run_set_2
# # create arguments 
# metadata_save_2=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
# metadata=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
# metadata$BMI_group=NULL
# edata_Irradiated=Irradiated_Responses_Run_set_2[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_2))]
# edata_Irradiated=t(edata_Irradiated)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Irradiated_Responses_Run_set_2$Radiation_Batch
# ### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
# Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_2, custom.delta=Delta_factor_Run_set_2, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Rad_Corrected_Irrad_Samples_Run_Set_2 = t(Combat_custom_Rad_correction)
# Rad_Corrected_Irrad_Samples_Run_Set_2=cbind(Rad_Corrected_Irrad_Samples_Run_Set_2, metadata_save_2)
# 
# ##### Run_set_3
# # create arguments 
# metadata_save_3=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
# metadata=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
# metadata$BMI_group=NULL
# edata_Irradiated=Irradiated_Responses_Run_set_3[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_3))]
# edata_Irradiated=t(edata_Irradiated)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Irradiated_Responses_Run_set_3$Radiation_Batch
# ### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
# Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_3, custom.delta=Delta_factor_Run_set_3, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Rad_Corrected_Irrad_Samples_Run_Set_3 = t(Combat_custom_Rad_correction)
# Rad_Corrected_Irrad_Samples_Run_Set_3=cbind(Rad_Corrected_Irrad_Samples_Run_Set_3, metadata_save_3)
# 
# ##### Run_set_4
# # create arguments 
# metadata_save_4=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
# metadata=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
# metadata$BMI_group=NULL
# edata_Irradiated=Irradiated_Responses_Run_set_4[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_4))]
# edata_Irradiated=t(edata_Irradiated)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Irradiated_Responses_Run_set_4$Radiation_Batch
# ### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
# Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_4, custom.delta=Delta_factor_Run_set_4, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Rad_Corrected_Irrad_Samples_Run_Set_4 = t(Combat_custom_Rad_correction)
# Rad_Corrected_Irrad_Samples_Run_Set_4=cbind(Rad_Corrected_Irrad_Samples_Run_Set_4, metadata_save_4)
# 
# 
# ##### Run_set_5
# # create arguments 
# metadata_save_5=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
# metadata=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
# metadata$BMI_group=NULL
# edata_Irradiated=Irradiated_Responses_Run_set_5[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_5))]
# edata_Irradiated=t(edata_Irradiated)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Irradiated_Responses_Run_set_5$Radiation_Batch
# ### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
# Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_5, custom.delta=Delta_factor_Run_set_5, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Rad_Corrected_Irrad_Samples_Run_Set_5 = t(Combat_custom_Rad_correction)
# Rad_Corrected_Irrad_Samples_Run_Set_5=cbind(Rad_Corrected_Irrad_Samples_Run_Set_5, metadata_save_5)
# 
# ##### Run_set_6
# # create arguments 
# metadata_save_6=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
# metadata=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
# metadata$BMI_group=NULL
# edata_Irradiated=Irradiated_Responses_Run_set_6[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_6))]
# edata_Irradiated=t(edata_Irradiated)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Irradiated_Responses_Run_set_6$Radiation_Batch
# ### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
# Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_6, custom.delta=Delta_factor_Run_set_6, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Rad_Corrected_Irrad_Samples_Run_Set_6 = t(Combat_custom_Rad_correction)
# Rad_Corrected_Irrad_Samples_Run_Set_6=cbind(Rad_Corrected_Irrad_Samples_Run_Set_6, metadata_save_6)
# 
# ########## Now we regroup run/set and radiation corrected irradiated samples 
# Corrected_low_dose_irradiated_samples=bind_rows(Rad_Corrected_Irrad_Samples_Run_Set_1, Rad_Corrected_Irrad_Samples_Run_Set_2, 
#                                        Rad_Corrected_Irrad_Samples_Run_Set_3, Rad_Corrected_Irrad_Samples_Run_Set_4,
#                                        Rad_Corrected_Irrad_Samples_Run_Set_5, Rad_Corrected_Irrad_Samples_Run_Set_6)
# 
# Corrected_low_dose_irradiated_samples$Run_set_batch=NULL
# Corrected_low_dose_irradiated_samples$Radiation_Batch=NULL
# 
# ################################ high dose ######################################
# Raw_high_dose_irradiated_samples=Raw_DD_with_metadata[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|avg_foci_no_outl_high_dose|avg_nfoci_high_dose",colnames(Raw_DD_with_metadata))]
# 
# Raw_high_dose_irradiated_samples$Rad_dose_Gy = Raw_high_dose_irradiated_samples$Radiation_type
# Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Fe"] <- high_dose_Fe
# Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Ar"] <- high_dose_Ar
# Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Si"] <- high_dose_Si
# Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Gamma"] <- high_dose_Gamma
# 
# Raw_high_dose_irradiated_samples=Raw_high_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|avg_foci_no_outl_high_dose|avg_nfoci_high_dose|Rad_dose_Gy",colnames(Raw_high_dose_irradiated_samples))]
# 
# metadata_save = Raw_high_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Rad_dose",colnames(Raw_high_dose_irradiated_samples))]
# 
# ############## Run and set correction 
# #create arguments
# metadata=Raw_high_dose_irradiated_samples[,grep("Sample_ID|Timepoint|Radiation_type|Rad_dose_Gy|Age|BMI|Gender",colnames(Raw_high_dose_irradiated_samples))]
# metadata$BMI_group=NULL
# edata_high_dose_responses=Raw_high_dose_irradiated_samples[,grep("avg_nfoci_high|avg_foci_no_outl_high",colnames(Raw_high_dose_irradiated_samples))]
# edata_irradiation_responses=t(edata_high_dose_responses)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Raw_high_dose_irradiated_samples$Run_set_batch
# ### Gamma and delta factor used here are those from ComBat save apply to Raw controls and with Run and set as batch variable
# Run_combat_custom <- ComBat_custom(dat=edata_irradiation_responses, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_correction, custom.delta=Delta_factor_Run_set_correction, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# high_dose_run_set_corrected_response=t(Run_combat_custom)
# high_dose_run_set_corrected_response=cbind(high_dose_run_set_corrected_response, metadata_save)
# 
# #########################################################################################
# ################# correction between radiation within each run_set (on Irradiated samples)
# ##########################################################################################
# # Here too a line must be added for each new Run_set irradiated/imaged in the future and considered in this analysis
# Irradiated_Responses_Run_set_1 = high_dose_run_set_corrected_response %>% filter(high_dose_run_set_corrected_response$Run_set_batch == 1)
# Irradiated_Responses_Run_set_2 = high_dose_run_set_corrected_response %>% filter(high_dose_run_set_corrected_response$Run_set_batch == 2)
# Irradiated_Responses_Run_set_3 = high_dose_run_set_corrected_response %>% filter(high_dose_run_set_corrected_response$Run_set_batch == 3)
# Irradiated_Responses_Run_set_4 = high_dose_run_set_corrected_response %>% filter(high_dose_run_set_corrected_response$Run_set_batch == 4)
# Irradiated_Responses_Run_set_5 = high_dose_run_set_corrected_response %>% filter(high_dose_run_set_corrected_response$Run_set_batch == 5)
# Irradiated_Responses_Run_set_6 = high_dose_run_set_corrected_response %>% filter(high_dose_run_set_corrected_response$Run_set_batch == 6)
# 
# 
# ##### Run_set_1
# # create arguments 
# metadata_save_1=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
# metadata=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
# metadata$BMI_group=NULL
# edata_Irradiated=Irradiated_Responses_Run_set_1[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_1))]
# edata_Irradiated=t(edata_Irradiated)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Irradiated_Responses_Run_set_1$Radiation_Batch
# ### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
# Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_1, custom.delta=Delta_factor_Run_set_1, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Rad_Corrected_Irrad_Samples_Run_Set_1 = t(Combat_custom_Rad_correction)
# Rad_Corrected_Irrad_Samples_Run_Set_1=cbind(Rad_Corrected_Irrad_Samples_Run_Set_1, metadata_save_1)
# 
# ##### Run_set_2
# # create arguments 
# metadata_save_2=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
# metadata=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
# metadata$BMI_group=NULL
# edata_Irradiated=Irradiated_Responses_Run_set_2[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_2))]
# edata_Irradiated=t(edata_Irradiated)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Irradiated_Responses_Run_set_2$Radiation_Batch
# ### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
# Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_2, custom.delta=Delta_factor_Run_set_2, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Rad_Corrected_Irrad_Samples_Run_Set_2 = t(Combat_custom_Rad_correction)
# Rad_Corrected_Irrad_Samples_Run_Set_2=cbind(Rad_Corrected_Irrad_Samples_Run_Set_2, metadata_save_2)
# 
# ##### Run_set_3
# # create arguments 
# metadata_save_3=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
# metadata=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
# metadata$BMI_group=NULL
# edata_Irradiated=Irradiated_Responses_Run_set_3[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_3))]
# edata_Irradiated=t(edata_Irradiated)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Irradiated_Responses_Run_set_3$Radiation_Batch
# ### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
# Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_3, custom.delta=Delta_factor_Run_set_3, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Rad_Corrected_Irrad_Samples_Run_Set_3 = t(Combat_custom_Rad_correction)
# Rad_Corrected_Irrad_Samples_Run_Set_3=cbind(Rad_Corrected_Irrad_Samples_Run_Set_3, metadata_save_3)
# 
# ##### Run_set_4
# # create arguments 
# metadata_save_4=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
# metadata=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
# metadata$BMI_group=NULL
# edata_Irradiated=Irradiated_Responses_Run_set_4[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_4))]
# edata_Irradiated=t(edata_Irradiated)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Irradiated_Responses_Run_set_4$Radiation_Batch
# ### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
# Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_4, custom.delta=Delta_factor_Run_set_4, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Rad_Corrected_Irrad_Samples_Run_Set_4 = t(Combat_custom_Rad_correction)
# Rad_Corrected_Irrad_Samples_Run_Set_4=cbind(Rad_Corrected_Irrad_Samples_Run_Set_4, metadata_save_4)
# 
# ##### Run_set_5
# # create arguments 
# metadata_save_5=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
# metadata=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
# metadata$BMI_group=NULL
# edata_Irradiated=Irradiated_Responses_Run_set_5[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_5))]
# edata_Irradiated=t(edata_Irradiated)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Irradiated_Responses_Run_set_5$Radiation_Batch
# ### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
# Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_5, custom.delta=Delta_factor_Run_set_5, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Rad_Corrected_Irrad_Samples_Run_Set_5 = t(Combat_custom_Rad_correction)
# Rad_Corrected_Irrad_Samples_Run_Set_5=cbind(Rad_Corrected_Irrad_Samples_Run_Set_5, metadata_save_5)
# 
# ##### Run_set_6
# # create arguments 
# metadata_save_6=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
# metadata=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
# metadata$BMI_group=NULL
# edata_Irradiated=Irradiated_Responses_Run_set_6[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_6))]
# edata_Irradiated=t(edata_Irradiated)
# modcombat = model.matrix(~1, data= metadata) 
# Batch_C= Irradiated_Responses_Run_set_6$Radiation_Batch
# ### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
# Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_6, custom.delta=Delta_factor_Run_set_6, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
# #
# Rad_Corrected_Irrad_Samples_Run_Set_6 = t(Combat_custom_Rad_correction)
# Rad_Corrected_Irrad_Samples_Run_Set_6=cbind(Rad_Corrected_Irrad_Samples_Run_Set_6, metadata_save_6)
# 
# ################# Now we regroup run/set and radiation corrected irradiated samples 
# Corrected_high_dose_irradiated_samples=bind_rows(Rad_Corrected_Irrad_Samples_Run_Set_1, Rad_Corrected_Irrad_Samples_Run_Set_2, 
#                                        Rad_Corrected_Irrad_Samples_Run_Set_3, Rad_Corrected_Irrad_Samples_Run_Set_4,
#                                        Rad_Corrected_Irrad_Samples_Run_Set_5, Rad_Corrected_Irrad_Samples_Run_Set_6)
# 
# Corrected_high_dose_irradiated_samples$Run_set_batch=NULL
# Corrected_high_dose_irradiated_samples$Radiation_Batch=NULL
# 
# 
# 
# #### Regroup all DD corrected samples 
# Corrected_controls$Dose_relative = "0 Gy Controls"
# Corrected_low_dose_irradiated_samples$Dose_relative = "Low dose"
# Corrected_high_dose_irradiated_samples$Dose_relative = "High dose"
# colnames(Corrected_controls)[colnames(Corrected_controls)=="avg_nfoci_0"] = "avg_nfoci"
# colnames(Corrected_low_dose_irradiated_samples)[colnames(Corrected_low_dose_irradiated_samples)=="avg_nfoci_low_dose"] = "avg_nfoci"
# colnames(Corrected_high_dose_irradiated_samples)[colnames(Corrected_high_dose_irradiated_samples)=="avg_nfoci_high_dose"] = "avg_nfoci"
# colnames(Corrected_controls)[colnames(Corrected_controls)=="avg_foci_no_outl_0"] = "avg_foci_no_outl"
# colnames(Corrected_low_dose_irradiated_samples)[colnames(Corrected_low_dose_irradiated_samples)=="avg_foci_no_outl_low_dose"] = "avg_foci_no_outl"
# colnames(Corrected_high_dose_irradiated_samples)[colnames(Corrected_high_dose_irradiated_samples)=="avg_foci_no_outl_high_dose"] = "avg_foci_no_outl"
# #
# Corrected_controls$Rad_dose_Gy=as.character(Corrected_controls$Rad_dose_Gy)
# All_Corrected_DD=bind_rows(Corrected_controls,Corrected_low_dose_irradiated_samples, Corrected_high_dose_irradiated_samples) 
# 
# 
# #### The correction may generate negative value => we fix those negative value to 0 
# All_Corrected_DD$avg_foci_no_outl[All_Corrected_DD$avg_foci_no_outl < 0] <- 0 
# All_Corrected_DD$avg_foci[All_Corrected_DD$avg_foci < 0] <-  0 

```


```{r}
##############################################################################
########################### DNA damage correction ############################
##############################################################################

#### Read DNA damage data BNL19A
gamma_plate_nums_19A = c(433, 435, 437, 439, 441, 444, 445, 447, 449, 451, 453, 455, 457, 459, 461, 463, 465, 467, 469, 471, 473, 475, 477,479)
gamma_plate_count_19A = length(gamma_plate_nums_19A)
ar_plate_nums_19A = c(481, 483, 485, 487, 489, 491, 493, 495, 497, 499, 501, 503, 505, 507, 509, 511, 513, 515, 517, 519, 521, 523, 525,527)
ar_plate_count_19A = length(ar_plate_nums_19A)
si_plate_nums_19A = c(577, 579, 581, 583, 585, 587, 589, 591, 593, 595, 597, 599, 601, 603, 605,607, 609, 611, 613,615, 617, 619, 621, 623)
si_plate_count_19A = length(si_plate_nums_19A)
fe_plate_nums_19A = c(529, 531, 533, 535, 537, 539, 541, 543, 545, 547, 549, 551, 553, 555, 557, 559, 561, 563, 565, 567, 569, 571, 573,575)
fe_plate_count_19A = length(fe_plate_nums_19A)
gamma_si_fe_ar_plate_nums_19A = c(gamma_plate_nums_19A, si_plate_nums_19A, fe_plate_nums_19A, ar_plate_nums_19A)
gamma_si_fe_ar_plate_count_19A = length(gamma_si_fe_ar_plate_nums_19A)


#### Read first file
foci_gamma_first_19A = data.frame(Plate = gamma_plate_nums_19A[1], Plate_well = paste(gamma_plate_nums_19A[1], read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", gamma_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", gamma_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE))

gamma_table_19A=foci_gamma_first_19A

foci_si_first_19A = data.frame(Plate = si_plate_nums_19A[1], Plate_well = paste(si_plate_nums_19A[1], read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", si_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", si_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE))

si_table_19A=foci_si_first_19A

foci_ar_first_19A = data.frame(Plate = ar_plate_nums_19A[1], Plate_well = paste(ar_plate_nums_19A[1], read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", ar_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", ar_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE))

ar_table_19A=foci_ar_first_19A

foci_fe_first_19A = data.frame(Plate = fe_plate_nums_19A[1], Plate_well = paste(fe_plate_nums_19A[1], read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", fe_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("BNL19A-ProcessedFiles-Threshold3000/average_well_P", fe_plate_nums_19A[1],'.txt', sep=""), sep="\t", header = TRUE))

fe_table_19A=foci_fe_first_19A


#### Read all the other files and combine them into a single giant file with ALL the plates and ALL the wells
for(ii in 2:gamma_plate_count_19A){
  temp_gamma_filename = paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', gamma_plate_nums_19A[ii],'.txt', sep="")
  temp_gamma_table = data.frame(Plate = gamma_plate_nums_19A[ii], Plate_well = paste(gamma_plate_nums_19A[ii], read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', gamma_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', gamma_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE))
  gamma_table_19A = rbind(gamma_table_19A, temp_gamma_table)
}

for(ii in 2:si_plate_count_19A){
  temp_si_filename = paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', si_plate_nums_19A[ii],'.txt', sep="")
  temp_si_table = data.frame(Plate = si_plate_nums_19A[ii], Plate_well = paste(si_plate_nums_19A[ii], read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', si_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', si_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE))
  si_table_19A = rbind(si_table_19A, temp_si_table)
}

for(ii in 2:ar_plate_count_19A){
  temp_ar_filename = paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', ar_plate_nums_19A[ii],'.txt', sep="")
  temp_ar_table = data.frame(Plate = ar_plate_nums_19A[ii], Plate_well = paste(ar_plate_nums_19A[ii], read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', ar_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', ar_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE))
  ar_table_19A = rbind(ar_table_19A, temp_ar_table)
  }

for(ii in 2:fe_plate_count_19A){
  temp_fe_filename = paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', fe_plate_nums_19A[ii],'.txt', sep="")
  temp_fe_table = data.frame(Plate = fe_plate_nums_19A[ii], Plate_well = paste(fe_plate_nums_19A[ii], read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', fe_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('BNL19A-ProcessedFiles-Threshold3000/average_well_P', fe_plate_nums_19A[ii],'.txt', sep=""), sep="\t", header = TRUE))
  fe_table_19A = rbind(fe_table_19A, temp_fe_table)
  }


#### Read DNA damage data BNL18B
ar_plate_nums_18B = c(381,382,383,386,387,390,391,394,395,396,399,400,402)
ar_plate_count_18B = length(ar_plate_nums_18B)
si_plate_nums_18B = c(333,337,341,345,349,353)  
si_plate_count_18B = length(si_plate_nums_18B)
fe_plate_nums_18B = c(355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,372,373,374,375,376,377,378)
fe_plate_count_18B = length(fe_plate_nums_18B)
fe_ar_plate_nums_18B = c(fe_plate_nums_18B, ar_plate_nums_18B)
fe_ar_plate_count_18B = length(fe_ar_plate_nums_18B)

#### Read first file
foci_ar_first_18B = data.frame(Plate = ar_plate_nums_18B[1], Plate_well = paste(ar_plate_nums_18B[1], read.table(paste("BNL18B-ProcessedFile/Ar-BNL_18B-reimaged/average_well_P", ar_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("BNL18B-ProcessedFile/Ar-BNL_18B-reimaged/average_well_P", ar_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE))

ar_table_18B=foci_ar_first_18B

foci_si_first_18B = data.frame(Plate = si_plate_nums_18B[1], Plate_well = paste(si_plate_nums_18B[1], read.table(paste("BNL18B-ProcessedFile/Si-BNL_18B-reimaged/average_well_P", si_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("BNL18B-ProcessedFile/Si-BNL_18B-reimaged/average_well_P", si_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE))

si_table_18B=foci_si_first_18B

foci_fe_first_18B = data.frame(Plate = fe_plate_nums_18B[1], Plate_well = paste(fe_plate_nums_18B[1], read.table(paste("BNL18B-ProcessedFile/Fe-BNL_18B-reprocessed/average_well_P", fe_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("BNL18B-ProcessedFile/Fe-BNL_18B-reprocessed/average_well_P", fe_plate_nums_18B[1],'.txt', sep=""), sep="\t", header = TRUE))

fe_table_18B=foci_fe_first_18B

#### Read all the other files and combine them into a single giant file with ALL the plates and ALL the wells
for(ii in 2:ar_plate_count_18B){
  temp_ar_filename = paste('BNL18B-ProcessedFile/Ar-BNL_18B-reimaged/average_well_P', ar_plate_nums_18B[ii],'.txt', sep="")
  temp_ar_table = data.frame(Plate = ar_plate_nums_18B[ii], Plate_well = paste(ar_plate_nums_18B[ii], read.table(paste('BNL18B-ProcessedFile/Ar-BNL_18B-reimaged/average_well_P', ar_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('BNL18B-ProcessedFile/Ar-BNL_18B-reimaged/average_well_P', ar_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE))
  ar_table_18B = rbind(ar_table_18B, temp_ar_table)
  }

for(ii in 2:si_plate_count_18B){
  temp_si_filename = paste('BNL18B-ProcessedFile/Si-BNL_18B-reimaged/average_well_P', si_plate_nums_18B[ii],'.txt', sep="")
  temp_si_table = data.frame(Plate = si_plate_nums_18B[ii], Plate_well = paste(si_plate_nums_18B[ii], read.table(paste('BNL18B-ProcessedFile/Si-BNL_18B-reimaged/average_well_P', si_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('BNL18B-ProcessedFile/Si-BNL_18B-reimaged/average_well_P', si_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE))
  si_table_18B = rbind(si_table_18B, temp_si_table)
  }

for(ii in 2:fe_plate_count_18B){
  temp_fe_filename = paste('BNL18B-ProcessedFile/Fe-BNL_18B-reprocessed/average_well_P', fe_plate_nums_18B[ii],'.txt', sep="")
  temp_fe_table = data.frame(Plate = fe_plate_nums_18B[ii], Plate_well = paste(fe_plate_nums_18B[ii], read.table(paste('BNL18B-ProcessedFile/Fe-BNL_18B-reprocessed/average_well_P', fe_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('BNL18B-ProcessedFile/Fe-BNL_18B-reprocessed/average_well_P', fe_plate_nums_18B[ii],'.txt', sep=""), sep="\t", header = TRUE))
  fe_table_18B = rbind(fe_table_18B, temp_fe_table)
  }

#### We combine 18B and 19A data
ar_table = rbind(ar_table_18B, ar_table_19A)
fe_table = rbind(fe_table_18B, fe_table_19A)
si_table = rbind(si_table_18B, si_table_19A)
gamma_table = gamma_table_19A


#### add duplicate info
Plate_Duplicate <- read.csv('Plate_Duplicate.csv', header = TRUE, sep = ";", quote = "\"", dec = ".")
Plate_Duplicate$Run=NULL
ar_table=merge(ar_table, Plate_Duplicate, by.x="Plate", by.y="Plate_number", all.x = TRUE)
fe_table=merge(fe_table, Plate_Duplicate, by.x="Plate", by.y="Plate_number", all.x = TRUE)
si_table=merge(si_table, Plate_Duplicate, by.x="Plate", by.y="Plate_number", all.x = TRUE)
gamma_table=merge(gamma_table, Plate_Duplicate, by.x="Plate", by.y="Plate_number", all.x = TRUE)



#### Now we will add plate metadata
plate_meta = read.csv('Plate_metadata.csv', sep = ",", header = TRUE)
fe_table_w_plate_meta = merge(fe_table, plate_meta, by.x = 'Plate', by.y = 'Plate_number', all.x = TRUE, all.y = FALSE)
ar_table_w_plate_meta = merge(ar_table, plate_meta, by.x = 'Plate', by.y = 'Plate_number', all.x = TRUE, all.y = FALSE)
si_table_w_plate_meta = merge(si_table, plate_meta, by.x = 'Plate', by.y = 'Plate_number', all.x = TRUE, all.y = FALSE)
gamma_table_w_plate_meta = merge(gamma_table, plate_meta, by.x = 'Plate', by.y = 'Plate_number', all.x = TRUE, all.y = FALSE)

## Wells are different based on sample sets, so we need to make an extra column for Set_Well, and then add well metadata based on it.
fe_table_w_plate_meta$Run_set_well = paste(fe_table_w_plate_meta$Run, fe_table_w_plate_meta$Sample_sets, fe_table_w_plate_meta$Well, sep = "_")
ar_table_w_plate_meta$Run_set_well = paste(ar_table_w_plate_meta$Run, ar_table_w_plate_meta$Sample_sets, ar_table_w_plate_meta$Well, sep = "_")
si_table_w_plate_meta$Run_set_well = paste(si_table_w_plate_meta$Run, si_table_w_plate_meta$Sample_sets, si_table_w_plate_meta$Well, sep = "_")
gamma_table_w_plate_meta$Run_set_well = paste(gamma_table_w_plate_meta$Run, gamma_table_w_plate_meta$Sample_sets, gamma_table_w_plate_meta$Well, sep = "_")

## create column run_set 
fe_table_w_plate_meta$Run_set = paste(fe_table_w_plate_meta$Run, fe_table_w_plate_meta$Sample_sets, sep = "_")
ar_table_w_plate_meta$Run_set = paste(ar_table_w_plate_meta$Run, ar_table_w_plate_meta$Sample_sets, sep = "_")
si_table_w_plate_meta$Run_set = paste(si_table_w_plate_meta$Run, si_table_w_plate_meta$Sample_sets, sep = "_")
gamma_table_w_plate_meta$Run_set = paste(gamma_table_w_plate_meta$Run, gamma_table_w_plate_meta$Sample_sets, sep = "_")

#### Set low bar. This is arbitrary! We will ask for at least 50 imaged nuclei per well to consider that well. 
low_bar = 50
fe_filt = fe_table_w_plate_meta[fe_table_w_plate_meta$num_nuc > (low_bar-1),]
ar_filt = ar_table_w_plate_meta[ar_table_w_plate_meta$num_nuc > (low_bar-1),]
si_filt = si_table_w_plate_meta[si_table_w_plate_meta$num_nuc > (low_bar-1),]
gamma_filt = gamma_table_w_plate_meta[gamma_table_w_plate_meta$num_nuc > (low_bar-1),]

#### Truncate dataframe to only include the columns of interest
col_trunc = c("Run_set_well", "avg_nfoci", "avg_foci_no_outl", "Dose_Fluence", "Timepoint", "Duplicate", 'Run_set', 'Staining_date')
fe_trunc = fe_filt[,colnames(fe_filt) %in% col_trunc]

col_trunc = c("Run_set_well", "avg_nfoci", "avg_foci_no_outl", "Dose_Fluence", "Timepoint", "Duplicate", 'Run_set', 'Staining_date')
ar_trunc = ar_filt[,colnames(ar_filt) %in% col_trunc]

col_trunc = c("Run_set_well", "avg_nfoci", "avg_foci_no_outl", "Dose_Fluence", "Timepoint", "Duplicate", 'Run_set', 'Staining_date')
si_trunc = si_filt[,colnames(si_filt) %in% col_trunc]

col_trunc = c("Run_set_well", "avg_nfoci", "avg_foci_no_outl", "Dose_Fluence", "Timepoint", "Duplicate", 'Run_set', 'Staining_date')
gamma_trunc = gamma_filt[,colnames(gamma_filt) %in% col_trunc]


#### Now we combine all ions in a single matrix

## For Fe:
fe_reshaped_1 <- dcast(fe_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_nfoci'))
colnames(fe_reshaped_1)[colnames(fe_reshaped_1) == "0"] = "avg_nfoci_0"
colnames(fe_reshaped_1)[colnames(fe_reshaped_1) == "1.1"] = "avg_nfoci_low_dose"
colnames(fe_reshaped_1)[colnames(fe_reshaped_1) == "3"] = "avg_nfoci_high_dose"

fe_reshaped_2 <- dcast(fe_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_foci_no_outl'))
colnames(fe_reshaped_2)[colnames(fe_reshaped_2) == "0"] = "avg_foci_no_outl_0"
colnames(fe_reshaped_2)[colnames(fe_reshaped_2) == "1.1"] = "avg_foci_no_outl_low_dose"
colnames(fe_reshaped_2)[colnames(fe_reshaped_2) == "3"] = "avg_foci_no_outl_high_dose"
 
fe_reshaped = full_join(fe_reshaped_1, fe_reshaped_2, by=c("Run_set_well", "Duplicate", "Staining_date", "Run_set", "Timepoint"))

## For Ar:
ar_reshaped_1 <- dcast(ar_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_nfoci'))
colnames(ar_reshaped_1)[colnames(ar_reshaped_1) == "0"] = "avg_nfoci_0"
colnames(ar_reshaped_1)[colnames(ar_reshaped_1) == "1.1"] = "avg_nfoci_low_dose"
colnames(ar_reshaped_1)[colnames(ar_reshaped_1) == "3"] = "avg_nfoci_high_dose"

ar_reshaped_2 <- dcast(ar_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_foci_no_outl'))
colnames(ar_reshaped_2)[colnames(ar_reshaped_2) == "0"] = "avg_foci_no_outl_0"
colnames(ar_reshaped_2)[colnames(ar_reshaped_2) == "1.1"] = "avg_foci_no_outl_low_dose"
colnames(ar_reshaped_2)[colnames(ar_reshaped_2) == "3"] = "avg_foci_no_outl_high_dose"
 
ar_reshaped = full_join(ar_reshaped_1, ar_reshaped_2, by=c("Run_set_well", "Duplicate", "Staining_date", "Run_set", "Timepoint"))

## For Si:
si_reshaped_1 <- dcast(si_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_nfoci'))
colnames(si_reshaped_1)[colnames(si_reshaped_1) == "0"] = "avg_nfoci_0"
colnames(si_reshaped_1)[colnames(si_reshaped_1) == "1.1"] = "avg_nfoci_low_dose"
colnames(si_reshaped_1)[colnames(si_reshaped_1) == "3"] = "avg_nfoci_high_dose"

si_reshaped_2 <- dcast(si_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_foci_no_outl'))
colnames(si_reshaped_2)[colnames(si_reshaped_2) == "0"] = "avg_foci_no_outl_0"
colnames(si_reshaped_2)[colnames(si_reshaped_2) == "1.1"] = "avg_foci_no_outl_low_dose"
colnames(si_reshaped_2)[colnames(si_reshaped_2) == "3"] = "avg_foci_no_outl_high_dose"
 
si_reshaped = full_join(si_reshaped_1, si_reshaped_2, by=c("Run_set_well", "Duplicate", "Staining_date", "Run_set", "Timepoint"))

## For Gamma:
gamma_reshaped_1 <- dcast(gamma_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_nfoci'))
colnames(gamma_reshaped_1)[colnames(gamma_reshaped_1) == "0"] = "avg_nfoci_0"
colnames(gamma_reshaped_1)[colnames(gamma_reshaped_1) == "0.1"] = "avg_nfoci_low_dose"
colnames(gamma_reshaped_1)[colnames(gamma_reshaped_1) == "1"] = "avg_nfoci_high_dose"

gamma_reshaped_2 <- dcast(gamma_trunc, Run_set_well + Duplicate + Staining_date + Run_set + Timepoint ~ Dose_Fluence, value.var = c('avg_foci_no_outl'))
colnames(gamma_reshaped_2)[colnames(gamma_reshaped_2) == "0"] = "avg_foci_no_outl_0"
colnames(gamma_reshaped_2)[colnames(gamma_reshaped_2) == "0.1"] = "avg_foci_no_outl_low_dose"
colnames(gamma_reshaped_2)[colnames(gamma_reshaped_2) == "1"] = "avg_foci_no_outl_high_dose"
 
gamma_reshaped = full_join(gamma_reshaped_1, gamma_reshaped_2, by=c("Run_set_well", "Duplicate", "Staining_date", "Run_set", "Timepoint"))

#### Add info radiation type + Combine in one table 
fe_reshaped$Radiation_type = "Fe"
ar_reshaped$Radiation_type = "Ar"
si_reshaped$Radiation_type = "Si"
gamma_reshaped$Radiation_type = "Gamma"

all_RIF=bind_rows(fe_reshaped, ar_reshaped)
all_RIF=bind_rows(all_RIF, si_reshaped)
all_RIF=bind_rows(all_RIF, gamma_reshaped)


##### Now we add well metadata
well_meta = read.csv('Well_metadata.csv', sep = ",", header = TRUE)
all_RIF_Raw = merge(all_RIF, well_meta, by.x = 'Run_set_well', by.y = 'Run_set_well', all.x = TRUE)

Subject_metadata_save=all_RIF_Raw[,grepl("Sample_ID|Age|Gender|BMI", colnames(all_RIF_Raw))]


###########################################################################
####### 1) Correction between radiation within each run/set ###############
###########################################################################

Raw_pc = all_RIF_Raw 
Raw_pc$Run_set_well=NULL

Run_set_batch <- read.csv('Run_set_batch.csv', header = TRUE, sep = ";", quote = "\"", dec = ".")

Raw_pc=merge(Raw_pc, Run_set_batch, by="Run_set",all.x = TRUE)
Raw_pc$CMV=NULL
Raw_pcX=NULL

colnames(Raw_pc)[colnames(Raw_pc)=="Batch"] = "Run_set_batch"

Raw_pc_metadata = Raw_pc[,grepl("Sample_ID|Age|Run|BMI",colnames(Raw_pc))]

## Add column radiation_batch 
Raw_pc$Radiation_Batch= Raw_pc$Radiation_type
Raw_pc$Radiation_Batch[Raw_pc$Radiation_Batch=="Fe"] <- 1
Raw_pc$Radiation_Batch[Raw_pc$Radiation_Batch=="Ar"] <- 2
Raw_pc$Radiation_Batch[Raw_pc$Radiation_Batch=="Si"] <- 3
Raw_pc$Radiation_Batch[Raw_pc$Radiation_Batch=="Gamma"] <- 4

metadata_save = Raw_pc[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender",colnames(Raw_pc))]


# To know how many "Run and set" values we have 
Run_set_list = Raw_pc[, grepl("Run", colnames(Raw_pc))]
Run_set_list=unique(Run_set_list)
print(Run_set_list)


## In this case we have 6 different "Run and set" values
Run_set_1 = Raw_pc %>% filter(Raw_pc$Run_set_batch == 1)
Run_set_2 = Raw_pc %>% filter(Raw_pc$Run_set_batch == 2)
Run_set_3 = Raw_pc %>% filter(Raw_pc$Run_set_batch == 3)
Run_set_4 = Raw_pc %>% filter(Raw_pc$Run_set_batch == 4)
Run_set_5 = Raw_pc %>% filter(Raw_pc$Run_set_batch == 5)
Run_set_6 = Raw_pc %>% filter(Raw_pc$Run_set_batch == 6)

# for each run and set value we apply Finsam's function with radiation as a batch effect variable 
##### Run_set_1
metadata_save_1=Run_set_1[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_1))]
metadata=Run_set_1[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_1))]
metadata$BMI_group=NULL
edata_control=Run_set_1[,grep("avg_nfoci_0|avg_foci_no_outl_0",colnames(Run_set_1))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_1$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_1_Corrected_Controls = Modified_ComBat$data
Run_Set_1_Corrected_Controls=t(Run_Set_1_Corrected_Controls)
Run_Set_1_Corrected_Controls=cbind(Run_Set_1_Corrected_Controls, metadata_save_1)
#
Gamma_factor_Run_set_1= Modified_ComBat$gamma
Delta_factor_Run_set_1= Modified_ComBat$delta

##### Run_set_2
metadata_save_2=Run_set_2[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_2))]
metadata=Run_set_2[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_2))]
metadata$BMI_group=NULL
edata_control=Run_set_2[,grep("avg_nfoci_0|avg_foci_no_outl_0",colnames(Run_set_2))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_2$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_2_Corrected_Controls = Modified_ComBat$data
Run_Set_2_Corrected_Controls=t(Run_Set_2_Corrected_Controls)
Run_Set_2_Corrected_Controls=cbind(Run_Set_2_Corrected_Controls, metadata_save_2)
#
Gamma_factor_Run_set_2= Modified_ComBat$gamma
Delta_factor_Run_set_2= Modified_ComBat$delta


##### Run_set_3
metadata_save_3=Run_set_3[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_3))]
metadata=Run_set_3[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_3))]
metadata$BMI_group=NULL
edata_control=Run_set_3[,grep("avg_nfoci_0|avg_foci_no_outl_0",colnames(Run_set_3))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_3$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_3_Corrected_Controls = Modified_ComBat$data
Run_Set_3_Corrected_Controls=t(Run_Set_3_Corrected_Controls)
Run_Set_3_Corrected_Controls=cbind(Run_Set_3_Corrected_Controls, metadata_save_3)
#
Gamma_factor_Run_set_3= Modified_ComBat$gamma
Delta_factor_Run_set_3= Modified_ComBat$delta

##### Run_set_4
metadata_save_4=Run_set_4[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_4))]
metadata=Run_set_4[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_4))]
metadata$BMI_group=NULL
edata_control=Run_set_4[,grep("avg_nfoci_0|avg_foci_no_outl_0",colnames(Run_set_4))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_4$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_4_Corrected_Controls = Modified_ComBat$data
Run_Set_4_Corrected_Controls=t(Run_Set_4_Corrected_Controls)
Run_Set_4_Corrected_Controls=cbind(Run_Set_4_Corrected_Controls, metadata_save_4)
#
Gamma_factor_Run_set_4= Modified_ComBat$gamma
Delta_factor_Run_set_4= Modified_ComBat$delta

##### Run_set_5
metadata_save_5=Run_set_5[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_5))]
metadata=Run_set_5[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_5))]
metadata$BMI_group=NULL
edata_control=Run_set_5[,grep("avg_nfoci_0|avg_foci_no_outl_0",colnames(Run_set_5))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_5$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_5_Corrected_Controls = Modified_ComBat$data
Run_Set_5_Corrected_Controls=t(Run_Set_5_Corrected_Controls)
Run_Set_5_Corrected_Controls=cbind(Run_Set_5_Corrected_Controls, metadata_save_5)
#
Gamma_factor_Run_set_5= Modified_ComBat$gamma
Delta_factor_Run_set_5= Modified_ComBat$delta

##### Run_set_6
metadata_save_6=Run_set_6[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_6))]
metadata=Run_set_6[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_6))]
metadata$BMI_group=NULL
edata_control=Run_set_6[,grep("avg_nfoci_0|avg_foci_no_outl_0",colnames(Run_set_6))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_6$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_6_Corrected_Controls = Modified_ComBat$data
Run_Set_6_Corrected_Controls=t(Run_Set_6_Corrected_Controls)
Run_Set_6_Corrected_Controls=cbind(Run_Set_6_Corrected_Controls, metadata_save_6)
#
Gamma_factor_Run_set_6= Modified_ComBat$gamma
Delta_factor_Run_set_6= Modified_ComBat$delta

######### regroup corrected controls 
Corrected_controls= bind_rows(Run_Set_1_Corrected_Controls, Run_Set_2_Corrected_Controls,
                              Run_Set_3_Corrected_Controls,Run_Set_4_Corrected_Controls,
                              Run_Set_5_Corrected_Controls,Run_Set_6_Corrected_Controls)
Corrected_controls$Rad_dose_Gy = 0
Corrected_controls$Run_set_batch=NULL
Corrected_controls$Radiation_Batch=NULL


##############################################################
################# Run & set correction (on Irradiated samples)
##############################################################


######## we separate low and high dose to include the dose in Gy as a covariate
################################ Low dose ######################################
Raw_low_dose_irradiated_samples=Raw_pc[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|avg_foci_no_outl_low_dose|avg_nfoci_low_dose",colnames(Raw_pc))]

Raw_low_dose_irradiated_samples$Rad_dose_Gy = Raw_low_dose_irradiated_samples$Radiation_type
Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Fe"] <- low_dose_Fe
Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Ar"] <- low_dose_Ar
Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Si"] <- low_dose_Si
Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Gamma"] <- low_dose_Gamma

Raw_low_dose_irradiated_samples=Raw_low_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|avg_foci_no_outl_low_dose|avg_nfoci_low_dose|Rad_dose_Gy",colnames(Raw_low_dose_irradiated_samples))]

metadata_save = Raw_low_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Rad_dose",colnames(Raw_low_dose_irradiated_samples))]

################### Now, for each run and set value we correct by radiation
Irradiated_Responses_Run_set_1 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 1)
Irradiated_Responses_Run_set_2 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 2)
Irradiated_Responses_Run_set_3 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 3)
Irradiated_Responses_Run_set_4 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 4)
Irradiated_Responses_Run_set_5 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 5)
Irradiated_Responses_Run_set_6 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 6)

##### Run_set_1
# create arguments 
metadata_save_1=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
metadata=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_1[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_1))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_1$Radiation_Batch
### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_1, custom.delta=Delta_factor_Run_set_1, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_1 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_1=cbind(Rad_Corrected_Irrad_Samples_Run_Set_1, metadata_save_1)

##### Run_set_2
# create arguments 
metadata_save_2=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
metadata=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_2[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_2))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_2$Radiation_Batch
### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_2, custom.delta=Delta_factor_Run_set_2, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_2 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_2=cbind(Rad_Corrected_Irrad_Samples_Run_Set_2, metadata_save_2)

##### Run_set_3
# create arguments 
metadata_save_3=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
metadata=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_3[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_3))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_3$Radiation_Batch
### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_3, custom.delta=Delta_factor_Run_set_3, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_3 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_3=cbind(Rad_Corrected_Irrad_Samples_Run_Set_3, metadata_save_3)

##### Run_set_4
# create arguments 
metadata_save_4=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
metadata=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_4[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_4))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_4$Radiation_Batch
### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_4, custom.delta=Delta_factor_Run_set_4, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_4 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_4=cbind(Rad_Corrected_Irrad_Samples_Run_Set_4, metadata_save_4)


##### Run_set_5
# create arguments 
metadata_save_5=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
metadata=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_5[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_5))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_5$Radiation_Batch
### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_5, custom.delta=Delta_factor_Run_set_5, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_5 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_5=cbind(Rad_Corrected_Irrad_Samples_Run_Set_5, metadata_save_5)

##### Run_set_6
# create arguments 
metadata_save_6=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
metadata=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_6[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_6))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_6$Radiation_Batch
### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_6, custom.delta=Delta_factor_Run_set_6, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_6 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_6=cbind(Rad_Corrected_Irrad_Samples_Run_Set_6, metadata_save_6)

########## Now we regroup run/set and radiation corrected irradiated samples 
Corrected_low_dose_irradiated_samples=bind_rows(Rad_Corrected_Irrad_Samples_Run_Set_1, Rad_Corrected_Irrad_Samples_Run_Set_2, 
                                       Rad_Corrected_Irrad_Samples_Run_Set_3, Rad_Corrected_Irrad_Samples_Run_Set_4,
                                       Rad_Corrected_Irrad_Samples_Run_Set_5, Rad_Corrected_Irrad_Samples_Run_Set_6)

Corrected_low_dose_irradiated_samples$Run_set_batch=NULL
Corrected_low_dose_irradiated_samples$Radiation_Batch=NULL

################################ high dose ######################################
Raw_high_dose_irradiated_samples=Raw_pc[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|avg_foci_no_outl_high_dose|avg_nfoci_high_dose",colnames(Raw_pc))]

Raw_high_dose_irradiated_samples$Rad_dose_Gy = Raw_high_dose_irradiated_samples$Radiation_type
Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Fe"] <- high_dose_Fe
Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Ar"] <- high_dose_Ar
Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Si"] <- high_dose_Si
Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Gamma"] <- high_dose_Gamma

Raw_high_dose_irradiated_samples=Raw_high_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|avg_foci_no_outl_high_dose|avg_nfoci_high_dose|Rad_dose_Gy",colnames(Raw_high_dose_irradiated_samples))]

metadata_save = Raw_high_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Rad_dose",colnames(Raw_high_dose_irradiated_samples))]

Irradiated_Responses_Run_set_1 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 1)
Irradiated_Responses_Run_set_2 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 2)
Irradiated_Responses_Run_set_3 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 3)
Irradiated_Responses_Run_set_4 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 4)
Irradiated_Responses_Run_set_5 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 5)
Irradiated_Responses_Run_set_6 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 6)

##### Run_set_1
# create arguments 
metadata_save_1=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
metadata=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_1[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_1))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_1$Radiation_Batch
### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_1, custom.delta=Delta_factor_Run_set_1, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_1 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_1=cbind(Rad_Corrected_Irrad_Samples_Run_Set_1, metadata_save_1)

##### Run_set_2
# create arguments 
metadata_save_2=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
metadata=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_2[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_2))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_2$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_2, custom.delta=Delta_factor_Run_set_2, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_2 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_2=cbind(Rad_Corrected_Irrad_Samples_Run_Set_2, metadata_save_2)

##### Run_set_3
# create arguments 
metadata_save_3=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
metadata=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_3[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_3))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_3$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_3, custom.delta=Delta_factor_Run_set_3, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_3 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_3=cbind(Rad_Corrected_Irrad_Samples_Run_Set_3, metadata_save_3)

##### Run_set_4
# create arguments 
metadata_save_4=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
metadata=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_4[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_4))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_4$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_4, custom.delta=Delta_factor_Run_set_4, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_4 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_4=cbind(Rad_Corrected_Irrad_Samples_Run_Set_4, metadata_save_4)

##### Run_set_5
# create arguments 
metadata_save_5=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
metadata=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_5[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_5))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_5$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_5, custom.delta=Delta_factor_Run_set_5, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_5 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_5=cbind(Rad_Corrected_Irrad_Samples_Run_Set_5, metadata_save_5)

##### Run_set_6
# create arguments 
metadata_save_6=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
metadata=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_6[,grep("avg_nfoci|avg_foci_no_outl",colnames(Irradiated_Responses_Run_set_6))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_6$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_6, custom.delta=Delta_factor_Run_set_6, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_6 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_6=cbind(Rad_Corrected_Irrad_Samples_Run_Set_6, metadata_save_6)

########## Now we regroup run/set and radiation corrected irradiated samples 
Corrected_high_dose_irradiated_samples=bind_rows(Rad_Corrected_Irrad_Samples_Run_Set_1, Rad_Corrected_Irrad_Samples_Run_Set_2, 
                                       Rad_Corrected_Irrad_Samples_Run_Set_3, Rad_Corrected_Irrad_Samples_Run_Set_4,
                                       Rad_Corrected_Irrad_Samples_Run_Set_5, Rad_Corrected_Irrad_Samples_Run_Set_6)

Corrected_high_dose_irradiated_samples$Run_set_batch=NULL
Corrected_high_dose_irradiated_samples$Radiation_Batch=NULL


### Control, low irradiated and high irradiated samples are separate into 3 tables. In these three table, DNA damage for all radiation/time points are mixed into one column and complete with two metadata columns = time point & radiation_type. For the three table, we need to separate results by time point and radiation in order to do the normalization using for each conditions the respective controls

## controls
Controls_4h = Corrected_controls %>% filter(Corrected_controls$Timepoint=="4h")
Controls_4h_Fe =Controls_4h %>% filter(Controls_4h$Radiation_type=="Fe")
Controls_4h_Ar = Controls_4h %>% filter(Controls_4h$Radiation_type=="Ar")
Controls_4h_Si = Controls_4h %>% filter(Controls_4h$Radiation_type=="Si")
Controls_4h_Gamma = Controls_4h %>% filter(Controls_4h$Radiation_type=="Gamma")
#
Controls_24h = Corrected_controls %>% filter(Corrected_controls$Timepoint=="24h")
Controls_24h_Fe = Controls_24h %>% filter(Controls_24h$Radiation_type=="Fe")
Controls_24h_Ar = Controls_24h%>% filter(Controls_24h$Radiation_type=="Ar")
Controls_24h_Si =Controls_24h %>% filter(Controls_24h$Radiation_type=="Si")
Controls_24h_Gamma = Controls_24h %>% filter(Controls_24h$Radiation_type=="Gamma")

## Low dose
LD_4h = Corrected_low_dose_irradiated_samples %>% filter(Corrected_low_dose_irradiated_samples$Timepoint=="4h")
LD_4h_Fe = LD_4h %>% filter(LD_4h$Radiation_type=="Fe")
LD_4h_Fe=LD_4h_Fe[,grepl("Sample_ID|avg_nfoci_low|Run_set|Duplicate",colnames(LD_4h_Fe))]
LD_4h_Ar = LD_4h %>% filter(LD_4h$Radiation_type=="Ar")
LD_4h_Ar=LD_4h_Ar[,grepl("Sample_ID|avg_nfoci_low|Run_set|Duplicate",colnames(LD_4h_Ar))]
LD_4h_Si = LD_4h %>% filter(LD_4h$Radiation_type=="Si")
LD_4h_Si=LD_4h_Si[,grepl("Sample_ID|avg_nfoci_low|Run_set|Duplicate",colnames(LD_4h_Si))]
LD_4h_Gamma = LD_4h %>% filter(LD_4h$Radiation_type=="Gamma")
LD_4h_Gamma=LD_4h_Gamma[,grepl("Sample_ID|avg_nfoci_low|Run_set|Duplicate",colnames(LD_4h_Gamma))]
#
LD_24h = Corrected_low_dose_irradiated_samples %>% filter(Corrected_low_dose_irradiated_samples$Timepoint=="24h")
LD_24h_Fe = LD_24h %>% filter(LD_24h$Radiation_type=="Fe")
LD_24h_Fe=LD_24h_Fe[,grepl("Sample_ID|avg_nfoci_low|Run_set|Duplicate",colnames(LD_24h_Fe))]
LD_24h_Ar = LD_24h %>% filter(LD_24h$Radiation_type=="Ar")
LD_24h_Ar=LD_24h_Ar[,grepl("Sample_ID|avg_nfoci_low|Run_set|Duplicate",colnames(LD_24h_Ar))]
LD_24h_Si = LD_24h %>% filter(LD_24h$Radiation_type=="Si")
LD_24h_Si=LD_24h_Si[,grepl("Sample_ID|avg_nfoci_low|Run_set|Duplicate",colnames(LD_24h_Si))]
LD_24h_Gamma = LD_24h %>% filter(LD_24h$Radiation_type=="Gamma")
LD_24h_Gamma=LD_24h_Gamma[,grepl("Sample_ID|avg_nfoci_low|Run_set|Duplicate",colnames(LD_24h_Gamma))]

## High dose
HD_4h = Corrected_high_dose_irradiated_samples %>% filter(Corrected_high_dose_irradiated_samples$Timepoint=="4h")
HD_4h_Fe = HD_4h %>% filter(HD_4h$Radiation_type=="Fe")
HD_4h_Fe=HD_4h_Fe[,grepl("Sample_ID|avg_nfoci_high|Run_set|Duplicate",colnames(HD_4h_Fe))]
HD_4h_Ar = HD_4h %>% filter(HD_4h$Radiation_type=="Ar")
HD_4h_Ar=HD_4h_Ar[,grepl("Sample_ID|avg_nfoci_high|Run_set|Duplicate",colnames(HD_4h_Ar))]
HD_4h_Si = HD_4h %>% filter(HD_4h$Radiation_type=="Si")
HD_4h_Si=HD_4h_Si[,grepl("Sample_ID|avg_nfoci_high|Run_set|Duplicate",colnames(HD_4h_Si))]
HD_4h_Gamma = HD_4h %>% filter(HD_4h$Radiation_type=="Gamma")
HD_4h_Gamma=HD_4h_Gamma[,grepl("Sample_ID|avg_nfoci_high|Run_set|Duplicate",colnames(HD_4h_Gamma))]
#
HD_24h = Corrected_high_dose_irradiated_samples %>% filter(Corrected_high_dose_irradiated_samples$Timepoint=="24h")
HD_24h_Fe = HD_24h %>% filter(HD_24h$Radiation_type=="Fe")
HD_24h_Fe=HD_24h_Fe[,grepl("Sample_ID|avg_nfoci_high|Run_set|Duplicate",colnames(HD_24h_Fe))]
HD_24h_Ar = HD_24h %>% filter(HD_24h$Radiation_type=="Ar")
HD_24h_Ar=HD_24h_Ar[,grepl("Sample_ID|avg_nfoci_high|Run_set|Duplicate",colnames(HD_24h_Ar))]
HD_24h_Si = HD_24h %>% filter(HD_24h$Radiation_type=="Si")
HD_24h_Si=HD_24h_Si[,grepl("Sample_ID|avg_nfoci_high|Run_set|Duplicate",colnames(HD_24h_Si))]
HD_24h_Gamma = HD_24h %>% filter(HD_24h$Radiation_type=="Gamma")
HD_24h_Gamma=HD_24h_Gamma[,grepl("Sample_ID|avg_nfoci_high|Run_set|Duplicate",colnames(HD_24h_Gamma))]


## Regroup 
Correct_Fe_4h=merge(Controls_4h_Fe, LD_4h_Fe, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Fe_4h=merge(Correct_Fe_4h, HD_4h_Fe, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Ar_4h=merge(Controls_4h_Ar, LD_4h_Ar, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Ar_4h=merge(Correct_Ar_4h, HD_4h_Ar, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Si_4h=merge(Controls_4h_Si, LD_4h_Si, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Si_4h=merge(Correct_Si_4h, HD_4h_Si, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Gamma_4h=merge(Controls_4h_Gamma, LD_4h_Gamma, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Gamma_4h=merge(Correct_Gamma_4h, HD_4h_Gamma, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Fe_24h=merge(Controls_24h_Fe, LD_24h_Fe, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Fe_24h=merge(Correct_Fe_24h, HD_24h_Fe, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Ar_24h=merge(Controls_24h_Ar, LD_24h_Ar, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Ar_24h=merge(Correct_Ar_24h, HD_24h_Ar, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Si_24h=merge(Controls_24h_Si, LD_24h_Si, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Si_24h=merge(Correct_Si_24h, HD_24h_Si, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Gamma_24h=merge(Controls_24h_Gamma, LD_24h_Gamma, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Gamma_24h=merge(Correct_Gamma_24h, HD_24h_Gamma, by=c("Sample_ID", "Duplicate", "Run_set"))

#### Regroup everything into 1 table

Corrected_DNA_Damage= bind_rows(Correct_Fe_4h, Correct_Fe_24h,
                                Correct_Ar_4h, Correct_Ar_24h,
                                Correct_Si_4h, Correct_Si_24h,
                                Correct_Gamma_4h, Correct_Gamma_24h)

Corrected_DNA_Damage$avg_foci_no_outl_0=NULL
Corrected_DNA_Damage$Rad_dose_Gy=NULL
#### The correction may generate negative value => we fix those negative value to 0 
Corrected_DNA_Damage$avg_nfoci_0[Corrected_DNA_Damage$avg_nfoci_0 < 0] <- 0 
Corrected_DNA_Damage$avg_nfoci_low_dose[Corrected_DNA_Damage$avg_nfoci_low_dose < 0] <-  0 
Corrected_DNA_Damage$avg_nfoci_high_dose[Corrected_DNA_Damage$avg_nfoci_high_dose < 0] <-  0 




###########################################################################
##################### 2) z-score correction ###############################
###########################################################################



# 19A is used as the reference, we perform the correction first between on 18B and then on 19C
Run_19A= c("Run_19A_Set_1", "Run_19A_Set_2")
Run_18B = c("Run_18B_Set_2", "Run_18B_Set_1")
Run_19C = c("Run_19C_Set_2", "Run_19C_Set_1", "Run_19C_Set_3", "Run_19C_Set_4")

Run_19A_18B = c("Run_18B_Set_2", "Run_18B_Set_1","Run_19A_Set_1", "Run_19A_Set_2")
RIF_correct_19A_18B = Corrected_DNA_Damage %>% filter(Corrected_DNA_Damage$Run_set %in% Run_19A_18B)
Run_19A_19C = c("Run_19C_Set_2", "Run_19C_Set_1", "Run_19C_Set_3", "Run_19C_Set_4","Run_19A_Set_1", "Run_19A_Set_2")
RIF_correct_19A_19C = Corrected_DNA_Damage %>% filter(Corrected_DNA_Damage$Run_set %in% Run_19A_19C)
# Select the 10 people that overlap in these two runs
Subject_18B_19A = c(1214, 1215,1216,1217,1218,1219,1220,1221,1222,1223)
Subject_19C_19A = c() ## Need to complete sample_ID of subjects that overlap in 19C and 19A

RIF_correct_19A_18B_10p = RIF_correct_19A_18B %>% filter(RIF_correct_19A_18B$Sample_ID %in% Subject_18B_19A )
RIF_correct_19A_19C_10p = RIF_correct_19A_19C %>% filter(RIF_correct_19A_19C$Sample_ID %in% Subject_19C_19A )


### 19C_Set_1: for each condition: time point, rad, and low high dose calculate the mean and variance that will be used as a reference 
Samp_19A_10p = RIF_correct_19A_18B_10p %>% filter(RIF_correct_19A_18B_10p$Run_set %in% Run_19A)

## For Controls 
Controls_19A= Samp_19A_10p
Controls_19A$avg_nfoci_low_dose=NULL
Controls_19A$avg_nfoci_high_dose=NULL
#
### 4h 
control_19A_4h = Controls_19A %>% filter(Controls_19A$Timepoint=="4h")
#
control_19A_4h_Fe = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Fe")
control_19A_4h_Ar = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Ar")
control_19A_4h_Si = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Si")
control_19A_4h_Gamma = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Gamma")
### 24h 
control_19A_24h = Controls_19A %>% filter(Controls_19A$Timepoint=="24h")
#
control_19A_24h_Fe = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Fe")
control_19A_24h_Ar = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Ar")
control_19A_24h_Si = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Si")
control_19A_24h_Gamma = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_ref_Cont_Fe_4h = mean(NaRV.omit(control_19A_4h_Fe$avg_nfoci_0))
Mean_ref_Cont_Ar_4h = mean(NaRV.omit(control_19A_4h_Ar$avg_nfoci_0))
Mean_ref_Cont_Si_4h = mean(NaRV.omit(control_19A_4h_Si$avg_nfoci_0))
Mean_ref_Cont_Gamma_4h = mean(NaRV.omit(control_19A_4h_Gamma$avg_nfoci_0))
# 24h
Mean_ref_Cont_Fe_24h = mean(NaRV.omit(control_19A_24h_Fe$avg_nfoci_0))
Mean_ref_Cont_Ar_24h = mean(NaRV.omit(control_19A_24h_Ar$avg_nfoci_0))
Mean_ref_Cont_Si_24h = mean(NaRV.omit(control_19A_24h_Si$avg_nfoci_0))
Mean_ref_Cont_Gamma_24h = mean(NaRV.omit(control_19A_24h_Gamma$avg_nfoci_0))
####### sd
# 4h
Std_ref_Cont_Fe_4h = sd(NaRV.omit(control_19A_4h_Fe$avg_nfoci_0))
Std_ref_Cont_Ar_4h = sd(NaRV.omit(control_19A_4h_Ar$avg_nfoci_0))
Std_ref_Cont_Si_4h = sd(NaRV.omit(control_19A_4h_Si$avg_nfoci_0))
Std_ref_Cont_Gamma_4h = sd(NaRV.omit(control_19A_4h_Gamma$avg_nfoci_0))
# 24h
Std_ref_Cont_Fe_24h = sd(NaRV.omit(control_19A_24h_Fe$avg_nfoci_0))
Std_ref_Cont_Ar_24h = sd(NaRV.omit(control_19A_24h_Ar$avg_nfoci_0))
Std_ref_Cont_Si_24h = sd(NaRV.omit(control_19A_24h_Si$avg_nfoci_0))
Std_ref_Cont_Gamma_24h = sd(NaRV.omit(control_19A_24h_Gamma$avg_nfoci_0))
#
#
## For Low dose irradiated samples
LD_19A= Samp_19A_10p
LD_19A$avg_nfoci_0=NULL
LD_19A$avg_nfoci_high_dose=NULL
#
### 4h 
LD_19A_4h = LD_19A %>% filter(LD_19A$Timepoint=="4h")
#
LD_19A_4h_Fe = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Fe")
LD_19A_4h_Ar = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Ar")
LD_19A_4h_Si = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Si")
LD_19A_4h_Gamma = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Gamma")
### 24h 
LD_19A_24h = LD_19A %>% filter(LD_19A$Timepoint=="24h")
#
LD_19A_24h_Fe = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Fe")
LD_19A_24h_Ar = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Ar")
LD_19A_24h_Si = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Si")
LD_19A_24h_Gamma = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_ref_LD_Fe_4h = mean(NaRV.omit(LD_19A_4h_Fe$avg_nfoci_low_dose))
Mean_ref_LD_Ar_4h = mean(NaRV.omit(LD_19A_4h_Ar$avg_nfoci_low_dose))
Mean_ref_LD_Si_4h = mean(NaRV.omit(LD_19A_4h_Si$avg_nfoci_low_dose))
Mean_ref_LD_Gamma_4h = mean(NaRV.omit(LD_19A_4h_Gamma$avg_nfoci_low_dose))
# 24h
Mean_ref_LD_Fe_24h = mean(NaRV.omit(LD_19A_24h_Fe$avg_nfoci_low_dose))
Mean_ref_LD_Ar_24h = mean(NaRV.omit(LD_19A_24h_Ar$avg_nfoci_low_dose))
Mean_ref_LD_Si_24h = mean(NaRV.omit(LD_19A_24h_Si$avg_nfoci_low_dose))
Mean_ref_LD_Gamma_24h = mean(NaRV.omit(LD_19A_24h_Gamma$avg_nfoci_low_dose))
####### sd
# 4h
Std_ref_LD_Fe_4h = sd(NaRV.omit(LD_19A_4h_Fe$avg_nfoci_low_dose))
Std_ref_LD_Ar_4h = sd(NaRV.omit(LD_19A_4h_Ar$avg_nfoci_low_dose))
Std_ref_LD_Si_4h = sd(NaRV.omit(LD_19A_4h_Si$avg_nfoci_low_dose))
Std_ref_LD_Gamma_4h = sd(NaRV.omit(LD_19A_4h_Gamma$avg_nfoci_low_dose))
# 24h
Std_ref_LD_Fe_24h = sd(NaRV.omit(LD_19A_24h_Fe$avg_nfoci_low_dose))
Std_ref_LD_Ar_24h = sd(NaRV.omit(LD_19A_24h_Ar$avg_nfoci_low_dose))
Std_ref_LD_Si_24h = sd(NaRV.omit(LD_19A_24h_Si$avg_nfoci_low_dose))
Std_ref_LD_Gamma_24h = sd(NaRV.omit(LD_19A_24h_Gamma$avg_nfoci_low_dose))
#
#
## For high dose irradiated samples
HD_19A= Samp_19A_10p
HD_19A$avg_nfoci_0=NULL
HD_19A$avg_nfoci_low_dose=NULL
#
### 4h 
HD_19A_4h = HD_19A %>% filter(HD_19A$Timepoint=="4h")
#
HD_19A_4h_Fe = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Fe")
HD_19A_4h_Ar = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Ar")
HD_19A_4h_Si = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Si")
HD_19A_4h_Gamma = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Gamma")
### 24h 
HD_19A_24h = HD_19A %>% filter(HD_19A$Timepoint=="24h")
#
HD_19A_24h_Fe = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Fe")
HD_19A_24h_Ar = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Ar")
HD_19A_24h_Si = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Si")
HD_19A_24h_Gamma = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_ref_HD_Fe_4h = mean(NaRV.omit(HD_19A_4h_Fe$avg_nfoci_high_dose))
Mean_ref_HD_Ar_4h = mean(NaRV.omit(HD_19A_4h_Ar$avg_nfoci_high_dose))
Mean_ref_HD_Si_4h = mean(NaRV.omit(HD_19A_4h_Si$avg_nfoci_high_dose))
Mean_ref_HD_Gamma_4h = mean(NaRV.omit(HD_19A_4h_Gamma$avg_nfoci_high_dose))
# 24h
Mean_ref_HD_Fe_24h = mean(NaRV.omit(HD_19A_24h_Fe$avg_nfoci_high_dose))
Mean_ref_HD_Ar_24h = mean(NaRV.omit(HD_19A_24h_Ar$avg_nfoci_high_dose))
Mean_ref_HD_Si_24h = mean(NaRV.omit(HD_19A_24h_Si$avg_nfoci_high_dose))
Mean_ref_HD_Gamma_24h = mean(NaRV.omit(HD_19A_24h_Gamma$avg_nfoci_high_dose))
####### sd
# 4h
Std_ref_HD_Fe_4h = sd(NaRV.omit(HD_19A_4h_Fe$avg_nfoci_high_dose))
Std_ref_HD_Ar_4h = sd(NaRV.omit(HD_19A_4h_Ar$avg_nfoci_high_dose))
Std_ref_HD_Si_4h = sd(NaRV.omit(HD_19A_4h_Si$avg_nfoci_high_dose))
Std_ref_HD_Gamma_4h = sd(NaRV.omit(HD_19A_4h_Gamma$avg_nfoci_high_dose))
# 24h
Std_ref_HD_Fe_24h = sd(NaRV.omit(HD_19A_24h_Fe$avg_nfoci_high_dose))
Std_ref_HD_Ar_24h = sd(NaRV.omit(HD_19A_24h_Ar$avg_nfoci_high_dose))
Std_ref_HD_Si_24h = sd(NaRV.omit(HD_19A_24h_Si$avg_nfoci_high_dose))
Std_ref_HD_Gamma_24h = sd(NaRV.omit(HD_19A_24h_Gamma$avg_nfoci_high_dose))


############################## For controls and irradiated samples 18B we also calculate mean and std to perform the "z-score" normalization
############ For the 10 peoples that overlap ##########
Samp_18B_10p = RIF_correct_19A_18B_10p %>% filter(RIF_correct_19A_18B_10p$Run_set %in% Run_18B)

## For Controls 
Controls_18B= Samp_18B_10p
Controls_18B$avg_nfoci_low_dose=NULL
Controls_18B$avg_nfoci_high_dose=NULL
#
### 4h 
control_18B_4h = Controls_18B %>% filter(Controls_18B$Timepoint=="4h")
#
control_18B_4h_Fe = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Fe")
control_18B_4h_Ar = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Ar")
control_18B_4h_Si = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Si")
control_18B_4h_Gamma = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Gamma")
### 24h 
control_18B_24h = Controls_18B %>% filter(Controls_18B$Timepoint=="24h")
#
control_18B_24h_Fe = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Fe")
control_18B_24h_Ar = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Ar")
control_18B_24h_Si = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Si")
control_18B_24h_Gamma = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_Cont_Fe_4h = mean(NaRV.omit(control_18B_4h_Fe$avg_nfoci_0))
Mean_Cont_Ar_4h = mean(NaRV.omit(control_18B_4h_Ar$avg_nfoci_0))
Mean_Cont_Si_4h = mean(NaRV.omit(control_18B_4h_Si$avg_nfoci_0))
Mean_Cont_Gamma_4h = mean(NaRV.omit(control_18B_4h_Gamma$avg_nfoci_0))
# 24h
Mean_Cont_Fe_24h = mean(NaRV.omit(control_18B_24h_Fe$avg_nfoci_0))
Mean_Cont_Ar_24h = mean(NaRV.omit(control_18B_24h_Ar$avg_nfoci_0))
Mean_Cont_Si_24h = mean(NaRV.omit(control_18B_24h_Si$avg_nfoci_0))
Mean_Cont_Gamma_24h = mean(NaRV.omit(control_18B_24h_Gamma$avg_nfoci_0))
####### sd
# 4h
Std_Cont_Fe_4h = sd(NaRV.omit(control_18B_4h_Fe$avg_nfoci_0))
Std_Cont_Ar_4h = sd(NaRV.omit(control_18B_4h_Ar$avg_nfoci_0))
Std_Cont_Si_4h = sd(NaRV.omit(control_18B_4h_Si$avg_nfoci_0))
Std_Cont_Gamma_4h = sd(NaRV.omit(control_18B_4h_Gamma$avg_nfoci_0))
# 24h
Std_Cont_Fe_24h = sd(NaRV.omit(control_18B_24h_Fe$avg_nfoci_0))
Std_Cont_Ar_24h = sd(NaRV.omit(control_18B_24h_Ar$avg_nfoci_0))
Std_Cont_Si_24h = sd(NaRV.omit(control_18B_24h_Si$avg_nfoci_0))
Std_Cont_Gamma_24h = sd(NaRV.omit(control_18B_24h_Gamma$avg_nfoci_0))
#
## z-score correction on all people from 18B
Controls_allp_18B= Corrected_DNA_Damage %>% filter(Corrected_DNA_Damage$Run_set %in% Run_18B)
Controls_allp_18B$avg_nfoci_low_dose=NULL
Controls_allp_18B$avg_nfoci_high_dose=NULL
#
### 4h 
control_allp_18B_4h = Controls_allp_18B %>% filter(Controls_allp_18B$Timepoint=="4h")
#
control_allp_18B_4h_Fe = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Fe")
control_allp_18B_4h_Ar = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Ar")
control_allp_18B_4h_Si = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Si")
control_allp_18B_4h_Gamma = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Gamma")
### 24h 
control_allp_18B_24h = Controls_allp_18B %>% filter(Controls_allp_18B$Timepoint=="24h")
#
control_allp_18B_24h_Fe = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Fe")
control_allp_18B_24h_Ar = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Ar")
control_allp_18B_24h_Si = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Si")
control_allp_18B_24h_Gamma = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Gamma")
## z-score correction
# 4h
control_allp_18B_4h_Fe$avg_nfoci_0 = (((control_allp_18B_4h_Fe$avg_nfoci_0 - Mean_Cont_Fe_4h)/Std_Cont_Fe_4h)*Std_ref_Cont_Fe_4h) + Mean_ref_Cont_Fe_4h
control_allp_18B_4h_Ar$avg_nfoci_0 = (((control_allp_18B_4h_Ar$avg_nfoci_0 - Mean_Cont_Ar_4h)/Std_Cont_Ar_4h)*Std_ref_Cont_Ar_4h) + Mean_ref_Cont_Ar_4h
control_allp_18B_4h_Si$avg_nfoci_0 = (((control_allp_18B_4h_Si$avg_nfoci_0 - Mean_Cont_Si_4h)/Std_Cont_Si_4h)*Std_ref_Cont_Si_4h) + Mean_ref_Cont_Si_4h
control_allp_18B_4h_Gamma$avg_nfoci_0 = (((control_allp_18B_4h_Gamma$avg_nfoci_0 - Mean_Cont_Gamma_4h)/Std_Cont_Gamma_4h)*Std_ref_Cont_Gamma_4h) + Mean_ref_Cont_Gamma_4h
# 24h
control_allp_18B_24h_Fe$avg_nfoci_0 = (((control_allp_18B_24h_Fe$avg_nfoci_0 - Mean_Cont_Fe_24h)/Std_Cont_Fe_24h)*Std_ref_Cont_Fe_24h) + Mean_ref_Cont_Fe_24h
control_allp_18B_24h_Ar$avg_nfoci_0 = (((control_allp_18B_24h_Ar$avg_nfoci_0 - Mean_Cont_Ar_24h)/Std_Cont_Ar_24h)*Std_ref_Cont_Ar_24h) + Mean_ref_Cont_Ar_24h
control_allp_18B_24h_Si$avg_nfoci_0 = (((control_allp_18B_24h_Si$avg_nfoci_0 - Mean_Cont_Si_24h)/Std_Cont_Si_24h)*Std_ref_Cont_Si_24h) + Mean_ref_Cont_Si_24h
control_allp_18B_24h_Gamma$avg_nfoci_0 = (((control_allp_18B_24h_Gamma$avg_nfoci_0 - Mean_Cont_Gamma_24h)/Std_Cont_Gamma_24h)*Std_ref_Cont_Gamma_24h) + Mean_ref_Cont_Gamma_24h
##
##
## For Low dose irradiated samples
LD_18B= Samp_18B_10p
LD_18B$avg_nfoci_0=NULL
LD_18B$avg_nfoci_high_dose=NULL
#
### 4h 
LD_18B_4h = LD_18B %>% filter(LD_18B$Timepoint=="4h")
#
LD_18B_4h_Fe = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Fe")
LD_18B_4h_Ar = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Ar")
LD_18B_4h_Si = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Si")
LD_18B_4h_Gamma = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Gamma")
### 24h 
LD_18B_24h = LD_18B %>% filter(LD_18B$Timepoint=="24h")
#
LD_18B_24h_Fe = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Fe")
LD_18B_24h_Ar = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Ar")
LD_18B_24h_Si = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Si")
LD_18B_24h_Gamma = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_LD_Fe_4h = mean(NaRV.omit(LD_18B_4h_Fe$avg_nfoci_low_dose))
Mean_LD_Ar_4h = mean(NaRV.omit(LD_18B_4h_Ar$avg_nfoci_low_dose))
Mean_LD_Si_4h = mean(NaRV.omit(LD_18B_4h_Si$avg_nfoci_low_dose))
Mean_LD_Gamma_4h = mean(NaRV.omit(LD_18B_4h_Gamma$avg_nfoci_low_dose))
# 24h
Mean_LD_Fe_24h = mean(NaRV.omit(LD_18B_24h_Fe$avg_nfoci_low_dose))
Mean_LD_Ar_24h = mean(NaRV.omit(LD_18B_24h_Ar$avg_nfoci_low_dose))
Mean_LD_Si_24h = mean(NaRV.omit(LD_18B_24h_Si$avg_nfoci_low_dose))
Mean_LD_Gamma_24h = mean(NaRV.omit(LD_18B_24h_Gamma$avg_nfoci_low_dose))
####### sd
# 4h
Std_LD_Fe_4h = sd(NaRV.omit(LD_18B_4h_Fe$avg_nfoci_low_dose))
Std_LD_Ar_4h = sd(NaRV.omit(LD_18B_4h_Ar$avg_nfoci_low_dose))
Std_LD_Si_4h = sd(NaRV.omit(LD_18B_4h_Si$avg_nfoci_low_dose))
Std_LD_Gamma_4h = sd(NaRV.omit(LD_18B_4h_Gamma$avg_nfoci_low_dose))
# 24h
Std_LD_Fe_24h = sd(NaRV.omit(LD_18B_24h_Fe$avg_nfoci_low_dose))
Std_LD_Ar_24h = sd(NaRV.omit(LD_18B_24h_Ar$avg_nfoci_low_dose))
Std_LD_Si_24h = sd(NaRV.omit(LD_18B_24h_Si$avg_nfoci_low_dose))
Std_LD_Gamma_24h = sd(NaRV.omit(LD_18B_24h_Gamma$avg_nfoci_low_dose))
#
#
## z-score correction on all people from 18B
LD_allp_18B= Corrected_DNA_Damage %>% filter(Corrected_DNA_Damage$Run_set %in% Run_18B)
LD_allp_18B$avg_nfoci_0=NULL
LD_allp_18B$avg_nfoci_high_dose=NULL
#
### 4h 
LD_allp_18B_4h = LD_allp_18B %>% filter(LD_allp_18B$Timepoint=="4h")
#
LD_allp_18B_4h_Fe = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Fe")
LD_allp_18B_4h_Ar = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Ar")
LD_allp_18B_4h_Si = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Si")
LD_allp_18B_4h_Gamma = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Gamma")
### 24h 
LD_allp_18B_24h = LD_allp_18B %>% filter(LD_allp_18B$Timepoint=="24h")
#
LD_allp_18B_24h_Fe = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Fe")
LD_allp_18B_24h_Ar = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Ar")
LD_allp_18B_24h_Si = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Si")
LD_allp_18B_24h_Gamma = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Gamma")

## z-score correction
# 4h
LD_allp_18B_4h_Fe$avg_nfoci_low_dose = (((LD_allp_18B_4h_Fe$avg_nfoci_low_dose - Mean_LD_Fe_4h)/Std_LD_Fe_4h)*Std_ref_LD_Fe_4h) + Mean_ref_LD_Fe_4h
LD_allp_18B_4h_Ar$avg_nfoci_low_dose = (((LD_allp_18B_4h_Ar$avg_nfoci_low_dose - Mean_LD_Ar_4h)/Std_LD_Ar_4h)*Std_ref_LD_Ar_4h) + Mean_ref_LD_Ar_4h
LD_allp_18B_4h_Si$avg_nfoci_low_dose = (((LD_allp_18B_4h_Si$avg_nfoci_low_dose - Mean_LD_Si_4h)/Std_LD_Si_4h)*Std_ref_LD_Si_4h) + Mean_ref_LD_Si_4h
LD_allp_18B_4h_Gamma$avg_nfoci_low_dose = (((LD_allp_18B_4h_Gamma$avg_nfoci_low_dose - Mean_LD_Gamma_4h)/Std_LD_Gamma_4h)*Std_ref_LD_Gamma_4h) + Mean_ref_LD_Gamma_4h
# 24h
LD_allp_18B_24h_Fe$avg_nfoci_low_dose = (((LD_allp_18B_24h_Fe$avg_nfoci_low_dose - Mean_LD_Fe_24h)/Std_LD_Fe_24h)*Std_ref_LD_Fe_24h) + Mean_ref_LD_Fe_24h
LD_allp_18B_24h_Ar$avg_nfoci_low_dose = (((LD_allp_18B_24h_Ar$avg_nfoci_low_dose - Mean_LD_Ar_24h)/Std_LD_Ar_24h)*Std_ref_LD_Ar_24h) + Mean_ref_LD_Ar_24h
LD_allp_18B_24h_Si$avg_nfoci_low_dose = (((LD_allp_18B_24h_Si$avg_nfoci_low_dose - Mean_LD_Si_24h)/Std_LD_Si_24h)*Std_ref_LD_Si_24h) + Mean_ref_LD_Si_24h
LD_allp_18B_24h_Gamma$avg_nfoci_low_dose = (((LD_allp_18B_24h_Gamma$avg_nfoci_low_dose - Mean_LD_Gamma_24h)/Std_LD_Gamma_24h)*Std_ref_LD_Gamma_24h) + Mean_ref_LD_Gamma_24h


## For high dose irradiated samples
HD_18B= Samp_18B_10p
HD_18B$avg_nfoci_0=NULL
HD_18B$avg_nfoci_low_dose=NULL
#
### 4h 
HD_18B_4h = HD_18B %>% filter(HD_18B$Timepoint=="4h")
#
HD_18B_4h_Fe = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Fe")
HD_18B_4h_Ar = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Ar")
HD_18B_4h_Si = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Si")
HD_18B_4h_Gamma = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Gamma")
### 24h 
HD_18B_24h = HD_18B %>% filter(HD_18B$Timepoint=="24h")
#
HD_18B_24h_Fe = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Fe")
HD_18B_24h_Ar = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Ar")
HD_18B_24h_Si = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Si")
HD_18B_24h_Gamma = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_HD_Fe_4h = mean(NaRV.omit(HD_18B_4h_Fe$avg_nfoci_high_dose))
Mean_HD_Ar_4h = mean(NaRV.omit(HD_18B_4h_Ar$avg_nfoci_high_dose))
Mean_HD_Si_4h = mean(NaRV.omit(HD_18B_4h_Si$avg_nfoci_high_dose))
Mean_HD_Gamma_4h = mean(NaRV.omit(HD_18B_4h_Gamma$avg_nfoci_high_dose))
# 24h
Mean_HD_Fe_24h = mean(NaRV.omit(HD_18B_24h_Fe$avg_nfoci_high_dose))
Mean_HD_Ar_24h = mean(NaRV.omit(HD_18B_24h_Ar$avg_nfoci_high_dose))
Mean_HD_Si_24h = mean(NaRV.omit(HD_18B_24h_Si$avg_nfoci_high_dose))
Mean_HD_Gamma_24h = mean(NaRV.omit(HD_18B_24h_Gamma$avg_nfoci_high_dose))
####### sd
# 4h
Std_HD_Fe_4h = sd(NaRV.omit(HD_18B_4h_Fe$avg_nfoci_high_dose))
Std_HD_Ar_4h = sd(NaRV.omit(HD_18B_4h_Ar$avg_nfoci_high_dose))
Std_HD_Si_4h = sd(NaRV.omit(HD_18B_4h_Si$avg_nfoci_high_dose))
Std_HD_Gamma_4h = sd(NaRV.omit(HD_18B_4h_Gamma$avg_nfoci_high_dose))
# 24h
Std_HD_Fe_24h = sd(NaRV.omit(HD_18B_24h_Fe$avg_nfoci_high_dose))
Std_HD_Ar_24h = sd(NaRV.omit(HD_18B_24h_Ar$avg_nfoci_high_dose))
Std_HD_Si_24h = sd(NaRV.omit(HD_18B_24h_Si$avg_nfoci_high_dose))
Std_HD_Gamma_24h = sd(NaRV.omit(HD_18B_24h_Gamma$avg_nfoci_high_dose))
#
#
## z-score correction on all people from 18B
HD_allp_18B= Corrected_DNA_Damage %>% filter(Corrected_DNA_Damage$Run_set %in% Run_18B)
HD_allp_18B$avg_nfoci_0=NULL
HD_allp_18B$avg_nfoci_low_dose=NULL
#
### 4h 
HD_allp_18B_4h = HD_allp_18B %>% filter(HD_allp_18B$Timepoint=="4h")
#
HD_allp_18B_4h_Fe = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Fe")
HD_allp_18B_4h_Ar = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Ar")
HD_allp_18B_4h_Si = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Si")
HD_allp_18B_4h_Gamma = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Gamma")
### 24h 
HD_allp_18B_24h = HD_allp_18B %>% filter(HD_allp_18B$Timepoint=="24h")
#
HD_allp_18B_24h_Fe = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Fe")
HD_allp_18B_24h_Ar = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Ar")
HD_allp_18B_24h_Si = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Si")
HD_allp_18B_24h_Gamma = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Gamma")

## z-score correction
# 4h
HD_allp_18B_4h_Fe$avg_nfoci_high_dose = (((HD_allp_18B_4h_Fe$avg_nfoci_high_dose - Mean_HD_Fe_4h)/Std_HD_Fe_4h)*Std_ref_HD_Fe_4h) + Mean_ref_HD_Fe_4h
HD_allp_18B_4h_Ar$avg_nfoci_high_dose = (((HD_allp_18B_4h_Ar$avg_nfoci_high_dose - Mean_HD_Ar_4h)/Std_HD_Ar_4h)*Std_ref_HD_Ar_4h) + Mean_ref_HD_Ar_4h
HD_allp_18B_4h_Si$avg_nfoci_high_dose = (((HD_allp_18B_4h_Si$avg_nfoci_high_dose - Mean_HD_Si_4h)/Std_HD_Si_4h)*Std_ref_HD_Si_4h) + Mean_ref_HD_Si_4h
HD_allp_18B_4h_Gamma$avg_nfoci_high_dose = (((HD_allp_18B_4h_Gamma$avg_nfoci_high_dose - Mean_HD_Gamma_4h)/Std_HD_Gamma_4h)*Std_ref_HD_Gamma_4h) + Mean_ref_HD_Gamma_4h
# 24h
HD_allp_18B_24h_Fe$avg_nfoci_high_dose = (((HD_allp_18B_24h_Fe$avg_nfoci_high_dose - Mean_HD_Fe_24h)/Std_HD_Fe_24h)*Std_ref_HD_Fe_24h) + Mean_ref_HD_Fe_24h
HD_allp_18B_24h_Ar$avg_nfoci_high_dose = (((HD_allp_18B_24h_Ar$avg_nfoci_high_dose - Mean_HD_Ar_24h)/Std_HD_Ar_24h)*Std_ref_HD_Ar_24h) + Mean_ref_HD_Ar_24h
HD_allp_18B_24h_Si$avg_nfoci_high_dose = (((HD_allp_18B_24h_Si$avg_nfoci_high_dose - Mean_HD_Si_24h)/Std_HD_Si_24h)*Std_ref_HD_Si_24h) + Mean_ref_HD_Si_24h
HD_allp_18B_24h_Gamma$avg_nfoci_high_dose = (((HD_allp_18B_24h_Gamma$avg_nfoci_high_dose - Mean_HD_Gamma_24h)/Std_HD_Gamma_24h)*Std_ref_HD_Gamma_24h) + Mean_ref_HD_Gamma_24h






############################## For controls and irradiated samples 19C we also calculate mean and std to perform the "z-score" normalization
############ For the 10 peoples that overlap ##########

Samp_19C_10p = RIF_correct_19A_19C_10p %>% filter(RIF_correct_19A_19C_10p$Run_set %in% Run_19C)

## For Controls 
Controls_19C= Samp_19C_10p
Controls_19C$avg_nfoci_low_dose=NULL
Controls_19C$avg_nfoci_high_dose=NULL
#
### 4h 
control_19C_4h = Controls_19C %>% filter(Controls_19C$Timepoint=="4h")
#
control_19C_4h_Fe = control_19C_4h %>% filter(control_19C_4h$Radiation_type=="Fe")
control_19C_4h_Ar = control_19C_4h %>% filter(control_19C_4h$Radiation_type=="Ar")
control_19C_4h_Si = control_19C_4h %>% filter(control_19C_4h$Radiation_type=="Si")
control_19C_4h_Gamma = control_19C_4h %>% filter(control_19C_4h$Radiation_type=="Gamma")
### 24h 
control_19C_24h = Controls_19C %>% filter(Controls_19C$Timepoint=="24h")
#
control_19C_24h_Fe = control_19C_24h %>% filter(control_19C_24h$Radiation_type=="Fe")
control_19C_24h_Ar = control_19C_24h %>% filter(control_19C_24h$Radiation_type=="Ar")
control_19C_24h_Si = control_19C_24h %>% filter(control_19C_24h$Radiation_type=="Si")
control_19C_24h_Gamma = control_19C_24h %>% filter(control_19C_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_Cont_Fe_4h = mean(NaRV.omit(control_19C_4h_Fe$avg_nfoci_0))
Mean_Cont_Ar_4h = mean(NaRV.omit(control_19C_4h_Ar$avg_nfoci_0))
Mean_Cont_Si_4h = mean(NaRV.omit(control_19C_4h_Si$avg_nfoci_0))
Mean_Cont_Gamma_4h = mean(NaRV.omit(control_19C_4h_Gamma$avg_nfoci_0))
# 24h
Mean_Cont_Fe_24h = mean(NaRV.omit(control_19C_24h_Fe$avg_nfoci_0))
Mean_Cont_Ar_24h = mean(NaRV.omit(control_19C_24h_Ar$avg_nfoci_0))
Mean_Cont_Si_24h = mean(NaRV.omit(control_19C_24h_Si$avg_nfoci_0))
Mean_Cont_Gamma_24h = mean(NaRV.omit(control_19C_24h_Gamma$avg_nfoci_0))
####### sd
# 4h
Std_Cont_Fe_4h = sd(NaRV.omit(control_19C_4h_Fe$avg_nfoci_0))
Std_Cont_Ar_4h = sd(NaRV.omit(control_19C_4h_Ar$avg_nfoci_0))
Std_Cont_Si_4h = sd(NaRV.omit(control_19C_4h_Si$avg_nfoci_0))
Std_Cont_Gamma_4h = sd(NaRV.omit(control_19C_4h_Gamma$avg_nfoci_0))
# 24h
Std_Cont_Fe_24h = sd(NaRV.omit(control_19C_24h_Fe$avg_nfoci_0))
Std_Cont_Ar_24h = sd(NaRV.omit(control_19C_24h_Ar$avg_nfoci_0))
Std_Cont_Si_24h = sd(NaRV.omit(control_19C_24h_Si$avg_nfoci_0))
Std_Cont_Gamma_24h = sd(NaRV.omit(control_19C_24h_Gamma$avg_nfoci_0))
#
## z-score correction on all people from 19C
Controls_allp_19C= Corrected_DNA_Damage %>% filter(Corrected_DNA_Damage$Run_set %in% Run_19C)
Controls_allp_19C$avg_nfoci_low_dose=NULL
Controls_allp_19C$avg_nfoci_high_dose=NULL
#
### 4h 
control_allp_19C_4h = Controls_allp_19C %>% filter(Controls_allp_19C$Timepoint=="4h")
#
control_allp_19C_4h_Fe = control_allp_19C_4h %>% filter(control_allp_19C_4h$Radiation_type=="Fe")
control_allp_19C_4h_Ar = control_allp_19C_4h %>% filter(control_allp_19C_4h$Radiation_type=="Ar")
control_allp_19C_4h_Si = control_allp_19C_4h %>% filter(control_allp_19C_4h$Radiation_type=="Si")
control_allp_19C_4h_Gamma = control_allp_19C_4h %>% filter(control_allp_19C_4h$Radiation_type=="Gamma")
### 24h 
control_allp_19C_24h = Controls_allp_19C %>% filter(Controls_allp_19C$Timepoint=="24h")
#
control_allp_19C_24h_Fe = control_allp_19C_24h %>% filter(control_allp_19C_24h$Radiation_type=="Fe")
control_allp_19C_24h_Ar = control_allp_19C_24h %>% filter(control_allp_19C_24h$Radiation_type=="Ar")
control_allp_19C_24h_Si = control_allp_19C_24h %>% filter(control_allp_19C_24h$Radiation_type=="Si")
control_allp_19C_24h_Gamma = control_allp_19C_24h %>% filter(control_allp_19C_24h$Radiation_type=="Gamma")
## z-score correction
# 4h
control_allp_19C_4h_Fe$avg_nfoci_0 = (((control_allp_19C_4h_Fe$avg_nfoci_0 - Mean_Cont_Fe_4h)/Std_Cont_Fe_4h)*Std_ref_Cont_Fe_4h) + Mean_ref_Cont_Fe_4h
control_allp_19C_4h_Ar$avg_nfoci_0 = (((control_allp_19C_4h_Ar$avg_nfoci_0 - Mean_Cont_Ar_4h)/Std_Cont_Ar_4h)*Std_ref_Cont_Ar_4h) + Mean_ref_Cont_Ar_4h
control_allp_19C_4h_Si$avg_nfoci_0 = (((control_allp_19C_4h_Si$avg_nfoci_0 - Mean_Cont_Si_4h)/Std_Cont_Si_4h)*Std_ref_Cont_Si_4h) + Mean_ref_Cont_Si_4h
control_allp_19C_4h_Gamma$avg_nfoci_0 = (((control_allp_19C_4h_Gamma$avg_nfoci_0 - Mean_Cont_Gamma_4h)/Std_Cont_Gamma_4h)*Std_ref_Cont_Gamma_4h) + Mean_ref_Cont_Gamma_4h
# 24h
control_allp_19C_24h_Fe$avg_nfoci_0 = (((control_allp_19C_24h_Fe$avg_nfoci_0 - Mean_Cont_Fe_24h)/Std_Cont_Fe_24h)*Std_ref_Cont_Fe_24h) + Mean_ref_Cont_Fe_24h
control_allp_19C_24h_Ar$avg_nfoci_0 = (((control_allp_19C_24h_Ar$avg_nfoci_0 - Mean_Cont_Ar_24h)/Std_Cont_Ar_24h)*Std_ref_Cont_Ar_24h) + Mean_ref_Cont_Ar_24h
control_allp_19C_24h_Si$avg_nfoci_0 = (((control_allp_19C_24h_Si$avg_nfoci_0 - Mean_Cont_Si_24h)/Std_Cont_Si_24h)*Std_ref_Cont_Si_24h) + Mean_ref_Cont_Si_24h
control_allp_19C_24h_Gamma$avg_nfoci_0 = (((control_allp_19C_24h_Gamma$avg_nfoci_0 - Mean_Cont_Gamma_24h)/Std_Cont_Gamma_24h)*Std_ref_Cont_Gamma_24h) + Mean_ref_Cont_Gamma_24h
##
##
## For Low dose irradiated samples
LD_19C= Samp_19C_10p
LD_19C$avg_nfoci_0=NULL
LD_19C$avg_nfoci_high_dose=NULL
#
### 4h 
LD_19C_4h = LD_19C %>% filter(LD_19C$Timepoint=="4h")
#
LD_19C_4h_Fe = LD_19C_4h %>% filter(LD_19C_4h$Radiation_type=="Fe")
LD_19C_4h_Ar = LD_19C_4h %>% filter(LD_19C_4h$Radiation_type=="Ar")
LD_19C_4h_Si = LD_19C_4h %>% filter(LD_19C_4h$Radiation_type=="Si")
LD_19C_4h_Gamma = LD_19C_4h %>% filter(LD_19C_4h$Radiation_type=="Gamma")
### 24h 
LD_19C_24h = LD_19C %>% filter(LD_19C$Timepoint=="24h")
#
LD_19C_24h_Fe = LD_19C_24h %>% filter(LD_19C_24h$Radiation_type=="Fe")
LD_19C_24h_Ar = LD_19C_24h %>% filter(LD_19C_24h$Radiation_type=="Ar")
LD_19C_24h_Si = LD_19C_24h %>% filter(LD_19C_24h$Radiation_type=="Si")
LD_19C_24h_Gamma = LD_19C_24h %>% filter(LD_19C_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_LD_Fe_4h = mean(NaRV.omit(LD_19C_4h_Fe$avg_nfoci_low_dose))
Mean_LD_Ar_4h = mean(NaRV.omit(LD_19C_4h_Ar$avg_nfoci_low_dose))
Mean_LD_Si_4h = mean(NaRV.omit(LD_19C_4h_Si$avg_nfoci_low_dose))
Mean_LD_Gamma_4h = mean(NaRV.omit(LD_19C_4h_Gamma$avg_nfoci_low_dose))
# 24h
Mean_LD_Fe_24h = mean(NaRV.omit(LD_19C_24h_Fe$avg_nfoci_low_dose))
Mean_LD_Ar_24h = mean(NaRV.omit(LD_19C_24h_Ar$avg_nfoci_low_dose))
Mean_LD_Si_24h = mean(NaRV.omit(LD_19C_24h_Si$avg_nfoci_low_dose))
Mean_LD_Gamma_24h = mean(NaRV.omit(LD_19C_24h_Gamma$avg_nfoci_low_dose))
####### sd
# 4h
Std_LD_Fe_4h = sd(NaRV.omit(LD_19C_4h_Fe$avg_nfoci_low_dose))
Std_LD_Ar_4h = sd(NaRV.omit(LD_19C_4h_Ar$avg_nfoci_low_dose))
Std_LD_Si_4h = sd(NaRV.omit(LD_19C_4h_Si$avg_nfoci_low_dose))
Std_LD_Gamma_4h = sd(NaRV.omit(LD_19C_4h_Gamma$avg_nfoci_low_dose))
# 24h
Std_LD_Fe_24h = sd(NaRV.omit(LD_19C_24h_Fe$avg_nfoci_low_dose))
Std_LD_Ar_24h = sd(NaRV.omit(LD_19C_24h_Ar$avg_nfoci_low_dose))
Std_LD_Si_24h = sd(NaRV.omit(LD_19C_24h_Si$avg_nfoci_low_dose))
Std_LD_Gamma_24h = sd(NaRV.omit(LD_19C_24h_Gamma$avg_nfoci_low_dose))
#
#
## z-score correction on all people from 19C
LD_allp_19C= Corrected_DNA_Damage %>% filter(Corrected_DNA_Damage$Run_set %in% Run_19C)
LD_allp_19C$avg_nfoci_0=NULL
LD_allp_19C$avg_nfoci_high_dose=NULL
#
### 4h 
LD_allp_19C_4h = LD_allp_19C %>% filter(LD_allp_19C$Timepoint=="4h")
#
LD_allp_19C_4h_Fe = LD_allp_19C_4h %>% filter(LD_allp_19C_4h$Radiation_type=="Fe")
LD_allp_19C_4h_Ar = LD_allp_19C_4h %>% filter(LD_allp_19C_4h$Radiation_type=="Ar")
LD_allp_19C_4h_Si = LD_allp_19C_4h %>% filter(LD_allp_19C_4h$Radiation_type=="Si")
LD_allp_19C_4h_Gamma = LD_allp_19C_4h %>% filter(LD_allp_19C_4h$Radiation_type=="Gamma")
### 24h 
LD_allp_19C_24h = LD_allp_19C %>% filter(LD_allp_19C$Timepoint=="24h")
#
LD_allp_19C_24h_Fe = LD_allp_19C_24h %>% filter(LD_allp_19C_24h$Radiation_type=="Fe")
LD_allp_19C_24h_Ar = LD_allp_19C_24h %>% filter(LD_allp_19C_24h$Radiation_type=="Ar")
LD_allp_19C_24h_Si = LD_allp_19C_24h %>% filter(LD_allp_19C_24h$Radiation_type=="Si")
LD_allp_19C_24h_Gamma = LD_allp_19C_24h %>% filter(LD_allp_19C_24h$Radiation_type=="Gamma")

## z-score correction
# 4h
LD_allp_19C_4h_Fe$avg_nfoci_low_dose = (((LD_allp_19C_4h_Fe$avg_nfoci_low_dose - Mean_LD_Fe_4h)/Std_LD_Fe_4h)*Std_ref_LD_Fe_4h) + Mean_ref_LD_Fe_4h
LD_allp_19C_4h_Ar$avg_nfoci_low_dose = (((LD_allp_19C_4h_Ar$avg_nfoci_low_dose - Mean_LD_Ar_4h)/Std_LD_Ar_4h)*Std_ref_LD_Ar_4h) + Mean_ref_LD_Ar_4h
LD_allp_19C_4h_Si$avg_nfoci_low_dose = (((LD_allp_19C_4h_Si$avg_nfoci_low_dose - Mean_LD_Si_4h)/Std_LD_Si_4h)*Std_ref_LD_Si_4h) + Mean_ref_LD_Si_4h
LD_allp_19C_4h_Gamma$avg_nfoci_low_dose = (((LD_allp_19C_4h_Gamma$avg_nfoci_low_dose - Mean_LD_Gamma_4h)/Std_LD_Gamma_4h)*Std_ref_LD_Gamma_4h) + Mean_ref_LD_Gamma_4h
# 24h
LD_allp_19C_24h_Fe$avg_nfoci_low_dose = (((LD_allp_19C_24h_Fe$avg_nfoci_low_dose - Mean_LD_Fe_24h)/Std_LD_Fe_24h)*Std_ref_LD_Fe_24h) + Mean_ref_LD_Fe_24h
LD_allp_19C_24h_Ar$avg_nfoci_low_dose = (((LD_allp_19C_24h_Ar$avg_nfoci_low_dose - Mean_LD_Ar_24h)/Std_LD_Ar_24h)*Std_ref_LD_Ar_24h) + Mean_ref_LD_Ar_24h
LD_allp_19C_24h_Si$avg_nfoci_low_dose = (((LD_allp_19C_24h_Si$avg_nfoci_low_dose - Mean_LD_Si_24h)/Std_LD_Si_24h)*Std_ref_LD_Si_24h) + Mean_ref_LD_Si_24h
LD_allp_19C_24h_Gamma$avg_nfoci_low_dose = (((LD_allp_19C_24h_Gamma$avg_nfoci_low_dose - Mean_LD_Gamma_24h)/Std_LD_Gamma_24h)*Std_ref_LD_Gamma_24h) + Mean_ref_LD_Gamma_24h


## For high dose irradiated samples
HD_19C= Samp_19C_10p
HD_19C$avg_nfoci_0=NULL
HD_19C$avg_nfoci_low_dose=NULL
#
### 4h 
HD_19C_4h = HD_19C %>% filter(HD_19C$Timepoint=="4h")
#
HD_19C_4h_Fe = HD_19C_4h %>% filter(HD_19C_4h$Radiation_type=="Fe")
HD_19C_4h_Ar = HD_19C_4h %>% filter(HD_19C_4h$Radiation_type=="Ar")
HD_19C_4h_Si = HD_19C_4h %>% filter(HD_19C_4h$Radiation_type=="Si")
HD_19C_4h_Gamma = HD_19C_4h %>% filter(HD_19C_4h$Radiation_type=="Gamma")
### 24h 
HD_19C_24h = HD_19C %>% filter(HD_19C$Timepoint=="24h")
#
HD_19C_24h_Fe = HD_19C_24h %>% filter(HD_19C_24h$Radiation_type=="Fe")
HD_19C_24h_Ar = HD_19C_24h %>% filter(HD_19C_24h$Radiation_type=="Ar")
HD_19C_24h_Si = HD_19C_24h %>% filter(HD_19C_24h$Radiation_type=="Si")
HD_19C_24h_Gamma = HD_19C_24h %>% filter(HD_19C_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_HD_Fe_4h = mean(NaRV.omit(HD_19C_4h_Fe$avg_nfoci_high_dose))
Mean_HD_Ar_4h = mean(NaRV.omit(HD_19C_4h_Ar$avg_nfoci_high_dose))
Mean_HD_Si_4h = mean(NaRV.omit(HD_19C_4h_Si$avg_nfoci_high_dose))
Mean_HD_Gamma_4h = mean(NaRV.omit(HD_19C_4h_Gamma$avg_nfoci_high_dose))
# 24h
Mean_HD_Fe_24h = mean(NaRV.omit(HD_19C_24h_Fe$avg_nfoci_high_dose))
Mean_HD_Ar_24h = mean(NaRV.omit(HD_19C_24h_Ar$avg_nfoci_high_dose))
Mean_HD_Si_24h = mean(NaRV.omit(HD_19C_24h_Si$avg_nfoci_high_dose))
Mean_HD_Gamma_24h = mean(NaRV.omit(HD_19C_24h_Gamma$avg_nfoci_high_dose))
####### sd
# 4h
Std_HD_Fe_4h = sd(NaRV.omit(HD_19C_4h_Fe$avg_nfoci_high_dose))
Std_HD_Ar_4h = sd(NaRV.omit(HD_19C_4h_Ar$avg_nfoci_high_dose))
Std_HD_Si_4h = sd(NaRV.omit(HD_19C_4h_Si$avg_nfoci_high_dose))
Std_HD_Gamma_4h = sd(NaRV.omit(HD_19C_4h_Gamma$avg_nfoci_high_dose))
# 24h
Std_HD_Fe_24h = sd(NaRV.omit(HD_19C_24h_Fe$avg_nfoci_high_dose))
Std_HD_Ar_24h = sd(NaRV.omit(HD_19C_24h_Ar$avg_nfoci_high_dose))
Std_HD_Si_24h = sd(NaRV.omit(HD_19C_24h_Si$avg_nfoci_high_dose))
Std_HD_Gamma_24h = sd(NaRV.omit(HD_19C_24h_Gamma$avg_nfoci_high_dose))
#
#
## z-score correction on all people from 19C
HD_allp_19C= Corrected_DNA_Damage %>% filter(Corrected_DNA_Damage$Run_set %in% Run_19C)
HD_allp_19C$avg_nfoci_0=NULL
HD_allp_19C$avg_nfoci_low_dose=NULL
#
### 4h 
HD_allp_19C_4h = HD_allp_19C %>% filter(HD_allp_19C$Timepoint=="4h")
#
HD_allp_19C_4h_Fe = HD_allp_19C_4h %>% filter(HD_allp_19C_4h$Radiation_type=="Fe")
HD_allp_19C_4h_Ar = HD_allp_19C_4h %>% filter(HD_allp_19C_4h$Radiation_type=="Ar")
HD_allp_19C_4h_Si = HD_allp_19C_4h %>% filter(HD_allp_19C_4h$Radiation_type=="Si")
HD_allp_19C_4h_Gamma = HD_allp_19C_4h %>% filter(HD_allp_19C_4h$Radiation_type=="Gamma")
### 24h 
HD_allp_19C_24h = HD_allp_19C %>% filter(HD_allp_19C$Timepoint=="24h")
#
HD_allp_19C_24h_Fe = HD_allp_19C_24h %>% filter(HD_allp_19C_24h$Radiation_type=="Fe")
HD_allp_19C_24h_Ar = HD_allp_19C_24h %>% filter(HD_allp_19C_24h$Radiation_type=="Ar")
HD_allp_19C_24h_Si = HD_allp_19C_24h %>% filter(HD_allp_19C_24h$Radiation_type=="Si")
HD_allp_19C_24h_Gamma = HD_allp_19C_24h %>% filter(HD_allp_19C_24h$Radiation_type=="Gamma")

## z-score correction
# 4h
HD_allp_19C_4h_Fe$avg_nfoci_high_dose = (((HD_allp_19C_4h_Fe$avg_nfoci_high_dose - Mean_HD_Fe_4h)/Std_HD_Fe_4h)*Std_ref_HD_Fe_4h) + Mean_ref_HD_Fe_4h
HD_allp_19C_4h_Ar$avg_nfoci_high_dose = (((HD_allp_19C_4h_Ar$avg_nfoci_high_dose - Mean_HD_Ar_4h)/Std_HD_Ar_4h)*Std_ref_HD_Ar_4h) + Mean_ref_HD_Ar_4h
HD_allp_19C_4h_Si$avg_nfoci_high_dose = (((HD_allp_19C_4h_Si$avg_nfoci_high_dose - Mean_HD_Si_4h)/Std_HD_Si_4h)*Std_ref_HD_Si_4h) + Mean_ref_HD_Si_4h
HD_allp_19C_4h_Gamma$avg_nfoci_high_dose = (((HD_allp_19C_4h_Gamma$avg_nfoci_high_dose - Mean_HD_Gamma_4h)/Std_HD_Gamma_4h)*Std_ref_HD_Gamma_4h) + Mean_ref_HD_Gamma_4h
# 24h
HD_allp_19C_24h_Fe$avg_nfoci_high_dose = (((HD_allp_19C_24h_Fe$avg_nfoci_high_dose - Mean_HD_Fe_24h)/Std_HD_Fe_24h)*Std_ref_HD_Fe_24h) + Mean_ref_HD_Fe_24h
HD_allp_19C_24h_Ar$avg_nfoci_high_dose = (((HD_allp_19C_24h_Ar$avg_nfoci_high_dose - Mean_HD_Ar_24h)/Std_HD_Ar_24h)*Std_ref_HD_Ar_24h) + Mean_ref_HD_Ar_24h
HD_allp_19C_24h_Si$avg_nfoci_high_dose = (((HD_allp_19C_24h_Si$avg_nfoci_high_dose - Mean_HD_Si_24h)/Std_HD_Si_24h)*Std_ref_HD_Si_24h) + Mean_ref_HD_Si_24h
HD_allp_19C_24h_Gamma$avg_nfoci_high_dose = (((HD_allp_19C_24h_Gamma$avg_nfoci_high_dose - Mean_HD_Gamma_24h)/Std_HD_Gamma_24h)*Std_ref_HD_Gamma_24h) + Mean_ref_HD_Gamma_24h

### Now we regroup everything
## regroup 18B
Cont_18B_All_rad= bind_rows(control_allp_18B_4h_Fe,  control_allp_18B_24h_Fe, 
                            control_allp_18B_4h_Ar,  control_allp_18B_24h_Ar,
                            control_allp_18B_4h_Si,  control_allp_18B_24h_Si,
                            control_allp_18B_4h_Gamma,  control_allp_18B_24h_Gamma)
colnames(Cont_18B_All_rad)[colnames(Cont_18B_All_rad)=="avg_nfoci_0"]<- "RIF"
Cont_18B_All_rad$Dose_relative="0 Gy control"


LD_18B_All_rad= bind_rows(LD_allp_18B_4h_Fe,  LD_allp_18B_24h_Fe, 
                          LD_allp_18B_4h_Ar,  LD_allp_18B_24h_Ar,
                          LD_allp_18B_4h_Si,  LD_allp_18B_24h_Si,
                          LD_allp_18B_4h_Gamma,  LD_allp_18B_24h_Gamma)
colnames(LD_18B_All_rad)[colnames(LD_18B_All_rad)=="avg_nfoci_low_dose"]<- "RIF"
LD_18B_All_rad$Dose_relative = "Low dose"


HD_18B_All_rad= bind_rows(HD_allp_18B_4h_Fe,  HD_allp_18B_24h_Fe, 
                          HD_allp_18B_4h_Ar,  HD_allp_18B_24h_Ar,
                          HD_allp_18B_4h_Si,  HD_allp_18B_24h_Si,
                          HD_allp_18B_4h_Gamma,  HD_allp_18B_24h_Gamma)
colnames(HD_18B_All_rad)[colnames(HD_18B_All_rad)=="avg_nfoci_high_dose"]<- "RIF"
HD_18B_All_rad$Dose_relative = "High dose"

## regroup 19C
Cont_19C_All_rad= bind_rows(control_allp_19C_4h_Fe,  control_allp_19C_24h_Fe, 
                            control_allp_19C_4h_Ar,  control_allp_19C_24h_Ar,
                            control_allp_19C_4h_Si,  control_allp_19C_24h_Si,
                            control_allp_19C_4h_Gamma,  control_allp_19C_24h_Gamma)
colnames(Cont_19C_All_rad)[colnames(Cont_19C_All_rad)=="avg_nfoci_0"]<- "RIF"
Cont_19C_All_rad$Dose_relative="0 Gy control"

LD_19C_All_rad= bind_rows(LD_allp_19C_4h_Fe,  LD_allp_19C_24h_Fe, 
                          LD_allp_19C_4h_Ar,  LD_allp_19C_24h_Ar,
                          LD_allp_19C_4h_Si,  LD_allp_19C_24h_Si,
                          LD_allp_19C_4h_Gamma,  LD_allp_19C_24h_Gamma)
colnames(LD_19C_All_rad)[colnames(LD_19C_All_rad)=="avg_nfoci_low_dose"]<- "RIF"
LD_19C_All_rad$Dose_relative="Low dose"

HD_19C_All_rad= bind_rows(HD_allp_19C_4h_Fe,  HD_allp_19C_24h_Fe, 
                          HD_allp_19C_4h_Ar,  HD_allp_19C_24h_Ar,
                          HD_allp_19C_4h_Si,  HD_allp_19C_24h_Si,
                          HD_allp_19C_4h_Gamma,  HD_allp_19C_24h_Gamma)
colnames(HD_19C_All_rad)[colnames(HD_19C_All_rad)=="avg_nfoci_high_dose"]<- "RIF"
HD_19C_All_rad$Dose_relative="High dose"


#19A was used as reference: data were not modified. We format the table to fit the same structure as 18B and 19C 
Samp_19A_allp_cont = Corrected_DNA_Damage %>% filter(Corrected_DNA_Damage$Run_set %in% Run_19A)
Samp_19A_allp_cont$avg_nfoci_low_dose = NULL
Samp_19A_allp_cont$avg_nfoci_high_dose = NULL
colnames(Samp_19A_allp_cont)[colnames(Samp_19A_allp_cont)=="avg_nfoci_0"]<- "RIF"
Samp_19A_allp_cont$Dose_relative="0 Gy control"


Samp_19A_allp_LD = Corrected_DNA_Damage %>% filter(Corrected_DNA_Damage$Run_set %in% Run_19A)
Samp_19A_allp_LD$avg_nfoci_high_dose = NULL
Samp_19A_allp_LD$avg_nfoci_0 = NULL
colnames(Samp_19A_allp_LD)[colnames(Samp_19A_allp_LD)=="avg_nfoci_low_dose"]<- "RIF"
Samp_19A_allp_LD$Dose_relative="Low dose"


Samp_19A_allp_HD = Corrected_DNA_Damage %>% filter(Corrected_DNA_Damage$Run_set %in% Run_19A)
Samp_19A_allp_HD$avg_nfoci_low_dose = NULL
Samp_19A_allp_HD$avg_nfoci_0 = NULL
colnames(Samp_19A_allp_HD)[colnames(Samp_19A_allp_HD)=="avg_nfoci_high_dose"]<- "RIF"
Samp_19A_allp_HD$Dose_relative="High dose"





#### Regroup all runs and sets
All_Corrected_DD = bind_rows(Cont_18B_All_rad, LD_18B_All_rad, HD_18B_All_rad,
                             Cont_19C_All_rad, LD_19C_All_rad, HD_19C_All_rad,
                             Samp_19A_allp_cont, Samp_19A_allp_LD, Samp_19A_allp_HD)

colnames(All_Corrected_DD)[colnames(All_Corrected_DD)=="RIF"]<- "avg_nfoci"

#### The correction may generate negative value => we fix those negative value to 0 
All_Corrected_DD$avg_foci[All_Corrected_DD$avg_foci < 0] <-  0 


```








```{r}

##################################################################################################
################################ Read Baseline DATA + Correction #################################
##################################################################################################

# Baseline data avg_nfoci
baseline_plate_nums = c(319,320,321,322,323,324,428, 429, 430, 431, 432, 625, 626, 627, 628, 629, 630)
baseline_plate_count = length(baseline_plate_nums)

subject_meta = read.csv('Baseline_metadata.csv', sep = ",", header = TRUE)
subject_ids = unique(subject_meta$Sample_ID)
num_subj = length(subject_ids)
plate_meta = read.csv('Baseline_plate_metadata.csv', sep = ";", header = TRUE)
plate_meta$Date=NULL
plate_meta$Staining_date=NULL
plate_ids = unique(plate_meta$Plate_number)
num_plate = length(plate_ids)

foci_baseline_first = data.frame(Plate = baseline_plate_nums[1], Plate_well = paste(baseline_plate_nums[1], read.table(paste("Baselines-all/average_well_P", baseline_plate_nums[1],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste("Baselines-all/average_well_P", baseline_plate_nums[1],'.txt', sep=""), sep="\t", header = TRUE))
baseline_table=foci_baseline_first

for(ii in 2:baseline_plate_count){
  temp_baseline_filename = paste('Baselines-all/average_well_P', baseline_plate_nums[ii],'.txt', sep="")
  temp_baseline_table = data.frame(Plate = baseline_plate_nums[ii], Plate_well = paste(baseline_plate_nums[ii], read.table(paste('Baselines-all/average_well_P', baseline_plate_nums[ii],'.txt', sep=""), sep="\t", header = TRUE)$Well, sep = "_"), read.table(paste('Baselines-all/average_well_P', baseline_plate_nums[ii],'.txt', sep=""), sep="\t", header = TRUE))
  baseline_table = rbind(baseline_table, temp_baseline_table)
}

baseline_w_plate_meta1 = merge(baseline_table, plate_meta, by.x = 'Plate', by.y = 'Plate_number', all.x = TRUE, all.y = TRUE)
baseline_w_plate_meta = merge(baseline_w_plate_meta1, subject_meta, by.x = 'Plate_well', by.y = 'Plate_Well', all.x = TRUE, all.y = TRUE)
colnames(baseline_w_plate_meta)[colnames(baseline_w_plate_meta)=="Plate.x"]<-"Plate"
colnames(baseline_w_plate_meta)[colnames(baseline_w_plate_meta)=="Well.x"]<-"Well"

## Filt
low_bar = 50
baseline_filt = baseline_w_plate_meta[baseline_w_plate_meta$num_nuc > (low_bar-1),]

baseline_filt_2 = baseline_filt[baseline_filt$avg_nfoci != 0,]

# 
Raw_Baseline_Threshold=baseline_filt_2
CMV_save=Raw_Baseline_Threshold[,grepl("Sample_ID|CMV", colnames(Raw_Baseline_Threshold))]
CMV_save=unique(CMV_save)
Raw_Baseline_Threshold$Duplicates=NULL
Raw_Baseline_Threshold$Plate.y=NULL
Raw_Baseline_Threshold$Well.y=NULL
Raw_Baseline_Threshold=Raw_Baseline_Threshold[,grepl("Plate_well|Plate|Well|avg_nfoci|avg_foci_no_outl|Duplicate|Sample_ID|Age|Gender|BMI", colnames(Raw_Baseline_Threshold))]
Raw_Baseline_Threshold=unique((Raw_Baseline_Threshold))
Raw_Baseline_Threshold=NaRV.omit(Raw_Baseline_Threshold)

Raw_Baseline=merge(Raw_Baseline_Threshold, CMV_save, by.x="Sample_ID", by.y ="Sample_ID" ,all.x = TRUE)
Raw_Baseline=merge(Raw_Baseline, Plate_Duplicate, by.x="Plate", by.y="Plate_number")
#write.csv(Raw_Baseline, "Raw_Baseline.csv")


#########################################  Correction ############################################
##################################################################################################

# NB : for the baseline correction we use ComBat function from the SVA R package and not the Finsam's function since we don't need to extract correction coefficient to apply them on irradiated samples. 

## each plate is associated with its duplicate number (A or B)
plate_metadata <- read.csv('Baseline_plate_metadata.csv', header = TRUE, sep = ";", quote = "\"", dec = ".")
plate_metadata$Duplicates=NULL
plate_metadata$Staining_date=NULL

Raw_Baseline_batch=merge(Raw_Baseline, plate_metadata, by.x="Plate", by.y="Plate_number",all.x = TRUE)

CMV_save=Raw_Baseline_batch[,grepl("Sample_ID|CMV", colnames(Raw_Baseline_batch))]
CMV_save=unique(CMV_save)
Raw_Baseline_batch$CMV=NULL

### Correction performed independently for each duplicate A and B
Baseline_A=Raw_Baseline_batch
Baseline_B=Raw_Baseline_batch

Baseline_A$Duplicate[Baseline_A$Duplicate== 'B'] <- NA
Baseline_B$Duplicate[Baseline_B$Duplicate== 'A'] <- NA

Baseline_A=NaRV.omit(Baseline_A)
Baseline_B=NaRV.omit(Baseline_B)

## Duplicates A
Baseline_metadata_save_A=Baseline_A[ , grepl( "Sample_ID|Duplicate|Staining_date|Run_Set|Age|BMI|Gender|Time_Point|Radiation|Run_set" , names(Baseline_A) ) ]

#create arguments to apply ComBat function for duplicates A
edata <-Baseline_A[ , grepl( "avg_nfoci|avg_foci" , names(Baseline_A) ) ]
edata=t(edata)
pheno= Baseline_A[ , grepl( "Age|BMI|Gender" , names(Baseline_A) ) ]
Batch_baseline= Baseline_A$Date

modcombat = model.matrix(~1, data=pheno) 
combat_edata = ComBat(edata, batch=Batch_baseline, mod=modcombat)
combat_edata_t=t(combat_edata)
combat_edata_t=data.frame(combat_edata_t)

Baseline_corrected_A = cbind(Baseline_metadata_save_A, combat_edata_t)


## Duplicates B
Baseline_metadata_save_B=Baseline_B[ , grepl( "Sample_ID|Duplicate|Staining_date|Run_Set|Age|BMI|Gender|Time_Point|Radiation|Run_set" , names(Baseline_B) ) ]

#create arguments to apply ComBat function for duplicates B
edata <-Baseline_B[ , grepl( "avg_nfoci|avg_foci" , names(Baseline_B) ) ]
edata=NaRV.omit(edata)
edata=t(edata)
pheno= Baseline_B[ , grepl( "Age|BMI|Gender|Sample_ID" , names(Baseline_B) ) ]
Batch_baseline= Baseline_B$Date

modcombat = model.matrix(~1, data=pheno) 
combat_edata = ComBat(edata, batch=Batch_baseline, mod=modcombat)
combat_edata_t=t(combat_edata)
combat_edata_t=data.frame(combat_edata_t)

Baseline_corrected_B = cbind(Baseline_metadata_save_B, combat_edata_t)


## Regroupe duplicates A and B after correction and average by sample ID

Corrected_baselines=bind_rows(Baseline_corrected_A, Baseline_corrected_B)
Corrected_baselines$avg_nfoci[Corrected_baselines$avg_nfoci < 0] <- 0

# add a column radiation for using facet_grid()
Baseline_Corrected_Fe=Corrected_baselines
Baseline_Corrected_Fe$Radiation_type="Fe"
Baseline_Corrected_Ar=Corrected_baselines
Baseline_Corrected_Ar$Radiation_type="Ar"
Baseline_Corrected_Si=Corrected_baselines
Baseline_Corrected_Si$Radiation_type="Si"
Baseline_Corrected_Gamma=Corrected_baselines
Baseline_Corrected_Gamma$Radiation_type="Gamma"
#
Corrected_baselines=bind_rows(Baseline_Corrected_Fe,Baseline_Corrected_Ar,
                              Baseline_Corrected_Si,Baseline_Corrected_Gamma)

Corrected_baselines$Timepoint="foci level"
Corrected_baselines$Rad_dose_Gy = 0
Corrected_baselines$Run_set = "Baseline Foci level"

Corrected_baselines$Dose_relative="Baseline"
Corrected_baselines$Rad_dose_Gy=as.character(Corrected_baselines$Rad_dose_Gy)
Corrected_baselines$avg_foci_no_outl=NULL

#### The correction may generate negative values => we fix them to 0 
Corrected_baselines$avg_foci[Corrected_baselines$avg_foci < 0] <-  0 

#### Regroup all corrected DD & corrected baseline
All_Corrected_DD_and_Baseline = bind_rows(All_Corrected_DD, Corrected_baselines)

```

```{r}
##################################################################################################
######################################## Cell Death ##############################################
##################################################################################################

#### Now we read flow data 

## Read all flow data, which in this case includes metadata of CellROX intensity and cell death percentage in WIDE format
flow_all = read.csv('all_flow.csv', sep = ",", header = TRUE)
# Now we add well metadata
well_meta <- read.csv('Well_meta.csv', header = TRUE, sep = ";", quote = "\"", dec = ".")
all_flow_meta = merge(flow_all, well_meta, by = 'Sample_ID')
#
#
Cell_Death_Raw=all_flow_meta[,grepl("Dead_percentage|Sample_ID|Timepoint|Run|Age|Gender|BMI|Collection", colnames(all_flow_meta))]
#

## we read and associate quartiles value to the initial file 
sheet_names <- excel_sheets(here::here("Flow_CRmedian_DeathQuartiles_20200909.xlsx"))
sheet_names
nbr_of_sheet = length(sheet_names)
nbr_of_sheet

for (i in 1:nbr_of_sheet){
  name <- sheet_names[i]  ## store the sheet name 
  data <- read_excel(here::here("Flow_CRmedian_DeathQuartiles_20200909.xlsx"), sheet=i ) ## we read the sheet i only in the excel file
name <- paste0("Sheet_", name)
assign(name, data)                   
rm(name, data)
}

# Not reading 18B_Gamma since will be read in 19C 
Cell_death_extra_Fe = bind_rows(Sheet_18B_Dead_Fe, Sheet_19A_Dead_Fe, Sheet_19C_Dead_Fe) 
Cell_death_extra_Ar = bind_rows(Sheet_18B_Dead_Ar, Sheet_19A_Dead_Ar, Sheet_19C_Dead_Ar) 
Cell_death_extra_Si = bind_rows(Sheet_18B_Dead_Si, Sheet_19A_Dead_Si, Sheet_19C_Dead_Si) 
#Cell_death_extra_Gamma = bind_rows(Sheet_19A_Dead_Gamma, Sheet_19C_Dead_Gamma)
Cell_death_extra_Gamma = bind_rows(Sheet_19A_Dead_Gamma) 

#                            
Cell_death_extra= merge(Cell_death_extra_Fe, Cell_death_extra_Ar,by=c("Sample_number", "Set"), all=TRUE )
Cell_death_extra= merge(Cell_death_extra, Cell_death_extra_Si,by=c("Sample_number", "Set"), all=TRUE )
Cell_death_extra= merge(Cell_death_extra, Cell_death_extra_Gamma,by=c("Sample_number", "Set"), all=TRUE )  

## Separate 4h and 24h and create variable time point 
# 4h
Cell_death_extra_4h = Cell_death_extra[,grepl("Sample|Set|_4h", colnames(Cell_death_extra))]
colnames(Cell_death_extra_4h)[colnames(Cell_death_extra_4h)=="Fe_Dead_Q1Q4_0_4h"] <- "Fe_Dead_Q1Q4_0"
colnames(Cell_death_extra_4h)[colnames(Cell_death_extra_4h)=="Fe_Dead_Q1Q4_1_4h"] <- "Fe_Dead_Q1Q4_1"
colnames(Cell_death_extra_4h)[colnames(Cell_death_extra_4h)=="Fe_Dead_Q1Q4_3_4h"] <- "Fe_Dead_Q1Q4_3"
colnames(Cell_death_extra_4h)[colnames(Cell_death_extra_4h)=="Ar_Dead_Q1Q4_0_4h"] <- "Ar_Dead_Q1Q4_0"
colnames(Cell_death_extra_4h)[colnames(Cell_death_extra_4h)=="Ar_Dead_Q1Q4_1_4h"] <- "Ar_Dead_Q1Q4_1"
colnames(Cell_death_extra_4h)[colnames(Cell_death_extra_4h)=="Ar_Dead_Q1Q4_3_4h"] <- "Ar_Dead_Q1Q4_3"
colnames(Cell_death_extra_4h)[colnames(Cell_death_extra_4h)=="Si_Dead_Q1Q4_0_4h"] <- "Si_Dead_Q1Q4_0"
colnames(Cell_death_extra_4h)[colnames(Cell_death_extra_4h)=="Si_Dead_Q1Q4_1_4h"] <- "Si_Dead_Q1Q4_1"
colnames(Cell_death_extra_4h)[colnames(Cell_death_extra_4h)=="Si_Dead_Q1Q4_3_4h"] <- "Si_Dead_Q1Q4_3"
colnames(Cell_death_extra_4h)[colnames(Cell_death_extra_4h)=="Gamma_Dead_Q1Q4_0_4h"] <- "Gamma_Dead_Q1Q4_0"
colnames(Cell_death_extra_4h)[colnames(Cell_death_extra_4h)=="Gamma_Dead_Q1Q4_01_4h"] <- "Gamma_Dead_Q1Q4_01"
colnames(Cell_death_extra_4h)[colnames(Cell_death_extra_4h)=="Gamma_Dead_Q1Q4_1_4h"] <- "Gamma_Dead_Q1Q4_1"
Cell_death_extra_4h$Timepoint="4h"
#
#
Cell_death_extra_24h = Cell_death_extra[,grepl("Sample|Set|_24h", colnames(Cell_death_extra))]
colnames(Cell_death_extra_24h)[colnames(Cell_death_extra_24h)=="Fe_Dead_Q1Q4_0_24h"] <- "Fe_Dead_Q1Q4_0"
colnames(Cell_death_extra_24h)[colnames(Cell_death_extra_24h)=="Fe_Dead_Q1Q4_1_24h"] <- "Fe_Dead_Q1Q4_1"
colnames(Cell_death_extra_24h)[colnames(Cell_death_extra_24h)=="Fe_Dead_Q1Q4_3_24h"] <- "Fe_Dead_Q1Q4_3"
colnames(Cell_death_extra_24h)[colnames(Cell_death_extra_24h)=="Ar_Dead_Q1Q4_0_24h"] <- "Ar_Dead_Q1Q4_0"
colnames(Cell_death_extra_24h)[colnames(Cell_death_extra_24h)=="Ar_Dead_Q1Q4_1_24h"] <- "Ar_Dead_Q1Q4_1"
colnames(Cell_death_extra_24h)[colnames(Cell_death_extra_24h)=="Ar_Dead_Q1Q4_3_24h"] <- "Ar_Dead_Q1Q4_3"
colnames(Cell_death_extra_24h)[colnames(Cell_death_extra_24h)=="Si_Dead_Q1Q4_0_24h"] <- "Si_Dead_Q1Q4_0"
colnames(Cell_death_extra_24h)[colnames(Cell_death_extra_24h)=="Si_Dead_Q1Q4_1_24h"] <- "Si_Dead_Q1Q4_1"
colnames(Cell_death_extra_24h)[colnames(Cell_death_extra_24h)=="Si_Dead_Q1Q4_3_24h"] <- "Si_Dead_Q1Q4_3"
colnames(Cell_death_extra_24h)[colnames(Cell_death_extra_24h)=="Gamma_Dead_Q1Q4_0_24h"] <- "Gamma_Dead_Q1Q4_0"
colnames(Cell_death_extra_24h)[colnames(Cell_death_extra_24h)=="Gamma_Dead_Q1Q4_01_24h"] <- "Gamma_Dead_Q1Q4_01"
colnames(Cell_death_extra_24h)[colnames(Cell_death_extra_24h)=="Gamma_Dead_Q1Q4_1_24h"] <- "Gamma_Dead_Q1Q4_1"
Cell_death_extra_24h$Timepoint="24h"
Cell_death_extra=bind_rows(Cell_death_extra_4h, Cell_death_extra_24h)
#
colnames(Cell_death_extra)[colnames(Cell_death_extra) == "Sample_number"] = "Sample_ID"
colnames(Cell_death_extra)[colnames(Cell_death_extra) == "Set"] = "Run_set"
#
All_Cell_Death_Raw = merge(Cell_Death_Raw, Cell_death_extra,by=c("Sample_ID", "Run_set", 'Timepoint'), all=TRUE )

### Formatting: creating unique name for flow data and two columns: 1 for the radiation and 1 for the dose 
CD_meta=All_Cell_Death_Raw[,grepl("Sample_ID|Run|Age|Gender|BMI|Collection", colnames(All_Cell_Death_Raw))]
CD_meta=unique(CD_meta)
#
##### Fe
CD_Fe = All_Cell_Death_Raw[,grepl("Fe|Sample_ID|Timepoint", colnames(All_Cell_Death_Raw))]
## 4h 
CD_Fe_4h = CD_Fe %>% filter(CD_Fe$Timepoint =="4h")
colnames(CD_Fe_4h)[colnames(CD_Fe_4h)=="Fe_Dead_Q1Q4_0"] = "Dead_Q1Q4_0"
colnames(CD_Fe_4h)[colnames(CD_Fe_4h)=="Fe_Dead_Q1Q4_1"] = "Dead_Q1Q4_low_dose"
colnames(CD_Fe_4h)[colnames(CD_Fe_4h)=="Fe_Dead_Q1Q4_3"] = "Dead_Q1Q4_high_dose"
colnames(CD_Fe_4h)[colnames(CD_Fe_4h)=="Fe_Dead_percentage_0"] = "Dead_Cells_0"
colnames(CD_Fe_4h)[colnames(CD_Fe_4h)=="Fe_Dead_percentage_1"] = "Dead_Cells_low_dose"
colnames(CD_Fe_4h)[colnames(CD_Fe_4h)=="Fe_Dead_percentage_3"] = "Dead_Cells_high_dose"
## 24h 
CD_Fe_24h = CD_Fe %>% filter(CD_Fe$Timepoint =="24h")
colnames(CD_Fe_24h)[colnames(CD_Fe_24h)=="Fe_Dead_Q1Q4_0"] = "Dead_Q1Q4_0"
colnames(CD_Fe_24h)[colnames(CD_Fe_24h)=="Fe_Dead_Q1Q4_1"] = "Dead_Q1Q4_low_dose"
colnames(CD_Fe_24h)[colnames(CD_Fe_24h)=="Fe_Dead_Q1Q4_3"] = "Dead_Q1Q4_high_dose"
colnames(CD_Fe_24h)[colnames(CD_Fe_24h)=="Fe_Dead_percentage_0"] = "Dead_Cells_0"
colnames(CD_Fe_24h)[colnames(CD_Fe_24h)=="Fe_Dead_percentage_1"] = "Dead_Cells_low_dose"
colnames(CD_Fe_24h)[colnames(CD_Fe_24h)=="Fe_Dead_percentage_3"] = "Dead_Cells_high_dose"
#
CD_Fe=bind_rows(CD_Fe_4h, CD_Fe_24h)
CD_Fe=merge(CD_Fe,CD_meta, by="Sample_ID", all.x=TRUE, all.y = FALSE)
CD_Fe$Radiation_type="Fe"

##### Ar
CD_Ar = All_Cell_Death_Raw[,grepl("Ar|Sample_ID|Timepoint", colnames(All_Cell_Death_Raw))]
## 4h 
CD_Ar_4h = CD_Ar %>% filter(CD_Ar$Timepoint =="4h")
colnames(CD_Ar_4h)[colnames(CD_Ar_4h)=="Ar_Dead_Q1Q4_0"] = "Dead_Q1Q4_0"
colnames(CD_Ar_4h)[colnames(CD_Ar_4h)=="Ar_Dead_Q1Q4_1"] = "Dead_Q1Q4_low_dose"
colnames(CD_Ar_4h)[colnames(CD_Ar_4h)=="Ar_Dead_Q1Q4_3"] = "Dead_Q1Q4_high_dose"
colnames(CD_Ar_4h)[colnames(CD_Ar_4h)=="Ar_Dead_percentage_0"] = "Dead_Cells_0"
colnames(CD_Ar_4h)[colnames(CD_Ar_4h)=="Ar_Dead_percentage_1"] = "Dead_Cells_low_dose"
colnames(CD_Ar_4h)[colnames(CD_Ar_4h)=="Ar_Dead_percentage_3"] = "Dead_Cells_high_dose"
## 24h 
CD_Ar_24h = CD_Ar %>% filter(CD_Ar$Timepoint =="24h")
colnames(CD_Ar_24h)[colnames(CD_Ar_24h)=="Ar_Dead_Q1Q4_0"] = "Dead_Q1Q4_0"
colnames(CD_Ar_24h)[colnames(CD_Ar_24h)=="Ar_Dead_Q1Q4_1"] = "Dead_Q1Q4_low_dose"
colnames(CD_Ar_24h)[colnames(CD_Ar_24h)=="Ar_Dead_Q1Q4_3"] = "Dead_Q1Q4_high_dose"
colnames(CD_Ar_24h)[colnames(CD_Ar_24h)=="Ar_Dead_percentage_0"] = "Dead_Cells_0"
colnames(CD_Ar_24h)[colnames(CD_Ar_24h)=="Ar_Dead_percentage_1"] = "Dead_Cells_low_dose"
colnames(CD_Ar_24h)[colnames(CD_Ar_24h)=="Ar_Dead_percentage_3"] = "Dead_Cells_high_dose"
#
CD_Ar=bind_rows(CD_Ar_4h, CD_Ar_24h)
CD_Ar=merge(CD_Ar,CD_meta, by="Sample_ID", all.x=TRUE, all.y = FALSE)
CD_Ar$Radiation_type="Ar"

##### Si
CD_Si = All_Cell_Death_Raw[,grepl("Si|Sample_ID|Timepoint", colnames(All_Cell_Death_Raw))]
## 4h 
CD_Si_4h = CD_Si %>% filter(CD_Si$Timepoint =="4h")
colnames(CD_Si_4h)[colnames(CD_Si_4h)=="Si_Dead_Q1Q4_0"] = "Dead_Q1Q4_0"
colnames(CD_Si_4h)[colnames(CD_Si_4h)=="Si_Dead_Q1Q4_1"] = "Dead_Q1Q4_low_dose"
colnames(CD_Si_4h)[colnames(CD_Si_4h)=="Si_Dead_Q1Q4_3"] = "Dead_Q1Q4_high_dose"
colnames(CD_Si_4h)[colnames(CD_Si_4h)=="Si_Dead_percentage_0"] = "Dead_Cells_0"
colnames(CD_Si_4h)[colnames(CD_Si_4h)=="Si_Dead_percentage_1"] = "Dead_Cells_low_dose"
colnames(CD_Si_4h)[colnames(CD_Si_4h)=="Si_Dead_percentage_3"] = "Dead_Cells_high_dose"
## 24h 
CD_Si_24h = CD_Si %>% filter(CD_Si$Timepoint =="24h")
colnames(CD_Si_24h)[colnames(CD_Si_24h)=="Si_Dead_Q1Q4_0"] = "Dead_Q1Q4_0"
colnames(CD_Si_24h)[colnames(CD_Si_24h)=="Si_Dead_Q1Q4_1"] = "Dead_Q1Q4_low_dose"
colnames(CD_Si_24h)[colnames(CD_Si_24h)=="Si_Dead_Q1Q4_3"] = "Dead_Q1Q4_high_dose"
colnames(CD_Si_24h)[colnames(CD_Si_24h)=="Si_Dead_percentage_0"] = "Dead_Cells_0"
colnames(CD_Si_24h)[colnames(CD_Si_24h)=="Si_Dead_percentage_1"] = "Dead_Cells_low_dose"
colnames(CD_Si_24h)[colnames(CD_Si_24h)=="Si_Dead_percentage_3"] = "Dead_Cells_high_dose"
#
CD_Si=bind_rows(CD_Si_4h, CD_Si_24h)
CD_Si=merge(CD_Si,CD_meta, by="Sample_ID", all.x=TRUE, all.y = FALSE)
CD_Si$Radiation_type="Si"

##### Gamma
CD_Gamma = All_Cell_Death_Raw[,grepl("Gamma|Sample_ID|Timepoint", colnames(All_Cell_Death_Raw))]
## 4h 
CD_Gamma_4h = CD_Gamma %>% filter(CD_Gamma$Timepoint =="4h")
colnames(CD_Gamma_4h)[colnames(CD_Gamma_4h)=="Gamma_Dead_Q1Q4_0"] = "Dead_Q1Q4_0"
colnames(CD_Gamma_4h)[colnames(CD_Gamma_4h)=="Gamma_Dead_Q1Q4_01"] = "Dead_Q1Q4_low_dose"
colnames(CD_Gamma_4h)[colnames(CD_Gamma_4h)=="Gamma_Dead_Q1Q4_1"] = "Dead_Q1Q4_high_dose"
colnames(CD_Gamma_4h)[colnames(CD_Gamma_4h)=="Gamma_Dead_percentage_0"] = "Dead_Cells_0"
colnames(CD_Gamma_4h)[colnames(CD_Gamma_4h)=="Gamma_Dead_percentage_0.1"] = "Dead_Cells_low_dose"
colnames(CD_Gamma_4h)[colnames(CD_Gamma_4h)=="Gamma_Dead_percentage_1"] = "Dead_Cells_high_dose"
## 24h 
CD_Gamma_24h = CD_Gamma %>% filter(CD_Gamma$Timepoint =="24h")
colnames(CD_Gamma_24h)[colnames(CD_Gamma_24h)=="Gamma_Dead_Q1Q4_0"] = "Dead_Q1Q4_0"
colnames(CD_Gamma_24h)[colnames(CD_Gamma_24h)=="Gamma_Dead_Q1Q4_01"] = "Dead_Q1Q4_low_dose"
colnames(CD_Gamma_24h)[colnames(CD_Gamma_24h)=="Gamma_Dead_Q1Q4_1"] = "Dead_Q1Q4_high_dose"
colnames(CD_Gamma_24h)[colnames(CD_Gamma_24h)=="Gamma_Dead_percentage_0"] = "Dead_Cells_0"
colnames(CD_Gamma_24h)[colnames(CD_Gamma_24h)=="Gamma_Dead_percentage_0.1"] = "Dead_Cells_low_dose"
colnames(CD_Gamma_24h)[colnames(CD_Gamma_24h)=="Gamma_Dead_percentage_1"] = "Dead_Cells_high_dose"
#
CD_Gamma=bind_rows(CD_Gamma_4h, CD_Gamma_24h)
CD_Gamma=merge(CD_Gamma,CD_meta, by="Sample_ID", all.x=TRUE, all.y = FALSE)
CD_Gamma$Radiation_type="Gamma"

###
###
All_Cell_Death_Raw=bind_rows(CD_Fe, CD_Ar, CD_Si, CD_Gamma)


#########################################  Correction ############################################
##################################################################################################

###########################################################################
####### 1) Correction between radiation within each run/set ###############
###########################################################################


#### we add the Batch numeration 
Run_set_batch <- read.csv('Run_set_batch.csv', header = TRUE, sep = ";", quote = "\"", dec = ".")

Raw_CD_with_metadata=merge(All_Cell_Death_Raw, Run_set_batch, by="Run_set",all.x = TRUE)
Raw_CD_with_metadata$CMV=NULL
Raw_CD_with_metadata$Run_set_well=NULL

colnames(Raw_CD_with_metadata)[colnames(Raw_CD_with_metadata)=="Batch"] = "Run_set_batch"

## Add column radiation_batch 
Raw_CD_with_metadata$Radiation_Batch= Raw_CD_with_metadata$Radiation_type
Raw_CD_with_metadata$Radiation_Batch[Raw_CD_with_metadata$Radiation_Batch=="Fe"] <- 1
Raw_CD_with_metadata$Radiation_Batch[Raw_CD_with_metadata$Radiation_Batch=="Ar"] <- 2
Raw_CD_with_metadata$Radiation_Batch[Raw_CD_with_metadata$Radiation_Batch=="Si"] <- 3
Raw_CD_with_metadata$Radiation_Batch[Raw_CD_with_metadata$Radiation_Batch=="Gamma"] <- 4

metadata_save = Raw_CD_with_metadata[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender",colnames(Raw_CD_with_metadata))]


# To know how many "Run and set" values we have 
Run_set_list = Raw_CD_with_metadata[, grepl("Run", colnames(Raw_CD_with_metadata))]
Run_set_list=unique(Run_set_list)
print(Run_set_list)


## In this case we have 8 different "Run and set" values
Run_set_1 = Raw_CD_with_metadata %>% filter(Raw_CD_with_metadata$Run_set_batch == 1)
Run_set_2 = Raw_CD_with_metadata %>% filter(Raw_CD_with_metadata$Run_set_batch == 2)
Run_set_3 = Raw_CD_with_metadata %>% filter(Raw_CD_with_metadata$Run_set_batch == 3)
Run_set_4 = Raw_CD_with_metadata %>% filter(Raw_CD_with_metadata$Run_set_batch == 4)
Run_set_5 = Raw_CD_with_metadata %>% filter(Raw_CD_with_metadata$Run_set_batch == 5)
Run_set_6 =Raw_CD_with_metadata %>% filter(Raw_CD_with_metadata$Run_set_batch == 6)
Run_set_7 = Raw_CD_with_metadata %>% filter(Raw_CD_with_metadata$Run_set_batch == 7)
Run_set_8 = Raw_CD_with_metadata %>% filter(Raw_CD_with_metadata$Run_set_batch == 8)


# for each run and set value we apply Finsam's function with radiation as a batch effect variable 

#####################################################################
######################### On controls first #########################
#####################################################################

##### Run_set_1
metadata_save_1=Run_set_1[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_1))]
metadata=Run_set_1[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_1))]
metadata$BMI_group=NULL
edata_control=Run_set_1[,grep("Count_PBMC_0|Dead_Cells_0",colnames(Run_set_1))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_1$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_1_Corrected_Controls = Modified_ComBat$data
Run_Set_1_Corrected_Controls=t(Run_Set_1_Corrected_Controls)
Run_Set_1_Corrected_Controls=cbind(Run_Set_1_Corrected_Controls, metadata_save_1)
#
Gamma_factor_Run_set_1= Modified_ComBat$gamma
Delta_factor_Run_set_1= Modified_ComBat$delta

##### Run_set_2
metadata_save_2=Run_set_2[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_2))]
metadata=Run_set_2[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_2))]
metadata$BMI_group=NULL
edata_control=Run_set_2[,grep("Count_PBMC_0|Dead_Cells_0",colnames(Run_set_2))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_2$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_2_Corrected_Controls = Modified_ComBat$data
Run_Set_2_Corrected_Controls=t(Run_Set_2_Corrected_Controls)
Run_Set_2_Corrected_Controls=cbind(Run_Set_2_Corrected_Controls, metadata_save_2)
#
Gamma_factor_Run_set_2= Modified_ComBat$gamma
Delta_factor_Run_set_2= Modified_ComBat$delta


##### Run_set_3
metadata_save_3=Run_set_3[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_3))]
metadata=Run_set_3[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_3))]
metadata$BMI_group=NULL
edata_control=Run_set_3[,grep("Count_PBMC_0|Dead_Cells_0",colnames(Run_set_3))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_3$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_3_Corrected_Controls = Modified_ComBat$data
Run_Set_3_Corrected_Controls=t(Run_Set_3_Corrected_Controls)
Run_Set_3_Corrected_Controls=cbind(Run_Set_3_Corrected_Controls, metadata_save_3)
#
Gamma_factor_Run_set_3= Modified_ComBat$gamma
Delta_factor_Run_set_3= Modified_ComBat$delta


##### Run_set_4
metadata_save_4=Run_set_4[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_4))]
metadata=Run_set_4[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_4))]
metadata$BMI_group=NULL
edata_control=Run_set_4[,grep("Count_PBMC_0|Dead_Cells_0",colnames(Run_set_4))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_4$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_4_Corrected_Controls = Modified_ComBat$data
Run_Set_4_Corrected_Controls=t(Run_Set_4_Corrected_Controls)
Run_Set_4_Corrected_Controls=cbind(Run_Set_4_Corrected_Controls, metadata_save_4)
#
Gamma_factor_Run_set_4= Modified_ComBat$gamma
Delta_factor_Run_set_4= Modified_ComBat$delta

##### Run_set_5
metadata_save_5=Run_set_5[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_5))]
metadata=Run_set_5[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_5))]
metadata$BMI_group=NULL
edata_control=Run_set_5[,grep("Count_PBMC_0|Dead_Cells_0",colnames(Run_set_5))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_5$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_5_Corrected_Controls = Modified_ComBat$data
Run_Set_5_Corrected_Controls=t(Run_Set_5_Corrected_Controls)
Run_Set_5_Corrected_Controls=cbind(Run_Set_5_Corrected_Controls, metadata_save_5)
#
Gamma_factor_Run_set_5= Modified_ComBat$gamma
Delta_factor_Run_set_5= Modified_ComBat$delta


##### Run_set_6
metadata_save_6=Run_set_6[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_6))]
metadata=Run_set_6[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_6))]
metadata$BMI_group=NULL
edata_control=Run_set_6[,grep("Count_PBMC_0|Dead_Cells_0",colnames(Run_set_6))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_6$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_6_Corrected_Controls = Modified_ComBat$data
Run_Set_6_Corrected_Controls=t(Run_Set_6_Corrected_Controls)
Run_Set_6_Corrected_Controls=cbind(Run_Set_6_Corrected_Controls, metadata_save_6)
#
Gamma_factor_Run_set_6= Modified_ComBat$gamma
Delta_factor_Run_set_6= Modified_ComBat$delta

##### Run_set_7
metadata_save_7=Run_set_7[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_7))]
metadata=Run_set_7[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_7))]
metadata$BMI_group=NULL
edata_control=Run_set_7[,grep("Count_PBMC_0|Dead_Cells_0",colnames(Run_set_7))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_7$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_7_Corrected_Controls = Modified_ComBat$data
Run_Set_7_Corrected_Controls=t(Run_Set_7_Corrected_Controls)
Run_Set_7_Corrected_Controls=cbind(Run_Set_7_Corrected_Controls, metadata_save_7)
#
Gamma_factor_Run_set_7= Modified_ComBat$gamma
Delta_factor_Run_set_7= Modified_ComBat$delta

##### Run_set_8
metadata_save_8=Run_set_8[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_8))]
metadata=Run_set_8[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_8))]
metadata$BMI_group=NULL
edata_control=Run_set_8[,grep("Count_PBMC_0|Dead_Cells_0",colnames(Run_set_8))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_8$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_8_Corrected_Controls = Modified_ComBat$data
Run_Set_8_Corrected_Controls=t(Run_Set_8_Corrected_Controls)
Run_Set_8_Corrected_Controls=cbind(Run_Set_8_Corrected_Controls, metadata_save_8)
#
Gamma_factor_Run_set_8= Modified_ComBat$gamma
Delta_factor_Run_set_8= Modified_ComBat$delta


######### regroup corrected controls 
Corrected_controls= bind_rows(Run_Set_1_Corrected_Controls, Run_Set_2_Corrected_Controls,
                              Run_Set_3_Corrected_Controls,Run_Set_4_Corrected_Controls,
                              Run_Set_5_Corrected_Controls,Run_Set_6_Corrected_Controls,
                              Run_Set_7_Corrected_Controls,Run_Set_8_Corrected_Controls)
Corrected_controls$Rad_dose_Gy = 0
Corrected_controls$Run_set_batch=NULL
Corrected_controls$Radiation_Batch=NULL


#####################################################################
##################### On irradiated samples #########################
#####################################################################

######## we separate low and high dose to include the dose in Gy as a covariate
### dose en Gy
low_dose_Fe = 0.3 
low_dose_Ar = 0.18 
low_dose_Si = 0.11 
low_dose_Gamma = 0.1

high_dose_Fe = 0.82 
high_dose_Ar = 0.5 
high_dose_Si = 0.29 
high_dose_Gamma = 1

################################ Low dose ######################################
Raw_low_dose_irradiated_samples=Raw_CD_with_metadata[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Dead_Cells_low_dose|Dead_Q1Q4_low_dose",colnames(Raw_CD_with_metadata))]

Raw_low_dose_irradiated_samples$Rad_dose_Gy = Raw_low_dose_irradiated_samples$Radiation_type
Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Fe"] <- low_dose_Fe
Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Ar"] <- low_dose_Ar
Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Si"] <- low_dose_Si
Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Gamma"] <- low_dose_Gamma

Raw_low_dose_irradiated_samples=Raw_low_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Dead_Cells_low_dose|Dead_Q1Q4_low_dose|Rad_dose_Gy",colnames(Raw_low_dose_irradiated_samples))]

metadata_save = Raw_low_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Rad_dose",colnames(Raw_low_dose_irradiated_samples))]


################### Now, for each run and set value we correct by radiation
Irradiated_Responses_Run_set_1 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 1)
Irradiated_Responses_Run_set_2 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 2)
Irradiated_Responses_Run_set_3 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 3)
Irradiated_Responses_Run_set_4 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 4)
Irradiated_Responses_Run_set_5 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 5)
Irradiated_Responses_Run_set_6 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 6)
Irradiated_Responses_Run_set_7 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 7)
Irradiated_Responses_Run_set_8 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 8)

##### Run_set_1
# create arguments 
metadata_save_1=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
metadata=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_1[,grep("Dead_Cells_low_dose|Dead_Q1Q4_low_dose",colnames(Irradiated_Responses_Run_set_1))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_1$Radiation_Batch
### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_1, custom.delta=Delta_factor_Run_set_1, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_1 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_1=cbind(Rad_Corrected_Irrad_Samples_Run_Set_1, metadata_save_1)


##### Run_set_2
# create arguments 
metadata_save_2=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
metadata=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_2[,grep("Dead_Cells_low_dose|Dead_Q1Q4_low_dose",colnames(Irradiated_Responses_Run_set_2))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_2$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_2, custom.delta=Delta_factor_Run_set_2, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_2 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_2=cbind(Rad_Corrected_Irrad_Samples_Run_Set_2, metadata_save_2)


##### Run_set_3
# create arguments 
metadata_save_3=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
metadata=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_3[,grep("Dead_Cells_low_dose|Dead_Q1Q4_low_dose",colnames(Irradiated_Responses_Run_set_3))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_3$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_3, custom.delta=Delta_factor_Run_set_3, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_3 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_3=cbind(Rad_Corrected_Irrad_Samples_Run_Set_3, metadata_save_3)

##### Run_set_4
# create arguments 
metadata_save_4=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
metadata=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_4[,grep("Dead_Cells_low_dose|Dead_Q1Q4_low_dose",colnames(Irradiated_Responses_Run_set_4))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_4$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_4, custom.delta=Delta_factor_Run_set_4, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_4 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_4=cbind(Rad_Corrected_Irrad_Samples_Run_Set_4, metadata_save_4)

##### Run_set_5
# create arguments 
metadata_save_5=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
metadata=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_5[,grep("Dead_Cells_low_dose|Dead_Q1Q4_low_dose",colnames(Irradiated_Responses_Run_set_5))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_5$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_5, custom.delta=Delta_factor_Run_set_5, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_5 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_5=cbind(Rad_Corrected_Irrad_Samples_Run_Set_5, metadata_save_5)


##### Run_set_6
# create arguments 
metadata_save_6=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
metadata=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_6[,grep("Dead_Cells_low_dose|Dead_Q1Q4_low_dose",colnames(Irradiated_Responses_Run_set_6))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_6$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_6, custom.delta=Delta_factor_Run_set_6, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_6 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_6=cbind(Rad_Corrected_Irrad_Samples_Run_Set_6, metadata_save_6)

##### Run_set_7
# create arguments 
metadata_save_7=Irradiated_Responses_Run_set_7[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_7))]
metadata=Irradiated_Responses_Run_set_7[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_7))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_7[,grep("Dead_Cells_low_dose|Dead_Q1Q4_low_dose",colnames(Irradiated_Responses_Run_set_7))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_7$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_7, custom.delta=Delta_factor_Run_set_7, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_7 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_7=cbind(Rad_Corrected_Irrad_Samples_Run_Set_7, metadata_save_7)

##### Run_set_8
# create arguments 
metadata_save_8=Irradiated_Responses_Run_set_8[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_8))]
metadata=Irradiated_Responses_Run_set_8[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_8))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_8[,grep("Dead_Cells_low_dose|Dead_Q1Q4_low_dose",colnames(Irradiated_Responses_Run_set_8))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_8$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_8, custom.delta=Delta_factor_Run_set_8, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_8 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_8=cbind(Rad_Corrected_Irrad_Samples_Run_Set_8, metadata_save_8)


########## Now we regroup run/set and radiation corrected irradiated samples 
Corrected_low_dose_irradiated_samples=bind_rows(Rad_Corrected_Irrad_Samples_Run_Set_1, Rad_Corrected_Irrad_Samples_Run_Set_2, 
                                       Rad_Corrected_Irrad_Samples_Run_Set_3, Rad_Corrected_Irrad_Samples_Run_Set_4,
                                       Rad_Corrected_Irrad_Samples_Run_Set_5, Rad_Corrected_Irrad_Samples_Run_Set_6, 
                                       Rad_Corrected_Irrad_Samples_Run_Set_7, Rad_Corrected_Irrad_Samples_Run_Set_8)

Corrected_low_dose_irradiated_samples$Run_set_batch=NULL
Corrected_low_dose_irradiated_samples$Radiation_Batch=NULL


################################ High dose ######################################
Raw_high_dose_irradiated_samples=Raw_CD_with_metadata[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Dead_Cells_high_dose|Dead_Q1Q4_high_dose",colnames(Raw_CD_with_metadata))]

Raw_high_dose_irradiated_samples$Rad_dose_Gy = Raw_high_dose_irradiated_samples$Radiation_type
Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Fe"] <- high_dose_Fe
Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Ar"] <- high_dose_Ar
Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Si"] <- high_dose_Si
Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Gamma"] <- high_dose_Gamma

Raw_high_dose_irradiated_samples=Raw_high_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Dead_Cells_high_dose|Dead_Q1Q4_high_dose|Rad_dose_Gy",colnames(Raw_high_dose_irradiated_samples))]

metadata_save = Raw_high_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Rad_dose",colnames(Raw_high_dose_irradiated_samples))]


Irradiated_Responses_Run_set_1 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 1)
Irradiated_Responses_Run_set_2 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 2)
Irradiated_Responses_Run_set_3 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 3)
Irradiated_Responses_Run_set_4 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 4)
Irradiated_Responses_Run_set_5 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 5)
Irradiated_Responses_Run_set_6 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 6)
Irradiated_Responses_Run_set_7 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 7)
Irradiated_Responses_Run_set_8 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 8)

##### Run_set_1
# create arguments 
metadata_save_1=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
metadata=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_1[,grep("Dead_Cells_high_dose|Dead_Q1Q4_high_dose",colnames(Irradiated_Responses_Run_set_1))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_1$Radiation_Batch
### Apply combat function (be careful to use the right gamma and delta factors specific to each run and set value and calculated on controls !! )
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_1, custom.delta=Delta_factor_Run_set_1, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_1 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_1=cbind(Rad_Corrected_Irrad_Samples_Run_Set_1, metadata_save_1)


##### Run_set_2
# create arguments 
metadata_save_2=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
metadata=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_2[,grep("Dead_Cells_high_dose|Dead_Q1Q4_high_dose",colnames(Irradiated_Responses_Run_set_2))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_2$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_2, custom.delta=Delta_factor_Run_set_2, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_2 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_2=cbind(Rad_Corrected_Irrad_Samples_Run_Set_2, metadata_save_2)


##### Run_set_3
# create arguments 
metadata_save_3=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
metadata=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_3[,grep("Dead_Cells_high_dose|Dead_Q1Q4_high_dose",colnames(Irradiated_Responses_Run_set_3))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_3$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_3, custom.delta=Delta_factor_Run_set_3, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_3 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_3=cbind(Rad_Corrected_Irrad_Samples_Run_Set_3, metadata_save_3)

##### Run_set_4
# create arguments 
metadata_save_4=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
metadata=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_4[,grep("Dead_Cells_high_dose|Dead_Q1Q4_high_dose",colnames(Irradiated_Responses_Run_set_4))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_4$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_4, custom.delta=Delta_factor_Run_set_4, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_4 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_4=cbind(Rad_Corrected_Irrad_Samples_Run_Set_4, metadata_save_4)

##### Run_set_5
# create arguments 
metadata_save_5=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
metadata=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_5[,grep("Dead_Cells_high_dose|Dead_Q1Q4_high_dose",colnames(Irradiated_Responses_Run_set_5))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_5$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_5, custom.delta=Delta_factor_Run_set_5, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_5 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_5=cbind(Rad_Corrected_Irrad_Samples_Run_Set_5, metadata_save_5)


##### Run_set_6
# create arguments 
metadata_save_6=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
metadata=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_6[,grep("Dead_Cells_high_dose|Dead_Q1Q4_high_dose",colnames(Irradiated_Responses_Run_set_6))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_6$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_6, custom.delta=Delta_factor_Run_set_6, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_6 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_6=cbind(Rad_Corrected_Irrad_Samples_Run_Set_6, metadata_save_6)

##### Run_set_7
# create arguments 
metadata_save_7=Irradiated_Responses_Run_set_7[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_7))]
metadata=Irradiated_Responses_Run_set_7[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_7))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_7[,grep("Dead_Cells_high_dose|Dead_Q1Q4_high_dose",colnames(Irradiated_Responses_Run_set_7))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_7$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_7, custom.delta=Delta_factor_Run_set_7, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_7 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_7=cbind(Rad_Corrected_Irrad_Samples_Run_Set_7, metadata_save_7)

##### Run_set_8
# create arguments 
metadata_save_8=Irradiated_Responses_Run_set_8[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_8))]
metadata=Irradiated_Responses_Run_set_8[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_8))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_8[,grep("Dead_Cells_high_dose|Dead_Q1Q4_high_dose",colnames(Irradiated_Responses_Run_set_8))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_8$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_8, custom.delta=Delta_factor_Run_set_8, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_8 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_8=cbind(Rad_Corrected_Irrad_Samples_Run_Set_8, metadata_save_8)


########## Now we regroup run/set and radiation corrected irradiated samples 
Corrected_high_dose_irradiated_samples=bind_rows(Rad_Corrected_Irrad_Samples_Run_Set_1, Rad_Corrected_Irrad_Samples_Run_Set_2, 
                                       Rad_Corrected_Irrad_Samples_Run_Set_3, Rad_Corrected_Irrad_Samples_Run_Set_4,
                                       Rad_Corrected_Irrad_Samples_Run_Set_5, Rad_Corrected_Irrad_Samples_Run_Set_6, 
                                       Rad_Corrected_Irrad_Samples_Run_Set_7, Rad_Corrected_Irrad_Samples_Run_Set_8)

Corrected_high_dose_irradiated_samples$Run_set_batch=NULL
Corrected_high_dose_irradiated_samples$Radiation_Batch=NULL


### Control, low irradiated and high irradiated samples are separate into 3 tables. In these three table, cell death data for all radiation/time points are mixed into one column and complete with two metadata columns = time point & radiation_type. For the three table, we need to separate results by time point and radiation in order to do the normalization using for each conditions the respective controls

## controls
Controls_4h = Corrected_controls %>% filter(Corrected_controls$Timepoint=="4h")
Controls_4h_Fe =Controls_4h %>% filter(Controls_4h$Radiation_type=="Fe")
Controls_4h_Ar = Controls_4h %>% filter(Controls_4h$Radiation_type=="Ar")
Controls_4h_Si = Controls_4h %>% filter(Controls_4h$Radiation_type=="Si")
Controls_4h_Gamma = Controls_4h %>% filter(Controls_4h$Radiation_type=="Gamma")
#
Controls_24h = Corrected_controls %>% filter(Corrected_controls$Timepoint=="24h")
Controls_24h_Fe = Controls_24h %>% filter(Controls_24h$Radiation_type=="Fe")
Controls_24h_Ar = Controls_24h%>% filter(Controls_24h$Radiation_type=="Ar")
Controls_24h_Si =Controls_24h %>% filter(Controls_24h$Radiation_type=="Si")
Controls_24h_Gamma = Controls_24h %>% filter(Controls_24h$Radiation_type=="Gamma")

## Low dose
LD_4h = Corrected_low_dose_irradiated_samples %>% filter(Corrected_low_dose_irradiated_samples$Timepoint=="4h")
LD_4h_Fe = LD_4h %>% filter(LD_4h$Radiation_type=="Fe")
LD_4h_Fe=LD_4h_Fe[,grepl("Sample_ID|Dead_Cells_low|Run_set|Duplicate",colnames(LD_4h_Fe))]
LD_4h_Ar = LD_4h %>% filter(LD_4h$Radiation_type=="Ar")
LD_4h_Ar=LD_4h_Ar[,grepl("Sample_ID|Dead_Cells_low|Run_set|Duplicate",colnames(LD_4h_Ar))]
LD_4h_Si = LD_4h %>% filter(LD_4h$Radiation_type=="Si")
LD_4h_Si=LD_4h_Si[,grepl("Sample_ID|Dead_Cells_low|Run_set|Duplicate",colnames(LD_4h_Si))]
LD_4h_Gamma = LD_4h %>% filter(LD_4h$Radiation_type=="Gamma")
LD_4h_Gamma=LD_4h_Gamma[,grepl("Sample_ID|Dead_Cells_low|Run_set|Duplicate",colnames(LD_4h_Gamma))]
#
LD_24h = Corrected_low_dose_irradiated_samples %>% filter(Corrected_low_dose_irradiated_samples$Timepoint=="24h")
LD_24h_Fe = LD_24h %>% filter(LD_24h$Radiation_type=="Fe")
LD_24h_Fe=LD_24h_Fe[,grepl("Sample_ID|Dead_Cells_low|Run_set|Duplicate",colnames(LD_24h_Fe))]
LD_24h_Ar = LD_24h %>% filter(LD_24h$Radiation_type=="Ar")
LD_24h_Ar=LD_24h_Ar[,grepl("Sample_ID|Dead_Cells_low|Run_set|Duplicate",colnames(LD_24h_Ar))]
LD_24h_Si = LD_24h %>% filter(LD_24h$Radiation_type=="Si")
LD_24h_Si=LD_24h_Si[,grepl("Sample_ID|Dead_Cells_low|Run_set|Duplicate",colnames(LD_24h_Si))]
LD_24h_Gamma = LD_24h %>% filter(LD_24h$Radiation_type=="Gamma")
LD_24h_Gamma=LD_24h_Gamma[,grepl("Sample_ID|Dead_Cells_low|Run_set|Duplicate",colnames(LD_24h_Gamma))]

## High dose
HD_4h = Corrected_high_dose_irradiated_samples %>% filter(Corrected_high_dose_irradiated_samples$Timepoint=="4h")
HD_4h_Fe = HD_4h %>% filter(HD_4h$Radiation_type=="Fe")
HD_4h_Fe=HD_4h_Fe[,grepl("Sample_ID|Dead_Cells_high|Run_set|Duplicate",colnames(HD_4h_Fe))]
HD_4h_Ar = HD_4h %>% filter(HD_4h$Radiation_type=="Ar")
HD_4h_Ar=HD_4h_Ar[,grepl("Sample_ID|Dead_Cells_high|Run_set|Duplicate",colnames(HD_4h_Ar))]
HD_4h_Si = HD_4h %>% filter(HD_4h$Radiation_type=="Si")
HD_4h_Si=HD_4h_Si[,grepl("Sample_ID|Dead_Cells_high|Run_set|Duplicate",colnames(HD_4h_Si))]
HD_4h_Gamma = HD_4h %>% filter(HD_4h$Radiation_type=="Gamma")
HD_4h_Gamma=HD_4h_Gamma[,grepl("Sample_ID|Dead_Cells_high|Run_set|Duplicate",colnames(HD_4h_Gamma))]
#
HD_24h = Corrected_high_dose_irradiated_samples %>% filter(Corrected_high_dose_irradiated_samples$Timepoint=="24h")
HD_24h_Fe = HD_24h %>% filter(HD_24h$Radiation_type=="Fe")
HD_24h_Fe=HD_24h_Fe[,grepl("Sample_ID|Dead_Cells_high|Run_set|Duplicate",colnames(HD_24h_Fe))]
HD_24h_Ar = HD_24h %>% filter(HD_24h$Radiation_type=="Ar")
HD_24h_Ar=HD_24h_Ar[,grepl("Sample_ID|Dead_Cells_high|Run_set|Duplicate",colnames(HD_24h_Ar))]
HD_24h_Si = HD_24h %>% filter(HD_24h$Radiation_type=="Si")
HD_24h_Si=HD_24h_Si[,grepl("Sample_ID|Dead_Cells_high|Run_set|Duplicate",colnames(HD_24h_Si))]
HD_24h_Gamma = HD_24h %>% filter(HD_24h$Radiation_type=="Gamma")
HD_24h_Gamma=HD_24h_Gamma[,grepl("Sample_ID|Dead_Cells_high|Run_set|Duplicate",colnames(HD_24h_Gamma))]


## Regroup 
Correct_Fe_4h=merge(Controls_4h_Fe, LD_4h_Fe, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Fe_4h=merge(Correct_Fe_4h, HD_4h_Fe, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Ar_4h=merge(Controls_4h_Ar, LD_4h_Ar, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Ar_4h=merge(Correct_Ar_4h, HD_4h_Ar, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Si_4h=merge(Controls_4h_Si, LD_4h_Si, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Si_4h=merge(Correct_Si_4h, HD_4h_Si, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Gamma_4h=merge(Controls_4h_Gamma, LD_4h_Gamma, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Gamma_4h=merge(Correct_Gamma_4h, HD_4h_Gamma, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Fe_24h=merge(Controls_24h_Fe, LD_24h_Fe, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Fe_24h=merge(Correct_Fe_24h, HD_24h_Fe, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Ar_24h=merge(Controls_24h_Ar, LD_24h_Ar, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Ar_24h=merge(Correct_Ar_24h, HD_24h_Ar, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Si_24h=merge(Controls_24h_Si, LD_24h_Si, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Si_24h=merge(Correct_Si_24h, HD_24h_Si, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Gamma_24h=merge(Controls_24h_Gamma, LD_24h_Gamma, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Gamma_24h=merge(Correct_Gamma_24h, HD_24h_Gamma, by=c("Sample_ID", "Duplicate", "Run_set"))

#### Regroup everything into 1 table

Corrected_Cell_Death= bind_rows(Correct_Fe_4h, Correct_Fe_24h,
                                Correct_Ar_4h, Correct_Ar_24h,
                                Correct_Si_4h, Correct_Si_24h,
                                Correct_Gamma_4h, Correct_Gamma_24h)

Corrected_Cell_Death$Rad_dose_Gy=NULL
#### The correction may generate negative value => we fix those negative value to 0 
Corrected_Cell_Death$Dead_Cells_0[Corrected_Cell_Death$Dead_Cells_0 < 0] <- 0 
Corrected_Cell_Death$Dead_Cells_low_dose[Corrected_Cell_Death$Dead_Cells_low_dose < 0] <-  0 
Corrected_Cell_Death$Dead_Cells_high_dose[Corrected_Cell_Death$Dead_Cells_high_dose < 0] <-  0 


###########################################################################
##################### 2) z-score correction ###############################
###########################################################################

# 19A is used as the reference, we perform the correction first between on 18B and then on 19C
Run_19A= c("Run_19A_Set_1", "Run_19A_Set_2")
Run_18B = c("Run_18B_Set_2", "Run_18B_Set_1")
Run_19C = c("Run_19C_Set_2", "Run_19C_Set_1", "Run_19C_Set_3", "Run_19C_Set_4")

Run_19A_18B = c("Run_18B_Set_2", "Run_18B_Set_1","Run_19A_Set_1", "Run_19A_Set_2")
CD_correct_19A_18B = Corrected_Cell_Death %>% filter(Corrected_Cell_Death$Run_set %in% Run_19A_18B)
Run_19A_19C = c("Run_19C_Set_2", "Run_19C_Set_1", "Run_19C_Set_3", "Run_19C_Set_4","Run_19A_Set_1", "Run_19A_Set_2")
CD_correct_19A_19C = Corrected_Cell_Death %>% filter(Corrected_Cell_Death$Run_set %in% Run_19A_19C)
# Select the 10 people that overlap in these two runs
Subject_18B_19A = c(1214, 1215,1216,1217,1218,1219,1220,1221,1222,1223)
Subject_19C_19A = c() ## Need to complete sample_ID of subjects that overlap in 19C and 19A

CD_correct_19A_18B_10p = CD_correct_19A_18B %>% filter(CD_correct_19A_18B$Sample_ID %in% Subject_18B_19A )
CD_correct_19A_19C_10p = CD_correct_19A_19C %>% filter(CD_correct_19A_19C$Sample_ID %in% Subject_19C_19A )


### 19C_Set_1: for each condition: time point, rad, and low high dose calculate the mean and variance that will be used as a reference 
Samp_19A_10p = CD_correct_19A_18B_10p %>% filter(CD_correct_19A_18B_10p$Run_set %in% Run_19A)

## For Controls 
Controls_19A= Samp_19A_10p
Controls_19A$Dead_Cells_low_dose=NULL
Controls_19A$Dead_Cells_high_dose=NULL
#
### 4h 
control_19A_4h = Controls_19A %>% filter(Controls_19A$Timepoint=="4h")
#
control_19A_4h_Fe = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Fe")
control_19A_4h_Ar = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Ar")
control_19A_4h_Si = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Si")
control_19A_4h_Gamma = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Gamma")
### 24h 
control_19A_24h = Controls_19A %>% filter(Controls_19A$Timepoint=="24h")
#
control_19A_24h_Fe = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Fe")
control_19A_24h_Ar = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Ar")
control_19A_24h_Si = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Si")
control_19A_24h_Gamma = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_ref_Cont_Fe_4h = mean(NaRV.omit(control_19A_4h_Fe$Dead_Cells_0))
Mean_ref_Cont_Ar_4h = mean(NaRV.omit(control_19A_4h_Ar$Dead_Cells_0))
Mean_ref_Cont_Si_4h = mean(NaRV.omit(control_19A_4h_Si$Dead_Cells_0))
Mean_ref_Cont_Gamma_4h = mean(NaRV.omit(control_19A_4h_Gamma$Dead_Cells_0))
# 24h
Mean_ref_Cont_Fe_24h = mean(NaRV.omit(control_19A_24h_Fe$Dead_Cells_0))
Mean_ref_Cont_Ar_24h = mean(NaRV.omit(control_19A_24h_Ar$Dead_Cells_0))
Mean_ref_Cont_Si_24h = mean(NaRV.omit(control_19A_24h_Si$Dead_Cells_0))
Mean_ref_Cont_Gamma_24h = mean(NaRV.omit(control_19A_24h_Gamma$Dead_Cells_0))
####### sd
# 4h
Std_ref_Cont_Fe_4h = sd(NaRV.omit(control_19A_4h_Fe$Dead_Cells_0))
Std_ref_Cont_Ar_4h = sd(NaRV.omit(control_19A_4h_Ar$Dead_Cells_0))
Std_ref_Cont_Si_4h = sd(NaRV.omit(control_19A_4h_Si$Dead_Cells_0))
Std_ref_Cont_Gamma_4h = sd(NaRV.omit(control_19A_4h_Gamma$Dead_Cells_0))
# 24h
Std_ref_Cont_Fe_24h = sd(NaRV.omit(control_19A_24h_Fe$Dead_Cells_0))
Std_ref_Cont_Ar_24h = sd(NaRV.omit(control_19A_24h_Ar$Dead_Cells_0))
Std_ref_Cont_Si_24h = sd(NaRV.omit(control_19A_24h_Si$Dead_Cells_0))
Std_ref_Cont_Gamma_24h = sd(NaRV.omit(control_19A_24h_Gamma$Dead_Cells_0))
#
#
## For Low dose irradiated samples
LD_19A= Samp_19A_10p
LD_19A$Dead_Cells_0=NULL
LD_19A$Dead_Cells_high_dose=NULL
#
### 4h 
LD_19A_4h = LD_19A %>% filter(LD_19A$Timepoint=="4h")
#
LD_19A_4h_Fe = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Fe")
LD_19A_4h_Ar = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Ar")
LD_19A_4h_Si = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Si")
LD_19A_4h_Gamma = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Gamma")
### 24h 
LD_19A_24h = LD_19A %>% filter(LD_19A$Timepoint=="24h")
#
LD_19A_24h_Fe = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Fe")
LD_19A_24h_Ar = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Ar")
LD_19A_24h_Si = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Si")
LD_19A_24h_Gamma = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_ref_LD_Fe_4h = mean(NaRV.omit(LD_19A_4h_Fe$Dead_Cells_low_dose))
Mean_ref_LD_Ar_4h = mean(NaRV.omit(LD_19A_4h_Ar$Dead_Cells_low_dose))
Mean_ref_LD_Si_4h = mean(NaRV.omit(LD_19A_4h_Si$Dead_Cells_low_dose))
Mean_ref_LD_Gamma_4h = mean(NaRV.omit(LD_19A_4h_Gamma$Dead_Cells_low_dose))
# 24h
Mean_ref_LD_Fe_24h = mean(NaRV.omit(LD_19A_24h_Fe$Dead_Cells_low_dose))
Mean_ref_LD_Ar_24h = mean(NaRV.omit(LD_19A_24h_Ar$Dead_Cells_low_dose))
Mean_ref_LD_Si_24h = mean(NaRV.omit(LD_19A_24h_Si$Dead_Cells_low_dose))
Mean_ref_LD_Gamma_24h = mean(NaRV.omit(LD_19A_24h_Gamma$Dead_Cells_low_dose))
####### sd
# 4h
Std_ref_LD_Fe_4h = sd(NaRV.omit(LD_19A_4h_Fe$Dead_Cells_low_dose))
Std_ref_LD_Ar_4h = sd(NaRV.omit(LD_19A_4h_Ar$Dead_Cells_low_dose))
Std_ref_LD_Si_4h = sd(NaRV.omit(LD_19A_4h_Si$Dead_Cells_low_dose))
Std_ref_LD_Gamma_4h = sd(NaRV.omit(LD_19A_4h_Gamma$Dead_Cells_low_dose))
# 24h
Std_ref_LD_Fe_24h = sd(NaRV.omit(LD_19A_24h_Fe$Dead_Cells_low_dose))
Std_ref_LD_Ar_24h = sd(NaRV.omit(LD_19A_24h_Ar$Dead_Cells_low_dose))
Std_ref_LD_Si_24h = sd(NaRV.omit(LD_19A_24h_Si$Dead_Cells_low_dose))
Std_ref_LD_Gamma_24h = sd(NaRV.omit(LD_19A_24h_Gamma$Dead_Cells_low_dose))
#
#
## For high dose irradiated samples
HD_19A= Samp_19A_10p
HD_19A$Dead_Cells_0=NULL
HD_19A$Dead_Cells_low_dose=NULL
#
### 4h 
HD_19A_4h = HD_19A %>% filter(HD_19A$Timepoint=="4h")
#
HD_19A_4h_Fe = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Fe")
HD_19A_4h_Ar = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Ar")
HD_19A_4h_Si = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Si")
HD_19A_4h_Gamma = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Gamma")
### 24h 
HD_19A_24h = HD_19A %>% filter(HD_19A$Timepoint=="24h")
#
HD_19A_24h_Fe = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Fe")
HD_19A_24h_Ar = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Ar")
HD_19A_24h_Si = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Si")
HD_19A_24h_Gamma = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_ref_HD_Fe_4h = mean(NaRV.omit(HD_19A_4h_Fe$Dead_Cells_high_dose))
Mean_ref_HD_Ar_4h = mean(NaRV.omit(HD_19A_4h_Ar$Dead_Cells_high_dose))
Mean_ref_HD_Si_4h = mean(NaRV.omit(HD_19A_4h_Si$Dead_Cells_high_dose))
Mean_ref_HD_Gamma_4h = mean(NaRV.omit(HD_19A_4h_Gamma$Dead_Cells_high_dose))
# 24h
Mean_ref_HD_Fe_24h = mean(NaRV.omit(HD_19A_24h_Fe$Dead_Cells_high_dose))
Mean_ref_HD_Ar_24h = mean(NaRV.omit(HD_19A_24h_Ar$Dead_Cells_high_dose))
Mean_ref_HD_Si_24h = mean(NaRV.omit(HD_19A_24h_Si$Dead_Cells_high_dose))
Mean_ref_HD_Gamma_24h = mean(NaRV.omit(HD_19A_24h_Gamma$Dead_Cells_high_dose))
####### sd
# 4h
Std_ref_HD_Fe_4h = sd(NaRV.omit(HD_19A_4h_Fe$Dead_Cells_high_dose))
Std_ref_HD_Ar_4h = sd(NaRV.omit(HD_19A_4h_Ar$Dead_Cells_high_dose))
Std_ref_HD_Si_4h = sd(NaRV.omit(HD_19A_4h_Si$Dead_Cells_high_dose))
Std_ref_HD_Gamma_4h = sd(NaRV.omit(HD_19A_4h_Gamma$Dead_Cells_high_dose))
# 24h
Std_ref_HD_Fe_24h = sd(NaRV.omit(HD_19A_24h_Fe$Dead_Cells_high_dose))
Std_ref_HD_Ar_24h = sd(NaRV.omit(HD_19A_24h_Ar$Dead_Cells_high_dose))
Std_ref_HD_Si_24h = sd(NaRV.omit(HD_19A_24h_Si$Dead_Cells_high_dose))
Std_ref_HD_Gamma_24h = sd(NaRV.omit(HD_19A_24h_Gamma$Dead_Cells_high_dose))

############################## For controls and irradiated samples 18B we also calculate mean and std to perform the "z-score" normalization
############ For the 10 peoples that overlap ##########

Samp_18B_10p = CD_correct_19A_18B_10p %>% filter(CD_correct_19A_18B_10p$Run_set %in% Run_18B)

## For Controls 
Controls_18B= Samp_18B_10p
Controls_18B$Dead_Cells_low_dose=NULL
Controls_18B$Dead_Cells_high_dose=NULL
#
### 4h 
control_18B_4h = Controls_18B %>% filter(Controls_18B$Timepoint=="4h")
#
control_18B_4h_Fe = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Fe")
control_18B_4h_Ar = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Ar")
control_18B_4h_Si = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Si")
control_18B_4h_Gamma = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Gamma")
### 24h 
control_18B_24h = Controls_18B %>% filter(Controls_18B$Timepoint=="24h")
#
control_18B_24h_Fe = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Fe")
control_18B_24h_Ar = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Ar")
control_18B_24h_Si = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Si")
control_18B_24h_Gamma = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_Cont_Fe_4h = mean(NaRV.omit(control_18B_4h_Fe$Dead_Cells_0))
Mean_Cont_Ar_4h = mean(NaRV.omit(control_18B_4h_Ar$Dead_Cells_0))
Mean_Cont_Si_4h = mean(NaRV.omit(control_18B_4h_Si$Dead_Cells_0))
Mean_Cont_Gamma_4h = mean(NaRV.omit(control_18B_4h_Gamma$Dead_Cells_0))
# 24h
Mean_Cont_Fe_24h = mean(NaRV.omit(control_18B_24h_Fe$Dead_Cells_0))
Mean_Cont_Ar_24h = mean(NaRV.omit(control_18B_24h_Ar$Dead_Cells_0))
Mean_Cont_Si_24h = mean(NaRV.omit(control_18B_24h_Si$Dead_Cells_0))
Mean_Cont_Gamma_24h = mean(NaRV.omit(control_18B_24h_Gamma$Dead_Cells_0))
####### sd
# 4h
Std_Cont_Fe_4h = sd(NaRV.omit(control_18B_4h_Fe$Dead_Cells_0))
Std_Cont_Ar_4h = sd(NaRV.omit(control_18B_4h_Ar$Dead_Cells_0))
Std_Cont_Si_4h = sd(NaRV.omit(control_18B_4h_Si$Dead_Cells_0))
Std_Cont_Gamma_4h = sd(NaRV.omit(control_18B_4h_Gamma$Dead_Cells_0))
# 24h
Std_Cont_Fe_24h = sd(NaRV.omit(control_18B_24h_Fe$Dead_Cells_0))
Std_Cont_Ar_24h = sd(NaRV.omit(control_18B_24h_Ar$Dead_Cells_0))
Std_Cont_Si_24h = sd(NaRV.omit(control_18B_24h_Si$Dead_Cells_0))
Std_Cont_Gamma_24h = sd(NaRV.omit(control_18B_24h_Gamma$Dead_Cells_0))
#
## z-score correction on all people from 18B
Controls_allp_18B= Corrected_Cell_Death %>% filter(Corrected_Cell_Death$Run_set %in% Run_18B)
Controls_allp_18B$Dead_Cells_low_dose=NULL
Controls_allp_18B$Dead_Cells_high_dose=NULL
#
### 4h 
control_allp_18B_4h = Controls_allp_18B %>% filter(Controls_allp_18B$Timepoint=="4h")
#
control_allp_18B_4h_Fe = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Fe")
control_allp_18B_4h_Ar = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Ar")
control_allp_18B_4h_Si = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Si")
control_allp_18B_4h_Gamma = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Gamma")
### 24h 
control_allp_18B_24h = Controls_allp_18B %>% filter(Controls_allp_18B$Timepoint=="24h")
#
control_allp_18B_24h_Fe = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Fe")
control_allp_18B_24h_Ar = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Ar")
control_allp_18B_24h_Si = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Si")
control_allp_18B_24h_Gamma = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Gamma")
## z-score correction
# 4h
control_allp_18B_4h_Fe$Dead_Cells_0 = (((control_allp_18B_4h_Fe$Dead_Cells_0 - Mean_Cont_Fe_4h)/Std_Cont_Fe_4h)*Std_ref_Cont_Fe_4h) + Mean_ref_Cont_Fe_4h
control_allp_18B_4h_Ar$Dead_Cells_0 = (((control_allp_18B_4h_Ar$Dead_Cells_0 - Mean_Cont_Ar_4h)/Std_Cont_Ar_4h)*Std_ref_Cont_Ar_4h) + Mean_ref_Cont_Ar_4h
control_allp_18B_4h_Si$Dead_Cells_0 = (((control_allp_18B_4h_Si$Dead_Cells_0 - Mean_Cont_Si_4h)/Std_Cont_Si_4h)*Std_ref_Cont_Si_4h) + Mean_ref_Cont_Si_4h
control_allp_18B_4h_Gamma$Dead_Cells_0 = (((control_allp_18B_4h_Gamma$Dead_Cells_0 - Mean_Cont_Gamma_4h)/Std_Cont_Gamma_4h)*Std_ref_Cont_Gamma_4h) + Mean_ref_Cont_Gamma_4h
# 24h
control_allp_18B_24h_Fe$Dead_Cells_0 = (((control_allp_18B_24h_Fe$Dead_Cells_0 - Mean_Cont_Fe_24h)/Std_Cont_Fe_24h)*Std_ref_Cont_Fe_24h) + Mean_ref_Cont_Fe_24h
control_allp_18B_24h_Ar$Dead_Cells_0 = (((control_allp_18B_24h_Ar$Dead_Cells_0 - Mean_Cont_Ar_24h)/Std_Cont_Ar_24h)*Std_ref_Cont_Ar_24h) + Mean_ref_Cont_Ar_24h
control_allp_18B_24h_Si$Dead_Cells_0 = (((control_allp_18B_24h_Si$Dead_Cells_0 - Mean_Cont_Si_24h)/Std_Cont_Si_24h)*Std_ref_Cont_Si_24h) + Mean_ref_Cont_Si_24h
control_allp_18B_24h_Gamma$Dead_Cells_0 = (((control_allp_18B_24h_Gamma$Dead_Cells_0 - Mean_Cont_Gamma_24h)/Std_Cont_Gamma_24h)*Std_ref_Cont_Gamma_24h) + Mean_ref_Cont_Gamma_24h
##
##
## For Low dose irradiated samples
LD_18B= Samp_18B_10p
LD_18B$Dead_Cells_0=NULL
LD_18B$Dead_Cells_high_dose=NULL
#
### 4h 
LD_18B_4h = LD_18B %>% filter(LD_18B$Timepoint=="4h")
#
LD_18B_4h_Fe = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Fe")
LD_18B_4h_Ar = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Ar")
LD_18B_4h_Si = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Si")
LD_18B_4h_Gamma = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Gamma")
### 24h 
LD_18B_24h = LD_18B %>% filter(LD_18B$Timepoint=="24h")
#
LD_18B_24h_Fe = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Fe")
LD_18B_24h_Ar = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Ar")
LD_18B_24h_Si = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Si")
LD_18B_24h_Gamma = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_LD_Fe_4h = mean(NaRV.omit(LD_18B_4h_Fe$Dead_Cells_low_dose))
Mean_LD_Ar_4h = mean(NaRV.omit(LD_18B_4h_Ar$Dead_Cells_low_dose))
Mean_LD_Si_4h = mean(NaRV.omit(LD_18B_4h_Si$Dead_Cells_low_dose))
Mean_LD_Gamma_4h = mean(NaRV.omit(LD_18B_4h_Gamma$Dead_Cells_low_dose))
# 24h
Mean_LD_Fe_24h = mean(NaRV.omit(LD_18B_24h_Fe$Dead_Cells_low_dose))
Mean_LD_Ar_24h = mean(NaRV.omit(LD_18B_24h_Ar$Dead_Cells_low_dose))
Mean_LD_Si_24h = mean(NaRV.omit(LD_18B_24h_Si$Dead_Cells_low_dose))
Mean_LD_Gamma_24h = mean(NaRV.omit(LD_18B_24h_Gamma$Dead_Cells_low_dose))
####### sd
# 4h
Std_LD_Fe_4h = sd(NaRV.omit(LD_18B_4h_Fe$Dead_Cells_low_dose))
Std_LD_Ar_4h = sd(NaRV.omit(LD_18B_4h_Ar$Dead_Cells_low_dose))
Std_LD_Si_4h = sd(NaRV.omit(LD_18B_4h_Si$Dead_Cells_low_dose))
Std_LD_Gamma_4h = sd(NaRV.omit(LD_18B_4h_Gamma$Dead_Cells_low_dose))
# 24h
Std_LD_Fe_24h = sd(NaRV.omit(LD_18B_24h_Fe$Dead_Cells_low_dose))
Std_LD_Ar_24h = sd(NaRV.omit(LD_18B_24h_Ar$Dead_Cells_low_dose))
Std_LD_Si_24h = sd(NaRV.omit(LD_18B_24h_Si$Dead_Cells_low_dose))
Std_LD_Gamma_24h = sd(NaRV.omit(LD_18B_24h_Gamma$Dead_Cells_low_dose))
#
#
## z-score correction on all people from 18B
LD_allp_18B= Corrected_Cell_Death %>% filter(Corrected_Cell_Death$Run_set %in% Run_18B)
LD_allp_18B$Dead_Cells_0=NULL
LD_allp_18B$Dead_Cells_high_dose=NULL
#
### 4h 
LD_allp_18B_4h = LD_allp_18B %>% filter(LD_allp_18B$Timepoint=="4h")
#
LD_allp_18B_4h_Fe = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Fe")
LD_allp_18B_4h_Ar = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Ar")
LD_allp_18B_4h_Si = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Si")
LD_allp_18B_4h_Gamma = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Gamma")
### 24h 
LD_allp_18B_24h = LD_allp_18B %>% filter(LD_allp_18B$Timepoint=="24h")
#
LD_allp_18B_24h_Fe = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Fe")
LD_allp_18B_24h_Ar = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Ar")
LD_allp_18B_24h_Si = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Si")
LD_allp_18B_24h_Gamma = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Gamma")

## z-score correction
# 4h
LD_allp_18B_4h_Fe$Dead_Cells_low_dose = (((LD_allp_18B_4h_Fe$Dead_Cells_low_dose - Mean_LD_Fe_4h)/Std_LD_Fe_4h)*Std_ref_LD_Fe_4h) + Mean_ref_LD_Fe_4h
LD_allp_18B_4h_Ar$Dead_Cells_low_dose = (((LD_allp_18B_4h_Ar$Dead_Cells_low_dose - Mean_LD_Ar_4h)/Std_LD_Ar_4h)*Std_ref_LD_Ar_4h) + Mean_ref_LD_Ar_4h
LD_allp_18B_4h_Si$Dead_Cells_low_dose = (((LD_allp_18B_4h_Si$Dead_Cells_low_dose - Mean_LD_Si_4h)/Std_LD_Si_4h)*Std_ref_LD_Si_4h) + Mean_ref_LD_Si_4h
LD_allp_18B_4h_Gamma$Dead_Cells_low_dose = (((LD_allp_18B_4h_Gamma$Dead_Cells_low_dose - Mean_LD_Gamma_4h)/Std_LD_Gamma_4h)*Std_ref_LD_Gamma_4h) + Mean_ref_LD_Gamma_4h
# 24h
LD_allp_18B_24h_Fe$Dead_Cells_low_dose = (((LD_allp_18B_24h_Fe$Dead_Cells_low_dose - Mean_LD_Fe_24h)/Std_LD_Fe_24h)*Std_ref_LD_Fe_24h) + Mean_ref_LD_Fe_24h
LD_allp_18B_24h_Ar$Dead_Cells_low_dose = (((LD_allp_18B_24h_Ar$Dead_Cells_low_dose - Mean_LD_Ar_24h)/Std_LD_Ar_24h)*Std_ref_LD_Ar_24h) + Mean_ref_LD_Ar_24h
LD_allp_18B_24h_Si$Dead_Cells_low_dose = (((LD_allp_18B_24h_Si$Dead_Cells_low_dose - Mean_LD_Si_24h)/Std_LD_Si_24h)*Std_ref_LD_Si_24h) + Mean_ref_LD_Si_24h
LD_allp_18B_24h_Gamma$Dead_Cells_low_dose = (((LD_allp_18B_24h_Gamma$Dead_Cells_low_dose - Mean_LD_Gamma_24h)/Std_LD_Gamma_24h)*Std_ref_LD_Gamma_24h) + Mean_ref_LD_Gamma_24h


## For high dose irradiated samples
HD_18B= Samp_18B_10p
HD_18B$Dead_Cells_0=NULL
HD_18B$Dead_Cells_low_dose=NULL
#
### 4h 
HD_18B_4h = HD_18B %>% filter(HD_18B$Timepoint=="4h")
#
HD_18B_4h_Fe = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Fe")
HD_18B_4h_Ar = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Ar")
HD_18B_4h_Si = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Si")
HD_18B_4h_Gamma = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Gamma")
### 24h 
HD_18B_24h = HD_18B %>% filter(HD_18B$Timepoint=="24h")
#
HD_18B_24h_Fe = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Fe")
HD_18B_24h_Ar = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Ar")
HD_18B_24h_Si = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Si")
HD_18B_24h_Gamma = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_HD_Fe_4h = mean(NaRV.omit(HD_18B_4h_Fe$Dead_Cells_high_dose))
Mean_HD_Ar_4h = mean(NaRV.omit(HD_18B_4h_Ar$Dead_Cells_high_dose))
Mean_HD_Si_4h = mean(NaRV.omit(HD_18B_4h_Si$Dead_Cells_high_dose))
Mean_HD_Gamma_4h = mean(NaRV.omit(HD_18B_4h_Gamma$Dead_Cells_high_dose))
# 24h
Mean_HD_Fe_24h = mean(NaRV.omit(HD_18B_24h_Fe$Dead_Cells_high_dose))
Mean_HD_Ar_24h = mean(NaRV.omit(HD_18B_24h_Ar$Dead_Cells_high_dose))
Mean_HD_Si_24h = mean(NaRV.omit(HD_18B_24h_Si$Dead_Cells_high_dose))
Mean_HD_Gamma_24h = mean(NaRV.omit(HD_18B_24h_Gamma$Dead_Cells_high_dose))
####### sd
# 4h
Std_HD_Fe_4h = sd(NaRV.omit(HD_18B_4h_Fe$Dead_Cells_high_dose))
Std_HD_Ar_4h = sd(NaRV.omit(HD_18B_4h_Ar$Dead_Cells_high_dose))
Std_HD_Si_4h = sd(NaRV.omit(HD_18B_4h_Si$Dead_Cells_high_dose))
Std_HD_Gamma_4h = sd(NaRV.omit(HD_18B_4h_Gamma$Dead_Cells_high_dose))
# 24h
Std_HD_Fe_24h = sd(NaRV.omit(HD_18B_24h_Fe$Dead_Cells_high_dose))
Std_HD_Ar_24h = sd(NaRV.omit(HD_18B_24h_Ar$Dead_Cells_high_dose))
Std_HD_Si_24h = sd(NaRV.omit(HD_18B_24h_Si$Dead_Cells_high_dose))
Std_HD_Gamma_24h = sd(NaRV.omit(HD_18B_24h_Gamma$Dead_Cells_high_dose))
#
#
## z-score correction on all people from 18B
HD_allp_18B= Corrected_Cell_Death %>% filter(Corrected_Cell_Death$Run_set %in% Run_18B)
HD_allp_18B$Dead_Cells_0=NULL
HD_allp_18B$Dead_Cells_low_dose=NULL
#
### 4h 
HD_allp_18B_4h = HD_allp_18B %>% filter(HD_allp_18B$Timepoint=="4h")
#
HD_allp_18B_4h_Fe = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Fe")
HD_allp_18B_4h_Ar = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Ar")
HD_allp_18B_4h_Si = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Si")
HD_allp_18B_4h_Gamma = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Gamma")
### 24h 
HD_allp_18B_24h = HD_allp_18B %>% filter(HD_allp_18B$Timepoint=="24h")
#
HD_allp_18B_24h_Fe = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Fe")
HD_allp_18B_24h_Ar = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Ar")
HD_allp_18B_24h_Si = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Si")
HD_allp_18B_24h_Gamma = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Gamma")

## z-score correction
# 4h
HD_allp_18B_4h_Fe$Dead_Cells_high_dose = (((HD_allp_18B_4h_Fe$Dead_Cells_high_dose - Mean_HD_Fe_4h)/Std_HD_Fe_4h)*Std_ref_HD_Fe_4h) + Mean_ref_HD_Fe_4h
HD_allp_18B_4h_Ar$Dead_Cells_high_dose = (((HD_allp_18B_4h_Ar$Dead_Cells_high_dose - Mean_HD_Ar_4h)/Std_HD_Ar_4h)*Std_ref_HD_Ar_4h) + Mean_ref_HD_Ar_4h
HD_allp_18B_4h_Si$Dead_Cells_high_dose = (((HD_allp_18B_4h_Si$Dead_Cells_high_dose - Mean_HD_Si_4h)/Std_HD_Si_4h)*Std_ref_HD_Si_4h) + Mean_ref_HD_Si_4h
HD_allp_18B_4h_Gamma$Dead_Cells_high_dose = (((HD_allp_18B_4h_Gamma$Dead_Cells_high_dose - Mean_HD_Gamma_4h)/Std_HD_Gamma_4h)*Std_ref_HD_Gamma_4h) + Mean_ref_HD_Gamma_4h
# 24h
HD_allp_18B_24h_Fe$Dead_Cells_high_dose = (((HD_allp_18B_24h_Fe$Dead_Cells_high_dose - Mean_HD_Fe_24h)/Std_HD_Fe_24h)*Std_ref_HD_Fe_24h) + Mean_ref_HD_Fe_24h
HD_allp_18B_24h_Ar$Dead_Cells_high_dose = (((HD_allp_18B_24h_Ar$Dead_Cells_high_dose - Mean_HD_Ar_24h)/Std_HD_Ar_24h)*Std_ref_HD_Ar_24h) + Mean_ref_HD_Ar_24h
HD_allp_18B_24h_Si$Dead_Cells_high_dose = (((HD_allp_18B_24h_Si$Dead_Cells_high_dose - Mean_HD_Si_24h)/Std_HD_Si_24h)*Std_ref_HD_Si_24h) + Mean_ref_HD_Si_24h
HD_allp_18B_24h_Gamma$Dead_Cells_high_dose = (((HD_allp_18B_24h_Gamma$Dead_Cells_high_dose - Mean_HD_Gamma_24h)/Std_HD_Gamma_24h)*Std_ref_HD_Gamma_24h) + Mean_ref_HD_Gamma_24h

############################## For controls and irradiated samples 19C we also calculate mean and std to perform the "z-score" normalization
############ For the 10 peoples that overlap ##########

Samp_19C_10p = CD_correct_19A_19C_10p %>% filter(CD_correct_19A_19C_10p$Run_set %in% Run_19C)

## For Controls 
Controls_19C= Samp_19C_10p
Controls_19C$Dead_Cells_low_dose=NULL
Controls_19C$Dead_Cells_high_dose=NULL
#
### 4h 
control_19C_4h = Controls_19C %>% filter(Controls_19C$Timepoint=="4h")
#
control_19C_4h_Fe = control_19C_4h %>% filter(control_19C_4h$Radiation_type=="Fe")
control_19C_4h_Ar = control_19C_4h %>% filter(control_19C_4h$Radiation_type=="Ar")
control_19C_4h_Si = control_19C_4h %>% filter(control_19C_4h$Radiation_type=="Si")
control_19C_4h_Gamma = control_19C_4h %>% filter(control_19C_4h$Radiation_type=="Gamma")
### 24h 
control_19C_24h = Controls_19C %>% filter(Controls_19C$Timepoint=="24h")
#
control_19C_24h_Fe = control_19C_24h %>% filter(control_19C_24h$Radiation_type=="Fe")
control_19C_24h_Ar = control_19C_24h %>% filter(control_19C_24h$Radiation_type=="Ar")
control_19C_24h_Si = control_19C_24h %>% filter(control_19C_24h$Radiation_type=="Si")
control_19C_24h_Gamma = control_19C_24h %>% filter(control_19C_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_Cont_Fe_4h = mean(NaRV.omit(control_19C_4h_Fe$Dead_Cells_0))
Mean_Cont_Ar_4h = mean(NaRV.omit(control_19C_4h_Ar$Dead_Cells_0))
Mean_Cont_Si_4h = mean(NaRV.omit(control_19C_4h_Si$Dead_Cells_0))
Mean_Cont_Gamma_4h = mean(NaRV.omit(control_19C_4h_Gamma$Dead_Cells_0))
# 24h
Mean_Cont_Fe_24h = mean(NaRV.omit(control_19C_24h_Fe$Dead_Cells_0))
Mean_Cont_Ar_24h = mean(NaRV.omit(control_19C_24h_Ar$Dead_Cells_0))
Mean_Cont_Si_24h = mean(NaRV.omit(control_19C_24h_Si$Dead_Cells_0))
Mean_Cont_Gamma_24h = mean(NaRV.omit(control_19C_24h_Gamma$Dead_Cells_0))
####### sd
# 4h
Std_Cont_Fe_4h = sd(NaRV.omit(control_19C_4h_Fe$Dead_Cells_0))
Std_Cont_Ar_4h = sd(NaRV.omit(control_19C_4h_Ar$Dead_Cells_0))
Std_Cont_Si_4h = sd(NaRV.omit(control_19C_4h_Si$Dead_Cells_0))
Std_Cont_Gamma_4h = sd(NaRV.omit(control_19C_4h_Gamma$Dead_Cells_0))
# 24h
Std_Cont_Fe_24h = sd(NaRV.omit(control_19C_24h_Fe$Dead_Cells_0))
Std_Cont_Ar_24h = sd(NaRV.omit(control_19C_24h_Ar$Dead_Cells_0))
Std_Cont_Si_24h = sd(NaRV.omit(control_19C_24h_Si$Dead_Cells_0))
Std_Cont_Gamma_24h = sd(NaRV.omit(control_19C_24h_Gamma$Dead_Cells_0))
#
## z-score correction on all people from 19C
Controls_allp_19C= Corrected_Cell_Death %>% filter(Corrected_Cell_Death$Run_set %in% Run_19C)
Controls_allp_19C$Dead_Cells_low_dose=NULL
Controls_allp_19C$Dead_Cells_high_dose=NULL
#
### 4h 
control_allp_19C_4h = Controls_allp_19C %>% filter(Controls_allp_19C$Timepoint=="4h")
#
control_allp_19C_4h_Fe = control_allp_19C_4h %>% filter(control_allp_19C_4h$Radiation_type=="Fe")
control_allp_19C_4h_Ar = control_allp_19C_4h %>% filter(control_allp_19C_4h$Radiation_type=="Ar")
control_allp_19C_4h_Si = control_allp_19C_4h %>% filter(control_allp_19C_4h$Radiation_type=="Si")
control_allp_19C_4h_Gamma = control_allp_19C_4h %>% filter(control_allp_19C_4h$Radiation_type=="Gamma")
### 24h 
control_allp_19C_24h = Controls_allp_19C %>% filter(Controls_allp_19C$Timepoint=="24h")
#
control_allp_19C_24h_Fe = control_allp_19C_24h %>% filter(control_allp_19C_24h$Radiation_type=="Fe")
control_allp_19C_24h_Ar = control_allp_19C_24h %>% filter(control_allp_19C_24h$Radiation_type=="Ar")
control_allp_19C_24h_Si = control_allp_19C_24h %>% filter(control_allp_19C_24h$Radiation_type=="Si")
control_allp_19C_24h_Gamma = control_allp_19C_24h %>% filter(control_allp_19C_24h$Radiation_type=="Gamma")
## z-score correction
# 4h
control_allp_19C_4h_Fe$Dead_Cells_0 = (((control_allp_19C_4h_Fe$Dead_Cells_0 - Mean_Cont_Fe_4h)/Std_Cont_Fe_4h)*Std_ref_Cont_Fe_4h) + Mean_ref_Cont_Fe_4h
control_allp_19C_4h_Ar$Dead_Cells_0 = (((control_allp_19C_4h_Ar$Dead_Cells_0 - Mean_Cont_Ar_4h)/Std_Cont_Ar_4h)*Std_ref_Cont_Ar_4h) + Mean_ref_Cont_Ar_4h
control_allp_19C_4h_Si$Dead_Cells_0 = (((control_allp_19C_4h_Si$Dead_Cells_0 - Mean_Cont_Si_4h)/Std_Cont_Si_4h)*Std_ref_Cont_Si_4h) + Mean_ref_Cont_Si_4h
control_allp_19C_4h_Gamma$Dead_Cells_0 = (((control_allp_19C_4h_Gamma$Dead_Cells_0 - Mean_Cont_Gamma_4h)/Std_Cont_Gamma_4h)*Std_ref_Cont_Gamma_4h) + Mean_ref_Cont_Gamma_4h
# 24h
control_allp_19C_24h_Fe$Dead_Cells_0 = (((control_allp_19C_24h_Fe$Dead_Cells_0 - Mean_Cont_Fe_24h)/Std_Cont_Fe_24h)*Std_ref_Cont_Fe_24h) + Mean_ref_Cont_Fe_24h
control_allp_19C_24h_Ar$Dead_Cells_0 = (((control_allp_19C_24h_Ar$Dead_Cells_0 - Mean_Cont_Ar_24h)/Std_Cont_Ar_24h)*Std_ref_Cont_Ar_24h) + Mean_ref_Cont_Ar_24h
control_allp_19C_24h_Si$Dead_Cells_0 = (((control_allp_19C_24h_Si$Dead_Cells_0 - Mean_Cont_Si_24h)/Std_Cont_Si_24h)*Std_ref_Cont_Si_24h) + Mean_ref_Cont_Si_24h
control_allp_19C_24h_Gamma$Dead_Cells_0 = (((control_allp_19C_24h_Gamma$Dead_Cells_0 - Mean_Cont_Gamma_24h)/Std_Cont_Gamma_24h)*Std_ref_Cont_Gamma_24h) + Mean_ref_Cont_Gamma_24h
##
##
## For Low dose irradiated samples
LD_19C= Samp_19C_10p
LD_19C$Dead_Cells_0=NULL
LD_19C$Dead_Cells_high_dose=NULL
#
### 4h 
LD_19C_4h = LD_19C %>% filter(LD_19C$Timepoint=="4h")
#
LD_19C_4h_Fe = LD_19C_4h %>% filter(LD_19C_4h$Radiation_type=="Fe")
LD_19C_4h_Ar = LD_19C_4h %>% filter(LD_19C_4h$Radiation_type=="Ar")
LD_19C_4h_Si = LD_19C_4h %>% filter(LD_19C_4h$Radiation_type=="Si")
LD_19C_4h_Gamma = LD_19C_4h %>% filter(LD_19C_4h$Radiation_type=="Gamma")
### 24h 
LD_19C_24h = LD_19C %>% filter(LD_19C$Timepoint=="24h")
#
LD_19C_24h_Fe = LD_19C_24h %>% filter(LD_19C_24h$Radiation_type=="Fe")
LD_19C_24h_Ar = LD_19C_24h %>% filter(LD_19C_24h$Radiation_type=="Ar")
LD_19C_24h_Si = LD_19C_24h %>% filter(LD_19C_24h$Radiation_type=="Si")
LD_19C_24h_Gamma = LD_19C_24h %>% filter(LD_19C_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_LD_Fe_4h = mean(NaRV.omit(LD_19C_4h_Fe$Dead_Cells_low_dose))
Mean_LD_Ar_4h = mean(NaRV.omit(LD_19C_4h_Ar$Dead_Cells_low_dose))
Mean_LD_Si_4h = mean(NaRV.omit(LD_19C_4h_Si$Dead_Cells_low_dose))
Mean_LD_Gamma_4h = mean(NaRV.omit(LD_19C_4h_Gamma$Dead_Cells_low_dose))
# 24h
Mean_LD_Fe_24h = mean(NaRV.omit(LD_19C_24h_Fe$Dead_Cells_low_dose))
Mean_LD_Ar_24h = mean(NaRV.omit(LD_19C_24h_Ar$Dead_Cells_low_dose))
Mean_LD_Si_24h = mean(NaRV.omit(LD_19C_24h_Si$Dead_Cells_low_dose))
Mean_LD_Gamma_24h = mean(NaRV.omit(LD_19C_24h_Gamma$Dead_Cells_low_dose))
####### sd
# 4h
Std_LD_Fe_4h = sd(NaRV.omit(LD_19C_4h_Fe$Dead_Cells_low_dose))
Std_LD_Ar_4h = sd(NaRV.omit(LD_19C_4h_Ar$Dead_Cells_low_dose))
Std_LD_Si_4h = sd(NaRV.omit(LD_19C_4h_Si$Dead_Cells_low_dose))
Std_LD_Gamma_4h = sd(NaRV.omit(LD_19C_4h_Gamma$Dead_Cells_low_dose))
# 24h
Std_LD_Fe_24h = sd(NaRV.omit(LD_19C_24h_Fe$Dead_Cells_low_dose))
Std_LD_Ar_24h = sd(NaRV.omit(LD_19C_24h_Ar$Dead_Cells_low_dose))
Std_LD_Si_24h = sd(NaRV.omit(LD_19C_24h_Si$Dead_Cells_low_dose))
Std_LD_Gamma_24h = sd(NaRV.omit(LD_19C_24h_Gamma$Dead_Cells_low_dose))
#
#
## z-score correction on all people from 19C
LD_allp_19C= Corrected_Cell_Death %>% filter(Corrected_Cell_Death$Run_set %in% Run_19C)
LD_allp_19C$Dead_Cells_0=NULL
LD_allp_19C$Dead_Cells_high_dose=NULL
#
### 4h 
LD_allp_19C_4h = LD_allp_19C %>% filter(LD_allp_19C$Timepoint=="4h")
#
LD_allp_19C_4h_Fe = LD_allp_19C_4h %>% filter(LD_allp_19C_4h$Radiation_type=="Fe")
LD_allp_19C_4h_Ar = LD_allp_19C_4h %>% filter(LD_allp_19C_4h$Radiation_type=="Ar")
LD_allp_19C_4h_Si = LD_allp_19C_4h %>% filter(LD_allp_19C_4h$Radiation_type=="Si")
LD_allp_19C_4h_Gamma = LD_allp_19C_4h %>% filter(LD_allp_19C_4h$Radiation_type=="Gamma")
### 24h 
LD_allp_19C_24h = LD_allp_19C %>% filter(LD_allp_19C$Timepoint=="24h")
#
LD_allp_19C_24h_Fe = LD_allp_19C_24h %>% filter(LD_allp_19C_24h$Radiation_type=="Fe")
LD_allp_19C_24h_Ar = LD_allp_19C_24h %>% filter(LD_allp_19C_24h$Radiation_type=="Ar")
LD_allp_19C_24h_Si = LD_allp_19C_24h %>% filter(LD_allp_19C_24h$Radiation_type=="Si")
LD_allp_19C_24h_Gamma = LD_allp_19C_24h %>% filter(LD_allp_19C_24h$Radiation_type=="Gamma")

## z-score correction
# 4h
LD_allp_19C_4h_Fe$Dead_Cells_low_dose = (((LD_allp_19C_4h_Fe$Dead_Cells_low_dose - Mean_LD_Fe_4h)/Std_LD_Fe_4h)*Std_ref_LD_Fe_4h) + Mean_ref_LD_Fe_4h
LD_allp_19C_4h_Ar$Dead_Cells_low_dose = (((LD_allp_19C_4h_Ar$Dead_Cells_low_dose - Mean_LD_Ar_4h)/Std_LD_Ar_4h)*Std_ref_LD_Ar_4h) + Mean_ref_LD_Ar_4h
LD_allp_19C_4h_Si$Dead_Cells_low_dose = (((LD_allp_19C_4h_Si$Dead_Cells_low_dose - Mean_LD_Si_4h)/Std_LD_Si_4h)*Std_ref_LD_Si_4h) + Mean_ref_LD_Si_4h
LD_allp_19C_4h_Gamma$Dead_Cells_low_dose = (((LD_allp_19C_4h_Gamma$Dead_Cells_low_dose - Mean_LD_Gamma_4h)/Std_LD_Gamma_4h)*Std_ref_LD_Gamma_4h) + Mean_ref_LD_Gamma_4h
# 24h
LD_allp_19C_24h_Fe$Dead_Cells_low_dose = (((LD_allp_19C_24h_Fe$Dead_Cells_low_dose - Mean_LD_Fe_24h)/Std_LD_Fe_24h)*Std_ref_LD_Fe_24h) + Mean_ref_LD_Fe_24h
LD_allp_19C_24h_Ar$Dead_Cells_low_dose = (((LD_allp_19C_24h_Ar$Dead_Cells_low_dose - Mean_LD_Ar_24h)/Std_LD_Ar_24h)*Std_ref_LD_Ar_24h) + Mean_ref_LD_Ar_24h
LD_allp_19C_24h_Si$Dead_Cells_low_dose = (((LD_allp_19C_24h_Si$Dead_Cells_low_dose - Mean_LD_Si_24h)/Std_LD_Si_24h)*Std_ref_LD_Si_24h) + Mean_ref_LD_Si_24h
LD_allp_19C_24h_Gamma$Dead_Cells_low_dose = (((LD_allp_19C_24h_Gamma$Dead_Cells_low_dose - Mean_LD_Gamma_24h)/Std_LD_Gamma_24h)*Std_ref_LD_Gamma_24h) + Mean_ref_LD_Gamma_24h


## For high dose irradiated samples
HD_19C= Samp_19C_10p
HD_19C$Dead_Cells_0=NULL
HD_19C$Dead_Cells_low_dose=NULL
#
### 4h 
HD_19C_4h = HD_19C %>% filter(HD_19C$Timepoint=="4h")
#
HD_19C_4h_Fe = HD_19C_4h %>% filter(HD_19C_4h$Radiation_type=="Fe")
HD_19C_4h_Ar = HD_19C_4h %>% filter(HD_19C_4h$Radiation_type=="Ar")
HD_19C_4h_Si = HD_19C_4h %>% filter(HD_19C_4h$Radiation_type=="Si")
HD_19C_4h_Gamma = HD_19C_4h %>% filter(HD_19C_4h$Radiation_type=="Gamma")
### 24h 
HD_19C_24h = HD_19C %>% filter(HD_19C$Timepoint=="24h")
#
HD_19C_24h_Fe = HD_19C_24h %>% filter(HD_19C_24h$Radiation_type=="Fe")
HD_19C_24h_Ar = HD_19C_24h %>% filter(HD_19C_24h$Radiation_type=="Ar")
HD_19C_24h_Si = HD_19C_24h %>% filter(HD_19C_24h$Radiation_type=="Si")
HD_19C_24h_Gamma = HD_19C_24h %>% filter(HD_19C_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_HD_Fe_4h = mean(NaRV.omit(HD_19C_4h_Fe$Dead_Cells_high_dose))
Mean_HD_Ar_4h = mean(NaRV.omit(HD_19C_4h_Ar$Dead_Cells_high_dose))
Mean_HD_Si_4h = mean(NaRV.omit(HD_19C_4h_Si$Dead_Cells_high_dose))
Mean_HD_Gamma_4h = mean(NaRV.omit(HD_19C_4h_Gamma$Dead_Cells_high_dose))
# 24h
Mean_HD_Fe_24h = mean(NaRV.omit(HD_19C_24h_Fe$Dead_Cells_high_dose))
Mean_HD_Ar_24h = mean(NaRV.omit(HD_19C_24h_Ar$Dead_Cells_high_dose))
Mean_HD_Si_24h = mean(NaRV.omit(HD_19C_24h_Si$Dead_Cells_high_dose))
Mean_HD_Gamma_24h = mean(NaRV.omit(HD_19C_24h_Gamma$Dead_Cells_high_dose))
####### sd
# 4h
Std_HD_Fe_4h = sd(NaRV.omit(HD_19C_4h_Fe$Dead_Cells_high_dose))
Std_HD_Ar_4h = sd(NaRV.omit(HD_19C_4h_Ar$Dead_Cells_high_dose))
Std_HD_Si_4h = sd(NaRV.omit(HD_19C_4h_Si$Dead_Cells_high_dose))
Std_HD_Gamma_4h = sd(NaRV.omit(HD_19C_4h_Gamma$Dead_Cells_high_dose))
# 24h
Std_HD_Fe_24h = sd(NaRV.omit(HD_19C_24h_Fe$Dead_Cells_high_dose))
Std_HD_Ar_24h = sd(NaRV.omit(HD_19C_24h_Ar$Dead_Cells_high_dose))
Std_HD_Si_24h = sd(NaRV.omit(HD_19C_24h_Si$Dead_Cells_high_dose))
Std_HD_Gamma_24h = sd(NaRV.omit(HD_19C_24h_Gamma$Dead_Cells_high_dose))
#
#
## z-score correction on all people from 19C
HD_allp_19C= Corrected_Cell_Death %>% filter(Corrected_Cell_Death$Run_set %in% Run_19C)
HD_allp_19C$Dead_Cells_0=NULL
HD_allp_19C$Dead_Cells_low_dose=NULL
#
### 4h 
HD_allp_19C_4h = HD_allp_19C %>% filter(HD_allp_19C$Timepoint=="4h")
#
HD_allp_19C_4h_Fe = HD_allp_19C_4h %>% filter(HD_allp_19C_4h$Radiation_type=="Fe")
HD_allp_19C_4h_Ar = HD_allp_19C_4h %>% filter(HD_allp_19C_4h$Radiation_type=="Ar")
HD_allp_19C_4h_Si = HD_allp_19C_4h %>% filter(HD_allp_19C_4h$Radiation_type=="Si")
HD_allp_19C_4h_Gamma = HD_allp_19C_4h %>% filter(HD_allp_19C_4h$Radiation_type=="Gamma")
### 24h 
HD_allp_19C_24h = HD_allp_19C %>% filter(HD_allp_19C$Timepoint=="24h")
#
HD_allp_19C_24h_Fe = HD_allp_19C_24h %>% filter(HD_allp_19C_24h$Radiation_type=="Fe")
HD_allp_19C_24h_Ar = HD_allp_19C_24h %>% filter(HD_allp_19C_24h$Radiation_type=="Ar")
HD_allp_19C_24h_Si = HD_allp_19C_24h %>% filter(HD_allp_19C_24h$Radiation_type=="Si")
HD_allp_19C_24h_Gamma = HD_allp_19C_24h %>% filter(HD_allp_19C_24h$Radiation_type=="Gamma")

## z-score correction
# 4h
HD_allp_19C_4h_Fe$Dead_Cells_high_dose = (((HD_allp_19C_4h_Fe$Dead_Cells_high_dose - Mean_HD_Fe_4h)/Std_HD_Fe_4h)*Std_ref_HD_Fe_4h) + Mean_ref_HD_Fe_4h
HD_allp_19C_4h_Ar$Dead_Cells_high_dose = (((HD_allp_19C_4h_Ar$Dead_Cells_high_dose - Mean_HD_Ar_4h)/Std_HD_Ar_4h)*Std_ref_HD_Ar_4h) + Mean_ref_HD_Ar_4h
HD_allp_19C_4h_Si$Dead_Cells_high_dose = (((HD_allp_19C_4h_Si$Dead_Cells_high_dose - Mean_HD_Si_4h)/Std_HD_Si_4h)*Std_ref_HD_Si_4h) + Mean_ref_HD_Si_4h
HD_allp_19C_4h_Gamma$Dead_Cells_high_dose = (((HD_allp_19C_4h_Gamma$Dead_Cells_high_dose - Mean_HD_Gamma_4h)/Std_HD_Gamma_4h)*Std_ref_HD_Gamma_4h) + Mean_ref_HD_Gamma_4h
# 24h
HD_allp_19C_24h_Fe$Dead_Cells_high_dose = (((HD_allp_19C_24h_Fe$Dead_Cells_high_dose - Mean_HD_Fe_24h)/Std_HD_Fe_24h)*Std_ref_HD_Fe_24h) + Mean_ref_HD_Fe_24h
HD_allp_19C_24h_Ar$Dead_Cells_high_dose = (((HD_allp_19C_24h_Ar$Dead_Cells_high_dose - Mean_HD_Ar_24h)/Std_HD_Ar_24h)*Std_ref_HD_Ar_24h) + Mean_ref_HD_Ar_24h
HD_allp_19C_24h_Si$Dead_Cells_high_dose = (((HD_allp_19C_24h_Si$Dead_Cells_high_dose - Mean_HD_Si_24h)/Std_HD_Si_24h)*Std_ref_HD_Si_24h) + Mean_ref_HD_Si_24h
HD_allp_19C_24h_Gamma$Dead_Cells_high_dose = (((HD_allp_19C_24h_Gamma$Dead_Cells_high_dose - Mean_HD_Gamma_24h)/Std_HD_Gamma_24h)*Std_ref_HD_Gamma_24h) + Mean_ref_HD_Gamma_24h


### Now we regroup everything
## regroup 18B
Cont_18B_All_rad= bind_rows(control_allp_18B_4h_Fe,  control_allp_18B_24h_Fe, 
                            control_allp_18B_4h_Ar,  control_allp_18B_24h_Ar,
                            control_allp_18B_4h_Si,  control_allp_18B_24h_Si,
                            control_allp_18B_4h_Gamma,  control_allp_18B_24h_Gamma)
colnames(Cont_18B_All_rad)[colnames(Cont_18B_All_rad)=="Dead_Cells_0"]<- "CD"
Cont_18B_All_rad$Dose_relative="0 Gy control"


LD_18B_All_rad= bind_rows(LD_allp_18B_4h_Fe,  LD_allp_18B_24h_Fe, 
                          LD_allp_18B_4h_Ar,  LD_allp_18B_24h_Ar,
                          LD_allp_18B_4h_Si,  LD_allp_18B_24h_Si,
                          LD_allp_18B_4h_Gamma,  LD_allp_18B_24h_Gamma)
colnames(LD_18B_All_rad)[colnames(LD_18B_All_rad)=="Dead_Cells_low_dose"]<- "CD"
LD_18B_All_rad$Dose_relative = "Low dose"


HD_18B_All_rad= bind_rows(HD_allp_18B_4h_Fe,  HD_allp_18B_24h_Fe, 
                          HD_allp_18B_4h_Ar,  HD_allp_18B_24h_Ar,
                          HD_allp_18B_4h_Si,  HD_allp_18B_24h_Si,
                          HD_allp_18B_4h_Gamma,  HD_allp_18B_24h_Gamma)
colnames(HD_18B_All_rad)[colnames(HD_18B_All_rad)=="Dead_Cells_high_dose"]<- "CD"
HD_18B_All_rad$Dose_relative = "High dose"

## regroup 19C
Cont_19C_All_rad= bind_rows(control_allp_19C_4h_Fe,  control_allp_19C_24h_Fe, 
                            control_allp_19C_4h_Ar,  control_allp_19C_24h_Ar,
                            control_allp_19C_4h_Si,  control_allp_19C_24h_Si,
                            control_allp_19C_4h_Gamma,  control_allp_19C_24h_Gamma)
colnames(Cont_19C_All_rad)[colnames(Cont_19C_All_rad)=="Dead_Cells_0"]<- "CD"
Cont_19C_All_rad$Dose_relative="0 Gy control"

LD_19C_All_rad= bind_rows(LD_allp_19C_4h_Fe,  LD_allp_19C_24h_Fe, 
                          LD_allp_19C_4h_Ar,  LD_allp_19C_24h_Ar,
                          LD_allp_19C_4h_Si,  LD_allp_19C_24h_Si,
                          LD_allp_19C_4h_Gamma,  LD_allp_19C_24h_Gamma)
colnames(LD_19C_All_rad)[colnames(LD_19C_All_rad)=="Dead_Cells_low_dose"]<- "CD"
LD_19C_All_rad$Dose_relative="Low dose"

HD_19C_All_rad= bind_rows(HD_allp_19C_4h_Fe,  HD_allp_19C_24h_Fe, 
                          HD_allp_19C_4h_Ar,  HD_allp_19C_24h_Ar,
                          HD_allp_19C_4h_Si,  HD_allp_19C_24h_Si,
                          HD_allp_19C_4h_Gamma,  HD_allp_19C_24h_Gamma)
colnames(HD_19C_All_rad)[colnames(HD_19C_All_rad)=="Dead_Cells_high_dose"]<- "CD"
HD_19C_All_rad$Dose_relative="High dose"


#19A was used as reference: data were not modified. We format the table to fit the same structure as 18B and 19C 
Samp_19A_allp_cont = Corrected_Cell_Death %>% filter(Corrected_Cell_Death$Run_set %in% Run_19A)
Samp_19A_allp_cont$Dead_Cells_low_dose = NULL
Samp_19A_allp_cont$Dead_Cells_high_dose = NULL
colnames(Samp_19A_allp_cont)[colnames(Samp_19A_allp_cont)=="Dead_Cells_0"]<- "CD"
Samp_19A_allp_cont$Dose_relative="0 Gy control"


Samp_19A_allp_LD = Corrected_Cell_Death %>% filter(Corrected_Cell_Death$Run_set %in% Run_19A)
Samp_19A_allp_LD$Dead_Cells_high_dose = NULL
Samp_19A_allp_LD$Dead_Cells_0 = NULL
colnames(Samp_19A_allp_LD)[colnames(Samp_19A_allp_LD)=="Dead_Cells_low_dose"]<- "CD"
Samp_19A_allp_LD$Dose_relative="Low dose"


Samp_19A_allp_HD = Corrected_Cell_Death %>% filter(Corrected_Cell_Death$Run_set %in% Run_19A)
Samp_19A_allp_HD$Dead_Cells_low_dose = NULL
Samp_19A_allp_HD$Dead_Cells_0 = NULL
colnames(Samp_19A_allp_HD)[colnames(Samp_19A_allp_HD)=="Dead_Cells_high_dose"]<- "CD"
Samp_19A_allp_HD$Dose_relative="High dose"

#### Regroup all runs and sets
All_Corrected_CD = bind_rows(Cont_18B_All_rad, LD_18B_All_rad, HD_18B_All_rad,
                             Cont_19C_All_rad, LD_19C_All_rad, HD_19C_All_rad,
                             Samp_19A_allp_cont, Samp_19A_allp_LD, Samp_19A_allp_HD)

colnames(All_Corrected_CD)[colnames(All_Corrected_CD)=="CD"]<- "Dead_Cells"

#### The correction may generate negative value => we fix those negative value to 0 
All_Corrected_CD$Dead_Cells[All_Corrected_CD$Dead_Cells < 0] <-  0 

```



```{r}
##################################################################################################
#################################### Oxidative Stress ############################################
##################################################################################################

#### Now we read flow data 
## Read all flow data, which in this case includes metadata of CellROX intensity and cell death percentage in WIDE format
flow_all = read.csv('all_flow.csv', sep = ",", header = TRUE)
# Now we add well metadata
well_meta <- read.csv('Well_meta.csv', header = TRUE, sep = ";", quote = "\"", dec = ".")
all_flow_meta = merge(flow_all, well_meta, by = 'Sample_ID')
#
#
Ox_Stress_Raw=all_flow_meta[,grepl("Live_CR|Sample_ID|Timepoint|Run|Age|Gender|BMI|Collection", colnames(all_flow_meta))]
#
## we read and associate quartiles value to the initial file 
sheet_names <- excel_sheets(here::here("Flow_CRmedian_DeathQuartiles_20200909.xlsx"))
sheet_names
nbr_of_sheet = length(sheet_names)
nbr_of_sheet

for (i in 1:nbr_of_sheet){
  name <- sheet_names[i]  ## store the sheet name 
  data <- read_excel(here::here("Flow_CRmedian_DeathQuartiles_20200909.xlsx"), sheet=i ) ## we read the sheet i only in the excel file
name <- paste0("Sheet_", name)
assign(name, data)                   
rm(name, data)
}

# Not reading 18B_Gamma since will be read in 19C 
Ox_Stress_death_extra_Fe = bind_rows(Sheet_19C_CR_median_Fe,Sheet_19A_CR_median_Fe, Sheet_18B_CR_median_Fe) 
Ox_Stress_extra_Ar = bind_rows(Sheet_19C_CR_median_Ar,Sheet_19A_CR_median_Ar, Sheet_18B_CR_median_Ar) 
Ox_Stress_extra_Si = bind_rows(Sheet_19C_CR_median_Si,Sheet_19A_CR_median_Si, Sheet_18B_CR_median_Si) 
Ox_Stress_extra_Gamma = bind_rows(Sheet_19C_CR_median_Gamma,Sheet_19A_CR_median_Gamma) 
#                            
Ox_Stress_extra= merge(Ox_Stress_extra_Fe, Ox_Stress_extra_Ar,by=c("Sample_number", "Set"), all=TRUE )
Ox_Stress_extra= merge(Ox_Stress_extra, Ox_Stress_extra_Si,by=c("Sample_number", "Set"), all=TRUE )
Ox_Stress_extra= merge(Ox_Stress_extra, Ox_Stress_extra_Gamma,by=c("Sample_number", "Set"), all=TRUE )  

## Separate 4h and 24h and create variable time point 
# 4h
Ox_Stress_extra_4h = Ox_Stress_extra[,grepl("Sample|Set|_4h", colnames(Ox_Stress_extra))]
colnames(Ox_Stress_extra_4h)[colnames(Ox_Stress_extra_4h)=="Fe_Live_CR_ledian_0_4h"] <- "Fe_Live_CR_median_0"
colnames(Ox_Stress_extra_4h)[colnames(Ox_Stress_extra_4h)=="Fe_Live_CR_median_1_4h"] <- "Fe_Live_CR_median_1"
colnames(Ox_Stress_extra_4h)[colnames(Ox_Stress_extra_4h)=="Fe_Live_CR_median_3_4h"] <- "Fe_Live_CR_median_3"
colnames(Ox_Stress_extra_4h)[colnames(Ox_Stress_extra_4h)=="Ar_Live_CR_median_0_4h"] <- "Ar_Live_CR_median_0"
colnames(Ox_Stress_extra_4h)[colnames(Ox_Stress_extra_4h)=="Ar_Live_CR_median_1_4h"] <- "Ar_Live_CR_median_1"
colnames(Ox_Stress_extra_4h)[colnames(Ox_Stress_extra_4h)=="Ar_Live_CR_median_3_4h"] <- "Ar_Live_CR_median_3"
colnames(Ox_Stress_extra_4h)[colnames(Ox_Stress_extra_4h)=="Si_Live_CR_median_0_4h"] <- "Si_Live_CR_median_0"
colnames(Ox_Stress_extra_4h)[colnames(Ox_Stress_extra_4h)=="Si_Live_CR_median_1_4h"] <- "Si_Live_CR_median_1"
colnames(Ox_Stress_extra_4h)[colnames(Ox_Stress_extra_4h)=="Si_Live_CR_median_3_4h"] <- "Si_Live_CR_median_3"
colnames(Ox_Stress_extra_4h)[colnames(Ox_Stress_extra_4h)=="Gamma_Live_CR_median_0_4h"] <- "Gamma_Live_CR_median_0"
colnames(Ox_Stress_extra_4h)[colnames(Ox_Stress_extra_4h)=="Gamma_Live_CR_median_01_4h"] <- "Gamma_Live_CR_median_01"
colnames(Ox_Stress_extra_4h)[colnames(Ox_Stress_extra_4h)=="Gamma_Live_CR_median_1_4h"] <- "Gamma_Live_CR_median_1"
Ox_Stress_extra_4h$Timepoint="4h"
#
#
Ox_Stress_extra_24h = Ox_Stress_extra[,grepl("Sample|Set|_24h", colnames(Ox_Stress_extra))]
colnames(Ox_Stress_extra_24h)[colnames(Ox_Stress_extra_24h)=="Fe_Dead_Q1Q4_0_24h"] <- "Fe_Dead_Q1Q4_0"
colnames(Ox_Stress_extra_24h)[colnames(Ox_Stress_extra_24h)=="Fe_Dead_Q1Q4_1_24h"] <- "Fe_Dead_Q1Q4_1"
colnames(Ox_Stress_extra_24h)[colnames(Ox_Stress_extra_24h)=="Fe_Dead_Q1Q4_3_24h"] <- "Fe_Dead_Q1Q4_3"
colnames(Ox_Stress_extra_24h)[colnames(Ox_Stress_extra_24h)=="Ar_Dead_Q1Q4_0_24h"] <- "Ar_Dead_Q1Q4_0"
colnames(Ox_Stress_extra_24h)[colnames(Ox_Stress_extra_24h)=="Ar_Dead_Q1Q4_1_24h"] <- "Ar_Dead_Q1Q4_1"
colnames(Ox_Stress_extra_24h)[colnames(Ox_Stress_extra_24h)=="Ar_Dead_Q1Q4_3_24h"] <- "Ar_Dead_Q1Q4_3"
colnames(Ox_Stress_extra_24h)[colnames(Ox_Stress_extra_24h)=="Si_Dead_Q1Q4_0_24h"] <- "Si_Dead_Q1Q4_0"
colnames(Ox_Stress_extra_24h)[colnames(Ox_Stress_extra_24h)=="Si_Dead_Q1Q4_1_24h"] <- "Si_Dead_Q1Q4_1"
colnames(Ox_Stress_extra_24h)[colnames(Ox_Stress_extra_24h)=="Si_Dead_Q1Q4_3_24h"] <- "Si_Dead_Q1Q4_3"
colnames(Ox_Stress_extra_24h)[colnames(Ox_Stress_extra_24h)=="Gamma_Dead_Q1Q4_0_24h"] <- "Gamma_Dead_Q1Q4_0"
colnames(Ox_Stress_extra_24h)[colnames(Ox_Stress_extra_24h)=="Gamma_Dead_Q1Q4_01_24h"] <- "Gamma_Dead_Q1Q4_01"
colnames(Ox_Stress_extra_24h)[colnames(Ox_Stress_extra_24h)=="Gamma_Dead_Q1Q4_1_24h"] <- "Gamma_Dead_Q1Q4_1"
Ox_Stress_extra_24h$Timepoint="24h"
Ox_Stress_extra=bind_rows(Ox_Stress_extra_4h, Ox_Stress_extra_24h)
#
colnames(Ox_Stress_extra)[colnames(Ox_Stress_extra) == "Sample_number"] = "Sample_ID"
colnames(Ox_Stress_extra)[colnames(Ox_Stress_extra) == "Set"] = "Run_set"
#
All_Ox_Stress_Raw = merge(Ox_Stress_Raw, Ox_Stress_extra,by=c("Sample_ID", "Run_set", 'Timepoint'), all=TRUE )

### Formatting: creating unique name for flow data and two columns: 1 for the radiation and 1 for the dose 
OS_meta=All_Cell_Death_Raw[,grepl("Sample_ID|Run|Age|Gender|BMI|Collection", colnames(All_Cell_Death_Raw))]
OS_meta=unique(OS_meta)

##### Fe
OS_Fe = All_Ox_Stress_Raw[,grepl("Fe|Sample_ID|Timepoint", colnames(All_Ox_Stress_Raw))]
## 4h 
OS_Fe_4h = OS_Fe %>% filter(OS_Fe$Timepoint =="4h")
colnames(OS_Fe_4h)[colnames(OS_Fe_4h)=="Fe_Live_CR_median_0"] = "Ox_Stress_median_0"
colnames(OS_Fe_4h)[colnames(OS_Fe_4h)=="Fe_Live_CR_median_1"] = "Ox_Stress_median_low_dose"
colnames(OS_Fe_4h)[colnames(OS_Fe_4h)=="Fe_Live_CR_median_3"] = "Ox_Stress_median_high_dose"
colnames(OS_Fe_4h)[colnames(OS_Fe_4h)=="Fe_Live_CR_mean_0"] = "Ox_Stress_0"
colnames(OS_Fe_4h)[colnames(OS_Fe_4h)=="Fe_Live_CR_mean_1"] = "Ox_Stress_low_dose"
colnames(OS_Fe_4h)[colnames(OS_Fe_4h)=="Fe_Live_CR_mean_3"] = "Ox_Stress_high_dose"
## 24h 
OS_Fe_24h = OS_Fe %>% filter(OS_Fe$Timepoint =="24h")
colnames(OS_Fe_24h)[colnames(OS_Fe_24h)=="Fe_Live_CR_median_0"] = "Ox_Stress_median_0"
colnames(OS_Fe_24h)[colnames(OS_Fe_24h)=="Fe_Live_CR_median_1"] = "Ox_Stress_median_low_dose"
colnames(OS_Fe_24h)[colnames(OS_Fe_24h)=="Fe_Live_CR_median_3"] = "Ox_Stress_median_high_dose"
colnames(OS_Fe_24h)[colnames(OS_Fe_24h)=="Fe_Live_CR_mean_0"] = "Ox_Stress_0"
colnames(OS_Fe_24h)[colnames(OS_Fe_24h)=="Fe_Live_CR_mean_1"] = "Ox_Stress_low_dose"
colnames(OS_Fe_24h)[colnames(OS_Fe_24h)=="Fe_Live_CR_mean_3"] = "Ox_Stress_high_dose"
#
OS_Fe=bind_rows(OS_Fe_4h, OS_Fe_24h)
OS_Fe=merge(OS_Fe,OS_meta, by="Sample_ID", all.x=TRUE, all.y = FALSE)
OS_Fe$Radiation_type="Fe"

##### Ar
OS_Ar = All_Ox_Stress_Raw[,grepl("Ar|Sample_ID|Timepoint", colnames(All_Ox_Stress_Raw))]
## 4h 
OS_Ar_4h = OS_Ar %>% filter(OS_Ar$Timepoint =="4h")
colnames(OS_Ar_4h)[colnames(OS_Ar_4h)=="Ar_Live_CR_median_0"] = "Ox_Stress_median_0"
colnames(OS_Ar_4h)[colnames(OS_Ar_4h)=="Ar_Live_CR_median_1"] = "Ox_Stress_median_low_dose"
colnames(OS_Ar_4h)[colnames(OS_Ar_4h)=="Ar_Live_CR_median_3"] = "Ox_Stress_median_high_dose"
colnames(OS_Ar_4h)[colnames(OS_Ar_4h)=="Ar_Live_CR_mean_0"] = "Ox_Stress_0"
colnames(OS_Ar_4h)[colnames(OS_Ar_4h)=="Ar_Live_CR_mean_1"] = "Ox_Stress_low_dose"
colnames(OS_Ar_4h)[colnames(OS_Ar_4h)=="Ar_Live_CR_mean_3"] = "Ox_Stress_high_dose"
## 24h 
OS_Ar_24h = OS_Ar %>% filter(OS_Ar$Timepoint =="24h")
colnames(OS_Ar_24h)[colnames(OS_Ar_24h)=="Ar_Live_CR_median_0"] = "Ox_Stress_median_0"
colnames(OS_Ar_24h)[colnames(OS_Ar_24h)=="Ar_Live_CR_median_1"] = "Ox_Stress_median_low_dose"
colnames(OS_Ar_24h)[colnames(OS_Ar_24h)=="Ar_Live_CR_median_3"] = "Ox_Stress_median_high_dose"
colnames(OS_Ar_24h)[colnames(OS_Ar_24h)=="Ar_Live_CR_mean_0"] = "Ox_Stress_0"
colnames(OS_Ar_24h)[colnames(OS_Ar_24h)=="Ar_Live_CR_mean_1"] = "Ox_Stress_low_dose"
colnames(OS_Ar_24h)[colnames(OS_Ar_24h)=="Ar_Live_CR_mean_3"] = "Ox_Stress_high_dose"
#
OS_Ar=bind_rows(OS_Ar_4h, OS_Ar_24h)
OS_Ar=merge(OS_Ar,OS_meta, by="Sample_ID", all.x=TRUE, all.y = FALSE)
OS_Ar$Radiation_type="Ar"

##### Si
OS_Si = All_Ox_Stress_Raw[,grepl("Si|Sample_ID|Timepoint", colnames(All_Ox_Stress_Raw))]
## 4h 
OS_Si_4h = OS_Si %>% filter(OS_Si$Timepoint =="4h")
colnames(OS_Si_4h)[colnames(OS_Si_4h)=="Si_Live_CR_median_0"] = "Ox_Stress_median_0"
colnames(OS_Si_4h)[colnames(OS_Si_4h)=="Si_Live_CR_median_1"] = "Ox_Stress_median_low_dose"
colnames(OS_Si_4h)[colnames(OS_Si_4h)=="Si_Live_CR_median_3"] = "Ox_Stress_median_high_dose"
colnames(OS_Si_4h)[colnames(OS_Si_4h)=="Si_Live_CR_mean_0"] = "Ox_Stress_0"
colnames(OS_Si_4h)[colnames(OS_Si_4h)=="Si_Live_CR_mean_1"] = "Ox_Stress_low_dose"
colnames(OS_Si_4h)[colnames(OS_Si_4h)=="Si_Live_CR_mean_3"] = "Ox_Stress_high_dose"
## 24h 
OS_Si_24h = OS_Si %>% filter(OS_Si$Timepoint =="24h")
colnames(OS_Si_24h)[colnames(OS_Si_24h)=="Si_Live_CR_median_0"] = "Ox_Stress_median_0"
colnames(OS_Si_24h)[colnames(OS_Si_24h)=="Si_Live_CR_median_1"] = "Ox_Stress_median_low_dose"
colnames(OS_Si_24h)[colnames(OS_Si_24h)=="Si_Live_CR_median_3"] = "Ox_Stress_median_high_dose"
colnames(OS_Si_24h)[colnames(OS_Si_24h)=="Si_Live_CR_mean_0"] = "Ox_Stress_0"
colnames(OS_Si_24h)[colnames(OS_Si_24h)=="Si_Live_CR_mean_1"] = "Ox_Stress_low_dose"
colnames(OS_Si_24h)[colnames(OS_Si_24h)=="Si_Live_CR_mean_3"] = "Ox_Stress_high_dose"
#
OS_Si=bind_rows(OS_Si_4h, OS_Si_24h)
OS_Si=merge(OS_Si,OS_meta, by="Sample_ID", all.x=TRUE, all.y = FALSE)
OS_Si$Radiation_type="Si"

##### Gamma
OS_Gamma = All_Ox_Stress_Raw[,grepl("Gamma|Sample_ID|Timepoint", colnames(All_Ox_Stress_Raw))]
## 4h 
OS_Gamma_4h = OS_Gamma %>% filter(OS_Gamma$Timepoint =="4h")
colnames(OS_Gamma_4h)[colnames(OS_Gamma_4h)=="Gamma_Live_CR_median_0"] = "Ox_Stress_median_0"
colnames(OS_Gamma_4h)[colnames(OS_Gamma_4h)=="Gamma_Live_CR_median_01"] = "Ox_Stress_median_low_dose"
colnames(OS_Gamma_4h)[colnames(OS_Gamma_4h)=="Gamma_Live_CR_median_1"] = "Ox_Stress_median_high_dose"
colnames(OS_Gamma_4h)[colnames(OS_Gamma_4h)=="Gamma_Live_CR_mean_0"] = "Ox_Stress_0"
colnames(OS_Gamma_4h)[colnames(OS_Gamma_4h)=="Gamma_Live_CR_mean_0.1"] = "Ox_Stress_low_dose"
colnames(OS_Gamma_4h)[colnames(OS_Gamma_4h)=="Gamma_Live_CR_mean_1"] = "Ox_Stress_high_dose"
## 24h 
OS_Gamma_24h = OS_Gamma %>% filter(OS_Gamma$Timepoint =="24h")
colnames(OS_Gamma_24h)[colnames(OS_Gamma_24h)=="Gamma_Live_CR_median_0"] = "Ox_Stress_median_0"
colnames(OS_Gamma_24h)[colnames(OS_Gamma_24h)=="Gamma_Live_CR_median_01"] = "Ox_Stress_median_low_dose"
colnames(OS_Gamma_24h)[colnames(OS_Gamma_24h)=="Gamma_Live_CR_median_1"] = "Ox_Stress_median_high_dose"
colnames(OS_Gamma_24h)[colnames(OS_Gamma_24h)=="Gamma_Live_CR_mean_0"] = "Ox_Stress_0"
colnames(OS_Gamma_24h)[colnames(OS_Gamma_24h)=="Gamma_Live_CR_mean_0.1"] = "Ox_Stress_low_dose"
colnames(OS_Gamma_24h)[colnames(OS_Gamma_24h)=="Gamma_Live_CR_mean_1"] = "Ox_Stress_high_dose"
#
OS_Gamma=bind_rows(OS_Gamma_4h, OS_Gamma_24h)
OS_Gamma=merge(OS_Gamma,OS_meta, by="Sample_ID", all.x=TRUE, all.y = FALSE)
OS_Gamma$Radiation_type="Gamma"

###
All_Ox_Stress_Raw=bind_rows(OS_Fe, OS_Ar, OS_Si, OS_Gamma)


#########################################  Correction ############################################
##################################################################################################

###########################################################################
####### 1) Correction between radiation within each run/set ###############
###########################################################################

#### we add the Batch 
Run_set_batch <- read.csv('Run_set_batch.csv', header = TRUE, sep = ";", quote = "\"", dec = ".")

Raw_OS_with_metadata=merge(All_Ox_Stress_Raw, Run_set_batch, by="Run_set",all.x = TRUE)
Raw_OS_with_metadata$CMV=NULL
Raw_OS_with_metadata$Run_set_well=NULL

colnames(Raw_OS_with_metadata)[colnames(Raw_OS_with_metadata)=="Batch"] = "Run_set_batch"

## Add column radiation_batch 
Raw_OS_with_metadata$Radiation_Batch= Raw_OS_with_metadata$Radiation_type
Raw_OS_with_metadata$Radiation_Batch[Raw_OS_with_metadata$Radiation_Batch=="Fe"] <- 1
Raw_OS_with_metadata$Radiation_Batch[Raw_OS_with_metadata$Radiation_Batch=="Ar"] <- 2
Raw_OS_with_metadata$Radiation_Batch[Raw_OS_with_metadata$Radiation_Batch=="Si"] <- 3
Raw_OS_with_metadata$Radiation_Batch[Raw_OS_with_metadata$Radiation_Batch=="Gamma"] <- 4

metadata_save = Raw_OS_with_metadata[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender",colnames(Raw_OS_with_metadata))]


# To know how many "Run and set" values we have 
Run_set_list = Raw_OS_with_metadata[, grepl("Run", colnames(Raw_OS_with_metadata))]
Run_set_list=unique(Run_set_list)
print(Run_set_list)


## In this case we have 8 different "Run and set" values
Run_set_1 = Raw_OS_with_metadata %>% filter(Raw_OS_with_metadata$Run_set_batch == 1)
Run_set_2 = Raw_OS_with_metadata %>% filter(Raw_OS_with_metadata$Run_set_batch == 2)
Run_set_3 = Raw_OS_with_metadata %>% filter(Raw_OS_with_metadata$Run_set_batch == 3)
Run_set_4 = Raw_OS_with_metadata %>% filter(Raw_OS_with_metadata$Run_set_batch == 4)
Run_set_5 = Raw_OS_with_metadata %>% filter(Raw_OS_with_metadata$Run_set_batch == 5)
Run_set_6 =Raw_OS_with_metadata %>% filter(Raw_OS_with_metadata$Run_set_batch == 6)
Run_set_7 = Raw_OS_with_metadata %>% filter(Raw_OS_with_metadata$Run_set_batch == 7)
Run_set_8 = Raw_OS_with_metadata %>% filter(Raw_OS_with_metadata$Run_set_batch == 8)


# for each run and set value we apply Finsam's function with radiation as a batch effect variable 

#####################################################################
######################### On controls first #########################
#####################################################################

##### Run_set_1
metadata_save_1=Run_set_1[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_1))]
metadata=Run_set_1[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_1))]
metadata$BMI_group=NULL
edata_control=Run_set_1[,grep("Ox_Stress_median_0|Ox_Stress_0",colnames(Run_set_1))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_1$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_1_Corrected_Controls = Modified_ComBat$data
Run_Set_1_Corrected_Controls=t(Run_Set_1_Corrected_Controls)
Run_Set_1_Corrected_Controls=cbind(Run_Set_1_Corrected_Controls, metadata_save_1)
#
Gamma_factor_Run_set_1= Modified_ComBat$gamma
Delta_factor_Run_set_1= Modified_ComBat$delta


##### Run_set_2
metadata_save_2=Run_set_2[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_2))]
metadata=Run_set_2[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_2))]
metadata$BMI_group=NULL
edata_control=Run_set_2[,grep("Ox_Stress_median_0|Ox_Stress_0",colnames(Run_set_2))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_2$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_2_Corrected_Controls = Modified_ComBat$data
Run_Set_2_Corrected_Controls=t(Run_Set_2_Corrected_Controls)
Run_Set_2_Corrected_Controls=cbind(Run_Set_2_Corrected_Controls, metadata_save_2)
#
Gamma_factor_Run_set_2= Modified_ComBat$gamma
Delta_factor_Run_set_2= Modified_ComBat$delta

##### Run_set_3
metadata_save_3=Run_set_3[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_3))]
metadata=Run_set_3[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_3))]
metadata$BMI_group=NULL
edata_control=Run_set_3[,grep("Ox_Stress_median_0|Ox_Stress_0",colnames(Run_set_3))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_3$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_3_Corrected_Controls = Modified_ComBat$data
Run_Set_3_Corrected_Controls=t(Run_Set_3_Corrected_Controls)
Run_Set_3_Corrected_Controls=cbind(Run_Set_3_Corrected_Controls, metadata_save_3)
#
Gamma_factor_Run_set_3= Modified_ComBat$gamma
Delta_factor_Run_set_3= Modified_ComBat$delta

##### Run_set_4
metadata_save_4=Run_set_4[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_4))]
metadata=Run_set_4[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_4))]
metadata$BMI_group=NULL
edata_control=Run_set_4[,grep("Ox_Stress_median_0|Ox_Stress_0",colnames(Run_set_4))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_4$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_4_Corrected_Controls = Modified_ComBat$data
Run_Set_4_Corrected_Controls=t(Run_Set_4_Corrected_Controls)
Run_Set_4_Corrected_Controls=cbind(Run_Set_4_Corrected_Controls, metadata_save_4)
#
Gamma_factor_Run_set_4= Modified_ComBat$gamma
Delta_factor_Run_set_4= Modified_ComBat$delta


##### Run_set_5
metadata_save_5=Run_set_5[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_5))]
metadata=Run_set_5[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_5))]
metadata$BMI_group=NULL
edata_control=Run_set_5[,grep("Ox_Stress_median_0|Ox_Stress_0",colnames(Run_set_5))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_5$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_5_Corrected_Controls = Modified_ComBat$data
Run_Set_5_Corrected_Controls=t(Run_Set_5_Corrected_Controls)
Run_Set_5_Corrected_Controls=cbind(Run_Set_5_Corrected_Controls, metadata_save_5)
#
Gamma_factor_Run_set_5= Modified_ComBat$gamma
Delta_factor_Run_set_5= Modified_ComBat$delta

##### Run_set_6
metadata_save_6=Run_set_6[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_6))]
metadata=Run_set_6[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_6))]
metadata$BMI_group=NULL
edata_control=Run_set_6[,grep("Ox_Stress_median_0|Ox_Stress_0",colnames(Run_set_6))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_6$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_6_Corrected_Controls = Modified_ComBat$data
Run_Set_6_Corrected_Controls=t(Run_Set_6_Corrected_Controls)
Run_Set_6_Corrected_Controls=cbind(Run_Set_6_Corrected_Controls, metadata_save_6)
#
Gamma_factor_Run_set_6= Modified_ComBat$gamma
Delta_factor_Run_set_6= Modified_ComBat$delta

##### Run_set_7
metadata_save_7=Run_set_7[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_7))]
metadata=Run_set_7[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_7))]
metadata$BMI_group=NULL
edata_control=Run_set_7[,grep("Ox_Stress_median_0|Ox_Stress_0",colnames(Run_set_7))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_7$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_7_Corrected_Controls = Modified_ComBat$data
Run_Set_7_Corrected_Controls=t(Run_Set_7_Corrected_Controls)
Run_Set_7_Corrected_Controls=cbind(Run_Set_7_Corrected_Controls, metadata_save_7)
#
Gamma_factor_Run_set_7= Modified_ComBat$gamma
Delta_factor_Run_set_7= Modified_ComBat$delta

##### Run_set_8
metadata_save_8=Run_set_8[,grep("Sample_ID|Run|Duplicate|Staining|Radiation|Timepoint|Age|BMI|Gender",colnames(Run_set_8))]
metadata=Run_set_8[,grep("Sample_ID|Timepoint|Age|BMI|Gender",colnames(Run_set_8))]
metadata$BMI_group=NULL
edata_control=Run_set_8[,grep("Ox_Stress_median_0|Ox_Stress_0",colnames(Run_set_8))]
edata_control=t(edata_control)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Run_set_8$Radiation_Batch
## Run Finsam's function
Modified_ComBat = ComBat_save(dat=edata_control, batch=Batch_C, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Run_Set_8_Corrected_Controls = Modified_ComBat$data
Run_Set_8_Corrected_Controls=t(Run_Set_8_Corrected_Controls)
Run_Set_8_Corrected_Controls=cbind(Run_Set_8_Corrected_Controls, metadata_save_8)
#
Gamma_factor_Run_set_8= Modified_ComBat$gamma
Delta_factor_Run_set_8= Modified_ComBat$delta

######### regroup corrected controls 
Corrected_controls= bind_rows(Run_Set_1_Corrected_Controls, Run_Set_2_Corrected_Controls,
                              Run_Set_3_Corrected_Controls,Run_Set_4_Corrected_Controls,
                              Run_Set_5_Corrected_Controls,Run_Set_6_Corrected_Controls,
                              Run_Set_7_Corrected_Controls,Run_Set_8_Corrected_Controls)
Corrected_controls$Rad_dose_Gy = 0
Corrected_controls$Run_set_batch=NULL
Corrected_controls$Radiation_Batch=NULL


#####################################################################
##################### On irradiated samples #########################
#####################################################################

######## we separate low and high dose to include the dose in Gy as a covariate
### dose en Gy
low_dose_Fe = 0.3 
low_dose_Ar = 0.18 
low_dose_Si = 0.11 
low_dose_Gamma = 0.1

high_dose_Fe = 0.82 
high_dose_Ar = 0.5 
high_dose_Si = 0.29 
high_dose_Gamma = 1

################################ Low dose ######################################
Raw_low_dose_irradiated_samples=Raw_OS_with_metadata[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Ox_Stress_median_low_dose|Ox_Stress_low_dose",colnames(Raw_OS_with_metadata))]

Raw_low_dose_irradiated_samples$Rad_dose_Gy = Raw_low_dose_irradiated_samples$Radiation_type
Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Fe"] <- low_dose_Fe
Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Ar"] <- low_dose_Ar
Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Si"] <- low_dose_Si
Raw_low_dose_irradiated_samples$Rad_dose_Gy[Raw_low_dose_irradiated_samples$Rad_dose_Gy == "Gamma"] <- low_dose_Gamma

Raw_low_dose_irradiated_samples=Raw_low_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Ox_Stress_median_low_dose|Ox_Stress_low_dose|Rad_dose_Gy",colnames(Raw_low_dose_irradiated_samples))]

metadata_save = Raw_low_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Rad_dose",colnames(Raw_low_dose_irradiated_samples))]

################### Now, for each run and set value we correct by radiation
Irradiated_Responses_Run_set_1 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 1)
Irradiated_Responses_Run_set_2 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 2)
Irradiated_Responses_Run_set_3 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 3)
Irradiated_Responses_Run_set_4 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 4)
Irradiated_Responses_Run_set_5 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 5)
Irradiated_Responses_Run_set_6 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 6)
Irradiated_Responses_Run_set_7 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 7)
Irradiated_Responses_Run_set_8 = Raw_low_dose_irradiated_samples %>% filter(Raw_low_dose_irradiated_samples$Run_set_batch == 8)

##### Run_set_1
# create arguments 
metadata_save_1=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
metadata=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_1[,grep("Ox_Stress_median_low_dose|Ox_Stress_low_dose",colnames(Irradiated_Responses_Run_set_1))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_1$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_1, custom.delta=Delta_factor_Run_set_1, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_1 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_1=cbind(Rad_Corrected_Irrad_Samples_Run_Set_1, metadata_save_1)


##### Run_set_2
# create arguments 
metadata_save_2=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
metadata=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_2[,grep("Ox_Stress_median_low_dose|Ox_Stress_low_dose",colnames(Irradiated_Responses_Run_set_2))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_2$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_2, custom.delta=Delta_factor_Run_set_2, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_2 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_2=cbind(Rad_Corrected_Irrad_Samples_Run_Set_2, metadata_save_2)

##### Run_set_3
# create arguments 
metadata_save_3=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
metadata=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_3[,grep("Ox_Stress_median_low_dose|Ox_Stress_low_dose",colnames(Irradiated_Responses_Run_set_3))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_3$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_3, custom.delta=Delta_factor_Run_set_3, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_3 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_3=cbind(Rad_Corrected_Irrad_Samples_Run_Set_3, metadata_save_3)

##### Run_set_4
# create arguments 
metadata_save_4=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
metadata=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_4[,grep("Ox_Stress_median_low_dose|Ox_Stress_low_dose",colnames(Irradiated_Responses_Run_set_4))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_4$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_4, custom.delta=Delta_factor_Run_set_4, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_4 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_4=cbind(Rad_Corrected_Irrad_Samples_Run_Set_4, metadata_save_4)


##### Run_set_5
# create arguments 
metadata_save_5=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
metadata=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_5[,grep("Ox_Stress_median_low_dose|Ox_Stress_low_dose",colnames(Irradiated_Responses_Run_set_5))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_5$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_5, custom.delta=Delta_factor_Run_set_5, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_5 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_5=cbind(Rad_Corrected_Irrad_Samples_Run_Set_5, metadata_save_5)

##### Run_set_6
# create arguments 
metadata_save_6=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
metadata=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_6[,grep("Ox_Stress_median_low_dose|Ox_Stress_low_dose",colnames(Irradiated_Responses_Run_set_6))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_6$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_6, custom.delta=Delta_factor_Run_set_6, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_6 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_6=cbind(Rad_Corrected_Irrad_Samples_Run_Set_6, metadata_save_6)


##### Run_set_7
# create arguments 
metadata_save_7=Irradiated_Responses_Run_set_7[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_7))]
metadata=Irradiated_Responses_Run_set_7[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_7))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_7[,grep("Ox_Stress_median_low_dose|Ox_Stress_low_dose",colnames(Irradiated_Responses_Run_set_7))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_7$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_7, custom.delta=Delta_factor_Run_set_7, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_7 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_7=cbind(Rad_Corrected_Irrad_Samples_Run_Set_7, metadata_save_7)


##### Run_set_8
# create arguments 
metadata_save_8=Irradiated_Responses_Run_set_8[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_8))]
metadata=Irradiated_Responses_Run_set_8[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_8))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_8[,grep("Ox_Stress_median_low_dose|Ox_Stress_low_dose",colnames(Irradiated_Responses_Run_set_8))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_8$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_8, custom.delta=Delta_factor_Run_set_8, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_8 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_8=cbind(Rad_Corrected_Irrad_Samples_Run_Set_8, metadata_save_8)


########## Now we regroup run/set and radiation corrected irradiated samples 
Corrected_low_dose_irradiated_samples=bind_rows(Rad_Corrected_Irrad_Samples_Run_Set_1, Rad_Corrected_Irrad_Samples_Run_Set_2, 
                                       Rad_Corrected_Irrad_Samples_Run_Set_3, Rad_Corrected_Irrad_Samples_Run_Set_4,
                                       Rad_Corrected_Irrad_Samples_Run_Set_5, Rad_Corrected_Irrad_Samples_Run_Set_6, 
                                       Rad_Corrected_Irrad_Samples_Run_Set_7, Rad_Corrected_Irrad_Samples_Run_Set_8)

Corrected_low_dose_irradiated_samples$Run_set_batch=NULL
Corrected_low_dose_irradiated_samples$Radiation_Batch=NULL



################################ High dose ######################################
Raw_high_dose_irradiated_samples=Raw_OS_with_metadata[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Ox_Stress_median_high_dose|Ox_Stress_high_dose",colnames(Raw_OS_with_metadata))]

Raw_high_dose_irradiated_samples$Rad_dose_Gy = Raw_high_dose_irradiated_samples$Radiation_type
Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Fe"] <- high_dose_Fe
Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Ar"] <- high_dose_Ar
Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Si"] <- high_dose_Si
Raw_high_dose_irradiated_samples$Rad_dose_Gy[Raw_high_dose_irradiated_samples$Rad_dose_Gy == "Gamma"] <- high_dose_Gamma

Raw_high_dose_irradiated_samples=Raw_high_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Ox_Stress_median_high_dose|Ox_Stress_high_dose|Rad_dose_Gy",colnames(Raw_high_dose_irradiated_samples))]

metadata_save = Raw_high_dose_irradiated_samples[,grep("Sample_ID|Run_set|Duplicate|Staining_date|Timepoint|Radiation_type|Radiation_Batch|Age|BMI|Gender|Rad_dose",colnames(Raw_high_dose_irradiated_samples))]

################### Now, for each run and set value we correct by radiation
Irradiated_Responses_Run_set_1 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 1)
Irradiated_Responses_Run_set_2 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 2)
Irradiated_Responses_Run_set_3 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 3)
Irradiated_Responses_Run_set_4 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 4)
Irradiated_Responses_Run_set_5 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 5)
Irradiated_Responses_Run_set_6 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 6)
Irradiated_Responses_Run_set_7 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 7)
Irradiated_Responses_Run_set_8 = Raw_high_dose_irradiated_samples %>% filter(Raw_high_dose_irradiated_samples$Run_set_batch == 8)

##### Run_set_1
# create arguments 
metadata_save_1=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
metadata=Irradiated_Responses_Run_set_1[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_1))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_1[,grep("Ox_Stress_median_high_dose|Ox_Stress_high_dose",colnames(Irradiated_Responses_Run_set_1))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_1$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_1, custom.delta=Delta_factor_Run_set_1, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_1 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_1=cbind(Rad_Corrected_Irrad_Samples_Run_Set_1, metadata_save_1)


##### Run_set_2
# create arguments 
metadata_save_2=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
metadata=Irradiated_Responses_Run_set_2[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_2))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_2[,grep("Ox_Stress_median_high_dose|Ox_Stress_high_dose",colnames(Irradiated_Responses_Run_set_2))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_2$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_2, custom.delta=Delta_factor_Run_set_2, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_2 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_2=cbind(Rad_Corrected_Irrad_Samples_Run_Set_2, metadata_save_2)

##### Run_set_3
# create arguments 
metadata_save_3=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
metadata=Irradiated_Responses_Run_set_3[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_3))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_3[,grep("Ox_Stress_median_high_dose|Ox_Stress_high_dose",colnames(Irradiated_Responses_Run_set_3))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_3$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_3, custom.delta=Delta_factor_Run_set_3, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_3 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_3=cbind(Rad_Corrected_Irrad_Samples_Run_Set_3, metadata_save_3)

##### Run_set_4
# create arguments 
metadata_save_4=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
metadata=Irradiated_Responses_Run_set_4[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_4))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_4[,grep("Ox_Stress_median_high_dose|Ox_Stress_high_dose",colnames(Irradiated_Responses_Run_set_4))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_4$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_4, custom.delta=Delta_factor_Run_set_4, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_4 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_4=cbind(Rad_Corrected_Irrad_Samples_Run_Set_4, metadata_save_4)


##### Run_set_5
# create arguments 
metadata_save_5=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
metadata=Irradiated_Responses_Run_set_5[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_5))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_5[,grep("Ox_Stress_median_high_dose|Ox_Stress_high_dose",colnames(Irradiated_Responses_Run_set_5))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_5$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_5, custom.delta=Delta_factor_Run_set_5, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_5 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_5=cbind(Rad_Corrected_Irrad_Samples_Run_Set_5, metadata_save_5)

##### Run_set_6
# create arguments 
metadata_save_6=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
metadata=Irradiated_Responses_Run_set_6[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_6))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_6[,grep("Ox_Stress_median_high_dose|Ox_Stress_high_dose",colnames(Irradiated_Responses_Run_set_6))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_6$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_6, custom.delta=Delta_factor_Run_set_6, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_6 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_6=cbind(Rad_Corrected_Irrad_Samples_Run_Set_6, metadata_save_6)


##### Run_set_7
# create arguments 
metadata_save_7=Irradiated_Responses_Run_set_7[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_7))]
metadata=Irradiated_Responses_Run_set_7[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_7))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_7[,grep("Ox_Stress_median_high_dose|Ox_Stress_high_dose",colnames(Irradiated_Responses_Run_set_7))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_7$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_7, custom.delta=Delta_factor_Run_set_7, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_7 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_7=cbind(Rad_Corrected_Irrad_Samples_Run_Set_7, metadata_save_7)


##### Run_set_8
# create arguments 
metadata_save_8=Irradiated_Responses_Run_set_8[,grep("Sample_ID|Run|Duplicate|Staining|Rad_dose_Gy|Radiation|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_8))]
metadata=Irradiated_Responses_Run_set_8[,grep("Sample_ID|Rad_dose_Gy|Timepoint|Age|BMI|Gender",colnames(Irradiated_Responses_Run_set_8))]
metadata$BMI_group=NULL
edata_Irradiated=Irradiated_Responses_Run_set_8[,grep("Ox_Stress_median_high_dose|Ox_Stress_high_dose",colnames(Irradiated_Responses_Run_set_8))]
edata_Irradiated=t(edata_Irradiated)
modcombat = model.matrix(~1, data= metadata) 
Batch_C= Irradiated_Responses_Run_set_8$Radiation_Batch
Combat_custom_Rad_correction <- ComBat_custom(dat=edata_Irradiated, batch=Batch_C, custom.gamma=Gamma_factor_Run_set_8, custom.delta=Delta_factor_Run_set_8, mod=modcombat, par.prior=TRUE, prior.plots=FALSE)
#
Rad_Corrected_Irrad_Samples_Run_Set_8 = t(Combat_custom_Rad_correction)
Rad_Corrected_Irrad_Samples_Run_Set_8=cbind(Rad_Corrected_Irrad_Samples_Run_Set_8, metadata_save_8)


########## Now we regroup run/set and radiation corrected irradiated samples 
Corrected_high_dose_irradiated_samples=bind_rows(Rad_Corrected_Irrad_Samples_Run_Set_1, Rad_Corrected_Irrad_Samples_Run_Set_2, 
                                       Rad_Corrected_Irrad_Samples_Run_Set_3, Rad_Corrected_Irrad_Samples_Run_Set_4,
                                       Rad_Corrected_Irrad_Samples_Run_Set_5, Rad_Corrected_Irrad_Samples_Run_Set_6, 
                                       Rad_Corrected_Irrad_Samples_Run_Set_7, Rad_Corrected_Irrad_Samples_Run_Set_8)

Corrected_high_dose_irradiated_samples$Run_set_batch=NULL
Corrected_high_dose_irradiated_samples$Radiation_Batch=NULL


### Control, low irradiated and high irradiated samples are separate into 3 tables. In these three table, oxidative stress data for all radiation/time points are mixed into one column and complete with two metadata columns = time point & radiation_type. For the three table, we need to separate results by time point and radiation in order to do the normalization using for each conditions the respective controls

## controls
Controls_4h = Corrected_controls %>% filter(Corrected_controls$Timepoint=="4h")
Controls_4h_Fe =Controls_4h %>% filter(Controls_4h$Radiation_type=="Fe")
Controls_4h_Ar = Controls_4h %>% filter(Controls_4h$Radiation_type=="Ar")
Controls_4h_Si = Controls_4h %>% filter(Controls_4h$Radiation_type=="Si")
Controls_4h_Gamma = Controls_4h %>% filter(Controls_4h$Radiation_type=="Gamma")
#
Controls_24h = Corrected_controls %>% filter(Corrected_controls$Timepoint=="24h")
Controls_24h_Fe = Controls_24h %>% filter(Controls_24h$Radiation_type=="Fe")
Controls_24h_Ar = Controls_24h%>% filter(Controls_24h$Radiation_type=="Ar")
Controls_24h_Si =Controls_24h %>% filter(Controls_24h$Radiation_type=="Si")
Controls_24h_Gamma = Controls_24h %>% filter(Controls_24h$Radiation_type=="Gamma")

## Low dose
LD_4h = Corrected_low_dose_irradiated_samples %>% filter(Corrected_low_dose_irradiated_samples$Timepoint=="4h")
LD_4h_Fe = LD_4h %>% filter(LD_4h$Radiation_type=="Fe")
LD_4h_Fe=LD_4h_Fe[,grepl("Sample_ID|Ox_Stress_low|Run_set|Duplicate",colnames(LD_4h_Fe))]
LD_4h_Ar = LD_4h %>% filter(LD_4h$Radiation_type=="Ar")
LD_4h_Ar=LD_4h_Ar[,grepl("Sample_ID|Ox_Stress_low|Run_set|Duplicate",colnames(LD_4h_Ar))]
LD_4h_Si = LD_4h %>% filter(LD_4h$Radiation_type=="Si")
LD_4h_Si=LD_4h_Si[,grepl("Sample_ID|Ox_Stress_low|Run_set|Duplicate",colnames(LD_4h_Si))]
LD_4h_Gamma = LD_4h %>% filter(LD_4h$Radiation_type=="Gamma")
LD_4h_Gamma=LD_4h_Gamma[,grepl("Sample_ID|Ox_Stress_low|Run_set|Duplicate",colnames(LD_4h_Gamma))]
#
LD_24h = Corrected_low_dose_irradiated_samples %>% filter(Corrected_low_dose_irradiated_samples$Timepoint=="24h")
LD_24h_Fe = LD_24h %>% filter(LD_24h$Radiation_type=="Fe")
LD_24h_Fe=LD_24h_Fe[,grepl("Sample_ID|Ox_Stress_low|Run_set|Duplicate",colnames(LD_24h_Fe))]
LD_24h_Ar = LD_24h %>% filter(LD_24h$Radiation_type=="Ar")
LD_24h_Ar=LD_24h_Ar[,grepl("Sample_ID|Ox_Stress_low|Run_set|Duplicate",colnames(LD_24h_Ar))]
LD_24h_Si = LD_24h %>% filter(LD_24h$Radiation_type=="Si")
LD_24h_Si=LD_24h_Si[,grepl("Sample_ID|Ox_Stress_low|Run_set|Duplicate",colnames(LD_24h_Si))]
LD_24h_Gamma = LD_24h %>% filter(LD_24h$Radiation_type=="Gamma")
LD_24h_Gamma=LD_24h_Gamma[,grepl("Sample_ID|Ox_Stress_low|Run_set|Duplicate",colnames(LD_24h_Gamma))]

## High dose
HD_4h = Corrected_high_dose_irradiated_samples %>% filter(Corrected_high_dose_irradiated_samples$Timepoint=="4h")
HD_4h_Fe = HD_4h %>% filter(HD_4h$Radiation_type=="Fe")
HD_4h_Fe=HD_4h_Fe[,grepl("Sample_ID|Ox_Stress_high|Run_set|Duplicate",colnames(HD_4h_Fe))]
HD_4h_Ar = HD_4h %>% filter(HD_4h$Radiation_type=="Ar")
HD_4h_Ar=HD_4h_Ar[,grepl("Sample_ID|Ox_Stress_high|Run_set|Duplicate",colnames(HD_4h_Ar))]
HD_4h_Si = HD_4h %>% filter(HD_4h$Radiation_type=="Si")
HD_4h_Si=HD_4h_Si[,grepl("Sample_ID|Ox_Stress_high|Run_set|Duplicate",colnames(HD_4h_Si))]
HD_4h_Gamma = HD_4h %>% filter(HD_4h$Radiation_type=="Gamma")
HD_4h_Gamma=HD_4h_Gamma[,grepl("Sample_ID|Ox_Stress_high|Run_set|Duplicate",colnames(HD_4h_Gamma))]
#
HD_24h = Corrected_high_dose_irradiated_samples %>% filter(Corrected_high_dose_irradiated_samples$Timepoint=="24h")
HD_24h_Fe = HD_24h %>% filter(HD_24h$Radiation_type=="Fe")
HD_24h_Fe=HD_24h_Fe[,grepl("Sample_ID|Ox_Stress_high|Run_set|Duplicate",colnames(HD_24h_Fe))]
HD_24h_Ar = HD_24h %>% filter(HD_24h$Radiation_type=="Ar")
HD_24h_Ar=HD_24h_Ar[,grepl("Sample_ID|Ox_Stress_high|Run_set|Duplicate",colnames(HD_24h_Ar))]
HD_24h_Si = HD_24h %>% filter(HD_24h$Radiation_type=="Si")
HD_24h_Si=HD_24h_Si[,grepl("Sample_ID|Ox_Stress_high|Run_set|Duplicate",colnames(HD_24h_Si))]
HD_24h_Gamma = HD_24h %>% filter(HD_24h$Radiation_type=="Gamma")
HD_24h_Gamma=HD_24h_Gamma[,grepl("Sample_ID|Ox_Stress_high|Run_set|Duplicate",colnames(HD_24h_Gamma))]


## Regroup 
Correct_Fe_4h=merge(Controls_4h_Fe, LD_4h_Fe, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Fe_4h=merge(Correct_Fe_4h, HD_4h_Fe, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Ar_4h=merge(Controls_4h_Ar, LD_4h_Ar, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Ar_4h=merge(Correct_Ar_4h, HD_4h_Ar, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Si_4h=merge(Controls_4h_Si, LD_4h_Si, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Si_4h=merge(Correct_Si_4h, HD_4h_Si, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Gamma_4h=merge(Controls_4h_Gamma, LD_4h_Gamma, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Gamma_4h=merge(Correct_Gamma_4h, HD_4h_Gamma, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Fe_24h=merge(Controls_24h_Fe, LD_24h_Fe, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Fe_24h=merge(Correct_Fe_24h, HD_24h_Fe, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Ar_24h=merge(Controls_24h_Ar, LD_24h_Ar, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Ar_24h=merge(Correct_Ar_24h, HD_24h_Ar, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Si_24h=merge(Controls_24h_Si, LD_24h_Si, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Si_24h=merge(Correct_Si_24h, HD_24h_Si, by=c("Sample_ID", "Duplicate", "Run_set"))
#
Correct_Gamma_24h=merge(Controls_24h_Gamma, LD_24h_Gamma, by=c("Sample_ID", "Duplicate", "Run_set"))
Correct_Gamma_24h=merge(Correct_Gamma_24h, HD_24h_Gamma, by=c("Sample_ID", "Duplicate", "Run_set"))

#### Regroup everything into 1 table

Corrected_Ox_Stress= bind_rows(Correct_Fe_4h, Correct_Fe_24h,
                                Correct_Ar_4h, Correct_Ar_24h,
                                Correct_Si_4h, Correct_Si_24h,
                                Correct_Gamma_4h, Correct_Gamma_24h)

Corrected_Ox_Stress$Rad_dose_Gy=NULL
#### The correction may generate negative value => we fix those negative value to 0 
Corrected_Ox_Stress$Ox_Stress_0[Corrected_Ox_Stress$Ox_Stress_0 < 0] <- 0 
Corrected_Ox_Stress$Ox_Stress_low_dose[Corrected_Ox_Stress$Ox_Stress_low_dose < 0] <-  0 
Corrected_Ox_Stress$Ox_Stress_high_dose[Corrected_Ox_Stress$Ox_Stress_high_dose < 0] <-  0 

###########################################################################
##################### 2) z-score correction ###############################
###########################################################################


# 19A is used as the reference, we perform the correction first between on 18B and then on 19C
Run_19A= c("Run_19A_Set_1", "Run_19A_Set_2")
Run_18B = c("Run_18B_Set_2", "Run_18B_Set_1")
Run_19C = c("Run_19C_Set_2", "Run_19C_Set_1", "Run_19C_Set_3", "Run_19C_Set_4")

Run_19A_18B = c("Run_18B_Set_2", "Run_18B_Set_1","Run_19A_Set_1", "Run_19A_Set_2")
OS_correct_19A_18B = Corrected_Ox_Stress %>% filter(Corrected_Ox_Stress$Run_set %in% Run_19A_18B)
Run_19A_19C = c("Run_19C_Set_2", "Run_19C_Set_1", "Run_19C_Set_3", "Run_19C_Set_4","Run_19A_Set_1", "Run_19A_Set_2")
OS_correct_19A_19C = Corrected_Ox_Stress %>% filter(Corrected_Ox_Stress$Run_set %in% Run_19A_19C)
# Select the 10 people that overlap in these two runs
Subject_18B_19A = c(1214, 1215,1216,1217,1218,1219,1220,1221,1222,1223)
Subject_19C_19A = c() ## Need to complete sample_ID of subjects that overlap in 19C and 19A

OS_correct_19A_18B_10p = OS_correct_19A_18B %>% filter(OS_correct_19A_18B$Sample_ID %in% Subject_18B_19A )
OS_correct_19A_19C_10p = OS_correct_19A_19C %>% filter(OS_correct_19A_19C$Sample_ID %in% Subject_19C_19A )


### 19C_Set_1: for each condition: time point, rad, and low high dose calculate the mean and variance that will be used as a reference 
Samp_19A_10p = OS_correct_19A_18B_10p %>% filter(OS_correct_19A_18B_10p$Run_set %in% Run_19A)

## For Controls 
Controls_19A= Samp_19A_10p
Controls_19A$Ox_Stress_low_dose=NULL
Controls_19A$Ox_Stress_high_dose=NULL
#
### 4h 
control_19A_4h = Controls_19A %>% filter(Controls_19A$Timepoint=="4h")
#
control_19A_4h_Fe = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Fe")
control_19A_4h_Ar = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Ar")
control_19A_4h_Si = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Si")
control_19A_4h_Gamma = control_19A_4h %>% filter(control_19A_4h$Radiation_type=="Gamma")
### 24h 
control_19A_24h = Controls_19A %>% filter(Controls_19A$Timepoint=="24h")
#
control_19A_24h_Fe = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Fe")
control_19A_24h_Ar = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Ar")
control_19A_24h_Si = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Si")
control_19A_24h_Gamma = control_19A_24h %>% filter(control_19A_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_ref_Cont_Fe_4h = mean(NaRV.omit(control_19A_4h_Fe$Ox_Stress_0))
Mean_ref_Cont_Ar_4h = mean(NaRV.omit(control_19A_4h_Ar$Ox_Stress_0))
Mean_ref_Cont_Si_4h = mean(NaRV.omit(control_19A_4h_Si$Ox_Stress_0))
Mean_ref_Cont_Gamma_4h = mean(NaRV.omit(control_19A_4h_Gamma$Ox_Stress_0))
# 24h
Mean_ref_Cont_Fe_24h = mean(NaRV.omit(control_19A_24h_Fe$Ox_Stress_0))
Mean_ref_Cont_Ar_24h = mean(NaRV.omit(control_19A_24h_Ar$Ox_Stress_0))
Mean_ref_Cont_Si_24h = mean(NaRV.omit(control_19A_24h_Si$Ox_Stress_0))
Mean_ref_Cont_Gamma_24h = mean(NaRV.omit(control_19A_24h_Gamma$Ox_Stress_0))
####### sd
# 4h
Std_ref_Cont_Fe_4h = sd(NaRV.omit(control_19A_4h_Fe$Ox_Stress_0))
Std_ref_Cont_Ar_4h = sd(NaRV.omit(control_19A_4h_Ar$Ox_Stress_0))
Std_ref_Cont_Si_4h = sd(NaRV.omit(control_19A_4h_Si$Ox_Stress_0))
Std_ref_Cont_Gamma_4h = sd(NaRV.omit(control_19A_4h_Gamma$Ox_Stress_0))
# 24h
Std_ref_Cont_Fe_24h = sd(NaRV.omit(control_19A_24h_Fe$Ox_Stress_0))
Std_ref_Cont_Ar_24h = sd(NaRV.omit(control_19A_24h_Ar$Ox_Stress_0))
Std_ref_Cont_Si_24h = sd(NaRV.omit(control_19A_24h_Si$Ox_Stress_0))
Std_ref_Cont_Gamma_24h = sd(NaRV.omit(control_19A_24h_Gamma$Ox_Stress_0))
#
#
## For Low dose irradiated samples
LD_19A= Samp_19A_10p
LD_19A$Ox_Stress_0=NULL
LD_19A$Ox_Stress_high_dose=NULL
#
### 4h 
LD_19A_4h = LD_19A %>% filter(LD_19A$Timepoint=="4h")
#
LD_19A_4h_Fe = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Fe")
LD_19A_4h_Ar = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Ar")
LD_19A_4h_Si = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Si")
LD_19A_4h_Gamma = LD_19A_4h %>% filter(LD_19A_4h$Radiation_type=="Gamma")
### 24h 
LD_19A_24h = LD_19A %>% filter(LD_19A$Timepoint=="24h")
#
LD_19A_24h_Fe = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Fe")
LD_19A_24h_Ar = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Ar")
LD_19A_24h_Si = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Si")
LD_19A_24h_Gamma = LD_19A_24h %>% filter(LD_19A_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_ref_LD_Fe_4h = mean(NaRV.omit(LD_19A_4h_Fe$Ox_Stress_low_dose))
Mean_ref_LD_Ar_4h = mean(NaRV.omit(LD_19A_4h_Ar$Ox_Stress_low_dose))
Mean_ref_LD_Si_4h = mean(NaRV.omit(LD_19A_4h_Si$Ox_Stress_low_dose))
Mean_ref_LD_Gamma_4h = mean(NaRV.omit(LD_19A_4h_Gamma$Ox_Stress_low_dose))
# 24h
Mean_ref_LD_Fe_24h = mean(NaRV.omit(LD_19A_24h_Fe$Ox_Stress_low_dose))
Mean_ref_LD_Ar_24h = mean(NaRV.omit(LD_19A_24h_Ar$Ox_Stress_low_dose))
Mean_ref_LD_Si_24h = mean(NaRV.omit(LD_19A_24h_Si$Ox_Stress_low_dose))
Mean_ref_LD_Gamma_24h = mean(NaRV.omit(LD_19A_24h_Gamma$Ox_Stress_low_dose))
####### sd
# 4h
Std_ref_LD_Fe_4h = sd(NaRV.omit(LD_19A_4h_Fe$Ox_Stress_low_dose))
Std_ref_LD_Ar_4h = sd(NaRV.omit(LD_19A_4h_Ar$Ox_Stress_low_dose))
Std_ref_LD_Si_4h = sd(NaRV.omit(LD_19A_4h_Si$Ox_Stress_low_dose))
Std_ref_LD_Gamma_4h = sd(NaRV.omit(LD_19A_4h_Gamma$Ox_Stress_low_dose))
# 24h
Std_ref_LD_Fe_24h = sd(NaRV.omit(LD_19A_24h_Fe$Ox_Stress_low_dose))
Std_ref_LD_Ar_24h = sd(NaRV.omit(LD_19A_24h_Ar$Ox_Stress_low_dose))
Std_ref_LD_Si_24h = sd(NaRV.omit(LD_19A_24h_Si$Ox_Stress_low_dose))
Std_ref_LD_Gamma_24h = sd(NaRV.omit(LD_19A_24h_Gamma$Ox_Stress_low_dose))
#
#
## For high dose irradiated samples
HD_19A= Samp_19A_10p
HD_19A$Ox_Stress_0=NULL
HD_19A$Ox_Stress_low_dose=NULL
#
### 4h 
HD_19A_4h = HD_19A %>% filter(HD_19A$Timepoint=="4h")
#
HD_19A_4h_Fe = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Fe")
HD_19A_4h_Ar = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Ar")
HD_19A_4h_Si = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Si")
HD_19A_4h_Gamma = HD_19A_4h %>% filter(HD_19A_4h$Radiation_type=="Gamma")
### 24h 
HD_19A_24h = HD_19A %>% filter(HD_19A$Timepoint=="24h")
#
HD_19A_24h_Fe = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Fe")
HD_19A_24h_Ar = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Ar")
HD_19A_24h_Si = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Si")
HD_19A_24h_Gamma = HD_19A_24h %>% filter(HD_19A_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_ref_HD_Fe_4h = mean(NaRV.omit(HD_19A_4h_Fe$Ox_Stress_high_dose))
Mean_ref_HD_Ar_4h = mean(NaRV.omit(HD_19A_4h_Ar$Ox_Stress_high_dose))
Mean_ref_HD_Si_4h = mean(NaRV.omit(HD_19A_4h_Si$Ox_Stress_high_dose))
Mean_ref_HD_Gamma_4h = mean(NaRV.omit(HD_19A_4h_Gamma$Ox_Stress_high_dose))
# 24h
Mean_ref_HD_Fe_24h = mean(NaRV.omit(HD_19A_24h_Fe$Ox_Stress_high_dose))
Mean_ref_HD_Ar_24h = mean(NaRV.omit(HD_19A_24h_Ar$Ox_Stress_high_dose))
Mean_ref_HD_Si_24h = mean(NaRV.omit(HD_19A_24h_Si$Ox_Stress_high_dose))
Mean_ref_HD_Gamma_24h = mean(NaRV.omit(HD_19A_24h_Gamma$Ox_Stress_high_dose))
####### sd
# 4h
Std_ref_HD_Fe_4h = sd(NaRV.omit(HD_19A_4h_Fe$Ox_Stress_high_dose))
Std_ref_HD_Ar_4h = sd(NaRV.omit(HD_19A_4h_Ar$Ox_Stress_high_dose))
Std_ref_HD_Si_4h = sd(NaRV.omit(HD_19A_4h_Si$Ox_Stress_high_dose))
Std_ref_HD_Gamma_4h = sd(NaRV.omit(HD_19A_4h_Gamma$Ox_Stress_high_dose))
# 24h
Std_ref_HD_Fe_24h = sd(NaRV.omit(HD_19A_24h_Fe$Ox_Stress_high_dose))
Std_ref_HD_Ar_24h = sd(NaRV.omit(HD_19A_24h_Ar$Ox_Stress_high_dose))
Std_ref_HD_Si_24h = sd(NaRV.omit(HD_19A_24h_Si$Ox_Stress_high_dose))
Std_ref_HD_Gamma_24h = sd(NaRV.omit(HD_19A_24h_Gamma$Ox_Stress_high_dose))



############################## For controls and irradiated samples 18B we also calculate mean and std to perform the "z-score" normalization
############ For the 10 peoples that overlap ##########

Samp_18B_10p = OS_correct_19A_18B_10p %>% filter(OS_correct_19A_18B_10p$Run_set %in% Run_18B)

## For Controls 
Controls_18B= Samp_18B_10p
Controls_18B$Ox_Stress_low_dose=NULL
Controls_18B$Ox_Stress_high_dose=NULL
#
### 4h 
control_18B_4h = Controls_18B %>% filter(Controls_18B$Timepoint=="4h")
#
control_18B_4h_Fe = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Fe")
control_18B_4h_Ar = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Ar")
control_18B_4h_Si = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Si")
control_18B_4h_Gamma = control_18B_4h %>% filter(control_18B_4h$Radiation_type=="Gamma")
### 24h 
control_18B_24h = Controls_18B %>% filter(Controls_18B$Timepoint=="24h")
#
control_18B_24h_Fe = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Fe")
control_18B_24h_Ar = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Ar")
control_18B_24h_Si = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Si")
control_18B_24h_Gamma = control_18B_24h %>% filter(control_18B_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_Cont_Fe_4h = mean(NaRV.omit(control_18B_4h_Fe$Ox_Stress_0))
Mean_Cont_Ar_4h = mean(NaRV.omit(control_18B_4h_Ar$Ox_Stress_0))
Mean_Cont_Si_4h = mean(NaRV.omit(control_18B_4h_Si$Ox_Stress_0))
Mean_Cont_Gamma_4h = mean(NaRV.omit(control_18B_4h_Gamma$Ox_Stress_0))
# 24h
Mean_Cont_Fe_24h = mean(NaRV.omit(control_18B_24h_Fe$Ox_Stress_0))
Mean_Cont_Ar_24h = mean(NaRV.omit(control_18B_24h_Ar$Ox_Stress_0))
Mean_Cont_Si_24h = mean(NaRV.omit(control_18B_24h_Si$Ox_Stress_0))
Mean_Cont_Gamma_24h = mean(NaRV.omit(control_18B_24h_Gamma$Ox_Stress_0))
####### sd
# 4h
Std_Cont_Fe_4h = sd(NaRV.omit(control_18B_4h_Fe$Ox_Stress_0))
Std_Cont_Ar_4h = sd(NaRV.omit(control_18B_4h_Ar$Ox_Stress_0))
Std_Cont_Si_4h = sd(NaRV.omit(control_18B_4h_Si$Ox_Stress_0))
Std_Cont_Gamma_4h = sd(NaRV.omit(control_18B_4h_Gamma$Ox_Stress_0))
# 24h
Std_Cont_Fe_24h = sd(NaRV.omit(control_18B_24h_Fe$Ox_Stress_0))
Std_Cont_Ar_24h = sd(NaRV.omit(control_18B_24h_Ar$Ox_Stress_0))
Std_Cont_Si_24h = sd(NaRV.omit(control_18B_24h_Si$Ox_Stress_0))
Std_Cont_Gamma_24h = sd(NaRV.omit(control_18B_24h_Gamma$Ox_Stress_0))
#
## z-score correction on all people from 18B
Controls_allp_18B= Corrected_Ox_Stress %>% filter(Corrected_Ox_Stress$Run_set %in% Run_18B)
Controls_allp_18B$Ox_Stress_low_dose=NULL
Controls_allp_18B$Ox_Stress_high_dose=NULL
#
### 4h 
control_allp_18B_4h = Controls_allp_18B %>% filter(Controls_allp_18B$Timepoint=="4h")
#
control_allp_18B_4h_Fe = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Fe")
control_allp_18B_4h_Ar = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Ar")
control_allp_18B_4h_Si = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Si")
control_allp_18B_4h_Gamma = control_allp_18B_4h %>% filter(control_allp_18B_4h$Radiation_type=="Gamma")
### 24h 
control_allp_18B_24h = Controls_allp_18B %>% filter(Controls_allp_18B$Timepoint=="24h")
#
control_allp_18B_24h_Fe = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Fe")
control_allp_18B_24h_Ar = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Ar")
control_allp_18B_24h_Si = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Si")
control_allp_18B_24h_Gamma = control_allp_18B_24h %>% filter(control_allp_18B_24h$Radiation_type=="Gamma")
## z-score correction
# 4h
control_allp_18B_4h_Fe$Ox_Stress_0 = (((control_allp_18B_4h_Fe$Ox_Stress_0 - Mean_Cont_Fe_4h)/Std_Cont_Fe_4h)*Std_ref_Cont_Fe_4h) + Mean_ref_Cont_Fe_4h
control_allp_18B_4h_Ar$Ox_Stress_0 = (((control_allp_18B_4h_Ar$Ox_Stress_0 - Mean_Cont_Ar_4h)/Std_Cont_Ar_4h)*Std_ref_Cont_Ar_4h) + Mean_ref_Cont_Ar_4h
control_allp_18B_4h_Si$Ox_Stress_0 = (((control_allp_18B_4h_Si$Ox_Stress_0 - Mean_Cont_Si_4h)/Std_Cont_Si_4h)*Std_ref_Cont_Si_4h) + Mean_ref_Cont_Si_4h
control_allp_18B_4h_Gamma$Ox_Stress_0 = (((control_allp_18B_4h_Gamma$Ox_Stress_0 - Mean_Cont_Gamma_4h)/Std_Cont_Gamma_4h)*Std_ref_Cont_Gamma_4h) + Mean_ref_Cont_Gamma_4h
# 24h
control_allp_18B_24h_Fe$Ox_Stress_0 = (((control_allp_18B_24h_Fe$Ox_Stress_0 - Mean_Cont_Fe_24h)/Std_Cont_Fe_24h)*Std_ref_Cont_Fe_24h) + Mean_ref_Cont_Fe_24h
control_allp_18B_24h_Ar$Ox_Stress_0 = (((control_allp_18B_24h_Ar$Ox_Stress_0 - Mean_Cont_Ar_24h)/Std_Cont_Ar_24h)*Std_ref_Cont_Ar_24h) + Mean_ref_Cont_Ar_24h
control_allp_18B_24h_Si$Ox_Stress_0 = (((control_allp_18B_24h_Si$Ox_Stress_0 - Mean_Cont_Si_24h)/Std_Cont_Si_24h)*Std_ref_Cont_Si_24h) + Mean_ref_Cont_Si_24h
control_allp_18B_24h_Gamma$Ox_Stress_0 = (((control_allp_18B_24h_Gamma$Ox_Stress_0 - Mean_Cont_Gamma_24h)/Std_Cont_Gamma_24h)*Std_ref_Cont_Gamma_24h) + Mean_ref_Cont_Gamma_24h
##
##
## For Low dose irradiated samples
LD_18B= Samp_18B_10p
LD_18B$Ox_Stress_0=NULL
LD_18B$Ox_Stress_high_dose=NULL
#
### 4h 
LD_18B_4h = LD_18B %>% filter(LD_18B$Timepoint=="4h")
#
LD_18B_4h_Fe = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Fe")
LD_18B_4h_Ar = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Ar")
LD_18B_4h_Si = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Si")
LD_18B_4h_Gamma = LD_18B_4h %>% filter(LD_18B_4h$Radiation_type=="Gamma")
### 24h 
LD_18B_24h = LD_18B %>% filter(LD_18B$Timepoint=="24h")
#
LD_18B_24h_Fe = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Fe")
LD_18B_24h_Ar = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Ar")
LD_18B_24h_Si = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Si")
LD_18B_24h_Gamma = LD_18B_24h %>% filter(LD_18B_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_LD_Fe_4h = mean(NaRV.omit(LD_18B_4h_Fe$Ox_Stress_low_dose))
Mean_LD_Ar_4h = mean(NaRV.omit(LD_18B_4h_Ar$Ox_Stress_low_dose))
Mean_LD_Si_4h = mean(NaRV.omit(LD_18B_4h_Si$Ox_Stress_low_dose))
Mean_LD_Gamma_4h = mean(NaRV.omit(LD_18B_4h_Gamma$Ox_Stress_low_dose))
# 24h
Mean_LD_Fe_24h = mean(NaRV.omit(LD_18B_24h_Fe$Ox_Stress_low_dose))
Mean_LD_Ar_24h = mean(NaRV.omit(LD_18B_24h_Ar$Ox_Stress_low_dose))
Mean_LD_Si_24h = mean(NaRV.omit(LD_18B_24h_Si$Ox_Stress_low_dose))
Mean_LD_Gamma_24h = mean(NaRV.omit(LD_18B_24h_Gamma$Ox_Stress_low_dose))
####### sd
# 4h
Std_LD_Fe_4h = sd(NaRV.omit(LD_18B_4h_Fe$Ox_Stress_low_dose))
Std_LD_Ar_4h = sd(NaRV.omit(LD_18B_4h_Ar$Ox_Stress_low_dose))
Std_LD_Si_4h = sd(NaRV.omit(LD_18B_4h_Si$Ox_Stress_low_dose))
Std_LD_Gamma_4h = sd(NaRV.omit(LD_18B_4h_Gamma$Ox_Stress_low_dose))
# 24h
Std_LD_Fe_24h = sd(NaRV.omit(LD_18B_24h_Fe$Ox_Stress_low_dose))
Std_LD_Ar_24h = sd(NaRV.omit(LD_18B_24h_Ar$Ox_Stress_low_dose))
Std_LD_Si_24h = sd(NaRV.omit(LD_18B_24h_Si$Ox_Stress_low_dose))
Std_LD_Gamma_24h = sd(NaRV.omit(LD_18B_24h_Gamma$Ox_Stress_low_dose))
#
#
## z-score correction on all people from 18B
LD_allp_18B= Corrected_Cell_Death %>% filter(Corrected_Cell_Death$Run_set %in% Run_18B)
LD_allp_18B$Ox_Stress_0=NULL
LD_allp_18B$Ox_Stress_high_dose=NULL
#
### 4h 
LD_allp_18B_4h = LD_allp_18B %>% filter(LD_allp_18B$Timepoint=="4h")
#
LD_allp_18B_4h_Fe = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Fe")
LD_allp_18B_4h_Ar = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Ar")
LD_allp_18B_4h_Si = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Si")
LD_allp_18B_4h_Gamma = LD_allp_18B_4h %>% filter(LD_allp_18B_4h$Radiation_type=="Gamma")
### 24h 
LD_allp_18B_24h = LD_allp_18B %>% filter(LD_allp_18B$Timepoint=="24h")
#
LD_allp_18B_24h_Fe = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Fe")
LD_allp_18B_24h_Ar = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Ar")
LD_allp_18B_24h_Si = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Si")
LD_allp_18B_24h_Gamma = LD_allp_18B_24h %>% filter(LD_allp_18B_24h$Radiation_type=="Gamma")

## z-score correction
# 4h
LD_allp_18B_4h_Fe$Ox_Stress_low_dose = (((LD_allp_18B_4h_Fe$Ox_Stress_low_dose - Mean_LD_Fe_4h)/Std_LD_Fe_4h)*Std_ref_LD_Fe_4h) + Mean_ref_LD_Fe_4h
LD_allp_18B_4h_Ar$Ox_Stress_low_dose = (((LD_allp_18B_4h_Ar$Ox_Stress_low_dose - Mean_LD_Ar_4h)/Std_LD_Ar_4h)*Std_ref_LD_Ar_4h) + Mean_ref_LD_Ar_4h
LD_allp_18B_4h_Si$Ox_Stress_low_dose = (((LD_allp_18B_4h_Si$Ox_Stress_low_dose - Mean_LD_Si_4h)/Std_LD_Si_4h)*Std_ref_LD_Si_4h) + Mean_ref_LD_Si_4h
LD_allp_18B_4h_Gamma$Ox_Stress_low_dose = (((LD_allp_18B_4h_Gamma$Ox_Stress_low_dose - Mean_LD_Gamma_4h)/Std_LD_Gamma_4h)*Std_ref_LD_Gamma_4h) + Mean_ref_LD_Gamma_4h
# 24h
LD_allp_18B_24h_Fe$Ox_Stress_low_dose = (((LD_allp_18B_24h_Fe$Ox_Stress_low_dose - Mean_LD_Fe_24h)/Std_LD_Fe_24h)*Std_ref_LD_Fe_24h) + Mean_ref_LD_Fe_24h
LD_allp_18B_24h_Ar$Ox_Stress_low_dose = (((LD_allp_18B_24h_Ar$Ox_Stress_low_dose - Mean_LD_Ar_24h)/Std_LD_Ar_24h)*Std_ref_LD_Ar_24h) + Mean_ref_LD_Ar_24h
LD_allp_18B_24h_Si$Ox_Stress_low_dose = (((LD_allp_18B_24h_Si$Ox_Stress_low_dose - Mean_LD_Si_24h)/Std_LD_Si_24h)*Std_ref_LD_Si_24h) + Mean_ref_LD_Si_24h
LD_allp_18B_24h_Gamma$Ox_Stress_low_dose = (((LD_allp_18B_24h_Gamma$Ox_Stress_low_dose - Mean_LD_Gamma_24h)/Std_LD_Gamma_24h)*Std_ref_LD_Gamma_24h) + Mean_ref_LD_Gamma_24h


## For high dose irradiated samples
HD_18B= Samp_18B_10p
HD_18B$Ox_Stress_0=NULL
HD_18B$Ox_Stress_low_dose=NULL
#
### 4h 
HD_18B_4h = HD_18B %>% filter(HD_18B$Timepoint=="4h")
#
HD_18B_4h_Fe = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Fe")
HD_18B_4h_Ar = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Ar")
HD_18B_4h_Si = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Si")
HD_18B_4h_Gamma = HD_18B_4h %>% filter(HD_18B_4h$Radiation_type=="Gamma")
### 24h 
HD_18B_24h = HD_18B %>% filter(HD_18B$Timepoint=="24h")
#
HD_18B_24h_Fe = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Fe")
HD_18B_24h_Ar = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Ar")
HD_18B_24h_Si = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Si")
HD_18B_24h_Gamma = HD_18B_24h %>% filter(HD_18B_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_HD_Fe_4h = mean(NaRV.omit(HD_18B_4h_Fe$Ox_Stress_high_dose))
Mean_HD_Ar_4h = mean(NaRV.omit(HD_18B_4h_Ar$Ox_Stress_high_dose))
Mean_HD_Si_4h = mean(NaRV.omit(HD_18B_4h_Si$Ox_Stress_high_dose))
Mean_HD_Gamma_4h = mean(NaRV.omit(HD_18B_4h_Gamma$Ox_Stress_high_dose))
# 24h
Mean_HD_Fe_24h = mean(NaRV.omit(HD_18B_24h_Fe$Ox_Stress_high_dose))
Mean_HD_Ar_24h = mean(NaRV.omit(HD_18B_24h_Ar$Ox_Stress_high_dose))
Mean_HD_Si_24h = mean(NaRV.omit(HD_18B_24h_Si$Ox_Stress_high_dose))
Mean_HD_Gamma_24h = mean(NaRV.omit(HD_18B_24h_Gamma$Ox_Stress_high_dose))
####### sd
# 4h
Std_HD_Fe_4h = sd(NaRV.omit(HD_18B_4h_Fe$Ox_Stress_high_dose))
Std_HD_Ar_4h = sd(NaRV.omit(HD_18B_4h_Ar$Ox_Stress_high_dose))
Std_HD_Si_4h = sd(NaRV.omit(HD_18B_4h_Si$Ox_Stress_high_dose))
Std_HD_Gamma_4h = sd(NaRV.omit(HD_18B_4h_Gamma$Ox_Stress_high_dose))
# 24h
Std_HD_Fe_24h = sd(NaRV.omit(HD_18B_24h_Fe$Ox_Stress_high_dose))
Std_HD_Ar_24h = sd(NaRV.omit(HD_18B_24h_Ar$Ox_Stress_high_dose))
Std_HD_Si_24h = sd(NaRV.omit(HD_18B_24h_Si$Ox_Stress_high_dose))
Std_HD_Gamma_24h = sd(NaRV.omit(HD_18B_24h_Gamma$Ox_Stress_high_dose))
#
#
## z-score correction on all people from 18B
HD_allp_18B= Corrected_Ox_Stress_ %>% filter(Corrected_Ox_Stress_$Run_set %in% Run_18B)
HD_allp_18B$Ox_Stress_0=NULL
HD_allp_18B$Ox_Stress_low_dose=NULL
#
### 4h 
HD_allp_18B_4h = HD_allp_18B %>% filter(HD_allp_18B$Timepoint=="4h")
#
HD_allp_18B_4h_Fe = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Fe")
HD_allp_18B_4h_Ar = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Ar")
HD_allp_18B_4h_Si = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Si")
HD_allp_18B_4h_Gamma = HD_allp_18B_4h %>% filter(HD_allp_18B_4h$Radiation_type=="Gamma")
### 24h 
HD_allp_18B_24h = HD_allp_18B %>% filter(HD_allp_18B$Timepoint=="24h")
#
HD_allp_18B_24h_Fe = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Fe")
HD_allp_18B_24h_Ar = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Ar")
HD_allp_18B_24h_Si = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Si")
HD_allp_18B_24h_Gamma = HD_allp_18B_24h %>% filter(HD_allp_18B_24h$Radiation_type=="Gamma")

## z-score correction
# 4h
HD_allp_18B_4h_Fe$Ox_Stress_high_dose = (((HD_allp_18B_4h_Fe$Ox_Stress_high_dose - Mean_HD_Fe_4h)/Std_HD_Fe_4h)*Std_ref_HD_Fe_4h) + Mean_ref_HD_Fe_4h
HD_allp_18B_4h_Ar$Ox_Stress_high_dose = (((HD_allp_18B_4h_Ar$Ox_Stress_high_dose - Mean_HD_Ar_4h)/Std_HD_Ar_4h)*Std_ref_HD_Ar_4h) + Mean_ref_HD_Ar_4h
HD_allp_18B_4h_Si$Ox_Stress_high_dose = (((HD_allp_18B_4h_Si$Ox_Stress_high_dose - Mean_HD_Si_4h)/Std_HD_Si_4h)*Std_ref_HD_Si_4h) + Mean_ref_HD_Si_4h
HD_allp_18B_4h_Gamma$Ox_Stress_high_dose = (((HD_allp_18B_4h_Gamma$Ox_Stress_high_dose - Mean_HD_Gamma_4h)/Std_HD_Gamma_4h)*Std_ref_HD_Gamma_4h) + Mean_ref_HD_Gamma_4h
# 24h
HD_allp_18B_24h_Fe$Ox_Stress_high_dose = (((HD_allp_18B_24h_Fe$Ox_Stress_high_dose - Mean_HD_Fe_24h)/Std_HD_Fe_24h)*Std_ref_HD_Fe_24h) + Mean_ref_HD_Fe_24h
HD_allp_18B_24h_Ar$Ox_Stress_high_dose = (((HD_allp_18B_24h_Ar$Ox_Stress_high_dose - Mean_HD_Ar_24h)/Std_HD_Ar_24h)*Std_ref_HD_Ar_24h) + Mean_ref_HD_Ar_24h
HD_allp_18B_24h_Si$Ox_Stress_high_dose = (((HD_allp_18B_24h_Si$Ox_Stress_high_dose - Mean_HD_Si_24h)/Std_HD_Si_24h)*Std_ref_HD_Si_24h) + Mean_ref_HD_Si_24h
HD_allp_18B_24h_Gamma$Ox_Stress_high_dose = (((HD_allp_18B_24h_Gamma$Ox_Stress_high_dose - Mean_HD_Gamma_24h)/Std_HD_Gamma_24h)*Std_ref_HD_Gamma_24h) + Mean_ref_HD_Gamma_24h

############################## For controls and irradiated samples 19C we also calculate mean and std to perform the "z-score" normalization

############ For the 10 peoples that overlap ##########

Samp_19C_10p = OS_correct_19A_19C_10p %>% filter(OS_correct_19A_19C_10p$Run_set %in% Run_19C)

## For Controls 
Controls_19C= Samp_19C_10p
Controls_19C$Ox_Stress_low_dose=NULL
Controls_19C$Ox_Stress_high_dose=NULL
#
### 4h 
control_19C_4h = Controls_19C %>% filter(Controls_19C$Timepoint=="4h")
#
control_19C_4h_Fe = control_19C_4h %>% filter(control_19C_4h$Radiation_type=="Fe")
control_19C_4h_Ar = control_19C_4h %>% filter(control_19C_4h$Radiation_type=="Ar")
control_19C_4h_Si = control_19C_4h %>% filter(control_19C_4h$Radiation_type=="Si")
control_19C_4h_Gamma = control_19C_4h %>% filter(control_19C_4h$Radiation_type=="Gamma")
### 24h 
control_19C_24h = Controls_19C %>% filter(Controls_19C$Timepoint=="24h")
#
control_19C_24h_Fe = control_19C_24h %>% filter(control_19C_24h$Radiation_type=="Fe")
control_19C_24h_Ar = control_19C_24h %>% filter(control_19C_24h$Radiation_type=="Ar")
control_19C_24h_Si = control_19C_24h %>% filter(control_19C_24h$Radiation_type=="Si")
control_19C_24h_Gamma = control_19C_24h %>% filter(control_19C_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_Cont_Fe_4h = mean(NaRV.omit(control_19C_4h_Fe$Ox_Stress_0))
Mean_Cont_Ar_4h = mean(NaRV.omit(control_19C_4h_Ar$Ox_Stress_0))
Mean_Cont_Si_4h = mean(NaRV.omit(control_19C_4h_Si$Ox_Stress_0))
Mean_Cont_Gamma_4h = mean(NaRV.omit(control_19C_4h_Gamma$Ox_Stress_0))
# 24h
Mean_Cont_Fe_24h = mean(NaRV.omit(control_19C_24h_Fe$Ox_Stress_0))
Mean_Cont_Ar_24h = mean(NaRV.omit(control_19C_24h_Ar$Ox_Stress_0))
Mean_Cont_Si_24h = mean(NaRV.omit(control_19C_24h_Si$Ox_Stress_0))
Mean_Cont_Gamma_24h = mean(NaRV.omit(control_19C_24h_Gamma$Ox_Stress_0))
####### sd
# 4h
Std_Cont_Fe_4h = sd(NaRV.omit(control_19C_4h_Fe$Ox_Stress_0))
Std_Cont_Ar_4h = sd(NaRV.omit(control_19C_4h_Ar$Ox_Stress_0))
Std_Cont_Si_4h = sd(NaRV.omit(control_19C_4h_Si$Ox_Stress_0))
Std_Cont_Gamma_4h = sd(NaRV.omit(control_19C_4h_Gamma$Ox_Stress_0))
# 24h
Std_Cont_Fe_24h = sd(NaRV.omit(control_19C_24h_Fe$Ox_Stress_0))
Std_Cont_Ar_24h = sd(NaRV.omit(control_19C_24h_Ar$Ox_Stress_0))
Std_Cont_Si_24h = sd(NaRV.omit(control_19C_24h_Si$Ox_Stress_0))
Std_Cont_Gamma_24h = sd(NaRV.omit(control_19C_24h_Gamma$Ox_Stress_0))
#
## z-score correction on all people from 19C
Controls_allp_19C= Corrected_Ox_Stress_ %>% filter(Corrected_Ox_Stress_$Run_set %in% Run_19C)
Controls_allp_19C$Ox_Stress_low_dose=NULL
Controls_allp_19C$Ox_Stress_high_dose=NULL
#
### 4h 
control_allp_19C_4h = Controls_allp_19C %>% filter(Controls_allp_19C$Timepoint=="4h")
#
control_allp_19C_4h_Fe = control_allp_19C_4h %>% filter(control_allp_19C_4h$Radiation_type=="Fe")
control_allp_19C_4h_Ar = control_allp_19C_4h %>% filter(control_allp_19C_4h$Radiation_type=="Ar")
control_allp_19C_4h_Si = control_allp_19C_4h %>% filter(control_allp_19C_4h$Radiation_type=="Si")
control_allp_19C_4h_Gamma = control_allp_19C_4h %>% filter(control_allp_19C_4h$Radiation_type=="Gamma")
### 24h 
control_allp_19C_24h = Controls_allp_19C %>% filter(Controls_allp_19C$Timepoint=="24h")
#
control_allp_19C_24h_Fe = control_allp_19C_24h %>% filter(control_allp_19C_24h$Radiation_type=="Fe")
control_allp_19C_24h_Ar = control_allp_19C_24h %>% filter(control_allp_19C_24h$Radiation_type=="Ar")
control_allp_19C_24h_Si = control_allp_19C_24h %>% filter(control_allp_19C_24h$Radiation_type=="Si")
control_allp_19C_24h_Gamma = control_allp_19C_24h %>% filter(control_allp_19C_24h$Radiation_type=="Gamma")
## z-score correction
# 4h
control_allp_19C_4h_Fe$Ox_Stress_0 = (((control_allp_19C_4h_Fe$Ox_Stress_0 - Mean_Cont_Fe_4h)/Std_Cont_Fe_4h)*Std_ref_Cont_Fe_4h) + Mean_ref_Cont_Fe_4h
control_allp_19C_4h_Ar$Ox_Stress_0 = (((control_allp_19C_4h_Ar$Ox_Stress_0 - Mean_Cont_Ar_4h)/Std_Cont_Ar_4h)*Std_ref_Cont_Ar_4h) + Mean_ref_Cont_Ar_4h
control_allp_19C_4h_Si$Ox_Stress_0 = (((control_allp_19C_4h_Si$Ox_Stress_0 - Mean_Cont_Si_4h)/Std_Cont_Si_4h)*Std_ref_Cont_Si_4h) + Mean_ref_Cont_Si_4h
control_allp_19C_4h_Gamma$Ox_Stress_0 = (((control_allp_19C_4h_Gamma$Ox_Stress_0 - Mean_Cont_Gamma_4h)/Std_Cont_Gamma_4h)*Std_ref_Cont_Gamma_4h) + Mean_ref_Cont_Gamma_4h
# 24h
control_allp_19C_24h_Fe$Ox_Stress_0 = (((control_allp_19C_24h_Fe$Ox_Stress_0 - Mean_Cont_Fe_24h)/Std_Cont_Fe_24h)*Std_ref_Cont_Fe_24h) + Mean_ref_Cont_Fe_24h
control_allp_19C_24h_Ar$Ox_Stress_0 = (((control_allp_19C_24h_Ar$Ox_Stress_0 - Mean_Cont_Ar_24h)/Std_Cont_Ar_24h)*Std_ref_Cont_Ar_24h) + Mean_ref_Cont_Ar_24h
control_allp_19C_24h_Si$Ox_Stress_0 = (((control_allp_19C_24h_Si$Ox_Stress_0 - Mean_Cont_Si_24h)/Std_Cont_Si_24h)*Std_ref_Cont_Si_24h) + Mean_ref_Cont_Si_24h
control_allp_19C_24h_Gamma$Ox_Stress_0 = (((control_allp_19C_24h_Gamma$Ox_Stress_0 - Mean_Cont_Gamma_24h)/Std_Cont_Gamma_24h)*Std_ref_Cont_Gamma_24h) + Mean_ref_Cont_Gamma_24h
##
##
## For Low dose irradiated samples
LD_19C= Samp_19C_10p
LD_19C$Ox_Stress_0=NULL
LD_19C$Ox_Stress_high_dose=NULL
#
### 4h 
LD_19C_4h = LD_19C %>% filter(LD_19C$Timepoint=="4h")
#
LD_19C_4h_Fe = LD_19C_4h %>% filter(LD_19C_4h$Radiation_type=="Fe")
LD_19C_4h_Ar = LD_19C_4h %>% filter(LD_19C_4h$Radiation_type=="Ar")
LD_19C_4h_Si = LD_19C_4h %>% filter(LD_19C_4h$Radiation_type=="Si")
LD_19C_4h_Gamma = LD_19C_4h %>% filter(LD_19C_4h$Radiation_type=="Gamma")
### 24h 
LD_19C_24h = LD_19C %>% filter(LD_19C$Timepoint=="24h")
#
LD_19C_24h_Fe = LD_19C_24h %>% filter(LD_19C_24h$Radiation_type=="Fe")
LD_19C_24h_Ar = LD_19C_24h %>% filter(LD_19C_24h$Radiation_type=="Ar")
LD_19C_24h_Si = LD_19C_24h %>% filter(LD_19C_24h$Radiation_type=="Si")
LD_19C_24h_Gamma = LD_19C_24h %>% filter(LD_19C_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_LD_Fe_4h = mean(NaRV.omit(LD_19C_4h_Fe$Ox_Stress_low_dose))
Mean_LD_Ar_4h = mean(NaRV.omit(LD_19C_4h_Ar$Ox_Stress_low_dose))
Mean_LD_Si_4h = mean(NaRV.omit(LD_19C_4h_Si$Ox_Stress_low_dose))
Mean_LD_Gamma_4h = mean(NaRV.omit(LD_19C_4h_Gamma$Ox_Stress_low_dose))
# 24h
Mean_LD_Fe_24h = mean(NaRV.omit(LD_19C_24h_Fe$Ox_Stress_low_dose))
Mean_LD_Ar_24h = mean(NaRV.omit(LD_19C_24h_Ar$Ox_Stress_low_dose))
Mean_LD_Si_24h = mean(NaRV.omit(LD_19C_24h_Si$Ox_Stress_low_dose))
Mean_LD_Gamma_24h = mean(NaRV.omit(LD_19C_24h_Gamma$Ox_Stress_low_dose))
####### sd
# 4h
Std_LD_Fe_4h = sd(NaRV.omit(LD_19C_4h_Fe$Ox_Stress_low_dose))
Std_LD_Ar_4h = sd(NaRV.omit(LD_19C_4h_Ar$Ox_Stress_low_dose))
Std_LD_Si_4h = sd(NaRV.omit(LD_19C_4h_Si$Ox_Stress_low_dose))
Std_LD_Gamma_4h = sd(NaRV.omit(LD_19C_4h_Gamma$Ox_Stress_low_dose))
# 24h
Std_LD_Fe_24h = sd(NaRV.omit(LD_19C_24h_Fe$Ox_Stress_low_dose))
Std_LD_Ar_24h = sd(NaRV.omit(LD_19C_24h_Ar$Ox_Stress_low_dose))
Std_LD_Si_24h = sd(NaRV.omit(LD_19C_24h_Si$Ox_Stress_low_dose))
Std_LD_Gamma_24h = sd(NaRV.omit(LD_19C_24h_Gamma$Ox_Stress_low_dose))
#
#
## z-score correction on all people from 19C
LD_allp_19C= Corrected_Ox_Stress_ %>% filter(Corrected_Ox_Stress_$Run_set %in% Run_19C)
LD_allp_19C$Ox_Stress_0=NULL
LD_allp_19C$Ox_Stress_high_dose=NULL
#
### 4h 
LD_allp_19C_4h = LD_allp_19C %>% filter(LD_allp_19C$Timepoint=="4h")
#
LD_allp_19C_4h_Fe = LD_allp_19C_4h %>% filter(LD_allp_19C_4h$Radiation_type=="Fe")
LD_allp_19C_4h_Ar = LD_allp_19C_4h %>% filter(LD_allp_19C_4h$Radiation_type=="Ar")
LD_allp_19C_4h_Si = LD_allp_19C_4h %>% filter(LD_allp_19C_4h$Radiation_type=="Si")
LD_allp_19C_4h_Gamma = LD_allp_19C_4h %>% filter(LD_allp_19C_4h$Radiation_type=="Gamma")
### 24h 
LD_allp_19C_24h = LD_allp_19C %>% filter(LD_allp_19C$Timepoint=="24h")
#
LD_allp_19C_24h_Fe = LD_allp_19C_24h %>% filter(LD_allp_19C_24h$Radiation_type=="Fe")
LD_allp_19C_24h_Ar = LD_allp_19C_24h %>% filter(LD_allp_19C_24h$Radiation_type=="Ar")
LD_allp_19C_24h_Si = LD_allp_19C_24h %>% filter(LD_allp_19C_24h$Radiation_type=="Si")
LD_allp_19C_24h_Gamma = LD_allp_19C_24h %>% filter(LD_allp_19C_24h$Radiation_type=="Gamma")

## z-score correction
# 4h
LD_allp_19C_4h_Fe$Ox_Stress_low_dose = (((LD_allp_19C_4h_Fe$Ox_Stress_low_dose - Mean_LD_Fe_4h)/Std_LD_Fe_4h)*Std_ref_LD_Fe_4h) + Mean_ref_LD_Fe_4h
LD_allp_19C_4h_Ar$Ox_Stress_low_dose = (((LD_allp_19C_4h_Ar$Ox_Stress_low_dose - Mean_LD_Ar_4h)/Std_LD_Ar_4h)*Std_ref_LD_Ar_4h) + Mean_ref_LD_Ar_4h
LD_allp_19C_4h_Si$Ox_Stress_low_dose = (((LD_allp_19C_4h_Si$Ox_Stress_low_dose - Mean_LD_Si_4h)/Std_LD_Si_4h)*Std_ref_LD_Si_4h) + Mean_ref_LD_Si_4h
LD_allp_19C_4h_Gamma$Ox_Stress_low_dose = (((LD_allp_19C_4h_Gamma$Ox_Stress_low_dose - Mean_LD_Gamma_4h)/Std_LD_Gamma_4h)*Std_ref_LD_Gamma_4h) + Mean_ref_LD_Gamma_4h
# 24h
LD_allp_19C_24h_Fe$Ox_Stress_low_dose = (((LD_allp_19C_24h_Fe$Ox_Stress_low_dose - Mean_LD_Fe_24h)/Std_LD_Fe_24h)*Std_ref_LD_Fe_24h) + Mean_ref_LD_Fe_24h
LD_allp_19C_24h_Ar$Ox_Stress_low_dose = (((LD_allp_19C_24h_Ar$Ox_Stress_low_dose - Mean_LD_Ar_24h)/Std_LD_Ar_24h)*Std_ref_LD_Ar_24h) + Mean_ref_LD_Ar_24h
LD_allp_19C_24h_Si$Ox_Stress_low_dose = (((LD_allp_19C_24h_Si$Ox_Stress_low_dose - Mean_LD_Si_24h)/Std_LD_Si_24h)*Std_ref_LD_Si_24h) + Mean_ref_LD_Si_24h
LD_allp_19C_24h_Gamma$Ox_Stress_low_dose = (((LD_allp_19C_24h_Gamma$Ox_Stress_low_dose - Mean_LD_Gamma_24h)/Std_LD_Gamma_24h)*Std_ref_LD_Gamma_24h) + Mean_ref_LD_Gamma_24h


## For high dose irradiated samples
HD_19C= Samp_19C_10p
HD_19C$Ox_Stress_0=NULL
HD_19C$Ox_Stress_low_dose=NULL
#
### 4h 
HD_19C_4h = HD_19C %>% filter(HD_19C$Timepoint=="4h")
#
HD_19C_4h_Fe = HD_19C_4h %>% filter(HD_19C_4h$Radiation_type=="Fe")
HD_19C_4h_Ar = HD_19C_4h %>% filter(HD_19C_4h$Radiation_type=="Ar")
HD_19C_4h_Si = HD_19C_4h %>% filter(HD_19C_4h$Radiation_type=="Si")
HD_19C_4h_Gamma = HD_19C_4h %>% filter(HD_19C_4h$Radiation_type=="Gamma")
### 24h 
HD_19C_24h = HD_19C %>% filter(HD_19C$Timepoint=="24h")
#
HD_19C_24h_Fe = HD_19C_24h %>% filter(HD_19C_24h$Radiation_type=="Fe")
HD_19C_24h_Ar = HD_19C_24h %>% filter(HD_19C_24h$Radiation_type=="Ar")
HD_19C_24h_Si = HD_19C_24h %>% filter(HD_19C_24h$Radiation_type=="Si")
HD_19C_24h_Gamma = HD_19C_24h %>% filter(HD_19C_24h$Radiation_type=="Gamma")
### For each conditions (radiation type/time point) calculate mean and std
####### Mean
# 4h
Mean_HD_Fe_4h = mean(NaRV.omit(HD_19C_4h_Fe$Ox_Stress_high_dose))
Mean_HD_Ar_4h = mean(NaRV.omit(HD_19C_4h_Ar$Ox_Stress_high_dose))
Mean_HD_Si_4h = mean(NaRV.omit(HD_19C_4h_Si$Ox_Stress_high_dose))
Mean_HD_Gamma_4h = mean(NaRV.omit(HD_19C_4h_Gamma$Ox_Stress_high_dose))
# 24h
Mean_HD_Fe_24h = mean(NaRV.omit(HD_19C_24h_Fe$Ox_Stress_high_dose))
Mean_HD_Ar_24h = mean(NaRV.omit(HD_19C_24h_Ar$Ox_Stress_high_dose))
Mean_HD_Si_24h = mean(NaRV.omit(HD_19C_24h_Si$Ox_Stress_high_dose))
Mean_HD_Gamma_24h = mean(NaRV.omit(HD_19C_24h_Gamma$Ox_Stress_high_dose))
####### sd
# 4h
Std_HD_Fe_4h = sd(NaRV.omit(HD_19C_4h_Fe$Ox_Stress_high_dose))
Std_HD_Ar_4h = sd(NaRV.omit(HD_19C_4h_Ar$Ox_Stress_high_dose))
Std_HD_Si_4h = sd(NaRV.omit(HD_19C_4h_Si$Ox_Stress_high_dose))
Std_HD_Gamma_4h = sd(NaRV.omit(HD_19C_4h_Gamma$Ox_Stress_high_dose))
# 24h
Std_HD_Fe_24h = sd(NaRV.omit(HD_19C_24h_Fe$Ox_Stress_high_dose))
Std_HD_Ar_24h = sd(NaRV.omit(HD_19C_24h_Ar$Ox_Stress_high_dose))
Std_HD_Si_24h = sd(NaRV.omit(HD_19C_24h_Si$Ox_Stress_high_dose))
Std_HD_Gamma_24h = sd(NaRV.omit(HD_19C_24h_Gamma$Ox_Stress_high_dose))
#
#
## z-score correction on all people from 19C
HD_allp_19C= Corrected_Ox_Stress_ %>% filter(Corrected_Ox_Stress_$Run_set %in% Run_19C)
HD_allp_19C$Ox_Stress_0=NULL
HD_allp_19C$Ox_Stress_low_dose=NULL
#
### 4h 
HD_allp_19C_4h = HD_allp_19C %>% filter(HD_allp_19C$Timepoint=="4h")
#
HD_allp_19C_4h_Fe = HD_allp_19C_4h %>% filter(HD_allp_19C_4h$Radiation_type=="Fe")
HD_allp_19C_4h_Ar = HD_allp_19C_4h %>% filter(HD_allp_19C_4h$Radiation_type=="Ar")
HD_allp_19C_4h_Si = HD_allp_19C_4h %>% filter(HD_allp_19C_4h$Radiation_type=="Si")
HD_allp_19C_4h_Gamma = HD_allp_19C_4h %>% filter(HD_allp_19C_4h$Radiation_type=="Gamma")
### 24h 
HD_allp_19C_24h = HD_allp_19C %>% filter(HD_allp_19C$Timepoint=="24h")
#
HD_allp_19C_24h_Fe = HD_allp_19C_24h %>% filter(HD_allp_19C_24h$Radiation_type=="Fe")
HD_allp_19C_24h_Ar = HD_allp_19C_24h %>% filter(HD_allp_19C_24h$Radiation_type=="Ar")
HD_allp_19C_24h_Si = HD_allp_19C_24h %>% filter(HD_allp_19C_24h$Radiation_type=="Si")
HD_allp_19C_24h_Gamma = HD_allp_19C_24h %>% filter(HD_allp_19C_24h$Radiation_type=="Gamma")

## z-score correction
# 4h
HD_allp_19C_4h_Fe$Ox_Stress_high_dose = (((HD_allp_19C_4h_Fe$Ox_Stress_high_dose - Mean_HD_Fe_4h)/Std_HD_Fe_4h)*Std_ref_HD_Fe_4h) + Mean_ref_HD_Fe_4h
HD_allp_19C_4h_Ar$Ox_Stress_high_dose = (((HD_allp_19C_4h_Ar$Ox_Stress_high_dose - Mean_HD_Ar_4h)/Std_HD_Ar_4h)*Std_ref_HD_Ar_4h) + Mean_ref_HD_Ar_4h
HD_allp_19C_4h_Si$Ox_Stress_high_dose = (((HD_allp_19C_4h_Si$Ox_Stress_high_dose - Mean_HD_Si_4h)/Std_HD_Si_4h)*Std_ref_HD_Si_4h) + Mean_ref_HD_Si_4h
HD_allp_19C_4h_Gamma$Ox_Stress_high_dose = (((HD_allp_19C_4h_Gamma$Ox_Stress_high_dose - Mean_HD_Gamma_4h)/Std_HD_Gamma_4h)*Std_ref_HD_Gamma_4h) + Mean_ref_HD_Gamma_4h
# 24h
HD_allp_19C_24h_Fe$Ox_Stress_high_dose = (((HD_allp_19C_24h_Fe$Ox_Stress_high_dose - Mean_HD_Fe_24h)/Std_HD_Fe_24h)*Std_ref_HD_Fe_24h) + Mean_ref_HD_Fe_24h
HD_allp_19C_24h_Ar$Ox_Stress_high_dose = (((HD_allp_19C_24h_Ar$Ox_Stress_high_dose - Mean_HD_Ar_24h)/Std_HD_Ar_24h)*Std_ref_HD_Ar_24h) + Mean_ref_HD_Ar_24h
HD_allp_19C_24h_Si$Ox_Stress_high_dose = (((HD_allp_19C_24h_Si$Ox_Stress_high_dose - Mean_HD_Si_24h)/Std_HD_Si_24h)*Std_ref_HD_Si_24h) + Mean_ref_HD_Si_24h
HD_allp_19C_24h_Gamma$Ox_Stress_high_dose = (((HD_allp_19C_24h_Gamma$Ox_Stress_high_dose - Mean_HD_Gamma_24h)/Std_HD_Gamma_24h)*Std_ref_HD_Gamma_24h) + Mean_ref_HD_Gamma_24h

### Now we regroup everything
## regroup 18B
Cont_18B_All_rad= bind_rows(control_allp_18B_4h_Fe,  control_allp_18B_24h_Fe, 
                            control_allp_18B_4h_Ar,  control_allp_18B_24h_Ar,
                            control_allp_18B_4h_Si,  control_allp_18B_24h_Si,
                            control_allp_18B_4h_Gamma,  control_allp_18B_24h_Gamma)
colnames(Cont_18B_All_rad)[colnames(Cont_18B_All_rad)=="Ox_Stress_0"]<- "OS"
Cont_18B_All_rad$Dose_relative="0 Gy control"


LD_18B_All_rad= bind_rows(LD_allp_18B_4h_Fe,  LD_allp_18B_24h_Fe, 
                          LD_allp_18B_4h_Ar,  LD_allp_18B_24h_Ar,
                          LD_allp_18B_4h_Si,  LD_allp_18B_24h_Si,
                          LD_allp_18B_4h_Gamma,  LD_allp_18B_24h_Gamma)
colnames(LD_18B_All_rad)[colnames(LD_18B_All_rad)=="Ox_Stress_low_dose"]<- "OS"
LD_18B_All_rad$Dose_relative = "Low dose"


HD_18B_All_rad= bind_rows(HD_allp_18B_4h_Fe,  HD_allp_18B_24h_Fe, 
                          HD_allp_18B_4h_Ar,  HD_allp_18B_24h_Ar,
                          HD_allp_18B_4h_Si,  HD_allp_18B_24h_Si,
                          HD_allp_18B_4h_Gamma,  HD_allp_18B_24h_Gamma)
colnames(HD_18B_All_rad)[colnames(HD_18B_All_rad)=="Ox_Stress_high_dose"]<- "OS"
HD_18B_All_rad$Dose_relative = "High dose"

## regroup 19C
Cont_19C_All_rad= bind_rows(control_allp_19C_4h_Fe,  control_allp_19C_24h_Fe, 
                            control_allp_19C_4h_Ar,  control_allp_19C_24h_Ar,
                            control_allp_19C_4h_Si,  control_allp_19C_24h_Si,
                            control_allp_19C_4h_Gamma,  control_allp_19C_24h_Gamma)
colnames(Cont_19C_All_rad)[colnames(Cont_19C_All_rad)=="Ox_Stress_0"]<- "OS"
Cont_19C_All_rad$Dose_relative="0 Gy control"

LD_19C_All_rad= bind_rows(LD_allp_19C_4h_Fe,  LD_allp_19C_24h_Fe, 
                          LD_allp_19C_4h_Ar,  LD_allp_19C_24h_Ar,
                          LD_allp_19C_4h_Si,  LD_allp_19C_24h_Si,
                          LD_allp_19C_4h_Gamma,  LD_allp_19C_24h_Gamma)
colnames(LD_19C_All_rad)[colnames(LD_19C_All_rad)=="Ox_Stress_low_dose"]<- "OS"
LD_19C_All_rad$Dose_relative="Low dose"

HD_19C_All_rad= bind_rows(HD_allp_19C_4h_Fe,  HD_allp_19C_24h_Fe, 
                          HD_allp_19C_4h_Ar,  HD_allp_19C_24h_Ar,
                          HD_allp_19C_4h_Si,  HD_allp_19C_24h_Si,
                          HD_allp_19C_4h_Gamma,  HD_allp_19C_24h_Gamma)
colnames(HD_19C_All_rad)[colnames(HD_19C_All_rad)=="Ox_Stress_high_dose"]<- "OS"
HD_19C_All_rad$Dose_relative="High dose"


#19A was used as reference: data were not modified. We format the table to fit the same structure as 18B and 19C 
Samp_19A_allp_cont = Corrected_Cell_Death %>% filter(Corrected_Cell_Death$Run_set %in% Run_19A)
Samp_19A_allp_cont$Dead_Cells_low_dose = NULL
Samp_19A_allp_cont$Dead_Cells_high_dose = NULL
colnames(Samp_19A_allp_cont)[colnames(Samp_19A_allp_cont)=="Ox_Stress_0"]<- "OS"
Samp_19A_allp_cont$Dose_relative="0 Gy control"


Samp_19A_allp_LD = Corrected_Cell_Death %>% filter(Corrected_Cell_Death$Run_set %in% Run_19A)
Samp_19A_allp_LD$Dead_Cells_high_dose = NULL
Samp_19A_allp_LD$Dead_Cells_0 = NULL
colnames(Samp_19A_allp_LD)[colnames(Samp_19A_allp_LD)=="Ox_Stress_low_dose"]<- "OS"
Samp_19A_allp_LD$Dose_relative="Low dose"


Samp_19A_allp_HD = Corrected_Cell_Death %>% filter(Corrected_Cell_Death$Run_set %in% Run_19A)
Samp_19A_allp_HD$Dead_Cells_low_dose = NULL
Samp_19A_allp_HD$Dead_Cells_0 = NULL
colnames(Samp_19A_allp_HD)[colnames(Samp_19A_allp_HD)=="Ox_Stress_high_dose"]<- "OS"
Samp_19A_allp_HD$Dose_relative="High dose"

#### Regroup all runs and sets
All_Corrected_OS = bind_rows(Cont_18B_All_rad, LD_18B_All_rad, HD_18B_All_rad,
                             Cont_19C_All_rad, LD_19C_All_rad, HD_19C_All_rad,
                             Samp_19A_allp_cont, Samp_19A_allp_LD, Samp_19A_allp_HD)

colnames(All_Corrected_OS)[colnames(All_Corrected_OS)=="OS"]<- "Ox_Stress"

#### The correction may generate negative value => we fix those negative value to 0 
All_Corrected_OS$Ox_Stress[All_Corrected_OS$Ox_Stress < 0] <-  0 

```




```{r}
##################################################################################################
#######################  Corrected data: Table formatting + Variable Summary #####################
##################################################################################################

#All_Corrected_DD : 1 column with DNA damage data completed with covariates columns for Timepoint and radiation
#All_Corrected_DD_and_Baseline:  1 column with DNA damage data and baselines completed with covariates columns for Timepoint and radiation
#All_Corrected_CD:  1 column with cell death data completed with covariates columns for Timepoint and radiation
#All_Corrected_OS:  1 column with oxidative stress data completed with covariates columns for Timepoint and radiation


##################################################################################################
## Below, new table with one column for each conditions phenotype_timepoint_dose_Radiation

### Baseline 
Baseline_DNA_damage = Corrected_baselines[,grepl("Sample_ID|avg_nfoci", colnames(Corrected_baselines))]
# we average by duplicate 
Baseline_DNA_damage = Baseline_DNA_damage %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(Baseline_DNA_damage)[colnames(Baseline_DNA_damage)=="avg_nfoci"]="baseline_nfoci"
# baseline + metadata 
Baseline_DNA_damage_meta=merge(Baseline_DNA_damage, well_meta, by="Sample_ID", all.x=TRUE)
Baseline_DNA_damage_meta$Run_set_well=NULL
Baseline_DNA_damage_meta$Run_set=NULL

### DNA Damage
Save_metadata_DD = All_Corrected_DD[, grepl("Sample_ID|Age|Gender|BMI|Run_set", colnames(All_Corrected_DD))]
Save_metadata_DD=unique(Save_metadata_DD)
#
Data_only = All_Corrected_DD[, grepl("Sample_ID|avg_nfoci|Dose_relative|Timepoint|Radiation_type", colnames(All_Corrected_DD))]
#
#
### Fe 
Data_only_rad = Data_only %>% filter(Data_only$Radiation_type =="Fe")
#
DD_4h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "4h")
DD_4h_Controls_tab = DD_4h_tab %>% filter(DD_4h_tab$Dose_relative == "0 Gy Controls")
DD_4h_Controls_tab <- DD_4h_Controls_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_4h_Controls_tab)[colnames(DD_4h_Controls_tab)=="avg_nfoci"]="avg_nfoci_Fe_0Gy_4h"
#
DD_4h_low_tab =DD_4h_tab %>% filter(DD_4h_tab$Dose_relative == "Low dose")
DD_4h_low_tab <- DD_4h_low_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_4h_low_tab)[colnames(DD_4h_low_tab)=="avg_nfoci"]="avg_nfoci_Fe_LowDose_4h"
#
DD_4h_high_tab = DD_4h_tab %>% filter(DD_4h_tab$Dose_relative == "High dose")
DD_4h_high_tab <- DD_4h_high_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_4h_high_tab)[colnames(DD_4h_high_tab)=="avg_nfoci"]="avg_nfoci_Fe_HighDose_4h"
#
Fe_4h=merge(DD_4h_Controls_tab, DD_4h_low_tab, by="Sample_ID", all=TRUE)
Fe_4h=merge(Fe_4h, DD_4h_high_tab, by="Sample_ID", all=TRUE)
#
DD_24h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "24h")
DD_24h_Controls_tab = DD_24h_tab %>% filter(DD_24h_tab$Dose_relative == "0 Gy Controls")
DD_24h_Controls_tab <- DD_24h_Controls_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_24h_Controls_tab)[colnames(DD_24h_Controls_tab)=="avg_nfoci"]="avg_nfoci_Fe_0Gy_24h"
#
DD_24h_low_tab =DD_24h_tab %>% filter(DD_24h_tab$Dose_relative == "Low dose")
DD_24h_low_tab <- DD_24h_low_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_24h_low_tab)[colnames(DD_24h_low_tab)=="avg_nfoci"]="avg_nfoci_Fe_LowDose_24h"
#
DD_24h_high_tab = DD_24h_tab %>% filter(DD_24h_tab$Dose_relative == "High dose")
DD_24h_high_tab <- DD_24h_high_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_24h_high_tab)[colnames(DD_24h_high_tab)=="avg_nfoci"]="avg_nfoci_Fe_HighDose_24h"
#
Fe_24h=merge(DD_24h_Controls_tab, DD_24h_low_tab, by="Sample_ID", all=TRUE)
Fe_24h=merge(Fe_24h, DD_24h_high_tab, by="Sample_ID", all=TRUE)
All_Fe=merge(Fe_4h, Fe_24h, by="Sample_ID", all=TRUE)
All_Fe=unique(All_Fe)

### Ar 
Data_only_rad = Data_only %>% filter(Data_only$Radiation_type =="Ar")
#
DD_4h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "4h")
DD_4h_Controls_tab = DD_4h_tab %>% filter(DD_4h_tab$Dose_relative == "0 Gy Controls")
DD_4h_Controls_tab <- DD_4h_Controls_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_4h_Controls_tab)[colnames(DD_4h_Controls_tab)=="avg_nfoci"]="avg_nfoci_Ar_0Gy_4h"
#
DD_4h_low_tab =DD_4h_tab %>% filter(DD_4h_tab$Dose_relative == "Low dose")
DD_4h_low_tab <- DD_4h_low_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_4h_low_tab)[colnames(DD_4h_low_tab)=="avg_nfoci"]="avg_nfoci_Ar_LowDose_4h"
#
DD_4h_high_tab = DD_4h_tab %>% filter(DD_4h_tab$Dose_relative == "High dose")
DD_4h_high_tab <- DD_4h_high_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_4h_high_tab)[colnames(DD_4h_high_tab)=="avg_nfoci"]="avg_nfoci_Ar_HighDose_4h"
#
Ar_4h=merge(DD_4h_Controls_tab, DD_4h_low_tab, by="Sample_ID", all=TRUE)
Ar_4h=merge(Ar_4h, DD_4h_high_tab, by="Sample_ID", all=TRUE)
#
DD_24h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "24h")
DD_24h_Controls_tab = DD_24h_tab %>% filter(DD_24h_tab$Dose_relative == "0 Gy Controls")
DD_24h_Controls_tab <- DD_24h_Controls_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_24h_Controls_tab)[colnames(DD_24h_Controls_tab)=="avg_nfoci"]="avg_nfoci_Ar_0Gy_24h"
#
DD_24h_low_tab =DD_24h_tab %>% filter(DD_24h_tab$Dose_relative == "Low dose")
DD_24h_low_tab <- DD_24h_low_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_24h_low_tab)[colnames(DD_24h_low_tab)=="avg_nfoci"]="avg_nfoci_Ar_LowDose_24h"
#
DD_24h_high_tab = DD_24h_tab %>% filter(DD_24h_tab$Dose_relative == "High dose")
DD_24h_high_tab <- DD_24h_high_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_24h_high_tab)[colnames(DD_24h_high_tab)=="avg_nfoci"]="avg_nfoci_Ar_HighDose_24h"
#
Ar_24h=merge(DD_24h_Controls_tab, DD_24h_low_tab, by="Sample_ID", all=TRUE)
Ar_24h=merge(Ar_24h, DD_24h_high_tab, by="Sample_ID", all=TRUE)
All_Ar=merge(Ar_4h, Ar_24h, by="Sample_ID", all=TRUE)
All_Ar=unique(All_Ar)

### Si 
Data_only_rad = Data_only %>% filter(Data_only$Radiation_type =="Si")
#
DD_4h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "4h")
DD_4h_Controls_tab = DD_4h_tab %>% filter(DD_4h_tab$Dose_relative == "0 Gy Controls")
DD_4h_Controls_tab <- DD_4h_Controls_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_4h_Controls_tab)[colnames(DD_4h_Controls_tab)=="avg_nfoci"]="avg_nfoci_Si_0Gy_4h"
#
DD_4h_low_tab =DD_4h_tab %>% filter(DD_4h_tab$Dose_relative == "Low dose")
DD_4h_low_tab <- DD_4h_low_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_4h_low_tab)[colnames(DD_4h_low_tab)=="avg_nfoci"]="avg_nfoci_Si_LowDose_4h"
#
DD_4h_high_tab = DD_4h_tab %>% filter(DD_4h_tab$Dose_relative == "High dose")
DD_4h_high_tab <- DD_4h_high_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_4h_high_tab)[colnames(DD_4h_high_tab)=="avg_nfoci"]="avg_nfoci_Si_HighDose_4h"
#
Si_4h=merge(DD_4h_Controls_tab, DD_4h_low_tab, by="Sample_ID", all=TRUE)
Si_4h=merge(Si_4h, DD_4h_high_tab, by="Sample_ID", all=TRUE)
#
DD_24h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "24h")
DD_24h_Controls_tab = DD_24h_tab %>% filter(DD_24h_tab$Dose_relative == "0 Gy Controls")
DD_24h_Controls_tab <- DD_24h_Controls_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_24h_Controls_tab)[colnames(DD_24h_Controls_tab)=="avg_nfoci"]="avg_nfoci_Si_0Gy_24h"
#
DD_24h_low_tab =DD_24h_tab %>% filter(DD_24h_tab$Dose_relative == "Low dose")
DD_24h_low_tab <- DD_24h_low_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_24h_low_tab)[colnames(DD_24h_low_tab)=="avg_nfoci"]="avg_nfoci_Si_LowDose_24h"
#
DD_24h_high_tab = DD_24h_tab %>% filter(DD_24h_tab$Dose_relative == "High dose")
DD_24h_high_tab <- DD_24h_high_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_24h_high_tab)[colnames(DD_24h_high_tab)=="avg_nfoci"]="avg_nfoci_Si_HighDose_24h"
#
Si_24h=merge(DD_24h_Controls_tab, DD_24h_low_tab, by="Sample_ID", all=TRUE)
Si_24h=merge(Si_24h, DD_24h_high_tab, by="Sample_ID", all=TRUE)
All_Si=merge(Si_4h, Si_24h, by="Sample_ID", all=TRUE)
All_Si=unique(All_Si)

### Gamma 
Data_only_rad = Data_only %>% filter(Data_only$Radiation_type =="Gamma")
#
DD_4h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "4h")
DD_4h_Controls_tab = DD_4h_tab %>% filter(DD_4h_tab$Dose_relative == "0 Gy Controls")
DD_4h_Controls_tab <- DD_4h_Controls_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_4h_Controls_tab)[colnames(DD_4h_Controls_tab)=="avg_nfoci"]="avg_nfoci_Gamma_0Gy_4h"
#
DD_4h_low_tab =DD_4h_tab %>% filter(DD_4h_tab$Dose_relative == "Low dose")
DD_4h_low_tab <- DD_4h_low_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_4h_low_tab)[colnames(DD_4h_low_tab)=="avg_nfoci"]="avg_nfoci_Gamma_LowDose_4h"
#
DD_4h_high_tab = DD_4h_tab %>% filter(DD_4h_tab$Dose_relative == "High dose")
DD_4h_high_tab <- DD_4h_high_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_4h_high_tab)[colnames(DD_4h_high_tab)=="avg_nfoci"]="avg_nfoci_Gamma_HighDose_4h"
#
Gamma_4h=merge(DD_4h_Controls_tab, DD_4h_low_tab, by="Sample_ID", all=TRUE)
Gamma_4h=merge(Gamma_4h, DD_4h_high_tab, by="Sample_ID", all=TRUE)
#
DD_24h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "24h")
DD_24h_Controls_tab = DD_24h_tab %>% filter(DD_24h_tab$Dose_relative == "0 Gy Controls")
DD_24h_Controls_tab <- DD_24h_Controls_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_24h_Controls_tab)[colnames(DD_24h_Controls_tab)=="avg_nfoci"]="avg_nfoci_Gamma_0Gy_24h"
#
DD_24h_low_tab =DD_24h_tab %>% filter(DD_24h_tab$Dose_relative == "Low dose")
DD_24h_low_tab <- DD_24h_low_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_24h_low_tab)[colnames(DD_24h_low_tab)=="avg_nfoci"]="avg_nfoci_Gamma_LowDose_24h"
#
DD_24h_high_tab = DD_24h_tab %>% filter(DD_24h_tab$Dose_relative == "High dose")
DD_24h_high_tab <- DD_24h_high_tab %>% group_by(Sample_ID) %>% summarize(avg_nfoci = mean(avg_nfoci))
colnames(DD_24h_high_tab)[colnames(DD_24h_high_tab)=="avg_nfoci"]="avg_nfoci_Gamma_HighDose_24h"
#
Gamma_24h=merge(DD_24h_Controls_tab, DD_24h_low_tab, by="Sample_ID", all=TRUE)
Gamma_24h=merge(Gamma_24h, DD_24h_high_tab, by="Sample_ID", all=TRUE)
All_Gamma=merge(Gamma_4h, Gamma_24h, by="Sample_ID", all=TRUE)
All_Gamma=unique(All_Gamma)
##
##
All_rad=merge(All_Fe, All_Ar, by="Sample_ID", all=TRUE)
All_rad=merge(All_rad, All_Si, by="Sample_ID", all=TRUE)
All_rad=merge(All_rad, All_Gamma, by="Sample_ID", all=TRUE)
#
DD_Cdts=merge(All_rad, Save_metadata_DD, by="Sample_ID", all.x=TRUE)



### Cell death 
Save_metadata_CD = All_Corrected_CD[, grepl("Sample_ID|Age|Gender|BMI|Run_set", colnames(All_Corrected_CD))]
Save_metadata_CD=unique(Save_metadata_CD)
#
Data_only = All_Corrected_CD[, grepl("Sample_ID|Dead_|Dose_relative|Timepoint|Radiation_type", colnames(All_Corrected_CD))]
#
#
### Fe 
Data_only_rad = Data_only %>% filter(Data_only$Radiation_type =="Fe")
#
CD_4h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "4h")
CD_4h_Controls_tab = CD_4h_tab %>% filter(CD_4h_tab$Dose_relative == "0 Gy Controls")
CD_4h_Controls_tab <- CD_4h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_4h_Controls_tab)[colnames(CD_4h_Controls_tab)=="Dead_Cells"]="Dead_Cells_Fe_0Gy_4h"
#
CD_4h_low_tab =CD_4h_tab %>% filter(CD_4h_tab$Dose_relative == "Low dose")
CD_4h_low_tab <- CD_4h_low_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_4h_low_tab)[colnames(CD_4h_low_tab)=="Dead_Cells"]="Dead_Cells_Fe_LowDose_4h"
#
CD_4h_high_tab = CD_4h_tab %>% filter(CD_4h_tab$Dose_relative == "High dose")
CD_4h_high_tab <- CD_4h_high_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_4h_high_tab)[colnames(CD_4h_high_tab)=="Dead_Cells"]="Dead_Cells_Fe_HighDose_4h"
#
Fe_4h=merge(CD_4h_Controls_tab, CD_4h_low_tab, by="Sample_ID", all=TRUE)
Fe_4h=merge(Fe_4h, CD_4h_high_tab, by="Sample_ID", all=TRUE)
#
CD_24h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "24h")
CD_24h_Controls_tab = CD_24h_tab %>% filter(CD_24h_tab$Dose_relative == "0 Gy Controls")
CD_24h_Controls_tab <- CD_24h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_24h_Controls_tab)[colnames(CD_24h_Controls_tab)=="Dead_Cells"]="Dead_Cells_Fe_0Gy_24h"
#
CD_24h_low_tab =CD_24h_tab %>% filter(CD_24h_tab$Dose_relative == "Low dose")
CD_24h_low_tab <- CD_24h_low_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_24h_low_tab)[colnames(CD_24h_low_tab)=="Dead_Cells"]="Dead_Cells_Fe_LowDose_24h"
#
CD_24h_high_tab = CD_24h_tab %>% filter(CD_24h_tab$Dose_relative == "High dose")
CD_24h_high_tab <- CD_24h_high_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_24h_high_tab)[colnames(CD_24h_high_tab)=="Dead_Cells"]="Dead_Cells_Fe_HighDose_24h"
#
Fe_24h=merge(CD_24h_Controls_tab, CD_24h_low_tab, by="Sample_ID", all=TRUE)
Fe_24h=merge(Fe_24h, CD_24h_high_tab, by="Sample_ID", all=TRUE)
All_Fe=merge(Fe_4h, Fe_24h, by="Sample_ID", all=TRUE)
All_Fe=unique(All_Fe)
#
### Ar
Data_only_rad = Data_only %>% filter(Data_only$Radiation_type =="Ar")
#
CD_4h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "4h")
CD_4h_Controls_tab = CD_4h_tab %>% filter(CD_4h_tab$Dose_relative == "0 Gy Controls")
CD_4h_Controls_tab <- CD_4h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_4h_Controls_tab)[colnames(CD_4h_Controls_tab)=="Dead_Cells"]="Dead_Cells_Ar_0Gy_4h"
#
CD_4h_low_tab =CD_4h_tab %>% filter(CD_4h_tab$Dose_relative == "Low dose")
CD_4h_low_tab <- CD_4h_low_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_4h_low_tab)[colnames(CD_4h_low_tab)=="Dead_Cells"]="Dead_Cells_Ar_LowDose_4h"
#
CD_4h_high_tab = CD_4h_tab %>% filter(CD_4h_tab$Dose_relative == "High dose")
CD_4h_high_tab <- CD_4h_high_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_4h_high_tab)[colnames(CD_4h_high_tab)=="Dead_Cells"]="Dead_Cells_Ar_HighDose_4h"
#
Ar_4h=merge(CD_4h_Controls_tab, CD_4h_low_tab, by="Sample_ID", all=TRUE)
Ar_4h=merge(Ar_4h, CD_4h_high_tab, by="Sample_ID", all=TRUE)
#
CD_24h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "24h")
CD_24h_Controls_tab = CD_24h_tab %>% filter(CD_24h_tab$Dose_relative == "0 Gy Controls")
CD_24h_Controls_tab <- CD_24h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_24h_Controls_tab)[colnames(CD_24h_Controls_tab)=="Dead_Cells"]="Dead_Cells_Ar_0Gy_24h"
#
CD_24h_low_tab =CD_24h_tab %>% filter(CD_24h_tab$Dose_relative == "Low dose")
CD_24h_low_tab <- CD_24h_low_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_24h_low_tab)[colnames(CD_24h_low_tab)=="Dead_Cells"]="Dead_Cells_Ar_LowDose_24h"
#
CD_24h_high_tab = CD_24h_tab %>% filter(CD_24h_tab$Dose_relative == "High dose")
CD_24h_high_tab <- CD_24h_high_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_24h_high_tab)[colnames(CD_24h_high_tab)=="Dead_Cells"]="Dead_Cells_Ar_HighDose_24h"
#
Ar_24h=merge(CD_24h_Controls_tab, CD_24h_low_tab, by="Sample_ID", all=TRUE)
Ar_24h=merge(Ar_24h, CD_24h_high_tab, by="Sample_ID", all=TRUE)
All_Ar=merge(Ar_4h, Ar_24h, by="Sample_ID", all=TRUE)
All_Ar=unique(All_Ar)
#
### Si 
Data_only_rad = Data_only %>% filter(Data_only$Radiation_type =="Si")
#
CD_4h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "4h")
CD_4h_Controls_tab = CD_4h_tab %>% filter(CD_4h_tab$Dose_relative == "0 Gy Controls")
CD_4h_Controls_tab <- CD_4h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_4h_Controls_tab)[colnames(CD_4h_Controls_tab)=="Dead_Cells"]="Dead_Cells_Si_0Gy_4h"
#
CD_4h_low_tab =CD_4h_tab %>% filter(CD_4h_tab$Dose_relative == "Low dose")
CD_4h_low_tab <- CD_4h_low_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_4h_low_tab)[colnames(CD_4h_low_tab)=="Dead_Cells"]="Dead_Cells_Si_LowDose_4h"
#
CD_4h_high_tab = CD_4h_tab %>% filter(CD_4h_tab$Dose_relative == "High dose")
CD_4h_high_tab <- CD_4h_high_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_4h_high_tab)[colnames(CD_4h_high_tab)=="Dead_Cells"]="Dead_Cells_Si_HighDose_4h"
#
Si_4h=merge(CD_4h_Controls_tab, CD_4h_low_tab, by="Sample_ID", all=TRUE)
Si_4h=merge(Si_4h, CD_4h_high_tab, by="Sample_ID", all=TRUE)
#
CD_24h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "24h")
CD_24h_Controls_tab = CD_24h_tab %>% filter(CD_24h_tab$Dose_relative == "0 Gy Controls")
CD_24h_Controls_tab <- CD_24h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_24h_Controls_tab)[colnames(CD_24h_Controls_tab)=="Dead_Cells"]="Dead_Cells_Si_0Gy_24h"
#
CD_24h_low_tab =CD_24h_tab %>% filter(CD_24h_tab$Dose_relative == "Low dose")
CD_24h_low_tab <- CD_24h_low_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_24h_low_tab)[colnames(CD_24h_low_tab)=="Dead_Cells"]="Dead_Cells_Si_LowDose_24h"
#
CD_24h_high_tab = CD_24h_tab %>% filter(CD_24h_tab$Dose_relative == "High dose")
CD_24h_high_tab <- CD_24h_high_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_24h_high_tab)[colnames(CD_24h_high_tab)=="Dead_Cells"]="Dead_Cells_Si_HighDose_24h"
#
Si_24h=merge(CD_24h_Controls_tab, CD_24h_low_tab, by="Sample_ID", all=TRUE)
Si_24h=merge(Si_24h, CD_24h_high_tab, by="Sample_ID", all=TRUE)
All_Si=merge(Si_4h, Si_24h, by="Sample_ID", all=TRUE)
All_Si=unique(All_Si)
#
### Gamma 
Data_only_rad = Data_only %>% filter(Data_only$Radiation_type =="Gamma")
#
CD_4h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "4h")
CD_4h_Controls_tab = CD_4h_tab %>% filter(CD_4h_tab$Dose_relative == "0 Gy Controls")
CD_4h_Controls_tab <- CD_4h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_4h_Controls_tab)[colnames(CD_4h_Controls_tab)=="Dead_Cells"]="Dead_Cells_Gamma_0Gy_4h"
#
CD_4h_low_tab =CD_4h_tab %>% filter(CD_4h_tab$Dose_relative == "Low dose")
CD_4h_low_tab <- CD_4h_low_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_4h_low_tab)[colnames(CD_4h_low_tab)=="Dead_Cells"]="Dead_Cells_Gamma_LowDose_4h"
#
CD_4h_high_tab = CD_4h_tab %>% filter(CD_4h_tab$Dose_relative == "High dose")
CD_4h_high_tab <- CD_4h_high_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_4h_high_tab)[colnames(CD_4h_high_tab)=="Dead_Cells"]="Dead_Cells_Gamma_HighDose_4h"
#
Gamma_4h=merge(CD_4h_Controls_tab, CD_4h_low_tab, by="Sample_ID", all=TRUE)
Gamma_4h=merge(Gamma_4h, CD_4h_high_tab, by="Sample_ID", all=TRUE)
#
CD_24h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "24h")
CD_24h_Controls_tab = CD_24h_tab %>% filter(CD_24h_tab$Dose_relative == "0 Gy Controls")
CD_24h_Controls_tab <- CD_24h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_24h_Controls_tab)[colnames(CD_24h_Controls_tab)=="Dead_Cells"]="Dead_Cells_Gamma_0Gy_24h"
#
CD_24h_low_tab =CD_24h_tab %>% filter(CD_24h_tab$Dose_relative == "Low dose")
CD_24h_low_tab <- CD_24h_low_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_24h_low_tab)[colnames(CD_24h_low_tab)=="Dead_Cells"]="Dead_Cells_Gamma_LowDose_24h"
#
CD_24h_high_tab = CD_24h_tab %>% filter(CD_24h_tab$Dose_relative == "High dose")
CD_24h_high_tab <- CD_24h_high_tab %>% group_by(Sample_ID) %>% summarize(Dead_Cells = mean(Dead_Cells))
colnames(CD_24h_high_tab)[colnames(CD_24h_high_tab)=="Dead_Cells"]="Dead_Cells_Gamma_HighDose_24h"
#
Gamma_24h=merge(CD_24h_Controls_tab, CD_24h_low_tab, by="Sample_ID", all=TRUE)
Gamma_24h=merge(Gamma_24h, CD_24h_high_tab, by="Sample_ID", all=TRUE)
All_Gamma=merge(Gamma_4h, Gamma_24h, by="Sample_ID", all=TRUE)
All_Gamma=unique(All_Gamma)
##
##
All_rad=merge(All_Fe, All_Ar, by="Sample_ID", all=TRUE)
All_rad=merge(All_rad, All_Si, by="Sample_ID", all=TRUE)
All_rad=merge(All_rad, All_Gamma, by="Sample_ID", all=TRUE)
#
CD_Cdts=merge(All_rad, Save_metadata_CD, by="Sample_ID", all.x=TRUE)


### Oxidative stress
Save_metadata_OS = All_Corrected_OS[, grepl("Sample_ID|Age|Gender|BMI|Run_set", colnames(All_Corrected_OS))]
Save_metadata_OS=unique(Save_metadata_OS)
#
Data_only = All_Corrected_OS[, grepl("Sample_ID|Ox_|Dose_relative|Timepoint|Radiation_type", colnames(All_Corrected_OS))]
#
#
### Fe 
Data_only_rad = Data_only %>% filter(Data_only$Radiation_type =="Fe")
#
OS_4h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "4h")
OS_4h_Controls_tab = OS_4h_tab %>% filter(OS_4h_tab$Dose_relative == "0 Gy Controls")
OS_4h_Controls_tab <- OS_4h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_4h_Controls_tab)[colnames(OS_4h_Controls_tab)=="Ox_Stress"]="Ox_Stress_Fe_0Gy_4h"
#
OS_4h_low_tab =OS_4h_tab %>% filter(OS_4h_tab$Dose_relative == "Low dose")
OS_4h_low_tab <- OS_4h_low_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_4h_low_tab)[colnames(OS_4h_low_tab)=="Ox_Stress"]="Ox_Stress_Fe_LowDose_4h"
#
OS_4h_high_tab = OS_4h_tab %>% filter(OS_4h_tab$Dose_relative == "High dose")
OS_4h_high_tab <- OS_4h_high_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_4h_high_tab)[colnames(OS_4h_high_tab)=="Ox_Stress"]="Ox_Stress_Fe_HighDose_4h"
#
Fe_4h=merge(OS_4h_Controls_tab, OS_4h_low_tab, by="Sample_ID", all=TRUE)
Fe_4h=merge(Fe_4h, OS_4h_high_tab, by="Sample_ID", all=TRUE)
#
OS_24h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "24h")
OS_24h_Controls_tab = OS_24h_tab %>% filter(OS_24h_tab$Dose_relative == "0 Gy Controls")
OS_24h_Controls_tab <- OS_24h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_24h_Controls_tab)[colnames(OS_24h_Controls_tab)=="Ox_Stress"]="Ox_Stress_Fe_0Gy_24h"
#
OS_24h_low_tab =OS_24h_tab %>% filter(OS_24h_tab$Dose_relative == "Low dose")
OS_24h_low_tab <- OS_24h_low_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_24h_low_tab)[colnames(OS_24h_low_tab)=="Ox_Stress"]="Ox_Stress_Fe_LowDose_24h"
#
OS_24h_high_tab = OS_24h_tab %>% filter(OS_24h_tab$Dose_relative == "High dose")
OS_24h_high_tab <- OS_24h_high_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_24h_high_tab)[colnames(OS_24h_high_tab)=="Ox_Stress"]="Ox_Stress_Fe_HighDose_24h"
#
Fe_24h=merge(OS_24h_Controls_tab, OS_24h_low_tab, by="Sample_ID", all=TRUE)
Fe_24h=merge(Fe_24h, OS_24h_high_tab, by="Sample_ID", all=TRUE)
All_Fe=merge(Fe_4h, Fe_24h, by="Sample_ID", all=TRUE)
All_Fe=unique(All_Fe)
#
### Ar 
Data_only_rad = Data_only %>% filter(Data_only$Radiation_type =="Ar")
#
OS_4h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "4h")
OS_4h_Controls_tab = OS_4h_tab %>% filter(OS_4h_tab$Dose_relative == "0 Gy Controls")
OS_4h_Controls_tab <- OS_4h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_4h_Controls_tab)[colnames(OS_4h_Controls_tab)=="Ox_Stress"]="Ox_Stress_Ar_0Gy_4h"
#
OS_4h_low_tab =OS_4h_tab %>% filter(OS_4h_tab$Dose_relative == "Low dose")
OS_4h_low_tab <- OS_4h_low_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_4h_low_tab)[colnames(OS_4h_low_tab)=="Ox_Stress"]="Ox_Stress_Ar_LowDose_4h"
#
OS_4h_high_tab = OS_4h_tab %>% filter(OS_4h_tab$Dose_relative == "High dose")
OS_4h_high_tab <- OS_4h_high_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_4h_high_tab)[colnames(OS_4h_high_tab)=="Ox_Stress"]="Ox_Stress_Ar_HighDose_4h"
#
Ar_4h=merge(OS_4h_Controls_tab, OS_4h_low_tab, by="Sample_ID", all=TRUE)
Ar_4h=merge(Ar_4h, OS_4h_high_tab, by="Sample_ID", all=TRUE)
#
OS_24h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "24h")
OS_24h_Controls_tab = OS_24h_tab %>% filter(OS_24h_tab$Dose_relative == "0 Gy Controls")
OS_24h_Controls_tab <- OS_24h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_24h_Controls_tab)[colnames(OS_24h_Controls_tab)=="Ox_Stress"]="Ox_Stress_Ar_0Gy_24h"
#
OS_24h_low_tab =OS_24h_tab %>% filter(OS_24h_tab$Dose_relative == "Low dose")
OS_24h_low_tab <- OS_24h_low_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_24h_low_tab)[colnames(OS_24h_low_tab)=="Ox_Stress"]="Ox_Stress_Ar_LowDose_24h"
#
OS_24h_high_tab = OS_24h_tab %>% filter(OS_24h_tab$Dose_relative == "High dose")
OS_24h_high_tab <- OS_24h_high_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_24h_high_tab)[colnames(OS_24h_high_tab)=="Ox_Stress"]="Ox_Stress_Ar_HighDose_24h"
#
Ar_24h=merge(OS_24h_Controls_tab, OS_24h_low_tab, by="Sample_ID", all=TRUE)
Ar_24h=merge(Ar_24h, OS_24h_high_tab, by="Sample_ID", all=TRUE)
All_Ar=merge(Ar_4h, Ar_24h, by="Sample_ID", all=TRUE)
All_Ar=unique(All_Ar)
#
### Si 
Data_only_rad = Data_only %>% filter(Data_only$Radiation_type =="Si")
#
OS_4h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "4h")
OS_4h_Controls_tab = OS_4h_tab %>% filter(OS_4h_tab$Dose_relative == "0 Gy Controls")
OS_4h_Controls_tab <- OS_4h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_4h_Controls_tab)[colnames(OS_4h_Controls_tab)=="Ox_Stress"]="Ox_Stress_Si_0Gy_4h"
#
OS_4h_low_tab =OS_4h_tab %>% filter(OS_4h_tab$Dose_relative == "Low dose")
OS_4h_low_tab <- OS_4h_low_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_4h_low_tab)[colnames(OS_4h_low_tab)=="Ox_Stress"]="Ox_Stress_Si_LowDose_4h"
#
OS_4h_high_tab = OS_4h_tab %>% filter(OS_4h_tab$Dose_relative == "High dose")
OS_4h_high_tab <- OS_4h_high_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_4h_high_tab)[colnames(OS_4h_high_tab)=="Ox_Stress"]="Ox_Stress_Si_HighDose_4h"
#
Si_4h=merge(OS_4h_Controls_tab, OS_4h_low_tab, by="Sample_ID", all=TRUE)
Si_4h=merge(Si_4h, OS_4h_high_tab, by="Sample_ID", all=TRUE)
#
OS_24h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "24h")
OS_24h_Controls_tab = OS_24h_tab %>% filter(OS_24h_tab$Dose_relative == "0 Gy Controls")
OS_24h_Controls_tab <- OS_24h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_24h_Controls_tab)[colnames(OS_24h_Controls_tab)=="Ox_Stress"]="Ox_Stress_Si_0Gy_24h"
#
OS_24h_low_tab =OS_24h_tab %>% filter(OS_24h_tab$Dose_relative == "Low dose")
OS_24h_low_tab <- OS_24h_low_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_24h_low_tab)[colnames(OS_24h_low_tab)=="Ox_Stress"]="Ox_Stress_Si_LowDose_24h"
#
OS_24h_high_tab = OS_24h_tab %>% filter(OS_24h_tab$Dose_relative == "High dose")
OS_24h_high_tab <- OS_24h_high_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_24h_high_tab)[colnames(OS_24h_high_tab)=="Ox_Stress"]="Ox_Stress_Si_HighDose_24h"
#
Si_24h=merge(OS_24h_Controls_tab, OS_24h_low_tab, by="Sample_ID", all=TRUE)
Si_24h=merge(Si_24h, OS_24h_high_tab, by="Sample_ID", all=TRUE)
All_Si=merge(Si_4h, Si_24h, by="Sample_ID", all=TRUE)
All_Si=unique(All_Si)
#
### Gamma 
Data_only_rad = Data_only %>% filter(Data_only$Radiation_type =="Gamma")
#
OS_4h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "4h")
OS_4h_Controls_tab = OS_4h_tab %>% filter(OS_4h_tab$Dose_relative == "0 Gy Controls")
OS_4h_Controls_tab <- OS_4h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_4h_Controls_tab)[colnames(OS_4h_Controls_tab)=="Ox_Stress"]="Ox_Stress_Gamma_0Gy_4h"
#
OS_4h_low_tab =OS_4h_tab %>% filter(OS_4h_tab$Dose_relative == "Low dose")
OS_4h_low_tab <- OS_4h_low_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_4h_low_tab)[colnames(OS_4h_low_tab)=="Ox_Stress"]="Ox_Stress_Gamma_LowDose_4h"
#
OS_4h_high_tab = OS_4h_tab %>% filter(OS_4h_tab$Dose_relative == "High dose")
OS_4h_high_tab <- OS_4h_high_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_4h_high_tab)[colnames(OS_4h_high_tab)=="Ox_Stress"]="Ox_Stress_Gamma_HighDose_4h"
#
Gamma_4h=merge(OS_4h_Controls_tab, OS_4h_low_tab, by="Sample_ID", all=TRUE)
Gamma_4h=merge(Gamma_4h, OS_4h_high_tab, by="Sample_ID", all=TRUE)
#
OS_24h_tab = Data_only_rad %>% filter(Data_only_rad$Timepoint == "24h")
OS_24h_Controls_tab = OS_24h_tab %>% filter(OS_24h_tab$Dose_relative == "0 Gy Controls")
OS_24h_Controls_tab <- OS_24h_Controls_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_24h_Controls_tab)[colnames(OS_24h_Controls_tab)=="Ox_Stress"]="Ox_Stress_Gamma_0Gy_24h"
#
OS_24h_low_tab =OS_24h_tab %>% filter(OS_24h_tab$Dose_relative == "Low dose")
OS_24h_low_tab <- OS_24h_low_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_24h_low_tab)[colnames(OS_24h_low_tab)=="Ox_Stress"]="Ox_Stress_Gamma_LowDose_24h"
#
OS_24h_high_tab = OS_24h_tab %>% filter(OS_24h_tab$Dose_relative == "High dose")
OS_24h_high_tab <- OS_24h_high_tab %>% group_by(Sample_ID) %>% summarize(Ox_Stress = mean(Ox_Stress))
colnames(OS_24h_high_tab)[colnames(OS_24h_high_tab)=="Ox_Stress"]="Ox_Stress_Gamma_HighDose_24h"
#
Gamma_24h=merge(OS_24h_Controls_tab, OS_24h_low_tab, by="Sample_ID", all=TRUE)
Gamma_24h=merge(Gamma_24h, OS_24h_high_tab, by="Sample_ID", all=TRUE)
All_Gamma=merge(Gamma_4h, Gamma_24h, by="Sample_ID", all=TRUE)
All_Gamma=unique(All_Gamma)

##
##
All_rad=merge(All_Fe, All_Ar, by="Sample_ID", all=TRUE)
All_rad=merge(All_rad, All_Si, by="Sample_ID", all=TRUE)
All_rad=merge(All_rad, All_Gamma, by="Sample_ID", all=TRUE)
#
OS_Cdts=merge(All_rad, Save_metadata_OS, by="Sample_ID", all.x=TRUE)


########################################################################
########################### Normalization ##############################
########################################################################

### DNA Damage 
DD_Cdts_Norm = DD_Cdts
#
DD_Cdts_Norm$avg_nfoci_Fe_LowDose_4h = DD_Cdts_Norm$avg_nfoci_Fe_LowDose_4h / DD_Cdts_Norm$avg_nfoci_Fe_0Gy_4h
DD_Cdts_Norm$avg_nfoci_Fe_HighDose_4h = DD_Cdts_Norm$avg_nfoci_Fe_HighDose_4h / DD_Cdts_Norm$avg_nfoci_Fe_0Gy_4h
DD_Cdts_Norm$avg_nfoci_Fe_LowDose_24h = DD_Cdts_Norm$avg_nfoci_Fe_LowDose_24h / DD_Cdts_Norm$avg_nfoci_Fe_0Gy_24h
DD_Cdts_Norm$avg_nfoci_Fe_HighDose_24h = DD_Cdts_Norm$avg_nfoci_Fe_HighDose_24h / DD_Cdts_Norm$avg_nfoci_Fe_0Gy_24h
DD_Cdts_Norm$avg_nfoci_Fe_0Gy_4h=NULL
DD_Cdts_Norm$avg_nfoci_Fe_0Gy_24h=NULL
#
DD_Cdts_Norm$avg_nfoci_Ar_LowDose_4h = DD_Cdts_Norm$avg_nfoci_Ar_LowDose_4h / DD_Cdts_Norm$avg_nfoci_Ar_0Gy_4h
DD_Cdts_Norm$avg_nfoci_Ar_HighDose_4h = DD_Cdts_Norm$avg_nfoci_Ar_HighDose_4h / DD_Cdts_Norm$avg_nfoci_Ar_0Gy_4h
DD_Cdts_Norm$avg_nfoci_Ar_LowDose_24h = DD_Cdts_Norm$avg_nfoci_Ar_LowDose_24h / DD_Cdts_Norm$avg_nfoci_Ar_0Gy_24h
DD_Cdts_Norm$avg_nfoci_Ar_HighDose_24h = DD_Cdts_Norm$avg_nfoci_Ar_HighDose_24h / DD_Cdts_Norm$avg_nfoci_Ar_0Gy_24h
DD_Cdts_Norm$avg_nfoci_Ar_0Gy_4h=NULL
DD_Cdts_Norm$avg_nfoci_Ar_0Gy_24h=NULL
#
DD_Cdts_Norm$avg_nfoci_Si_LowDose_4h = DD_Cdts_Norm$avg_nfoci_Si_LowDose_4h / DD_Cdts_Norm$avg_nfoci_Si_0Gy_4h
DD_Cdts_Norm$avg_nfoci_Si_HighDose_4h = DD_Cdts_Norm$avg_nfoci_Si_HighDose_4h / DD_Cdts_Norm$avg_nfoci_Si_0Gy_4h
DD_Cdts_Norm$avg_nfoci_Si_LowDose_24h = DD_Cdts_Norm$avg_nfoci_Si_LowDose_24h / DD_Cdts_Norm$avg_nfoci_Si_0Gy_24h
DD_Cdts_Norm$avg_nfoci_Si_HighDose_24h = DD_Cdts_Norm$avg_nfoci_Si_HighDose_24h / DD_Cdts_Norm$avg_nfoci_Si_0Gy_24h
DD_Cdts_Norm$avg_nfoci_Si_0Gy_4h=NULL
DD_Cdts_Norm$avg_nfoci_Si_0Gy_24h=NULL
#
DD_Cdts_Norm$avg_nfoci_Gamma_LowDose_4h = DD_Cdts_Norm$avg_nfoci_Gamma_LowDose_4h / DD_Cdts_Norm$avg_nfoci_Gamma_0Gy_4h
DD_Cdts_Norm$avg_nfoci_Gamma_HighDose_4h = DD_Cdts_Norm$avg_nfoci_Gamma_HighDose_4h / DD_Cdts_Norm$avg_nfoci_Gamma_0Gy_4h
DD_Cdts_Norm$avg_nfoci_Gamma_LowDose_24h = DD_Cdts_Norm$avg_nfoci_Gamma_LowDose_24h / DD_Cdts_Norm$avg_nfoci_Gamma_0Gy_24h
DD_Cdts_Norm$avg_nfoci_Gamma_HighDose_24h = DD_Cdts_Norm$avg_nfoci_Gamma_HighDose_24h / DD_Cdts_Norm$avg_nfoci_Gamma_0Gy_24h
DD_Cdts_Norm$avg_nfoci_Gamma_0Gy_4h=NULL
DD_Cdts_Norm$avg_nfoci_Gamma_0Gy_24h=NULL
##
##
### Cell death 
CD_Cdts_Norm = CD_Cdts
#
CD_Cdts_Norm$Dead_Cells_Fe_LowDose_4h = CD_Cdts_Norm$Dead_Cells_Fe_LowDose_4h / CD_Cdts_Norm$Dead_Cells_Fe_0Gy_4h
CD_Cdts_Norm$Dead_Cells_Fe_HighDose_4h = CD_Cdts_Norm$Dead_Cells_Fe_HighDose_4h / CD_Cdts_Norm$Dead_Cells_Fe_0Gy_4h
CD_Cdts_Norm$Dead_Cells_Fe_LowDose_24h = CD_Cdts_Norm$Dead_Cells_Fe_LowDose_24h / CD_Cdts_Norm$Dead_Cells_Fe_0Gy_24h
CD_Cdts_Norm$Dead_Cells_Fe_HighDose_24h = CD_Cdts_Norm$Dead_Cells_Fe_HighDose_24h / CD_Cdts_Norm$Dead_Cells_Fe_0Gy_24h
CD_Cdts_Norm$Dead_Cells_Fe_0Gy_4h=NULL
CD_Cdts_Norm$Dead_Cells_Fe_0Gy_24h=NULL
#
CD_Cdts_Norm$Dead_Cells_Ar_LowDose_4h = CD_Cdts_Norm$Dead_Cells_Ar_LowDose_4h / CD_Cdts_Norm$Dead_Cells_Ar_0Gy_4h
CD_Cdts_Norm$Dead_Cells_Ar_HighDose_4h = CD_Cdts_Norm$Dead_Cells_Ar_HighDose_4h / CD_Cdts_Norm$Dead_Cells_Ar_0Gy_4h
CD_Cdts_Norm$Dead_Cells_Ar_LowDose_24h = CD_Cdts_Norm$Dead_Cells_Ar_LowDose_24h / CD_Cdts_Norm$Dead_Cells_Ar_0Gy_24h
CD_Cdts_Norm$Dead_Cells_Ar_HighDose_24h = CD_Cdts_Norm$Dead_Cells_Ar_HighDose_24h / CD_Cdts_Norm$Dead_Cells_Ar_0Gy_24h
CD_Cdts_Norm$Dead_Cells_Ar_0Gy_4h=NULL
CD_Cdts_Norm$Dead_Cells_Ar_0Gy_24h=NULL
#
CD_Cdts_Norm$Dead_Cells_Si_LowDose_4h = CD_Cdts_Norm$Dead_Cells_Si_LowDose_4h / CD_Cdts_Norm$Dead_Cells_Si_0Gy_4h
CD_Cdts_Norm$Dead_Cells_Si_HighDose_4h = CD_Cdts_Norm$Dead_Cells_Si_HighDose_4h / CD_Cdts_Norm$Dead_Cells_Si_0Gy_4h
CD_Cdts_Norm$Dead_Cells_Si_LowDose_24h = CD_Cdts_Norm$Dead_Cells_Si_LowDose_24h / CD_Cdts_Norm$Dead_Cells_Si_0Gy_24h
CD_Cdts_Norm$Dead_Cells_Si_HighDose_24h = CD_Cdts_Norm$Dead_Cells_Si_HighDose_24h / CD_Cdts_Norm$Dead_Cells_Si_0Gy_24h
CD_Cdts_Norm$Dead_Cells_Si_0Gy_4h=NULL
CD_Cdts_Norm$Dead_Cells_Si_0Gy_24h=NULL
#
CD_Cdts_Norm$Dead_Cells_Gamma_LowDose_4h = CD_Cdts_Norm$Dead_Cells_Gamma_LowDose_4h / CD_Cdts_Norm$Dead_Cells_Gamma_0Gy_4h
CD_Cdts_Norm$Dead_Cells_Gamma_HighDose_4h = CD_Cdts_Norm$Dead_Cells_Gamma_HighDose_4h / CD_Cdts_Norm$Dead_Cells_Gamma_0Gy_4h
CD_Cdts_Norm$Dead_Cells_Gamma_LowDose_24h = CD_Cdts_Norm$Dead_Cells_Gamma_LowDose_24h / CD_Cdts_Norm$Dead_Cells_Gamma_0Gy_24h
CD_Cdts_Norm$Dead_Cells_Gamma_HighDose_24h = CD_Cdts_Norm$Dead_Cells_Gamma_HighDose_24h / CD_Cdts_Norm$Dead_Cells_Gamma_0Gy_24h
CD_Cdts_Norm$Dead_Cells_Gamma_0Gy_4h=NULL
CD_Cdts_Norm$Dead_Cells_Gamma_0Gy_24h=NULL
##
##
### Oxidative stress 
OS_Cdts_Norm = OS_Cdts
#
OS_Cdts_Norm$Ox_Stress_Fe_LowDose_4h = OS_Cdts_Norm$Ox_Stress_Fe_LowDose_4h / OS_Cdts_Norm$Ox_Stress_Fe_0Gy_4h
OS_Cdts_Norm$Ox_Stress_Fe_HighDose_4h = OS_Cdts_Norm$Ox_Stress_Fe_HighDose_4h / OS_Cdts_Norm$Ox_Stress_Fe_0Gy_4h
OS_Cdts_Norm$Ox_Stress_Fe_LowDose_24h = OS_Cdts_Norm$Ox_Stress_Fe_LowDose_24h / OS_Cdts_Norm$Ox_Stress_Fe_0Gy_24h
OS_Cdts_Norm$Ox_Stress_Fe_HighDose_24h = OS_Cdts_Norm$Ox_Stress_Fe_HighDose_24h / OS_Cdts_Norm$Ox_Stress_Fe_0Gy_24h
OS_Cdts_Norm$Ox_Stress_Fe_0Gy_4h=NULL
OS_Cdts_Norm$Ox_Stress_Fe_0Gy_24h=NULL
#
OS_Cdts_Norm$Ox_Stress_Ar_LowDose_4h = OS_Cdts_Norm$Ox_Stress_Ar_LowDose_4h / OS_Cdts_Norm$Ox_Stress_Ar_0Gy_4h
OS_Cdts_Norm$Ox_Stress_Ar_HighDose_4h = OS_Cdts_Norm$Ox_Stress_Ar_HighDose_4h / OS_Cdts_Norm$Ox_Stress_Ar_0Gy_4h
OS_Cdts_Norm$Ox_Stress_Ar_LowDose_24h = OS_Cdts_Norm$Ox_Stress_Ar_LowDose_24h / OS_Cdts_Norm$Ox_Stress_Ar_0Gy_24h
OS_Cdts_Norm$Ox_Stress_Ar_HighDose_24h = OS_Cdts_Norm$Ox_Stress_Ar_HighDose_24h / OS_Cdts_Norm$Ox_Stress_Ar_0Gy_24h
OS_Cdts_Norm$Ox_Stress_Ar_0Gy_4h=NULL
OS_Cdts_Norm$Ox_Stress_Ar_0Gy_24h=NULL
#
OS_Cdts_Norm$Ox_Stress_Si_LowDose_4h = OS_Cdts_Norm$Ox_Stress_Si_LowDose_4h / OS_Cdts_Norm$Ox_Stress_Si_0Gy_4h
OS_Cdts_Norm$Ox_Stress_Si_HighDose_4h = OS_Cdts_Norm$Ox_Stress_Si_HighDose_4h / OS_Cdts_Norm$Ox_Stress_Si_0Gy_4h
OS_Cdts_Norm$Ox_Stress_Si_LowDose_24h = OS_Cdts_Norm$Ox_Stress_Si_LowDose_24h / OS_Cdts_Norm$Ox_Stress_Si_0Gy_24h
OS_Cdts_Norm$Ox_Stress_Si_HighDose_24h = OS_Cdts_Norm$Ox_Stress_Si_HighDose_24h / OS_Cdts_Norm$Ox_Stress_Si_0Gy_24h
OS_Cdts_Norm$Ox_Stress_Si_0Gy_4h=NULL
OS_Cdts_Norm$Ox_Stress_Si_0Gy_24h=NULL
#
OS_Cdts_Norm$Ox_Stress_Gamma_LowDose_4h = OS_Cdts_Norm$Ox_Stress_Gamma_LowDose_4h / OS_Cdts_Norm$Ox_Stress_Gamma_0Gy_4h
OS_Cdts_Norm$Ox_Stress_Gamma_HighDose_4h = OS_Cdts_Norm$Ox_Stress_Gamma_HighDose_4h / OS_Cdts_Norm$Ox_Stress_Gamma_0Gy_4h
OS_Cdts_Norm$Ox_Stress_Gamma_LowDose_24h = OS_Cdts_Norm$Ox_Stress_Gamma_LowDose_24h / OS_Cdts_Norm$Ox_Stress_Gamma_0Gy_24h
OS_Cdts_Norm$Ox_Stress_Gamma_HighDose_24h = OS_Cdts_Norm$Ox_Stress_Gamma_HighDose_24h / OS_Cdts_Norm$Ox_Stress_Gamma_0Gy_24h
OS_Cdts_Norm$Ox_Stress_Gamma_0Gy_4h=NULL
OS_Cdts_Norm$Ox_Stress_Gamma_0Gy_24h=NULL

## All_Pheno_Norm
DD_Cdts_Norm_regroup = DD_Cdts_Norm[,grepl("Sample_ID|avg_",colnames(DD_Cdts_Norm))]
CD_Cdts_Norm_regroup = CD_Cdts_Norm[,grepl("Sample_ID|Dead_",colnames(CD_Cdts_Norm))]
OS_Cdts_Norm_regroup = OS_Cdts_Norm[,grepl("Sample_ID|Ox_",colnames(OS_Cdts_Norm))]
#
metadata_all=bind_rows(Save_metadata_DD,Save_metadata_CD, Save_metadata_OS)
metadata_all=unique(metadata_all)
#
All_Pheno_Norm=merge(DD_Cdts_Norm_regroup, CD_Cdts_Norm_regroup, by="Sample_ID", all=TRUE)
All_Pheno_Norm=merge(All_Pheno_Norm, OS_Cdts_Norm_regroup, by="Sample_ID", all=TRUE)
All_Pheno_Norm=merge(All_Pheno_Norm, metadata_all, by="Sample_ID", all.x=TRUE)

#### All_Pheno_Norm contains all corrected and normalized data. Each colums correspond to one phenotype, one time point, one radiation and one dose. 

# Below we create a Three table (one for each phenotype) that contains only one colums for the data wich are complete with radiation, time point and dose columns. These table will be useful for the dose and LET analysis (see from line 4378 to line 4469)

### dose en Gy
Low_dose_Fe = 0.3 
Low_dose_Ar = 0.18 
Low_dose_Si = 0.11 
Low_dose_Gamma = 0.1

High_dose_Fe = 0.82 
High_dose_Ar = 0.5 
High_dose_Si = 0.29 
High_dose_Gamma = 1


### DNA damage formatting (normalized data)
## DD 4h
DD_Cdts_Norm_4h= DD_Cdts_Norm[,grepl("_4h|Sample_ID",colnames(DD_Cdts_Norm))]
DD_Cdts_Norm_4h$Timepoint="4h"
# Fe
DD_Cdts_Norm_4h_Fe= DD_Cdts_Norm_4h[,grepl("Fe|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_4h))]
DD_Cdts_Norm_4h_Fe$Radiation_type="Fe"
DD_Cdts_Norm_4h_Fe_LD= DD_Cdts_Norm_4h_Fe[,grepl("LowDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_4h_Fe))]
DD_Cdts_Norm_4h_Fe_LD$Dose_relative="Low Dose"
DD_Cdts_Norm_4h_Fe_LD$Dose_Gy = Low_dose_Fe
DD_Cdts_Norm_4h_Fe_LD$Fluence="Fluence 1.1"
DD_Cdts_Norm_4h_Fe_LD$Radiation_type="Fe"
colnames(DD_Cdts_Norm_4h_Fe_LD)[colnames(DD_Cdts_Norm_4h_Fe_LD)=="avg_nfoci_Fe_LowDose_4h"]="avg_nfoci"
DD_Cdts_Norm_4h_Fe_HD= DD_Cdts_Norm_4h_Fe[,grepl("HighDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_4h_Fe))]
DD_Cdts_Norm_4h_Fe_HD$Dose_relative="High Dose"
DD_Cdts_Norm_4h_Fe_HD$Dose_Gy = High_dose_Fe
DD_Cdts_Norm_4h_Fe_HD$Fluence="Fluence 3"
DD_Cdts_Norm_4h_Fe_HD$Radiation_type="Fe"
colnames(DD_Cdts_Norm_4h_Fe_HD)[colnames(DD_Cdts_Norm_4h_Fe_HD)=="avg_nfoci_Fe_HighDose_4h"]="avg_nfoci"
# Ar
DD_Cdts_Norm_4h_Ar= DD_Cdts_Norm_4h[,grepl("Ar|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_4h))]
DD_Cdts_Norm_4h_Ar$Radiation_type="Ar"
DD_Cdts_Norm_4h_Ar_LD= DD_Cdts_Norm_4h_Ar[,grepl("LowDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_4h_Ar))]
DD_Cdts_Norm_4h_Ar_LD$Dose_relative="Low Dose"
DD_Cdts_Norm_4h_Ar_LD$Dose_Gy = Low_dose_Ar
DD_Cdts_Norm_4h_Ar_LD$Fluence="Fluence 1.1"
DD_Cdts_Norm_4h_Ar_LD$Radiation_type="Ar"
colnames(DD_Cdts_Norm_4h_Ar_LD)[colnames(DD_Cdts_Norm_4h_Ar_LD)=="avg_nfoci_Ar_LowDose_4h"]="avg_nfoci"
DD_Cdts_Norm_4h_Ar_HD= DD_Cdts_Norm_4h_Ar[,grepl("HighDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_4h_Ar))]
DD_Cdts_Norm_4h_Ar_HD$Dose_relative="High Dose"
DD_Cdts_Norm_4h_Ar_HD$Dose_Gy = High_dose_Ar
DD_Cdts_Norm_4h_Ar_HD$Fluence="Fluence 3"
DD_Cdts_Norm_4h_Ar_HD$Radiation_type="Ar"
colnames(DD_Cdts_Norm_4h_Ar_HD)[colnames(DD_Cdts_Norm_4h_Ar_HD)=="avg_nfoci_Ar_HighDose_4h"]="avg_nfoci"
# Si
DD_Cdts_Norm_4h_Si= DD_Cdts_Norm_4h[,grepl("Si|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_4h))]
DD_Cdts_Norm_4h_Si$Radiation_type="Si"
DD_Cdts_Norm_4h_Si_LD= DD_Cdts_Norm_4h_Si[,grepl("LowDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_4h_Si))]
DD_Cdts_Norm_4h_Si_LD$Dose_relative="Low Dose"
DD_Cdts_Norm_4h_Si_LD$Dose_Gy = Low_dose_Si
DD_Cdts_Norm_4h_Si_LD$Fluence="Fluence 1.1"
DD_Cdts_Norm_4h_Si_LD$Radiation_type="Si"
colnames(DD_Cdts_Norm_4h_Si_LD)[colnames(DD_Cdts_Norm_4h_Si_LD)=="avg_nfoci_Si_LowDose_4h"]="avg_nfoci"
DD_Cdts_Norm_4h_Si_HD= DD_Cdts_Norm_4h_Si[,grepl("HighDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_4h_Si))]
DD_Cdts_Norm_4h_Si_HD$Dose_relative="High Dose"
DD_Cdts_Norm_4h_Si_HD$Dose_Gy = High_dose_Si
DD_Cdts_Norm_4h_Si_HD$Fluence="Fluence 3"
DD_Cdts_Norm_4h_Si_HD$Radiation_type="Si"
colnames(DD_Cdts_Norm_4h_Si_HD)[colnames(DD_Cdts_Norm_4h_Si_HD)=="avg_nfoci_Si_HighDose_4h"]="avg_nfoci"
# Gamma
DD_Cdts_Norm_4h_Gamma= DD_Cdts_Norm_4h[,grepl("Gamma|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_4h))]
DD_Cdts_Norm_4h_Gamma$Radiation_type="Gamma"
DD_Cdts_Norm_4h_Gamma_LD= DD_Cdts_Norm_4h_Gamma[,grepl("LowDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_4h_Gamma))]
DD_Cdts_Norm_4h_Gamma_LD$Dose_relative="Low Dose"
DD_Cdts_Norm_4h_Gamma_LD$Dose_Gy = Low_dose_Gamma
DD_Cdts_Norm_4h_Gamma_LD$Fluence=NA
DD_Cdts_Norm_4h_Gamma_LD$Radiation_type="Gamma"
colnames(DD_Cdts_Norm_4h_Gamma_LD)[colnames(DD_Cdts_Norm_4h_Gamma_LD)=="avg_nfoci_Gamma_LowDose_4h"]="avg_nfoci"
DD_Cdts_Norm_4h_Gamma_HD= DD_Cdts_Norm_4h_Gamma[,grepl("HighDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_4h_Gamma))]
DD_Cdts_Norm_4h_Gamma_HD$Dose_relative="High Dose"
DD_Cdts_Norm_4h_Gamma_HD$Dose_Gy = High_dose_Gamma
DD_Cdts_Norm_4h_Gamma_HD$Fluence=NA
DD_Cdts_Norm_4h_Gamma_HD$Radiation_type="Gamma"
colnames(DD_Cdts_Norm_4h_Gamma_HD)[colnames(DD_Cdts_Norm_4h_Gamma_HD)=="avg_nfoci_Gamma_HighDose_4h"]="avg_nfoci"
## DD 24h
DD_Cdts_Norm_24h= DD_Cdts_Norm[,grepl("_24h|Sample_ID",colnames(DD_Cdts_Norm))]
DD_Cdts_Norm_24h$Timepoint="24h"
# Fe
DD_Cdts_Norm_24h_Fe= DD_Cdts_Norm_24h[,grepl("Fe|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_24h))]
DD_Cdts_Norm_24h_Fe$Radiation_type="Fe"
DD_Cdts_Norm_24h_Fe_LD= DD_Cdts_Norm_24h_Fe[,grepl("LowDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_24h_Fe))]
DD_Cdts_Norm_24h_Fe_LD$Dose_relative="Low Dose"
DD_Cdts_Norm_24h_Fe_LD$Dose_Gy = Low_dose_Fe
DD_Cdts_Norm_24h_Fe_LD$Fluence="Fluence 1.1"
DD_Cdts_Norm_24h_Fe_LD$Radiation_type="Fe"
colnames(DD_Cdts_Norm_24h_Fe_LD)[colnames(DD_Cdts_Norm_24h_Fe_LD)=="avg_nfoci_Fe_LowDose_24h"]="avg_nfoci"
DD_Cdts_Norm_24h_Fe_HD= DD_Cdts_Norm_24h_Fe[,grepl("HighDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_24h_Fe))]
DD_Cdts_Norm_24h_Fe_HD$Dose_relative="High Dose"
DD_Cdts_Norm_24h_Fe_HD$Dose_Gy = High_dose_Fe
DD_Cdts_Norm_24h_Fe_HD$Fluence="Fluence 3"
DD_Cdts_Norm_24h_Fe_HD$Radiation_type="Fe"
colnames(DD_Cdts_Norm_24h_Fe_HD)[colnames(DD_Cdts_Norm_24h_Fe_HD)=="avg_nfoci_Fe_HighDose_24h"]="avg_nfoci"
# Ar
DD_Cdts_Norm_24h_Ar= DD_Cdts_Norm_24h[,grepl("Ar|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_24h))]
DD_Cdts_Norm_24h_Ar$Radiation_type="Ar"
DD_Cdts_Norm_24h_Ar_LD= DD_Cdts_Norm_24h_Ar[,grepl("LowDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_24h_Ar))]
DD_Cdts_Norm_24h_Ar_LD$Dose_relative="Low Dose"
DD_Cdts_Norm_24h_Ar_LD$Dose_Gy = Low_dose_Ar
DD_Cdts_Norm_24h_Ar_LD$Fluence="Fluence 1.1"
DD_Cdts_Norm_24h_Ar_LD$Radiation_type="Ar"
colnames(DD_Cdts_Norm_24h_Ar_LD)[colnames(DD_Cdts_Norm_24h_Ar_LD)=="avg_nfoci_Ar_LowDose_24h"]="avg_nfoci"
DD_Cdts_Norm_24h_Ar_HD= DD_Cdts_Norm_24h_Ar[,grepl("HighDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_24h_Ar))]
DD_Cdts_Norm_24h_Ar_HD$Dose_relative="High Dose"
DD_Cdts_Norm_24h_Ar_HD$Dose_Gy = High_dose_Ar
DD_Cdts_Norm_24h_Ar_HD$Fluence="Fluence 3"
DD_Cdts_Norm_24h_Ar_HD$Radiation_type="Ar"
colnames(DD_Cdts_Norm_24h_Ar_HD)[colnames(DD_Cdts_Norm_24h_Ar_HD)=="avg_nfoci_Ar_HighDose_24h"]="avg_nfoci"
# Si
DD_Cdts_Norm_24h_Si= DD_Cdts_Norm_24h[,grepl("Si|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_24h))]
DD_Cdts_Norm_24h_Si$Radiation_type="Si"
DD_Cdts_Norm_24h_Si_LD= DD_Cdts_Norm_24h_Si[,grepl("LowDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_24h_Si))]
DD_Cdts_Norm_24h_Si_LD$Dose_relative="Low Dose"
DD_Cdts_Norm_24h_Si_LD$Dose_Gy = Low_dose_Si
DD_Cdts_Norm_24h_Si_LD$Fluence="Fluence 1.1"
DD_Cdts_Norm_24h_Si_LD$Radiation_type="Si"
colnames(DD_Cdts_Norm_24h_Si_LD)[colnames(DD_Cdts_Norm_24h_Si_LD)=="avg_nfoci_Si_LowDose_24h"]="avg_nfoci"
DD_Cdts_Norm_24h_Si_HD= DD_Cdts_Norm_24h_Si[,grepl("HighDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_24h_Si))]
DD_Cdts_Norm_24h_Si_HD$Dose_relative="High Dose"
DD_Cdts_Norm_24h_Si_HD$Dose_Gy = High_dose_Si
DD_Cdts_Norm_24h_Si_HD$Fluence="Fluence 3"
DD_Cdts_Norm_24h_Si_HD$Radiation_type="Si"
colnames(DD_Cdts_Norm_24h_Si_HD)[colnames(DD_Cdts_Norm_24h_Si_HD)=="avg_nfoci_Si_HighDose_24h"]="avg_nfoci"
# Gamma
DD_Cdts_Norm_24h_Gamma= DD_Cdts_Norm_24h[,grepl("Gamma|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_24h))]
DD_Cdts_Norm_24h_Gamma$Radiation_type="Gamma"
DD_Cdts_Norm_24h_Gamma_LD= DD_Cdts_Norm_24h_Gamma[,grepl("LowDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_24h_Gamma))]
DD_Cdts_Norm_24h_Gamma_LD$Dose_relative="Low Dose"
DD_Cdts_Norm_24h_Gamma_LD$Dose_Gy = Low_dose_Gamma
colnames(DD_Cdts_Norm_24h_Gamma_LD)[colnames(DD_Cdts_Norm_24h_Gamma_LD)=="avg_nfoci_Gamma_LowDose_24h"]="avg_nfoci"
DD_Cdts_Norm_24h_Gamma_LD$Fluence=NA
DD_Cdts_Norm_24h_Gamma_LD$Radiation_type="Gamma"
DD_Cdts_Norm_24h_Gamma_HD= DD_Cdts_Norm_24h_Gamma[,grepl("HighDose|Sample_ID|Timepoint",colnames(DD_Cdts_Norm_24h_Gamma))]
DD_Cdts_Norm_24h_Gamma_HD$Dose_relative="High Dose"
DD_Cdts_Norm_24h_Gamma_HD$Dose_Gy = High_dose_Gamma
DD_Cdts_Norm_24h_Gamma_HD$Fluence=NA
DD_Cdts_Norm_24h_Gamma_HD$Radiation_type="Gamma"
colnames(DD_Cdts_Norm_24h_Gamma_HD)[colnames(DD_Cdts_Norm_24h_Gamma_HD)=="avg_nfoci_Gamma_HighDose_24h"]="avg_nfoci"

DD_Norm_regroup=bind_rows(DD_Cdts_Norm_4h_Fe_LD, DD_Cdts_Norm_4h_Fe_HD, 
                          DD_Cdts_Norm_24h_Fe_LD, DD_Cdts_Norm_24h_Fe_HD, 
                          DD_Cdts_Norm_4h_Ar_LD, DD_Cdts_Norm_4h_Ar_HD, 
                          DD_Cdts_Norm_24h_Ar_LD, DD_Cdts_Norm_24h_Ar_HD,
                          DD_Cdts_Norm_4h_Si_LD, DD_Cdts_Norm_4h_Si_HD, 
                          DD_Cdts_Norm_24h_Si_LD, DD_Cdts_Norm_24h_Si_HD,
                          DD_Cdts_Norm_4h_Gamma_LD, DD_Cdts_Norm_4h_Gamma_HD, 
                          DD_Cdts_Norm_24h_Gamma_LD, DD_Cdts_Norm_24h_Gamma_HD)



### Cell death formatting (normalized data)
## CD 4h
CD_Cdts_Norm_4h= CD_Cdts_Norm[,grepl("_4h|Sample_ID",colnames(CD_Cdts_Norm))]
CD_Cdts_Norm_4h$Timepoint="4h"
# Fe
CD_Cdts_Norm_4h_Fe= CD_Cdts_Norm_4h[,grepl("Fe|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_4h))]
CD_Cdts_Norm_4h_Fe$Radiation_type="Fe"
CD_Cdts_Norm_4h_Fe_LD= CD_Cdts_Norm_4h_Fe[,grepl("LowDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_4h_Fe))]
CD_Cdts_Norm_4h_Fe_LD$Dose_relative="Low Dose"
CD_Cdts_Norm_4h_Fe_LD$Dose_Gy = Low_dose_Fe
CD_Cdts_Norm_4h_Fe_LD$Fluence="Fluence 1.1"
CD_Cdts_Norm_4h_Fe_LD$Radiation_type="Fe"
colnames(CD_Cdts_Norm_4h_Fe_LD)[colnames(CD_Cdts_Norm_4h_Fe_LD)=="Dead_Cells_Fe_LowDose_4h"]="Dead_Cells"
CD_Cdts_Norm_4h_Fe_HD= CD_Cdts_Norm_4h_Fe[,grepl("HighDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_4h_Fe))]
CD_Cdts_Norm_4h_Fe_HD$Dose_relative="High Dose"
CD_Cdts_Norm_4h_Fe_HD$Dose_Gy = High_dose_Fe
CD_Cdts_Norm_4h_Fe_HD$Fluence="Fluence 3"
CD_Cdts_Norm_4h_Fe_HD$Radiation_type="Fe"
colnames(CD_Cdts_Norm_4h_Fe_HD)[colnames(CD_Cdts_Norm_4h_Fe_HD)=="Dead_Cells_Fe_HighDose_4h"]="Dead_Cells"
# Ar
CD_Cdts_Norm_4h_Ar= CD_Cdts_Norm_4h[,grepl("Ar|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_4h))]
CD_Cdts_Norm_4h_Ar$Radiation_type="Ar"
CD_Cdts_Norm_4h_Ar_LD= CD_Cdts_Norm_4h_Ar[,grepl("LowDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_4h_Ar))]
CD_Cdts_Norm_4h_Ar_LD$Dose_relative="Low Dose"
CD_Cdts_Norm_4h_Ar_LD$Dose_Gy = Low_dose_Ar
CD_Cdts_Norm_4h_Ar_LD$Fluence="Fluence 1.1"
CD_Cdts_Norm_4h_Ar_LD$Radiation_type="Ar"
colnames(CD_Cdts_Norm_4h_Ar_LD)[colnames(CD_Cdts_Norm_4h_Ar_LD)=="Dead_Cells_Ar_LowDose_4h"]="Dead_Cells"
CD_Cdts_Norm_4h_Ar_HD= CD_Cdts_Norm_4h_Ar[,grepl("HighDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_4h_Ar))]
CD_Cdts_Norm_4h_Ar_HD$Dose_relative="High Dose"
CD_Cdts_Norm_4h_Ar_HD$Dose_Gy = High_dose_Ar
CD_Cdts_Norm_4h_Ar_HD$Fluence="Fluence 3"
CD_Cdts_Norm_4h_Ar_HD$Radiation_type="Ar"
colnames(CD_Cdts_Norm_4h_Ar_HD)[colnames(CD_Cdts_Norm_4h_Ar_HD)=="Dead_Cells_Ar_HighDose_4h"]="Dead_Cells"
# Si
CD_Cdts_Norm_4h_Si= CD_Cdts_Norm_4h[,grepl("Si|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_4h))]
CD_Cdts_Norm_4h_Si$Radiation_type="Si"
CD_Cdts_Norm_4h_Si_LD= CD_Cdts_Norm_4h_Si[,grepl("LowDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_4h_Si))]
CD_Cdts_Norm_4h_Si_LD$Dose_relative="Low Dose"
CD_Cdts_Norm_4h_Si_LD$Dose_Gy = Low_dose_Si
CD_Cdts_Norm_4h_Si_LD$Fluence="Fluence 1.1"
CD_Cdts_Norm_4h_Si_LD$Radiation_type="Si"
colnames(CD_Cdts_Norm_4h_Si_LD)[colnames(CD_Cdts_Norm_4h_Si_LD)=="Dead_Cells_Si_LowDose_4h"]="Dead_Cells"
CD_Cdts_Norm_4h_Si_HD= CD_Cdts_Norm_4h_Si[,grepl("HighDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_4h_Si))]
CD_Cdts_Norm_4h_Si_HD$Dose_relative="High Dose"
CD_Cdts_Norm_4h_Si_HD$Dose_Gy = High_dose_Si
CD_Cdts_Norm_4h_Si_HD$Fluence="Fluence 3"
CD_Cdts_Norm_4h_Si_HD$Radiation_type="Si"
colnames(CD_Cdts_Norm_4h_Si_HD)[colnames(CD_Cdts_Norm_4h_Si_HD)=="Dead_Cells_Si_HighDose_4h"]="Dead_Cells"
# Gamma
CD_Cdts_Norm_4h_Gamma= CD_Cdts_Norm_4h[,grepl("Gamma|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_4h))]
CD_Cdts_Norm_4h_Gamma$Radiation_type="Gamma"
CD_Cdts_Norm_4h_Gamma_LD= CD_Cdts_Norm_4h_Gamma[,grepl("LowDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_4h_Gamma))]
CD_Cdts_Norm_4h_Gamma_LD$Dose_relative="Low Dose"
CD_Cdts_Norm_4h_Gamma_LD$Dose_Gy = Low_dose_Gamma
CD_Cdts_Norm_4h_Gamma_LD$Fluence=NA
CD_Cdts_Norm_4h_Gamma_LD$Radiation_type="Gamma"
colnames(CD_Cdts_Norm_4h_Gamma_LD)[colnames(CD_Cdts_Norm_4h_Gamma_LD)=="Dead_Cells_Gamma_LowDose_4h"]="Dead_Cells"
CD_Cdts_Norm_4h_Gamma_HD= CD_Cdts_Norm_4h_Gamma[,grepl("HighDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_4h_Gamma))]
CD_Cdts_Norm_4h_Gamma_HD$Dose_relative="High Dose"
CD_Cdts_Norm_4h_Gamma_HD$Dose_Gy = High_dose_Gamma
CD_Cdts_Norm_4h_Gamma_HD$Fluence=NA
CD_Cdts_Norm_4h_Gamma_HD$Radiation_type="Gamma"
colnames(CD_Cdts_Norm_4h_Gamma_HD)[colnames(CD_Cdts_Norm_4h_Gamma_HD)=="Dead_Cells_Gamma_HighDose_4h"]="Dead_Cells"
## CD 24h
CD_Cdts_Norm_24h= CD_Cdts_Norm[,grepl("_24h|Sample_ID",colnames(CD_Cdts_Norm))]
CD_Cdts_Norm_24h$Timepoint="24h"
# Fe
CD_Cdts_Norm_24h_Fe= CD_Cdts_Norm_24h[,grepl("Fe|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_24h))]
CD_Cdts_Norm_24h_Fe$Radiation_type="Fe"
CD_Cdts_Norm_24h_Fe_LD= CD_Cdts_Norm_24h_Fe[,grepl("LowDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_24h_Fe))]
CD_Cdts_Norm_24h_Fe_LD$Dose_relative="Low Dose"
CD_Cdts_Norm_24h_Fe_LD$Dose_Gy = Low_dose_Fe
CD_Cdts_Norm_24h_Fe_LD$Fluence="Fluence 1.1"
CD_Cdts_Norm_24h_Fe_LD$Radiation_type="Fe"
colnames(CD_Cdts_Norm_24h_Fe_LD)[colnames(CD_Cdts_Norm_24h_Fe_LD)=="Dead_Cells_Fe_LowDose_24h"]="Dead_Cells"
CD_Cdts_Norm_24h_Fe_HD= CD_Cdts_Norm_24h_Fe[,grepl("HighDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_24h_Fe))]
CD_Cdts_Norm_24h_Fe_HD$Dose_relative="High Dose"
CD_Cdts_Norm_24h_Fe_HD$Dose_Gy = High_dose_Fe
CD_Cdts_Norm_24h_Fe_HD$Fluence="Fluence 3"
CD_Cdts_Norm_24h_Fe_HD$Radiation_type="Fe"
colnames(CD_Cdts_Norm_24h_Fe_HD)[colnames(CD_Cdts_Norm_24h_Fe_HD)=="Dead_Cells_Fe_HighDose_24h"]="Dead_Cells"
# Ar
CD_Cdts_Norm_24h_Ar= CD_Cdts_Norm_24h[,grepl("Ar|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_24h))]
CD_Cdts_Norm_24h_Ar$Radiation_type="Ar"
CD_Cdts_Norm_24h_Ar_LD= CD_Cdts_Norm_24h_Ar[,grepl("LowDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_24h_Ar))]
CD_Cdts_Norm_24h_Ar_LD$Dose_relative="Low Dose"
CD_Cdts_Norm_24h_Ar_LD$Dose_Gy = Low_dose_Ar
CD_Cdts_Norm_24h_Ar_LD$Fluence="Fluence 1.1"
CD_Cdts_Norm_24h_Ar_LD$Radiation_type="Ar"
colnames(CD_Cdts_Norm_24h_Ar_LD)[colnames(CD_Cdts_Norm_24h_Ar_LD)=="Dead_Cells_Ar_LowDose_24h"]="Dead_Cells"
CD_Cdts_Norm_24h_Ar_HD= CD_Cdts_Norm_24h_Ar[,grepl("HighDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_24h_Ar))]
CD_Cdts_Norm_24h_Ar_HD$Dose_relative="High Dose"
CD_Cdts_Norm_24h_Ar_HD$Dose_Gy = High_dose_Ar
CD_Cdts_Norm_24h_Ar_HD$Fluence="Fluence 3"
CD_Cdts_Norm_24h_Ar_HD$Radiation_type="Ar"
colnames(CD_Cdts_Norm_24h_Ar_HD)[colnames(CD_Cdts_Norm_24h_Ar_HD)=="Dead_Cells_Ar_HighDose_24h"]="Dead_Cells"
# Si
CD_Cdts_Norm_24h_Si= CD_Cdts_Norm_24h[,grepl("Si|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_24h))]
CD_Cdts_Norm_24h_Si$Radiation_type="Si"
CD_Cdts_Norm_24h_Si_LD= CD_Cdts_Norm_24h_Si[,grepl("LowDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_24h_Si))]
CD_Cdts_Norm_24h_Si_LD$Dose_relative="Low Dose"
CD_Cdts_Norm_24h_Si_LD$Dose_Gy = Low_dose_Si
CD_Cdts_Norm_24h_Si_LD$Fluence="Fluence 1.1"
CD_Cdts_Norm_24h_Si_LD$Radiation_type="Si"
colnames(CD_Cdts_Norm_24h_Si_LD)[colnames(CD_Cdts_Norm_24h_Si_LD)=="Dead_Cells_Si_LowDose_24h"]="Dead_Cells"
CD_Cdts_Norm_24h_Si_HD= CD_Cdts_Norm_24h_Si[,grepl("HighDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_24h_Si))]
CD_Cdts_Norm_24h_Si_HD$Dose_relative="High Dose"
CD_Cdts_Norm_24h_Si_HD$Dose_Gy = High_dose_Si
CD_Cdts_Norm_24h_Si_HD$Fluence="Fluence 3"
CD_Cdts_Norm_24h_Si_HD$Radiation_type="Si"
colnames(CD_Cdts_Norm_24h_Si_HD)[colnames(CD_Cdts_Norm_24h_Si_HD)=="Dead_Cells_Si_HighDose_24h"]="Dead_Cells"
# Gamma
CD_Cdts_Norm_24h_Gamma= CD_Cdts_Norm_24h[,grepl("Gamma|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_24h))]
CD_Cdts_Norm_24h_Gamma$Radiation_type="Gamma"
CD_Cdts_Norm_24h_Gamma_LD= CD_Cdts_Norm_24h_Gamma[,grepl("LowDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_24h_Gamma))]
CD_Cdts_Norm_24h_Gamma_LD$Dose_relative="Low Dose"
CD_Cdts_Norm_24h_Gamma_LD$Dose_Gy = Low_dose_Gamma
CD_Cdts_Norm_24h_Gamma_LD$Fluence=NA
CD_Cdts_Norm_24h_Gamma_LD$Radiation_type="Gamma"
colnames(CD_Cdts_Norm_24h_Gamma_LD)[colnames(CD_Cdts_Norm_24h_Gamma_LD)=="Dead_Cells_Gamma_LowDose_24h"]="Dead_Cells"
CD_Cdts_Norm_24h_Gamma_HD= CD_Cdts_Norm_24h_Gamma[,grepl("HighDose|Sample_ID|Timepoint",colnames(CD_Cdts_Norm_24h_Gamma))]
CD_Cdts_Norm_24h_Gamma_HD$Dose_relative="High Dose"
CD_Cdts_Norm_24h_Gamma_HD$Dose_Gy = High_dose_Gamma
CD_Cdts_Norm_24h_Gamma_HD$Fluence=NA
CD_Cdts_Norm_24h_Gamma_HD$Radiation_type="Gamma"
colnames(CD_Cdts_Norm_24h_Gamma_HD)[colnames(CD_Cdts_Norm_24h_Gamma_HD)=="Dead_Cells_Gamma_HighDose_24h"]="Dead_Cells"

CD_Norm_regroup=bind_rows(CD_Cdts_Norm_4h_Fe_LD, CD_Cdts_Norm_4h_Fe_HD, 
                          CD_Cdts_Norm_24h_Fe_LD, CD_Cdts_Norm_24h_Fe_HD, 
                          CD_Cdts_Norm_4h_Ar_LD, CD_Cdts_Norm_4h_Ar_HD, 
                          CD_Cdts_Norm_24h_Ar_LD, CD_Cdts_Norm_24h_Ar_HD,
                          CD_Cdts_Norm_4h_Si_LD, CD_Cdts_Norm_4h_Si_HD, 
                          CD_Cdts_Norm_24h_Si_LD, CD_Cdts_Norm_24h_Si_HD,
                          CD_Cdts_Norm_4h_Gamma_LD, CD_Cdts_Norm_4h_Gamma_HD, 
                          CD_Cdts_Norm_24h_Gamma_LD, CD_Cdts_Norm_24h_Gamma_HD)


### Oxidative stress formatting (normalized data)
## OS 4h
OS_Cdts_Norm_4h= OS_Cdts_Norm[,grepl("_4h|Sample_ID",colnames(OS_Cdts_Norm))]
OS_Cdts_Norm_4h$Timepoint="4h"
# Fe
OS_Cdts_Norm_4h_Fe= OS_Cdts_Norm_4h[,grepl("Fe|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_4h))]
OS_Cdts_Norm_4h_Fe$Radiation_type="Fe"
OS_Cdts_Norm_4h_Fe_LD= OS_Cdts_Norm_4h_Fe[,grepl("LowDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_4h_Fe))]
OS_Cdts_Norm_4h_Fe_LD$Dose_relative="Low Dose"
OS_Cdts_Norm_4h_Fe_LD$Dose_Gy = Low_dose_Fe
OS_Cdts_Norm_4h_Fe_LD$Fluence="Fluence 1.1"
OS_Cdts_Norm_4h_Fe_LD$Radiation_type="Fe"
colnames(OS_Cdts_Norm_4h_Fe_LD)[colnames(OS_Cdts_Norm_4h_Fe_LD)=="Ox_Stress_Fe_LowDose_4h"]="Ox_Stress"
OS_Cdts_Norm_4h_Fe_HD= OS_Cdts_Norm_4h_Fe[,grepl("HighDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_4h_Fe))]
OS_Cdts_Norm_4h_Fe_HD$Dose_relative="High Dose"
OS_Cdts_Norm_4h_Fe_HD$Dose_Gy = High_dose_Fe
OS_Cdts_Norm_4h_Fe_HD$Fluence="Fluence 3"
OS_Cdts_Norm_4h_Fe_HD$Radiation_type="Fe"
colnames(OS_Cdts_Norm_4h_Fe_HD)[colnames(OS_Cdts_Norm_4h_Fe_HD)=="Ox_Stress_Fe_HighDose_4h"]="Ox_Stress"
# Ar
OS_Cdts_Norm_4h_Ar= OS_Cdts_Norm_4h[,grepl("Ar|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_4h))]
OS_Cdts_Norm_4h_Ar$Radiation_type="Ar"
OS_Cdts_Norm_4h_Ar_LD= OS_Cdts_Norm_4h_Ar[,grepl("LowDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_4h_Ar))]
OS_Cdts_Norm_4h_Ar_LD$Dose_relative="Low Dose"
OS_Cdts_Norm_4h_Ar_LD$Dose_Gy = Low_dose_Ar
OS_Cdts_Norm_4h_Ar_LD$Fluence="Fluence 1.1"
OS_Cdts_Norm_4h_Ar_LD$Radiation_type="Ar"
colnames(OS_Cdts_Norm_4h_Ar_LD)[colnames(OS_Cdts_Norm_4h_Ar_LD)=="Ox_Stress_Ar_LowDose_4h"]="Ox_Stress"
OS_Cdts_Norm_4h_Ar_HD= OS_Cdts_Norm_4h_Ar[,grepl("HighDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_4h_Ar))]
OS_Cdts_Norm_4h_Ar_HD$Dose_relative="High Dose"
OS_Cdts_Norm_4h_Ar_HD$Dose_Gy = High_dose_Ar
OS_Cdts_Norm_4h_Ar_HD$Fluence="Fluence 3"
OS_Cdts_Norm_4h_Ar_HD$Radiation_type="Ar"
colnames(OS_Cdts_Norm_4h_Ar_HD)[colnames(OS_Cdts_Norm_4h_Ar_HD)=="Ox_Stress_Ar_HighDose_4h"]="Ox_Stress"
# Si
OS_Cdts_Norm_4h_Si= OS_Cdts_Norm_4h[,grepl("Si|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_4h))]
OS_Cdts_Norm_4h_Si$Radiation_type="Si"
OS_Cdts_Norm_4h_Si_LD= OS_Cdts_Norm_4h_Si[,grepl("LowDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_4h_Si))]
OS_Cdts_Norm_4h_Si_LD$Dose_relative="Low Dose"
OS_Cdts_Norm_4h_Si_LD$Dose_Gy = Low_dose_Si
OS_Cdts_Norm_4h_Si_LD$Fluence="Fluence 1.1"
OS_Cdts_Norm_4h_Si_LD$Radiation_type="Si"
colnames(OS_Cdts_Norm_4h_Si_LD)[colnames(OS_Cdts_Norm_4h_Si_LD)=="Ox_Stress_Si_LowDose_4h"]="Ox_Stress"
OS_Cdts_Norm_4h_Si_HD= OS_Cdts_Norm_4h_Si[,grepl("HighDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_4h_Si))]
OS_Cdts_Norm_4h_Si_HD$Dose_relative="High Dose"
OS_Cdts_Norm_4h_Si_HD$Dose_Gy = High_dose_Si
OS_Cdts_Norm_4h_Si_HD$Fluence="Fluence 3"
OS_Cdts_Norm_4h_Si_HD$Radiation_type="Si"
colnames(OS_Cdts_Norm_4h_Si_HD)[colnames(OS_Cdts_Norm_4h_Si_HD)=="Ox_Stress_Si_HighDose_4h"]="Ox_Stress"
# Gamma
OS_Cdts_Norm_4h_Gamma= OS_Cdts_Norm_4h[,grepl("Gamma|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_4h))]
OS_Cdts_Norm_4h_Gamma$Radiation_type="Gamma"
OS_Cdts_Norm_4h_Gamma_LD= OS_Cdts_Norm_4h_Gamma[,grepl("LowDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_4h_Gamma))]
OS_Cdts_Norm_4h_Gamma_LD$Dose_relative="Low Dose"
OS_Cdts_Norm_4h_Gamma_LD$Dose_Gy = Low_dose_Gamma
OS_Cdts_Norm_4h_Gamma_LD$Fluence=NA
OS_Cdts_Norm_4h_Gamma_LD$Radiation_type="Gamma"
colnames(OS_Cdts_Norm_4h_Gamma_LD)[colnames(OS_Cdts_Norm_4h_Gamma_LD)=="Ox_Stress_Gamma_LowDose_4h"]="Ox_Stress"
OS_Cdts_Norm_4h_Gamma_HD= OS_Cdts_Norm_4h_Gamma[,grepl("HighDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_4h_Gamma))]
OS_Cdts_Norm_4h_Gamma_HD$Dose_relative="High Dose"
OS_Cdts_Norm_4h_Gamma_HD$Dose_Gy = High_dose_Gamma
OS_Cdts_Norm_4h_Gamma_HD$Fluence=NA
OS_Cdts_Norm_4h_Gamma_HD$Radiation_type="Gamma"
colnames(OS_Cdts_Norm_4h_Gamma_HD)[colnames(OS_Cdts_Norm_4h_Gamma_HD)=="Ox_Stress_Gamma_HighDose_4h"]="Ox_Stress"
## OS 24h
OS_Cdts_Norm_24h= OS_Cdts_Norm[,grepl("_24h|Sample_ID",colnames(OS_Cdts_Norm))]
OS_Cdts_Norm_24h$Timepoint="24h"
# Fe
OS_Cdts_Norm_24h_Fe= OS_Cdts_Norm_24h[,grepl("Fe|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_24h))]
OS_Cdts_Norm_24h_Fe$Radiation_type="Fe"
OS_Cdts_Norm_24h_Fe_LD= OS_Cdts_Norm_24h_Fe[,grepl("LowDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_24h_Fe))]
OS_Cdts_Norm_24h_Fe_LD$Dose_relative="Low Dose"
OS_Cdts_Norm_24h_Fe_LD$Dose_Gy = Low_dose_Fe
OS_Cdts_Norm_24h_Fe_LD$Fluence="Fluence 1.1"
OS_Cdts_Norm_24h_Fe_LD$Radiation_type="Fe"
colnames(OS_Cdts_Norm_24h_Fe_LD)[colnames(OS_Cdts_Norm_24h_Fe_LD)=="Ox_Stress_Fe_LowDose_24h"]="Ox_Stress"
OS_Cdts_Norm_24h_Fe_HD= OS_Cdts_Norm_24h_Fe[,grepl("HighDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_24h_Fe))]
OS_Cdts_Norm_24h_Fe_HD$Dose_relative="High Dose"
OS_Cdts_Norm_24h_Fe_HD$Dose_Gy = High_dose_Fe
OS_Cdts_Norm_24h_Fe_HD$Fluence="Fluence 3"
OS_Cdts_Norm_24h_Fe_HD$Radiation_type="Fe"
colnames(OS_Cdts_Norm_24h_Fe_HD)[colnames(OS_Cdts_Norm_24h_Fe_HD)=="Ox_Stress_Fe_HighDose_24h"]="Ox_Stress"
# Ar
OS_Cdts_Norm_24h_Ar= OS_Cdts_Norm_24h[,grepl("Ar|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_24h))]
OS_Cdts_Norm_24h_Ar$Radiation_type="Ar"
OS_Cdts_Norm_24h_Ar_LD= OS_Cdts_Norm_24h_Ar[,grepl("LowDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_24h_Ar))]
OS_Cdts_Norm_24h_Ar_LD$Dose_relative="Low Dose"
OS_Cdts_Norm_24h_Ar_LD$Dose_Gy = Low_dose_Ar
OS_Cdts_Norm_24h_Ar_LD$Fluence="Fluence 1.1"
OS_Cdts_Norm_24h_Ar_LD$Radiation_type="Ar"
colnames(OS_Cdts_Norm_24h_Ar_LD)[colnames(OS_Cdts_Norm_24h_Ar_LD)=="Ox_Stress_Ar_LowDose_24h"]="Ox_Stress"
OS_Cdts_Norm_24h_Ar_HD= OS_Cdts_Norm_24h_Ar[,grepl("HighDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_24h_Ar))]
OS_Cdts_Norm_24h_Ar_HD$Dose_relative="High Dose"
OS_Cdts_Norm_24h_Ar_HD$Dose_Gy = High_dose_Ar
OS_Cdts_Norm_24h_Ar_HD$Fluence="Fluence 3"
OS_Cdts_Norm_24h_Ar_HD$Radiation_type="Ar"
colnames(OS_Cdts_Norm_24h_Ar_HD)[colnames(OS_Cdts_Norm_24h_Ar_HD)=="Ox_Stress_Ar_HighDose_24h"]="Ox_Stress"
# Si
OS_Cdts_Norm_24h_Si= OS_Cdts_Norm_24h[,grepl("Si|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_24h))]
OS_Cdts_Norm_24h_Si$Radiation_type="Si"
OS_Cdts_Norm_24h_Si_LD= OS_Cdts_Norm_24h_Si[,grepl("LowDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_24h_Si))]
OS_Cdts_Norm_24h_Si_LD$Dose_relative="Low Dose"
OS_Cdts_Norm_24h_Si_LD$Dose_Gy = Low_dose_Si
OS_Cdts_Norm_24h_Si_LD$Fluence="Fluence 1.1"
OS_Cdts_Norm_24h_Si_LD$Radiation_type="Si"
colnames(OS_Cdts_Norm_24h_Si_LD)[colnames(OS_Cdts_Norm_24h_Si_LD)=="Ox_Stress_Si_LowDose_24h"]="Ox_Stress"
OS_Cdts_Norm_24h_Si_HD= OS_Cdts_Norm_24h_Si[,grepl("HighDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_24h_Si))]
OS_Cdts_Norm_24h_Si_HD$Dose_relative="High Dose"
OS_Cdts_Norm_24h_Si_HD$Dose_Gy = High_dose_Si
OS_Cdts_Norm_24h_Si_HD$Fluence="Fluence 3"
OS_Cdts_Norm_24h_Si_HD$Radiation_type="Si"
colnames(OS_Cdts_Norm_24h_Si_HD)[colnames(OS_Cdts_Norm_24h_Si_HD)=="Ox_Stress_Si_HighDose_24h"]="Ox_Stress"
# Gamma
OS_Cdts_Norm_24h_Gamma= OS_Cdts_Norm_24h[,grepl("Gamma|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_24h))]
OS_Cdts_Norm_24h_Gamma$Radiation_type="Gamma"
OS_Cdts_Norm_24h_Gamma_LD= OS_Cdts_Norm_24h_Gamma[,grepl("LowDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_24h_Gamma))]
OS_Cdts_Norm_24h_Gamma_LD$Dose_relative="Low Dose"
OS_Cdts_Norm_24h_Gamma_LD$Dose_Gy = Low_dose_Gamma
OS_Cdts_Norm_24h_Gamma_LD$Fluence=NA
OS_Cdts_Norm_24h_Gamma_LD$Radiation_type="Gamma"
colnames(OS_Cdts_Norm_24h_Gamma_LD)[colnames(OS_Cdts_Norm_24h_Gamma_LD)=="Ox_Stress_Gamma_LowDose_24h"]="Ox_Stress"
OS_Cdts_Norm_24h_Gamma_HD= OS_Cdts_Norm_24h_Gamma[,grepl("HighDose|Sample_ID|Timepoint",colnames(OS_Cdts_Norm_24h_Gamma))]
OS_Cdts_Norm_24h_Gamma_HD$Dose_relative="High Dose"
OS_Cdts_Norm_24h_Gamma_HD$Dose_Gy = High_dose_Gamma
OS_Cdts_Norm_24h_Gamma_HD$Fluence=NA
OS_Cdts_Norm_24h_Gamma_HD$Radiation_type="Gamma"
colnames(OS_Cdts_Norm_24h_Gamma_HD)[colnames(OS_Cdts_Norm_24h_Gamma_HD)=="Ox_Stress_Gamma_HighDose_24h"]="Ox_Stress"

OS_Norm_regroup=bind_rows(OS_Cdts_Norm_4h_Fe_LD, OS_Cdts_Norm_4h_Fe_HD, 
                          OS_Cdts_Norm_24h_Fe_LD, OS_Cdts_Norm_24h_Fe_HD, 
                          OS_Cdts_Norm_4h_Ar_LD, OS_Cdts_Norm_4h_Ar_HD, 
                          OS_Cdts_Norm_24h_Ar_LD, OS_Cdts_Norm_24h_Ar_HD,
                          OS_Cdts_Norm_4h_Si_LD, OS_Cdts_Norm_4h_Si_HD, 
                          OS_Cdts_Norm_24h_Si_LD, OS_Cdts_Norm_24h_Si_HD,
                          OS_Cdts_Norm_4h_Gamma_LD, OS_Cdts_Norm_4h_Gamma_HD, 
                          OS_Cdts_Norm_24h_Gamma_LD, OS_Cdts_Norm_24h_Gamma_HD)

```

```{r}
##################################################################################################
########  Analysis: DD comparison raw and corrected data by run_set / staining date ##############
##################################################################################################


################################
#### Raw Data (no normalization)
################################
All_Raw_DD_and_Baseline = bind_rows(all_RIF_Raw, Raw_Baseline)
All_Raw_DD_and_Baseline$Data_point=paste(All_Raw_DD_and_Baseline$Dose_relative, All_Raw_DD_and_Baseline$Timepoint, sep=" ")
All_Raw_DD_and_Baseline$Run_set_staining_date = paste(All_Raw_DD_and_Baseline$Run_set, All_Raw_DD_and_Baseline$Staining_date, sep=" / ")
All_Raw_DD_and_Baseline$Data_point= factor(All_Raw_DD_and_Baseline$Data_point, 
                                  levels=c("Baseline foci level", "0 Gy Controls 4h", "Low dose 4h", "High dose 4h", 
                                           "0 Gy Controls 24h", "Low dose 24h", "High dose 24h"))
All_Raw_DD_and_Baseline$Radiation_type=factor(All_Raw_DD_and_Baseline$Radiation_type, levels=c("Fe", "Ar", "Si", "Gamma"))
#
#Plot: Color code = Run and set & staining date 
Control_Baseline_check <- ggplot(All_Raw_DD_and_Baseline, aes(x=Data_point, y=Foci_per_nucleus)) + geom_boxplot(aes(fill=Run_set_staining_date)) + ylim(0,7)
Control_Baseline_check_all_Rad <- Control_Baseline_check + facet_grid(. ~ Radiation_type) + theme_gray()
ggsave("Raw_Baseline_DNA_Damage_ColorCode_RunSet_Staining_Date.pdf", Control_Baseline_check_all_Rad, width=36, height=5)
#
#
#Same plots but with only baseline and control no radiation responses
Raw_data_baseline_control = All_Raw_DD_and_Baseline %>% filter(All_Raw_DD_and_Baseline$Data_point == c("Baseline foci level", "0 Gy controls 4h", "0 Gy controls 24h"))
Raw_data_baseline_control$Radiation_type=factor(Raw_data_baseline_control$Radiation_type, levels=c("Fe", "Ar", "Si", "Gamma"))
Control_Baseline_check <- ggplot(Raw_data_baseline_control, aes(x=Data_point, y=Foci_per_nucleus)) + geom_boxplot(aes(fill=Run_set_staining_date)) +ylim(0,7)
Control_Baseline_check_all_Rad <- Control_Baseline_check + facet_grid(. ~ Radiation_type) + theme_gray()
ggsave("Raw_Baseline_DNA_Damage_Controls_Only_ColorCode_RunSet_Staining_Date.pdf", Control_Baseline_check_all_Rad, width=36, height=5)

######################################
####  Corrected Data (no normalization)
######################################
All_Corrected_DD_and_Baseline = bind_rows(All_Corrected_DD, Corrected_baselines)
All_Corrected_DD_and_Baseline$Data_point=paste(All_Corrected_DD_and_Baseline$Dose_relative, All_Corrected_DD_and_Baseline$Timepoint, sep=" ")
All_Corrected_DD_and_Baseline$Run_set_staining_date = paste(All_Corrected_DD_and_Baseline$Run_set, All_Corrected_DD_and_Baseline$Staining_date, sep=" / ")
All_Corrected_DD_and_Baseline$Data_point= factor(All_Corrected_DD_and_Baseline$Data_point, 
                                  levels=c("Baseline foci level", "0 Gy Controls 4h", "Low dose 4h", "High dose 4h", 
                                           "0 Gy Controls 24h", "Low dose 24h", "High dose 24h"))
All_Corrected_DD_and_Baseline$Radiation_type=factor(All_Corrected_DD_and_Baseline$Radiation_type, levels=c("Fe", "Ar", "Si", "Gamma"))
#
#Plot: Color code = Run and set & staining date 
Control_Baseline_check <- ggplot(All_Corrected_DD_and_Baseline, aes(x=Data_point, y=avg_nfoci)) + geom_boxplot(aes(fill=Run_set_staining_date)) + ylim(0,7)
Control_Baseline_check_all_Rad <- Control_Baseline_check + facet_grid(. ~ Radiation_type) + theme_gray()
ggsave("Corrected_Baseline_DNA_Damage_ColorCode_RunSet_Staining_Date.pdf", Control_Baseline_check_all_Rad, width=36, height=5)
#
#Same plots but with only baseline and control no radiation responses
Corrected_data_baseline_control = All_Corrected_DD_and_Baseline %>% filter(All_Corrected_DD_and_Baseline$Data_point == c("Baseline foci level", "0 Gy Controls 4h", "0 Gy Controls 24h"))
Corrected_data_baseline_control$Radiation_type=factor(Corrected_data_baseline_control$Radiation_type, levels=c("Fe", "Ar", "Si", "Gamma"))
Control_Baseline_check <- ggplot(Corrected_data_baseline_control, aes(x=Data_point, y=avg_nfoci)) + geom_boxplot(aes(fill=Run_set_staining_date)) +ylim(0,7)
Control_Baseline_check_all_Rad <- Control_Baseline_check + facet_grid(. ~ Radiation_type) + theme_gray()
ggsave("Corrected_Baseline_DNA_Damage_Controls_Only_ColorCode_RunSet_Staining_Date.pdf", Control_Baseline_check_all_Rad, width=36, height=5)
```


```{r}
##################################################################################################
################################### Baseline Analyses ############################################
##################################################################################################


################################### Baseline Distribution ########################################
Baseline_DNA_damage$baseline_class=cut_width(Baseline_DNA_damage$baseline_nfoci, 0.05,boundary=0 )
quantile_baseline = quantile(Baseline_DNA_damage$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]
#
Baseline_DNA_damage$level <- "medium"
#
for(i in 1:nrow(Baseline_DNA_damage)){
  if (Baseline_DNA_damage$baseline_nfoci[i] <= LB){
    Baseline_DNA_damage$level[i] = "Low Baseline"
  }
  if (Baseline_DNA_damage$baseline_nfoci[i] >= HB){
    Baseline_DNA_damage$level[i] = "High Baseline"
  }
}
#
Graph_baseline_distribution <- ggplot(Baseline_DNA_damage, aes(x=baseline_class, fill=level)) + geom_histogram(stat="count")+
  xlab("Baseline Level") +
  ylab("Nb of Individuals") + theme(axis.text.x = element_text( size=9, angle=45))
ggsave("Graph_baseline_distribution.pdf", Graph_baseline_distribution, width=11, height=5)


######################### Baseline anlysis based on demographic factors ##########################
#####Gender
p <- plot_ly(data=Baseline_DNA_damage_meta,
             x = ~ factor(Gender),
             y = ~ baseline_nfoci,
             color = ~ factor(Gender),
             colors = c('springgreen3','blue'),
             type = "box", boxpoints = "all") %>% 
  layout(xaxis = list(title = "Gender", tickfont = list(size = 20),
                      zeroline = FALSE),
         yaxis = list(title = "Spontaneous foci/nucleus", titlefont = list(size = 25), tickfont = list(size = 20),
                      zeroline = FALSE))
print(p)
hide_legend(p)
orca(p, "baseline_gender.pdf")

##Significance analysis
ow_aov <- aov(baseline_nfoci ~ Gender,  data=Baseline_DNA_damage_meta)
summary(ow_aov)
t_test_ow_aov <- TukeyHSD(ow_aov)
print(t_test_ow_aov)

######## BMI
#####Linear Model 
p <- plot_ly(data=Baseline_DNA_damage_meta,
             x = ~ BMI,
             y = ~ baseline_nfoci,
             type = "scatter") %>% 
  layout(xaxis = list(title = "BMI", titlefont = list(size = 25), tickfont = list(size = 20),
                      zeroline = FALSE),
         yaxis = list(title = "Spontaneous foci/nucleus", titlefont = list(size = 25), tickfont = list(size = 20),
                      zeroline = FALSE))
print(p)
hide_legend(p)
orca(p, "baseline_BMI_LinearModel.pdf")
### Significance analysis
model = lm(baseline_nfoci ~ BMI, data = Baseline_DNA_damage_meta)
summary(model)

#####BMI groups 
Data$BMI_group.x=factor(Baseline_DNA_damage_meta$BMI_group, levels = c("Underweight", "Normal", "Overweight", "Obese"))
p <- plot_ly(data=Baseline_DNA_damage_meta,
             x = ~ factor(BMI_group),
             y = ~ baseline_nfoci,
             color = ~ factor(BMI_group),
             type = "box", boxpoints = "all") %>% 
  layout(xaxis = list(title = "BMI_group", tickfont = list(size = 20),
                      zeroline = FALSE),
         yaxis = list(title = "Spontaneous foci/nucleus", titlefont = list(size = 25), tickfont = list(size = 20),
                      zeroline = FALSE))
print(p)
hide_legend(p)
orca(p, "baseline_BMI_groups_boxplot.pdf")
##Significance analysis
ow_aov <- aov(baseline_nfoci ~ BMI_group,  data=Baseline_DNA_damage_meta)
summary(ow_aov)
t_test_ow_aov <- TukeyHSD(ow_aov)
print(t_test_ow_aov)

###### Age 
## Linear Model
p <- plot_ly(data=Baseline_DNA_damage_meta,
             x = ~ Age,
             y = ~ baseline_nfoci,
             type = "scatter") %>% 
  layout(xaxis = list(title = "Age", titlefont = list(size = 30), tickfont = list(size = 20),
                      zeroline = FALSE),
         yaxis = list(title = "Spontaneous foci/nucleus", titlefont = list(size = 25), tickfont = list(size = 20),
                      zeroline = FALSE))
print(p)
hide_legend(p)
orca(p, "baseline_Age_LinearModel.pdf")
### Significance analysis
model = lm(baseline_nfoci ~ Age, data = Baseline_DNA_damage_meta)
summary(model)

## Age groups
Baseline_DNA_damage_meta$age_bin = cut_width(Baseline_DNA_damage_meta$Age,5,boundary=15)

foci_by_age_BMI = ggplot(Baseline_DNA_damage_meta, aes(x=age_bin, y=baseline_nfoci, col=BMI_group)) + geom_boxplot() + geom_point(position=position_jitterdodge(),alpha=0.4) + ylab("Baseline nb of foci/nucleus") + xlab("Age Group") + labs(col = "BMI Group") + theme(axis.text.x = element_text(size = 50)) + theme(axis.text.y = element_text(size = 50)) + theme(axis.title.x = element_text(size = 50, face = "bold")) + theme(axis.title.y = element_text(size = 50, face = "bold"))  + theme(legend.title = element_text(size = 50)) + theme(legend.text = element_text(size = 50)) + ylim(0,2.25) + theme_classic()
foci_by_age_BMI
ggsave("foci_by_age_BMI .pdf", foci_by_age_BMI)

### Significance analysis
tw_aov_interaction <- aov(baseline_nfoci ~ Age * BMI_group,  data=Baseline_DNA_damage_meta)
summary(tw_aov_interaction)


### CMV
Baseline_CMV= merge(Baseline_DNA_damage_meta, CMV_save, by="Sample_ID")

p <- plot_ly(data=Baseline_CMV,
             x = ~ factor(CMV),
             y = ~ baseline_nfoci,
             color = ~ factor(CMV),
             colors=c("darkblue", 'orange'),
             type = "box", boxpoints = "all") %>% 
  layout(xaxis = list(title = "Latent CMV Infection", titlefont = list(size = 25), tickfont = list(size = 20),
                      zeroline = FALSE),
         yaxis = list(title = "Spontaneous foci/nucleus", titlefont = list(size = 25), tickfont = list(size = 20),
                      zeroline = FALSE))
print(p)
hide_legend(p)
orca(p, "baseline_CMV.pdf")

### Significance analysis
ow_aov <- aov(baseline_nfoci ~ CMV,  data=Baseline_CMV)
summary(ow_aov)
t_test_ow_aov <- TukeyHSD(ow_aov)
print(t_test_ow_aov)


################################### Baselines and 0 Gy controls 
Baselines_only=All_Corrected_DD_and_Baseline %>% filter(All_Corrected_DD_and_Baseline$Dose_relative == "Baseline")
Controls_0_Gy_only=All_Corrected_DD_and_Baseline %>% filter(All_Corrected_DD_and_Baseline$Dose_relative == "0 Gy Controls")
Baselines_0Gy_Controls_comparison = bind_rows(Baselines_only, Controls_0_Gy_only)

Baselines_0Gy_Controls_comparison$Dose_relative=factor(Baselines_0Gy_Controls_comparison$Dose_relative, levels = c("Baseline","0 Gy Controls"))
Baselines_0Gy_Controls_comparison$Timepoint=factor(Baselines_0Gy_Controls_comparison$Timepoint, levels=c("foci level","4h", "24h"))

# Graph
DD_base_control=ggplot(Baselines_0Gy_Controls_comparison, aes(x=Timepoint, y=avg_nfoci, col=Dose_relative))+ geom_boxplot() +geom_point(position=position_jitterdodge(),alpha=0.4) + ylab("Nb of foci/nucleus")  + theme(axis.text.x = element_text(size = 50)) + theme(axis.text.y = element_text(size = 50)) + theme(axis.title.x = element_text(size = 50, face = "bold")) + theme(axis.title.y = element_text(size = 50, face = "bold"))  + theme(legend.title = element_text(size = 50)) + theme(legend.text = element_text(size = 50)) + ylim(0,5) + theme_classic()
print(DD_base_control)
ggsave("DD_Baselines_Controls_Comparison.pdf", DD_base_control, width = 9, height=5)

```



```{r}
##################################################################################################
####################### Radiation Responses: Principal Components Analysis #######################
##################################################################################################

## Data are normalized by ratio to their respective (in terms of radiation type and Timepoint) 0 Gy controls
## 4h 
OS_Correct_4h=OS_Cdts_Norm[ , grepl( "Sample_ID|_4h|Gender|Age|BMI_group|Run_Set" , names(OS_Cdts_Norm) ) ]
CD_Correct_4h=CD_Cdts_Norm[ , grepl( "Sample_ID|_4h|Gender|Age|BMI_group|Run_Set" , names(CD_Cdts_Norm) ) ]
DD_Correct_4h=DD_Cdts_Norm[ , grepl( "Sample_ID|_4h|Gender|Age|BMI_group|Run_Set" , names(DD_Cdts_Norm) ) ]

#### DNA damage #######
# Remove Sample ID with missing data 
DD_Correct_4h=NaRV.omit(DD_Correct_4h)
nbr_Ind_DD_Correct_4h=nrow(DD_Correct_4h)
print(nbr_Ind_DD_Correct_4h)
# PCA
Data_PCA_DD_Correct_4h= DD_Correct_4h[ , grepl( "_4h" , names(DD_Correct_4h))]
PCA_DD_Correct_4h= prcomp(Data_PCA_DD_Correct_4h, center = TRUE, scale. = TRUE)
## Graph 
# PCA Color code = Age 
DD_Correct_4h$Age=cut_width(DD_Correct_4h$Age, 5,boundary=15)
PCA_DD_4h_Color_Age= ggbiplot(PCA_DD_Correct_4h, obs.scale = 1, var.scale = 1, groups =DD_Correct_4h$Age, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Age")+ theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = BMI
PCA_DD_4h_Color_BMI= ggbiplot(PCA_DD_Correct_4h, obs.scale = 1, var.scale = 1, groups =DD_Correct_4h$BMI_group, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA))+labs(col="BMI Group") + theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = Gender
PCA_DD_4h_Color_Gender= ggbiplot(PCA_DD_Correct_4h, obs.scale = 1, var.scale = 1, groups =DD_Correct_4h$Gender, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Gender")+ theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = Run & Set
PCA_DD_4h_Color_RunSet= ggbiplot(PCA_DD_Correct_4h, obs.scale = 1, var.scale = 1, groups =DD_Correct_4h$Run_Set, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Run & Set") + theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)

# Regroup all graph in 1 PDF
PCA_DD_4h_all_graph <- grid.arrange(PCA_DD_4h_Color_Age, PCA_DD_4h_Color_BMI, PCA_DD_4h_Color_Gender, PCA_DD_4h_Color_RunSet, ncol=4)
ggsave("PCA_DD_4h.pdf", PCA_DD_4h_all_graph, width = 45, height=10)

#### Cell death #######
# Remove Sample ID with missing data 
CD_Correct_4h=NaRV.omit(CD_Correct_4h)
nbr_Ind_CD_Correct_4h=nrow(CD_Correct_4h)
print(nbr_Ind_CD_Correct_4h)
# PCA
Data_PCA_CD_Correct_4h= CD_Correct_4h[ , grepl( "_4h" , names(CD_Correct_4h))]
PCA_CD_Correct_4h= prcomp(Data_PCA_CD_Correct_4h, center = TRUE, scale. = TRUE)
## Graph 
# PCA Color code = Age 
CD_Correct_4h$Age=cut_width(CD_Correct_4h$Age, 5,boundary=15)
PCA_CD_4h_Color_Age= ggbiplot(PCA_CD_Correct_4h, obs.scale = 1, var.scale = 1, groups =CD_Correct_4h$Age, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Age")+ theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = BMI
PCA_CD_4h_Color_BMI= ggbiplot(PCA_CD_Correct_4h, obs.scale = 1, var.scale = 1, groups =CD_Correct_4h$BMI_group, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA))+labs(col="BMI Group") + theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = Gender
PCA_CD_4h_Color_Gender= ggbiplot(PCA_CD_Correct_4h, obs.scale = 1, var.scale = 1, groups =CD_Correct_4h$Gender, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Gender")+ theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = Run & Set
PCA_CD_4h_Color_RunSet= ggbiplot(PCA_CD_Correct_4h, obs.scale = 1, var.scale = 1, groups =CD_Correct_4h$Run_Set, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Run & Set") + theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# Regroup all graph in 1 PDF
PCA_CD_4h_all_graph <- grid.arrange(PCA_CD_4h_Color_Age, PCA_CD_4h_Color_BMI, PCA_CD_4h_Color_Gender, PCA_CD_4h_Color_RunSet, ncol=4)
ggsave("PCA_CD_4h.pdf", PCA_CD_4h_all_graph, width = 45, height=10)


#### Oxidative Stress #######
# Remove Sample ID with missing data 
OS_Correct_4h=NaRV.omit(OS_Correct_4h)
nbr_Ind_OS_Correct_4h=nrow(OS_Correct_4h)
print(nbr_Ind_OS_Correct_4h)
# PCA
Data_PCA_OS_Correct_4h= OS_Correct_4h[ , grepl( "_4h" , names(OS_Correct_4h))]
PCA_OS_Correct_4h= prcomp(Data_PCA_OS_Correct_4h, center = TRUE, scale. = TRUE)
## Graph 
# PCA Color code = Age 
OS_Correct_4h$Age=cut_width(OS_Correct_4h$Age, 5,boundary=15)
PCA_OS_4h_Color_Age= ggbiplot(PCA_OS_Correct_4h, obs.scale = 1, var.scale = 1, groups =OS_Correct_4h$Age, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Age")+ theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = BMI
PCA_OS_4h_Color_BMI= ggbiplot(PCA_OS_Correct_4h, obs.scale = 1, var.scale = 1, groups =OS_Correct_4h$BMI_group, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA))+labs(col="BMI Group") + theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = Gender
PCA_OS_4h_Color_Gender= ggbiplot(PCA_OS_Correct_4h, obs.scale = 1, var.scale = 1, groups =OS_Correct_4h$Gender, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Gender")+ theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = Run & Set
PCA_OS_4h_Color_RunSet= ggbiplot(PCA_OS_Correct_4h, obs.scale = 1, var.scale = 1, groups =OS_Correct_4h$Run_Set, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Run & Set") + theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# Regroup all graph in 1 PDF
PCA_OS_4h_all_graph <- grid.arrange(PCA_OS_4h_Color_Age, PCA_OS_4h_Color_BMI, PCA_OS_4h_Color_Gender, PCA_OS_4h_Color_RunSet, ncol=4)
ggsave("PCA_OS_4h.pdf", PCA_OS_4h_all_graph, width = 45, height=10)


## 24h 
OS_Correct_24h=OS_Cdts_Norm[ , grepl( "Sample_ID|_24h|Gender|Age|BMI_group|Run_Set" , names(OS_Cdts) ) ]
CD_Correct_24h=CD_Cdts_Norm[ , grepl( "Sample_ID|_24h|Gender|Age|BMI_group|Run_Set" , names(CD_Cdts) ) ]
DD_Correct_24h=DD_Cdts_Norm[ , grepl( "Sample_ID|_24h|Gender|Age|BMI_group|Run_Set" , names(DD_Cdts) ) ]

#### DNA damage #######
# Remove Sample ID with missing data 
DD_Correct_24h=NaRV.omit(DD_Correct_24h)
nbr_Ind_DD_Correct_24h=nrow(DD_Correct_24h)
print(nbr_Ind_DD_Correct_24h)
# PCA
Data_PCA_DD_Correct_24h= DD_Correct_24h[ , grepl( "_24h" , names(DD_Correct_24h))]
PCA_DD_Correct_24h= prcomp(Data_PCA_DD_Correct_24h, center = TRUE, scale. = TRUE)
## Graph 
# PCA Color code = Age 
DD_Correct_24h$Age=cut_width(DD_Correct_24h$Age, 5,boundary=15)
PCA_DD_24h_Color_Age= ggbiplot(PCA_DD_Correct_24h, obs.scale = 1, var.scale = 1, groups =DD_Correct_24h$Age, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Age")+ theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = BMI
PCA_DD_24h_Color_BMI= ggbiplot(PCA_DD_Correct_24h, obs.scale = 1, var.scale = 1, groups =DD_Correct_24h$BMI_group, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA))+labs(col="BMI Group") + theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = Gender
PCA_DD_24h_Color_Gender= ggbiplot(PCA_DD_Correct_24h, obs.scale = 1, var.scale = 1, groups =DD_Correct_24h$Gender, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Gender")+ theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = Run & Set
PCA_DD_24h_Color_RunSet= ggbiplot(PCA_DD_Correct_24h, obs.scale = 1, var.scale = 1, groups =DD_Correct_24h$Run_Set, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Run & Set") + theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# Regroup all graph in 1 PDF
PCA_DD_24h_all_graph <- grid.arrange(PCA_DD_24h_Color_Age, PCA_DD_24h_Color_BMI, PCA_DD_24h_Color_Gender, PCA_DD_24h_Color_RunSet, ncol=4)
ggsave("PCA_DD_24h.pdf", PCA_DD_24h_all_graph, width = 45, height=10)

#### Cell death #######
# Remove Sample ID with missing data 
CD_Correct_24h=NaRV.omit(CD_Correct_24h)
nbr_Ind_CD_Correct_24h=nrow(CD_Correct_24h)
print(nbr_Ind_CD_Correct_24h)
# PCA
Data_PCA_CD_Correct_24h= CD_Correct_24h[ , grepl( "_24h" , names(CD_Correct_24h))]
PCA_CD_Correct_24h= prcomp(Data_PCA_CD_Correct_24h, center = TRUE, scale. = TRUE)
## Graph 
# PCA Color code = Age 
CD_Correct_24h$Age=cut_width(CD_Correct_24h$Age, 5,boundary=15)
PCA_CD_24h_Color_Age= ggbiplot(PCA_CD_Correct_24h, obs.scale = 1, var.scale = 1, groups =CD_Correct_24h$Age, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Age")+ theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = BMI
PCA_CD_24h_Color_BMI= ggbiplot(PCA_CD_Correct_24h, obs.scale = 1, var.scale = 1, groups =CD_Correct_24h$BMI_group, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA))+labs(col="BMI Group") + theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = Gender
PCA_CD_24h_Color_Gender= ggbiplot(PCA_CD_Correct_24h, obs.scale = 1, var.scale = 1, groups =CD_Correct_24h$Gender, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Gender")+ theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = Run & Set
PCA_CD_24h_Color_RunSet= ggbiplot(PCA_CD_Correct_24h, obs.scale = 1, var.scale = 1, groups =CD_Correct_24h$Run_Set, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Run & Set") + theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# Regroup all graph in 1 PDF
PCA_CD_24h_all_graph <- grid.arrange(PCA_CD_24h_Color_Age, PCA_CD_24h_Color_BMI, PCA_CD_24h_Color_Gender, PCA_CD_24h_Color_RunSet, ncol=4)
ggsave("PCA_CD_24h.pdf", PCA_CD_24h_all_graph, width = 45, height=10)


#### Oxidative Stress #######
# Remove Sample ID with missing data 
OS_Correct_24h=NaRV.omit(OS_Correct_24h)
nbr_Ind_OS_Correct_24h=nrow(OS_Correct_24h)
print(nbr_Ind_OS_Correct_24h)
# PCA
Data_PCA_OS_Correct_24h= OS_Correct_24h[ , grepl( "_24h" , names(OS_Correct_24h))]
PCA_OS_Correct_24h= prcomp(Data_PCA_OS_Correct_24h, center = TRUE, scale. = TRUE)
## Graph 
# PCA Color code = Age 
OS_Correct_24h$Age=cut_width(OS_Correct_24h$Age, 5,boundary=15)
PCA_OS_24h_Color_Age= ggbiplot(PCA_OS_Correct_24h, obs.scale = 1, var.scale = 1, groups =OS_Correct_24h$Age, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Age")+ theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = BMI
PCA_OS_24h_Color_BMI= ggbiplot(PCA_OS_Correct_24h, obs.scale = 1, var.scale = 1, groups =OS_Correct_24h$BMI_group, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA))+labs(col="BMI Group") + theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = Gender
PCA_OS_24h_Color_Gender= ggbiplot(PCA_OS_Correct_24h, obs.scale = 1, var.scale = 1, groups =OS_Correct_24h$Gender, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Gender")+ theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# PCA Color code = Run & Set
PCA_OS_24h_Color_RunSet= ggbiplot(PCA_OS_Correct_24h, obs.scale = 1, var.scale = 1, groups =OS_Correct_24h$Run_Set, ellipse = FALSE, circle = FALSE, var.axes=FALSE) + theme(legend.direction = 'horizontal', legend.position = 'top') + theme(panel.background =element_rect(fill = "transparent", colour = NA)) +labs(col="Run & Set") + theme(panel.grid.major = element_line(colour="grey")) + xlim(-7,7) + ylim(-7,7)
# Regroup all graph in 1 PDF
PCA_OS_24h_all_graph <- grid.arrange(PCA_OS_24h_Color_Age, PCA_OS_24h_Color_BMI, PCA_OS_24h_Color_Gender, PCA_OS_24h_Color_RunSet, ncol=4)
ggsave("PCA_OS_24h.pdf", PCA_OS_24h_all_graph, width = 45, height=10)

```


```{r}
##################################################################################################
############## Radiation Responses: LET and Dose Analysis  #######################################
##################################################################################################


###########  _4h post-irradiation
################ DNA damage ################
######### DNA damage vs Dose Gy
DD_Norm_regroup_4h= DD_Norm_regroup %>% filter(DD_Norm_regroup$Timepoint=="4h")
DD_Norm_regroup_4h$Dose_Gy=as.character(DD_Norm_regroup_4h$Dose_Gy)
DD_Norm_regroup_4h$Rad_Dose_Gy=factor(DD_Norm_regroup_4h$Dose_Gy, levels=c(0.1, 0.11, 0.18, 0.29, 0.30, 0.5, 0.82, 1))
DD_Norm_regroup_4h$Radiation_type=factor(DD_Norm_regroup_4h$Radiation_type, levels =c("Gamma","Si", "Ar", "Fe"))

#
Graph_RIF_Dose_rad <- ggplot(DD_Norm_regroup_4h, aes(x=Dose_Gy, y=avg_nfoci, fill=Radiation_type)) + geom_boxplot() + scale_fill_manual(breaks = c("Fe", "Ar", "Si", "Gamma"), values=c("indianred1", "orange", "grey", "dodgerblue1")) +labs(x='Dose (Gy)', y="Normalized nb of RIF/nucleus") + theme(axis.text.x = element_text(size = 20, face = "bold")) + theme(axis.text.y = element_text(size = 20, face = "bold")) + theme(axis.title.x = element_text(size = 20, face = "bold")) + theme(axis.title.y = element_text(size = 20, face = "bold")) + theme(legend.title = element_text(size=16))+ theme(legend.text = element_text(size=16)) + theme(plot.title = element_text(size=20, face="bold")) + ylim(0,10)
print(Graph_RIF_Dose_rad)
#
ggsave("Graph_RIF_Dose_rad.pdf", Graph_RIF_Dose_rad, width = 10, height = 5)

### Statistical analysis
ow_aov <- aov(avg_nfoci ~ Dose_Gy,  data=DD_Norm_regroup_4h)
summary(ow_aov)
t_test_ow_aov <- TukeyHSD(ow_aov)
print(t_test_ow_aov)


#########DNA damage vs Fluences 
DD_Norm_regroup_4h_Fluence = DD_Norm_regroup_4h %>% filter(DD_Norm_regroup_4h$Radiation_type !="Gamma")
DD_Norm_regroup_4h_Fluence$Fluence=factor(DD_Norm_regroup_4h_Fluence$Fluence, levels=c("Fluence 1.1", "Fluence 3"))
DD_Norm_regroup_4h_Fluence$Radiation_type=factor(DD_Norm_regroup_4h_Fluence$Radiation, levels =c("Si", "Ar", "Fe"))

Graph_RIF_Fluence_rad <- ggplot(DD_Norm_regroup_4h_Fluence, aes(x=Fluence, y=avg_nfoci, fill=Radiation_type)) + geom_boxplot() + scale_fill_manual(breaks = c("Fe", "Ar", "Si"), values=c("indianred1", "orange", "grey")) +labs(x='Fluence (particles/100um2)', y="Normalized nb of RIF/nucleus") + theme(axis.text.x = element_text(size = 20, face = "bold")) + theme(axis.text.y = element_text(size = 20, face = "bold")) + theme(axis.title.x = element_text(size = 20, face = "bold")) + theme(axis.title.y = element_text(size = 20, face = "bold")) + theme(legend.title = element_text(size=16))+ theme(legend.text = element_text(size=16)) + theme(plot.title = element_text(size=20, face="bold")) +ylim(0,7)
print(Graph_RIF_Fluence_rad)
#
ggsave("Graph_RIF_Fluence_rad.pdf", Graph_RIF_Fluence_rad, width = 10, height = 5)


################ Cell Death ################
CD_Norm_regroup_4h= CD_Norm_regroup %>% filter(CD_Norm_regroup$Timepoint=="4h")
CD_fluence_4h <- ggplot(CD_Norm_regroup_4h, aes(x=Radiation_type, y=Dead_Cells, fill=Dose_relative)) + geom_boxplot()+ scale_fill_manual(breaks = c("Low Dose", "High Dose"), values=c("blue", "orange")) + ylim(0, 7)+ ylab("Normalized Percentage of Dead Cells") + xlab("Dose") + labs(col = "Radiation") + theme(axis.text.x = element_text(size = 50)) + theme(axis.text.y = element_text(size = 50)) + theme(axis.title.x = element_text(size = 50, face = "bold")) + theme(axis.title.y = element_text(size = 50, face = "bold"))  + theme(legend.title = element_text(size = 50)) + theme(legend.text = element_text(size = 50)) + theme_classic()
print(CD_fluence_4h)
#
ggsave("CD_fluence_4h.pdf", CD_fluence_4h, width = 10, height = 5)

################ Oxidative stress ################
OS_Norm_regroup_4h= OS_Norm_regroup %>% filter(OS_Norm_regroup$Timepoint=="4h")
OS_fluence_4h <- ggplot(OS_Norm_regroup_4h, aes(x=Radiation_type, y=Ox_Stress, fill=Dose_relative)) + geom_boxplot()+ scale_fill_manual(breaks = c("Low Dose", "High Dose"), values=c("blue", "orange")) + ylim(0, 7)+ ylab("Normalized CellROX level in live cells") + xlab("Dose") + labs(col = "Radiation") + theme(axis.text.x = element_text(size = 50)) + theme(axis.text.y = element_text(size = 50)) + theme(axis.title.x = element_text(size = 50, face = "bold")) + theme(axis.title.y = element_text(size = 50, face = "bold"))  + theme(legend.title = element_text(size = 50)) + theme(legend.text = element_text(size = 50)) + theme_classic()
print(CD_fluence_4h)
#
ggsave("OS_fluence_4h.pdf", CD_fluence_4h, width = 10, height = 5)


###########  _24h post-irradiation
################ DNA damage ################
######### DNA damage vs Dose Gy
DD_Norm_regroup_24h= DD_Norm_regroup %>% filter(DD_Norm_regroup$Timepoint=="24h")
DD_Norm_regroup_24h$Dose_Gy=as.character(DD_Norm_regroup_24h$Dose_Gy)
DD_Norm_regroup_24h$Rad_Dose_Gy=factor(DD_Norm_regroup_24h$Dose_Gy, levels=c(0.1, 0.11, 0.18, 0.29, 0.30, 0.5, 0.82, 1))
DD_Norm_regroup_24h$Radiation_type=factor(DD_Norm_regroup_24h$Radiation_type, levels =c("Gamma","Si", "Ar", "Fe"))

#
Graph_RIF_Dose_rad <- ggplot(DD_Norm_regroup_24h, aes(x=Dose_Gy, y=avg_nfoci, fill=Radiation_type)) + geom_boxplot() + scale_fill_manual(breaks = c("Fe", "Ar", "Si", "Gamma"), values=c("indianred1", "orange", "grey", "dodgerblue1")) +labs(x='Dose (Gy)', y="Normalized nb of RIF/nucleus") + theme(axis.text.x = element_text(size = 20, face = "bold")) + theme(axis.text.y = element_text(size = 20, face = "bold")) + theme(axis.title.x = element_text(size = 20, face = "bold")) + theme(axis.title.y = element_text(size = 20, face = "bold")) + theme(legend.title = element_text(size=16))+ theme(legend.text = element_text(size=16)) + theme(plot.title = element_text(size=20, face="bold")) + ylim(0,10)
print(Graph_RIF_Dose_rad)
#
ggsave("Graph_RIF_Dose_rad.pdf", Graph_RIF_Dose_rad, width = 10, height = 5)

### Statistical analysis
ow_aov <- aov(avg_nfoci ~ Dose_Gy,  data=DD_Norm_regroup_24h)
summary(ow_aov)
t_test_ow_aov <- TukeyHSD(ow_aov)
print(t_test_ow_aov)


######### DNA damage vs Fluences 
DD_Norm_regroup_24h_Fluence = DD_Norm_regroup_24h %>% filter(DD_Norm_regroup_24h$Radiation_type !="Gamma")
DD_Norm_regroup_24h_Fluence$Fluence=factor(DD_Norm_regroup_24h_Fluence$Fluence, levels=c("Fluence 1.1", "Fluence 3"))
DD_Norm_regroup_24h_Fluence$Radiation_type=factor(DD_Norm_regroup_24h_Fluence$Radiation, levels =c("Si", "Ar", "Fe"))

Graph_RIF_Fluence_rad <- ggplot(DD_Norm_regroup_24h_Fluence, aes(x=Fluence, y=avg_nfoci, fill=Radiation_type)) + geom_boxplot() + scale_fill_manual(breaks = c("Fe", "Ar", "Si"), values=c("indianred1", "orange", "grey")) +labs(x='Fluence (particles/100um2)', y="Normalized nb of RIF/nucleus") + theme(axis.text.x = element_text(size = 20, face = "bold")) + theme(axis.text.y = element_text(size = 20, face = "bold")) + theme(axis.title.x = element_text(size = 20, face = "bold")) + theme(axis.title.y = element_text(size = 20, face = "bold")) + theme(legend.title = element_text(size=16))+ theme(legend.text = element_text(size=16)) + theme(plot.title = element_text(size=20, face="bold")) +ylim(0,7)
print(Graph_RIF_Fluence_rad)
#
ggsave("Graph_RIF_Fluence_rad.pdf", Graph_RIF_Fluence_rad, width = 10, height = 5)


################ Cell Death ################
CD_Norm_regroup_24h= CD_Norm_regroup %>% filter(CD_Norm_regroup$Timepoint=="24h")
CD_fluence_24h <- ggplot(CD_Norm_regroup_24h, aes(x=Radiation_type, y=Dead_Cells, fill=Dose_relative)) + geom_boxplot()+ scale_fill_manual(breaks = c("Low Dose", "High Dose"), values=c("blue", "orange")) + ylim(0, 7)+ ylab("Normalized Percentage of Dead Cells") + xlab("Dose") + labs(col = "Radiation") + theme(axis.text.x = element_text(size = 50)) + theme(axis.text.y = element_text(size = 50)) + theme(axis.title.x = element_text(size = 50, face = "bold")) + theme(axis.title.y = element_text(size = 50, face = "bold"))  + theme(legend.title = element_text(size = 50)) + theme(legend.text = element_text(size = 50)) + theme_classic()
print(CD_fluence_24h)
#
ggsave("CD_fluence_24h.pdf", CD_fluence_24h, width = 10, height = 5)

################ Oxidative stress ################
OS_Norm_regroup_24h= OS_Norm_regroup %>% filter(OS_Norm_regroup$Timepoint=="24h")
OS_fluence_24h <- ggplot(OS_Norm_regroup_24h, aes(x=Radiation_type, y=Ox_Stress, fill=Dose_relative)) + geom_boxplot()+ scale_fill_manual(breaks = c("Low Dose", "High Dose"), values=c("blue", "orange")) + ylim(0, 7)+ ylab("Normalized CellROX level in live cells") + xlab("Dose") + labs(col = "Radiation") + theme(axis.text.x = element_text(size = 50)) + theme(axis.text.y = element_text(size = 50)) + theme(axis.title.x = element_text(size = 50, face = "bold")) + theme(axis.title.y = element_text(size = 50, face = "bold"))  + theme(legend.title = element_text(size = 50)) + theme(legend.text = element_text(size = 50)) + theme_classic()
print(CD_fluence_24h)
#
ggsave("OS_fluence_24h.pdf", CD_fluence_24h, width = 10, height = 5)

```


```{r}
##################################################################################################
############################ Radiation Responses: Combined Analysis  #############################
##################################################################################################

### Ellipses for low and high doses separately at 4h 
############ Low dose
DD_OS_4h_low <- ggplot(All_Pheno_Norm) + xlim(0, 2.5) + ylim(0, 3) +
  stat_ellipse(aes(x=Ox_Stress_Fe_LowDose_4h  , y= avg_nfoci_Fe_LowDose_4h), colour='firebrick1',level = 0.75)+geom_point(aes(x=Ox_Stress_Fe_LowDose_4h  , y= avg_nfoci_Fe_LowDose_4h),colour='firebrick1', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Ar_LowDose_4h  , y= avg_nfoci_Ar_LowDose_4h), colour='darkorange',level = 0.75)+geom_point(aes(x=Ox_Stress_Ar_LowDose_4h  , y= avg_nfoci_Ar_LowDose_4h),colour='darkorange', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Si_LowDose_4h  , y= avg_nfoci_Si_LowDose_4h), colour='azure4',level = 0.75)+geom_point(aes(x=Ox_Stress_Si_LowDose_4h  , y= avg_nfoci_Si_LowDose_4h),colour='azure4', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Gamma_LowDose_4h  , y= avg_nfoci_Gamma_LowDose_4h), colour='dodgerblue1',level = 0.75)+geom_point(aes(x=Ox_Stress_Gamma_LowDose_4h  , y= avg_nfoci_Gamma_LowDose_4h), colour='dodgerblue1',alpha = 0.4)+
  labs(x="Normalized Mean CellROX in live cells", y="Normalized nb of RIF/nucleus") + theme(legend.direction = 'horizontal', legend.position = 'None') + ggtitle("DNA Damage (RIF) vs Oxidative Stress at 4h") 

DD_CD_4h_low <- ggplot(All_Pheno_Norm) + xlim(0, 4.5) + ylim(0, 3) +
  stat_ellipse(aes(x=Dead_Cells_Fe_LowDose_4h  , y= avg_nfoci_Fe_LowDose_4h), colour='firebrick1',level = 0.75)+geom_point(aes(x=Dead_Cells_Fe_LowDose_4h  , y= avg_nfoci_Fe_LowDose_4h),colour='firebrick1', alpha = 0.4)+
  stat_ellipse(aes(x=Dead_Cells_Ar_LowDose_4h  , y= avg_nfoci_Ar_LowDose_4h), colour='darkorange',level = 0.75)+geom_point(aes(x=Dead_Cells_Ar_LowDose_4h  , y= avg_nfoci_Ar_LowDose_4h),colour='darkorange', alpha = 0.4)+
  stat_ellipse(aes(x=Dead_Cells_Si_LowDose_4h  , y= avg_nfoci_Si_LowDose_4h), colour='azure4',level = 0.75)+geom_point(aes(x=Dead_Cells_Si_LowDose_4h  , y= avg_nfoci_Si_LowDose_4h), colour='azure4',alpha = 0.4)+
  stat_ellipse(aes(x=Dead_Cells_Gamma_LowDose_4h  , y= avg_nfoci_Gamma_LowDose_4h), colour='dodgerblue1',level = 0.75)+geom_point(aes(x=Dead_Cells_Gamma_LowDose_4h  , y= avg_nfoci_Gamma_LowDose_4h),colour='dodgerblue1', alpha = 0.4)+
  labs(x="Normalized Percentage of Dead Cell", y="Normalized nb of RIF/nucleus") + theme(legend.direction = 'horizontal', legend.position = 'None') + ggtitle("DNA Damage (RIF) vs Dead Cell at 4h") 
  
CD_OS_4h_low <- ggplot(All_Pheno_Norm) + xlim(0, 2.5) + ylim(0, 4.5) +
  stat_ellipse(aes(x=Ox_Stress_Fe_LowDose_4h  , y= Dead_Cells_Fe_LowDose_4h), colour='firebrick1',level = 0.75)+geom_point(aes(x=Ox_Stress_Fe_LowDose_4h  , y= Dead_Cells_Fe_LowDose_4h), colour='firebrick1', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Ar_LowDose_4h  , y= Dead_Cells_Ar_LowDose_4h), colour='darkorange',level = 0.75)+geom_point(aes(x=Ox_Stress_Ar_LowDose_4h  , y= Dead_Cells_Ar_LowDose_4h),colour='darkorange', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Si_LowDose_4h  , y= Dead_Cells_Si_LowDose_4h), colour='azure4',level = 0.75)+geom_point(aes(x=Ox_Stress_Si_LowDose_4h  , y= Dead_Cells_Si_LowDose_4h), colour='azure4',alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Gamma_LowDose_4h  , y= Dead_Cells_Gamma_LowDose_4h), colour='dodgerblue1',level = 0.75)+geom_point(aes(x=Ox_Stress_Gamma_LowDose_4h  , y= Dead_Cells_Gamma_LowDose_4h),colour='dodgerblue1', alpha = 0.4)+
  labs(x="Normalized Mean CellROX in live cells", y="Normalized Percentage of Dead Cell", col="Radiation & Doses") + theme(legend.direction = 'horizontal', legend.position = 'Left') + ggtitle("Dead Cell vs Oxidative Stress at 4h") 

Ellipses_4h_low <- grid.arrange(DD_OS_4h_low,DD_CD_4h_low, CD_OS_4h_low, ncol=3)
ggsave("Ellipses_4h_low.pdf", Ellipses_4h_low,  width = 31, height=9)

############ High dose
DD_OS_4h_high <- ggplot(All_Pheno_Norm) + xlim(0, 2.5) + ylim(0, 3) +
  stat_ellipse(aes(x=Ox_Stress_Fe_HighDose_4h  , y= avg_nfoci_Fe_HighDose_4h), colour='firebrick1',level = 0.75)+geom_point(aes(x=Ox_Stress_Fe_HighDose_4h  , y= avg_nfoci_Fe_HighDose_4h), colour='firebrick1', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Ar_HighDose_4h  , y= avg_nfoci_Ar_HighDose_4h), colour='darkorange',level = 0.75)+geom_point(aes(x=Ox_Stress_Ar_HighDose_4h  , y= avg_nfoci_Ar_HighDose_4h), colour='darkorange',alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Si_HighDose_4h  , y= avg_nfoci_Si_HighDose_4h), colour='azure4',level = 0.75)+geom_point(aes(x=Ox_Stress_Si_HighDose_4h  , y= avg_nfoci_Si_HighDose_4h), colour='azure4',alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Gamma_HighDose_4h  , y= avg_nfoci_Gamma_HighDose_4h), colour='dodgerblue1',level = 0.75)+geom_point(aes(x=Ox_Stress_Gamma_HighDose_4h  , y= avg_nfoci_Gamma_HighDose_4h),colour='dodgerblue1', alpha = 0.4)+
  labs(x="Normalized Mean CellROX in live cells", y="Normalized nb of RIF/nucleus") + theme(legend.direction = 'horizontal', legend.position = 'None') + ggtitle("DNA Damage (RIF) vs Oxidative Stress at 4h") 

DD_CD_4h_high <- ggplot(All_Pheno_Norm) + xlim(0, 4.5) + ylim(0, 3) +
  stat_ellipse(aes(x=Dead_Cells_Fe_HighDose_4h  , y= avg_nfoci_Fe_HighDose_4h), colour='firebrick1',level = 0.75)+geom_point(aes(x=Dead_Cells_Fe_HighDose_4h  , y= avg_nfoci_Fe_HighDose_4h),colour='firebrick1', alpha = 0.4)+
  stat_ellipse(aes(x=Dead_Cells_Ar_HighDose_4h  , y= avg_nfoci_Ar_HighDose_4h), colour='darkorange',level = 0.75)+geom_point(aes(x=Dead_Cells_Ar_HighDose_4h  , y= avg_nfoci_Ar_HighDose_4h),colour='darkorange', alpha = 0.4)+
  stat_ellipse(aes(x=Dead_Cells_Si_HighDose_4h  , y= avg_nfoci_Si_HighDose_4h), colour='azure4',level = 0.75)+geom_point(aes(x=Dead_Cells_Si_HighDose_4h  , y= avg_nfoci_Si_HighDose_4h),colour='azure4', alpha = 0.4)+
  stat_ellipse(aes(x=Dead_Cells_Gamma_HighDose_4h  , y= avg_nfoci_Gamma_HighDose_4h), colour='dodgerblue1',level = 0.75)+geom_point(aes(x=Dead_Cells_Gamma_HighDose_4h  , y= avg_nfoci_Gamma_HighDose_4h),colour='dodgerblue1', alpha = 0.4)+
  labs(x="Normalized Percentage of Dead Cell", y="Normalized nb of RIF/nucleus") + theme(legend.direction = 'horizontal', legend.position = 'None') + ggtitle("DNA Damage (RIF) vs Dead Cell at 4h") 
  
CD_OS_4h_high <- ggplot(All_Pheno_Norm) + xlim(0, 2.5) + ylim(0, 4.5) +
  stat_ellipse(aes(x=Ox_Stress_Fe_HighDose_4h  , y= Dead_Cells_Fe_HighDose_4h), colour='firebrick1',level = 0.75)+geom_point(aes(x=Ox_Stress_Fe_HighDose_4h  , y= Dead_Cells_Fe_HighDose_4h),colour='firebrick1', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Ar_HighDose_4h  , y= Dead_Cells_Ar_HighDose_4h), colour='darkorange',level = 0.75)+geom_point(aes(x=Ox_Stress_Ar_HighDose_4h  , y= Dead_Cells_Ar_HighDose_4h),colour='darkorange', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Si_HighDose_4h  , y= Dead_Cells_Si_HighDose_4h), colour='azure4',level = 0.75)+geom_point(aes(x=Ox_Stress_Si_HighDose_4h  , y= Dead_Cells_Si_HighDose_4h),colour='azure4', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Gamma_HighDose_4h  , y= Dead_Cells_Gamma_HighDose_4h), colour='dodgerblue1',level = 0.75)+geom_point(aes(x=Ox_Stress_Gamma_HighDose_4h  , y= Dead_Cells_Gamma_HighDose_4h),colour='dodgerblue1', alpha = 0.4)+
  labs(x="Normalized Mean CellROX in live cells", y="Normalized Percentage of Dead Cell", col="Radiation & Doses") + theme(legend.direction = 'horizontal', legend.position = 'Left') + ggtitle("Dead Cell vs Oxidative Stress at 4h") 

Ellipses_4h_High<- grid.arrange(DD_OS_4h_high,DD_CD_4h_high, CD_OS_4h_high, ncol=3)
ggsave("Ellipses_4h_high.pdf", Ellipses_4h_low,  width = 31, height=9)


### Ellipses for low and high doses separately at 24h 
############ Low dose
DD_OS_24h_low <- ggplot(All_Pheno_Norm) + xlim(0, 2.5) + ylim(0, 3) +
  stat_ellipse(aes(x=Ox_Stress_Fe_LowDose_24h  , y= avg_nfoci_Fe_LowDose_24h), colour='firebrick1',level = 0.75)+geom_point(aes(x=Ox_Stress_Fe_LowDose_24h  , y= avg_nfoci_Fe_LowDose_24h),colour='firebrick1', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Ar_LowDose_24h  , y= avg_nfoci_Ar_LowDose_24h), colour='darkorange',level = 0.75)+geom_point(aes(x=Ox_Stress_Ar_LowDose_24h  , y= avg_nfoci_Ar_LowDose_24h), colour='darkorange', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Si_LowDose_24h  , y= avg_nfoci_Si_LowDose_24h), colour='azure4',level = 0.75)+geom_point(aes(x=Ox_Stress_Si_LowDose_24h  , y= avg_nfoci_Si_LowDose_24h), colour='azure4',alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Gamma_LowDose_24h  , y= avg_nfoci_Gamma_LowDose_24h), colour='dodgerblue1',level = 0.75)+geom_point(aes(x=Ox_Stress_Gamma_LowDose_24h  , y= avg_nfoci_Gamma_LowDose_24h),colour='dodgerblue1', alpha = 0.4)+
  labs(x="Normalized Mean CellROX in live cells", y="Normalized nb of RIF/nucleus") + theme(legend.direction = 'horizontal', legend.position = 'None') + ggtitle("DNA Damage (RIF) vs Oxidative Stress at 4h") 

DD_CD_24h_low <- ggplot(All_Pheno_Norm) + xlim(0, 4.5) + ylim(0, 3) +
  stat_ellipse(aes(x=Dead_Cells_Fe_LowDose_24h  , y= avg_nfoci_Fe_LowDose_24h), colour='firebrick1',level = 0.75)+geom_point(aes(x=Dead_Cells_Fe_LowDose_24h  , y= avg_nfoci_Fe_LowDose_24h),colour='firebrick1', alpha = 0.4)+
  stat_ellipse(aes(x=Dead_Cells_Ar_LowDose_24h  , y= avg_nfoci_Ar_LowDose_24h), colour='darkorange',level = 0.75)+geom_point(aes(x=Dead_Cells_Ar_LowDose_24h  , y= avg_nfoci_Ar_LowDose_24h), colour='darkorange', alpha = 0.4)+
  stat_ellipse(aes(x=Dead_Cells_Si_LowDose_24h  , y= avg_nfoci_Si_LowDose_24h), colour='azure4',level = 0.75)+geom_point(aes(x=Dead_Cells_Si_LowDose_24h  , y= avg_nfoci_Si_LowDose_24h),colour='azure4', alpha = 0.4)+
  stat_ellipse(aes(x=Dead_Cells_Gamma_LowDose_24h  , y= avg_nfoci_Gamma_LowDose_24h), colour='dodgerblue1',level = 0.75)+geom_point(aes(x=Dead_Cells_Gamma_LowDose_24h  , y= avg_nfoci_Gamma_LowDose_24h), colour='dodgerblue1',alpha = 0.4)+
  labs(x="Normalized Percentage of Dead Cell", y="Normalized nb of RIF/nucleus") + theme(legend.direction = 'horizontal', legend.position = 'None') + ggtitle("DNA Damage (RIF) vs Dead Cell at 4h") 
  
CD_OS_24h_low <- ggplot(All_Pheno_Norm) + xlim(0, 2.5) + ylim(0, 4.5) +
  stat_ellipse(aes(x=Ox_Stress_Fe_LowDose_24h  , y= Dead_Cells_Fe_LowDose_24h), colour='firebrick1',level = 0.75)+geom_point(aes(x=Ox_Stress_Fe_LowDose_24h  , y= Dead_Cells_Fe_LowDose_24h),colour='firebrick1', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Ar_LowDose_24h  , y= Dead_Cells_Ar_LowDose_24h), colour='darkorange',level = 0.75)+geom_point(aes(x=Ox_Stress_Ar_LowDose_24h  , y= Dead_Cells_Ar_LowDose_24h),colour='darkorange', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Si_LowDose_24h  , y= Dead_Cells_Si_LowDose_24h), colour='azure4',level = 0.75)+geom_point(aes(x=Ox_Stress_Si_LowDose_24h  , y= Dead_Cells_Si_LowDose_24h), colour='azure4',alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Gamma_LowDose_24h  , y= Dead_Cells_Gamma_LowDose_24h), colour='dodgerblue1',level = 0.75)+geom_point(aes(x=Ox_Stress_Gamma_LowDose_24h  , y= Dead_Cells_Gamma_LowDose_24h), colour='dodgerblue1',alpha = 0.4)+
  labs(x="Normalized Mean CellROX in live cells", y="Normalized Percentage of Dead Cell", col="Radiation & Doses") + theme(legend.direction = 'horizontal', legend.position = 'Left') + ggtitle("Dead Cell vs Oxidative Stress at 4h") 

Ellipses_24h_low <- grid.arrange(DD_OS_24h_low,DD_CD_24h_low, CD_OS_24h_low, ncol=3)
ggsave("Ellipses_24h_low.pdf", Ellipses_24h_low,  width = 31, height=9)

############ High dose
DD_OS_24h_high <- ggplot(All_Pheno_Norm) + xlim(0, 2.5) + ylim(0, 3) +
  stat_ellipse(aes(x=Ox_Stress_Fe_HighDose_24h  , y= avg_nfoci_Fe_HighDose_24h), colour='firebrick1',level = 0.75)+geom_point(aes(x=Ox_Stress_Fe_HighDose_24h  , y= avg_nfoci_Fe_HighDose_24h),colour='firebrick1', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Ar_HighDose_24h  , y= avg_nfoci_Ar_HighDose_24h), colour='darkorange',level = 0.75)+geom_point(aes(x=Ox_Stress_Ar_HighDose_24h  , y= avg_nfoci_Ar_HighDose_24h), colour='darkorange', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Si_HighDose_24h  , y= avg_nfoci_Si_HighDose_24h), colour='azure4',level = 0.75)+geom_point(aes(x=Ox_Stress_Si_HighDose_24h  , y= avg_nfoci_Si_HighDose_24h),colour='azure4', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Gamma_HighDose_24h  , y= avg_nfoci_Gamma_HighDose_24h), colour='dodgerblue1',level = 0.75)+geom_point(aes(x=Ox_Stress_Gamma_HighDose_24h  , y= avg_nfoci_Gamma_HighDose_24h),colour='dodgerblue1', alpha = 0.4)+
  labs(x="Normalized Mean CellROX in live cells", y="Normalized nb of RIF/nucleus") + theme(legend.direction = 'horizontal', legend.position = 'None') + ggtitle("DNA Damage (RIF) vs Oxidative Stress at 4h") 

DD_CD_24h_high <- ggplot(All_Pheno_Norm) + xlim(0, 4.5) + ylim(0, 3) +
  stat_ellipse(aes(x=Dead_Cells_Fe_HighDose_24h  , y= avg_nfoci_Fe_HighDose_24h), colour='firebrick1',level = 0.75)+geom_point(aes(x=Dead_Cells_Fe_HighDose_24h  , y= avg_nfoci_Fe_HighDose_24h),colour='firebrick1', alpha = 0.4)+
  stat_ellipse(aes(x=Dead_Cells_Ar_HighDose_24h  , y= avg_nfoci_Ar_HighDose_24h), colour='darkorange',level = 0.75)+geom_point(aes(x=Dead_Cells_Ar_HighDose_24h  , y= avg_nfoci_Ar_HighDose_24h), colour='darkorange', alpha = 0.4)+
  stat_ellipse(aes(x=Dead_Cells_Si_HighDose_24h  , y= avg_nfoci_Si_HighDose_24h), colour='azure4',level = 0.75)+geom_point(aes(x=Dead_Cells_Si_HighDose_24h  , y= avg_nfoci_Si_HighDose_24h),colour='azure4', alpha = 0.4)+
  stat_ellipse(aes(x=Dead_Cells_Gamma_HighDose_24h  , y= avg_nfoci_Gamma_HighDose_24h), colour='dodgerblue1',level = 0.75)+geom_point(aes(x=Dead_Cells_Gamma_HighDose_24h  , y= avg_nfoci_Gamma_HighDose_24h), colour='dodgerblue1',alpha = 0.4)+
  labs(x="Normalized Percentage of Dead Cell", y="Normalized nb of RIF/nucleus") + theme(legend.direction = 'horizontal', legend.position = 'None') + ggtitle("DNA Damage (RIF) vs Dead Cell at 4h") 
  
CD_OS_24h_high <- ggplot(All_Pheno_Norm) + xlim(0, 2.5) + ylim(0, 4.5) +
  stat_ellipse(aes(x=Ox_Stress_Fe_HighDose_24h  , y= Dead_Cells_Fe_HighDose_24h), colour='firebrick1',colour='firebrick1',level = 0.75)+geom_point(aes(x=Ox_Stress_Fe_HighDose_24h  , y= Dead_Cells_Fe_HighDose_24h),colour='firebrick1', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Ar_HighDose_24h  , y= Dead_Cells_Ar_HighDose_24h), colour='darkorange',level = 0.75)+geom_point(aes(x=Ox_Stress_Ar_HighDose_24h  , y= Dead_Cells_Ar_HighDose_24h), colour='darkorange', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Si_HighDose_24h  , y= Dead_Cells_Si_HighDose_24h), colour='azure4',level = 0.75)+geom_point(aes(x=Ox_Stress_Si_HighDose_24h  , y= Dead_Cells_Si_HighDose_24h),colour='azure4', alpha = 0.4)+
  stat_ellipse(aes(x=Ox_Stress_Gamma_HighDose_24h  , y= Dead_Cells_Gamma_HighDose_24h), colour='dodgerblue1',level = 0.75)+geom_point(aes(x=Ox_Stress_Gamma_HighDose_24h  , y= Dead_Cells_Gamma_HighDose_24h),colour='dodgerblue1', alpha = 0.4)+
  labs(x="Normalized Mean CellROX in live cells", y="Normalized Percentage of Dead Cell", col="Radiation & Doses") + theme(legend.direction = 'horizontal', legend.position = 'Left') + ggtitle("Dead Cell vs Oxidative Stress at 4h") 

Ellipses_24h_High<- grid.arrange(DD_OS_24h_high,DD_CD_24h_high, CD_OS_24h_high, ncol=3)
ggsave("Ellipses_24h_high.pdf", Ellipses_24h_low,  width = 31, height=9)

### graphs with ellipses: graphs separated for 4h and 24h display two phenotypes at a time (CD vs OS, CD vs DD, or DD vs OS) and with all radiation and fluences/doses

################## Time Point = _4h

DD_OS_4h <- ggplot(All_Pheno_Norm) + xlim(0, 2.5) + ylim(0, 3) +
  stat_ellipse(aes(x=Ox_Stress_Fe_LowDose_4h  , y= avg_nfoci_Fe_LowDose_4h), colour='firebrick1',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Fe_HighDose_4h  , y= avg_nfoci_Fe_HighDose_4h), colour='firebrick1',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Ox_Stress_Ar_LowDose_4h  , y= avg_nfoci_Ar_LowDose_4h), colour='darkorange',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Ar_HighDose_4h  , y= avg_nfoci_Ar_HighDose_4h), colour='darkorange',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Ox_Stress_Si_LowDose_4h  , y= avg_nfoci_Si_LowDose_4h), colour='azure4',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Si_HighDose_4h  , y= avg_nfoci_Si_HighDose_4h), colour='azure4',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Ox_Stress_Gamma_LowDose_4h  , y= avg_nfoci_Gamma_LowDose_4h), colour='dodgerblue1',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Gamma_HighDose_4h  , y= avg_nfoci_Gamma_HighDose_4h), colour='dodgerblue1',level = 0.75, linetype="dashed")+
  labs(x="Normalized Mean CellROX in live cells", y="Normalized nb of RIF/nucleus") + theme(legend.direction = 'horizontal', legend.position = 'None') + ggtitle("DNA Damage (RIF) vs Oxidative Stress at 4h") 

DD_CD_4h <- ggplot(All_Pheno_Norm) + xlim(0, 4.5) + ylim(0, 3) +
  stat_ellipse(aes(x=Dead_Cells_Fe_LowDose_4h  , y= avg_nfoci_Fe_LowDose_4h), colour='firebrick1',level = 0.75)+
  stat_ellipse(aes(x=Dead_Cells_Fe_HighDose_4h  , y= avg_nfoci_Fe_HighDose_4h), colour='firebrick1',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Dead_Cells_Ar_LowDose_4h  , y= avg_nfoci_Ar_LowDose_4h), colour='darkorange',level = 0.75)+
  stat_ellipse(aes(x=Dead_Cells_Ar_HighDose_4h  , y= avg_nfoci_Ar_HighDose_4h), colour='darkorange',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Dead_Cells_Si_LowDose_4h  , y= avg_nfoci_Si_LowDose_4h), colour='azure4',level = 0.75)+
  stat_ellipse(aes(x=Dead_Cells_Si_HighDose_4h  , y= avg_nfoci_Si_HighDose_4h), colour='azure4',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Dead_Cells_Gamma_LowDose_4h  , y= avg_nfoci_Gamma_LowDose_4h), colour='dodgerblue1',level = 0.75)+
  stat_ellipse(aes(x=Dead_Cells_Gamma_HighDose_4h  , y= avg_nfoci_Gamma_HighDose_4h), colour='dodgerblue1',level = 0.75, linetype="dashed")+
  labs(x="Normalized Percentage of Dead Cell", y="Normalized nb of RIF/nucleus") + theme(legend.direction = 'horizontal', legend.position = 'None') + ggtitle("DNA Damage (RIF) vs Dead Cell at 4h") 
  
CD_OS_4h <- ggplot(All_Pheno_Norm) + xlim(0, 2.5) + ylim(0, 4.5) +
  stat_ellipse(aes(x=Ox_Stress_Fe_LowDose_4h  , y= Dead_Cells_Fe_LowDose_4h), colour='firebrick1',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Fe_HighDose_4h  , y= Dead_Cells_Fe_HighDose_4h), colour='firebrick1',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Ox_Stress_Ar_LowDose_4h  , y= Dead_Cells_Ar_LowDose_4h), colour='darkorange',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Ar_HighDose_4h  , y= Dead_Cells_Ar_HighDose_4h), colour='darkorange',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Ox_Stress_Si_LowDose_4h  , y= Dead_Cells_Si_LowDose_4h), colour='azure4',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Si_HighDose_4h  , y= Dead_Cells_Si_HighDose_4h), colour='azure4',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Ox_Stress_Gamma_LowDose_4h  , y= Dead_Cells_Gamma_LowDose_4h), colour='dodgerblue1',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Gamma_HighDose_4h  , y= Dead_Cells_Gamma_HighDose_4h), colour='dodgerblue1',level = 0.75, linetype="dashed")+
  labs(x="Normalized Mean CellROX in live cells", y="Normalized Percentage of Dead Cell", col="Radiation & Doses") + theme(legend.direction = 'horizontal', legend.position = 'Left') + ggtitle("Dead Cell vs Oxidative Stress at 4h") 

Ellipses_4h <- grid.arrange(DD_OS_4h,DD_CD_4h, CD_OS_4h, ncol=3)
ggsave("Ellipses_low_and_high_doses_4h.pdf", Ellipses_4h,  width = 31, height=9)



################## Time Point = _24h

DD_OS_24h <- ggplot(All_Pheno_Norm) + xlim(0, 2.5) + ylim(0, 3) +
  stat_ellipse(aes(x=Ox_Stress_Fe_LowDose_24h  , y= avg_nfoci_Fe_LowDose_24h), colour='firebrick1',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Fe_HighDose_24h  , y= avg_nfoci_Fe_HighDose_24h), colour='firebrick1',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Ox_Stress_Ar_LowDose_24h  , y= avg_nfoci_Ar_LowDose_24h), colour='darkorange',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Ar_HighDose_24h  , y= avg_nfoci_Ar_HighDose_24h), colour='darkorange',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Ox_Stress_Si_LowDose_24h  , y= avg_nfoci_Si_LowDose_24h), colour='azure4',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Si_HighDose_24h  , y= avg_nfoci_Si_HighDose_24h), colour='azure4',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Ox_Stress_Gamma_LowDose_24h  , y= avg_nfoci_Gamma_LowDose_24h), colour='dodgerblue1',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Gamma_HighDose_24h  , y= avg_nfoci_Gamma_HighDose_24h), colour='dodgerblue1',level = 0.75, linetype="dashed")+
  labs(x="Normalized Mean CellROX in live cells", y="Normalized nb of RIF/nucleus") + theme(legend.direction = 'horizontal', legend.position = 'None') + ggtitle("DNA Damage (RIF) vs Oxidative Stress at 4h") 

DD_CD_24h <- ggplot(All_Pheno_Norm) + xlim(0, 4.5) + ylim(0, 3) +
  stat_ellipse(aes(x=Dead_Cells_Fe_LowDose_24h  , y= avg_nfoci_Fe_LowDose_24h), colour='firebrick1',level = 0.75)+
  stat_ellipse(aes(x=Dead_Cells_Fe_HighDose_24h  , y= avg_nfoci_Fe_HighDose_24h), colour='firebrick1',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Dead_Cells_Ar_LowDose_24h  , y= avg_nfoci_Ar_LowDose_24h), colour='darkorange',level = 0.75)+
  stat_ellipse(aes(x=Dead_Cells_Ar_HighDose_24h  , y= avg_nfoci_Ar_HighDose_24h), colour='darkorange',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Dead_Cells_Si_LowDose_24h  , y= avg_nfoci_Si_LowDose_24h), colour='azure4',level = 0.75)+
  stat_ellipse(aes(x=Dead_Cells_Si_HighDose_24h  , y= avg_nfoci_Si_HighDose_24h), colour='azure4',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Dead_Cells_Gamma_LowDose_24h  , y= avg_nfoci_Gamma_LowDose_24h), colour='dodgerblue1',level = 0.75)+
  stat_ellipse(aes(x=Dead_Cells_Gamma_HighDose_24h  , y= avg_nfoci_Gamma_HighDose_24h), colour='dodgerblue1',level = 0.75, linetype="dashed")+
  labs(x="Normalized Percentage of Dead Cell", y="Normalized nb of RIF/nucleus") + theme(legend.direction = 'horizontal', legend.position = 'None') + ggtitle("DNA Damage (RIF) vs Dead Cell at 4h") 
  
CD_OS_24h <- ggplot(All_Pheno_Norm) + xlim(0, 2.5) + ylim(0, 4.5) +
  stat_ellipse(aes(x=Ox_Stress_Fe_LowDose_24h  , y= Dead_Cells_Fe_LowDose_24h), colour='firebrick1',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Fe_HighDose_24h  , y= Dead_Cells_Fe_HighDose_24h), colour='firebrick1',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Ox_Stress_Ar_LowDose_24h  , y= Dead_Cells_Ar_LowDose_24h), colour='darkorange',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Ar_HighDose_24h  , y= Dead_Cells_Ar_HighDose_24h), colour='darkorange',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Ox_Stress_Si_LowDose_24h  , y= Dead_Cells_Si_LowDose_24h), colour='azure4',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Si_HighDose_24h  , y= Dead_Cells_Si_HighDose_24h), colour='azure4',level = 0.75, linetype="dashed")+
  stat_ellipse(aes(x=Ox_Stress_Gamma_LowDose_24h  , y= Dead_Cells_Gamma_LowDose_24h), colour='dodgerblue1',level = 0.75)+
  stat_ellipse(aes(x=Ox_Stress_Gamma_HighDose_24h  , y= Dead_Cells_Gamma_HighDose_24h), colour='dodgerblue1',level = 0.75, linetype="dashed")+
  labs(x="Normalized Mean CellROX in live cells", y="Normalized Percentage of Dead Cell", col="Radiation & Doses") + theme(legend.direction = 'horizontal', legend.position = 'Left') + ggtitle("Dead Cell vs Oxidative Stress at 4h") 

Ellipses_24h <- grid.arrange(DD_OS_24h,DD_CD_24h, CD_OS_24h, ncol=3)
ggsave("Ellipses_low_and_high_doses_24h.pdf", Ellipses_24h,  width = 31, height=9)

```


```{r}
##################################################################################################
###################### Radiation Responses: OS & DD Individual Analysis  #########################
##################################################################################################

# To do so we calculate for each phenotype the difference between high and low dose and then we will class them according to the following classes:
# (OS+,DD-) : oxidative stress increases with the dose and DNA decreases with the dose 
# (OS-,DD-) : Both oxidative stress and DNA damage decrease with the dose 
# (OS-,DD+) : oxidative stress decreases with the dose and DNA increases with the dose 
# (OS+,DD+) : Both oxidative stress and DNA damage increase with the dose 

Dose_Response = All_Pheno_Norm

########################## At _4h ##########################
## Oxidative Stress Response
Dose_Response$OS_Resp_Fe_4h = Dose_Response$Ox_Stress_Fe_HighDose_4h -Dose_Response$Ox_Stress_Fe_LowDose_4h
Dose_Response$OS_Resp_Ar_4h = Dose_Response$Ox_Stress_Ar_HighDose_4h -Dose_Response$Ox_Stress_Ar_LowDose_4h
Dose_Response$OS_Resp_Si_4h = Dose_Response$Ox_Stress_Si_HighDose_4h -Dose_Response$Ox_Stress_Si_LowDose_4h
Dose_Response$OS_Resp_Gamma_4h = Dose_Response$Ox_Stress_Gamma_HighDose_4h -Dose_Response$Ox_Stress_Gamma_LowDose_4h
## DNA Damage Response
Dose_Response$DD_Resp_Fe_4h = Dose_Response$avg_nfoci_Fe_HighDose_4h -Dose_Response$avg_nfoci_Fe_LowDose_4h
Dose_Response$DD_Resp_Ar_4h = Dose_Response$avg_nfoci_Ar_HighDose_4h -Dose_Response$avg_nfoci_Ar_LowDose_4h
Dose_Response$DD_Resp_Si_4h = Dose_Response$avg_nfoci_Si_HighDose_4h -Dose_Response$avg_nfoci_Si_LowDose_4h
Dose_Response$DD_Resp_Gamma_4h = Dose_Response$avg_nfoci_Gamma_HighDose_4h -Dose_Response$avg_nfoci_Gamma_LowDose_4h

########################## At _24h ##########################
## Oxidative Stress Response
Dose_Response$OS_Resp_Fe_24h = Dose_Response$Ox_Stress_Fe_HighDose_24h -Dose_Response$Ox_Stress_Fe_LowDose_24h
Dose_Response$OS_Resp_Ar_24h = Dose_Response$Ox_Stress_Ar_HighDose_24h -Dose_Response$Ox_Stress_Ar_LowDose_24h
Dose_Response$OS_Resp_Si_24h = Dose_Response$Ox_Stress_Si_HighDose_24h -Dose_Response$Ox_Stress_Si_LowDose_24h
Dose_Response$OS_Resp_Gamma_24h = Dose_Response$Ox_Stress_Gamma_HighDose_24h -Dose_Response$Ox_Stress_Gamma_LowDose_24h
## DNA Damage Response
Dose_Response$DD_Resp_Fe_24h = Dose_Response$avg_nfoci_Fe_HighDose_24h -Dose_Response$avg_nfoci_Fe_LowDose_24h
Dose_Response$DD_Resp_Ar_24h = Dose_Response$avg_nfoci_Ar_HighDose_24h -Dose_Response$avg_nfoci_Ar_LowDose_24h
Dose_Response$DD_Resp_Si_24h = Dose_Response$avg_nfoci_Si_HighDose_24h -Dose_Response$avg_nfoci_Si_LowDose_24h
Dose_Response$DD_Resp_Gamma_24h = Dose_Response$avg_nfoci_Gamma_HighDose_24h -Dose_Response$avg_nfoci_Gamma_LowDose_24h
#
Dose_Response=Dose_Response[,grepl("Sample_ID|_Resp|Gender|Age|BMI_group|Run_Set", colnames(Dose_Response))]
#
########################## At _4h ##########################
############# Fe 
Response_Fe_4h=Dose_Response[,grepl("Sample_ID|_Fe_4h|Gender|Age|BMI_group|Run_Set", colnames(Dose_Response))]
Response_Fe_4h=NaRV.omit(Response_Fe_4h)
# OSvsDD
for (i in 1:nrow(Response_Fe_4h)){
  if(Response_Fe_4h$OS_Resp_Fe_4h[i] <= 0 && Response_Fe_4h$DD_Resp_Fe_4h[i] >0){
    Response_Fe_4h$Class_OS_DD[i]= list.append("(OS-,DD+)")}
    if(Response_Fe_4h$OS_Resp_Fe_4h[i] > 0 && Response_Fe_4h$DD_Resp_Fe_4h[i] >0){
    Response_Fe_4h$Class_OS_DD[i]= list.append("(OS+,DD+)")}
    if(Response_Fe_4h$OS_Resp_Fe_4h[i] > 0 && Response_Fe_4h$DD_Resp_Fe_4h[i] <= 0){
    Response_Fe_4h$Class_OS_DD[i]= list.append("(OS+,DD-)")}
    if(Response_Fe_4h$OS_Resp_Fe_4h[i] <= 0 && Response_Fe_4h$DD_Resp_Fe_4h[i] <= 0){
    Response_Fe_4h$Class_OS_DD[i]= list.append("(OS-,DD-)")}}

OS_DD_Fe_4h <- ggplot(Response_Fe_4h) + xlim(-2,2.5) + ylim(-2,4) + geom_point(aes(x=OS_Resp_Fe_4h, y=DD_Resp_Fe_4h, color=Class_OS_DD))+ 
  geom_vline(xintercept=0,color="brown1", size=0.2) + geom_hline(yintercept =0, color="brown1", size=0.2) +
  scale_color_manual(breaks = c("(OS-,DD+)", "(OS+,DD+)", "(OS+,DD-)", "(OS-,DD-)"), values=c("#FF3333","#FF9900", "#3333FF", "#33CC99"))+
  labs(x = "Normalized Mean CellROX in live Cells difference between High and Low dose", y = "Difference of Normalized RIF/nucleus between High and Low dose ",colour="Dose responses", shape = "Transmission") + ggtitle("DD vs OS dose reponses for Fe at 4h") + theme(legend.position = 'bottom')+ theme(axis.title.x = element_text(size = 12, face = "bold")) + theme(axis.title.y = element_text(size = 12, face = "bold"))  + theme(legend.title = element_text(size = 12)) + theme(legend.text = element_text(size = 12))
ggsave("OS_DD_Dose_Response_Fe_4h.pdf", OS_DD_Fe_4h,width = 15, height=13)


############# Ar 
Response_Ar_4h=Dose_Response[,grepl("Sample_ID|_Ar_4h|Gender|Age|BMI_group|Run_Set", colnames(Dose_Response))]
Response_Ar_4h=NaRV.omit(Response_Ar_4h)
# OSvsDD
for (i in 1:nrow(Response_Ar_4h)){
  if(Response_Ar_4h$OS_Resp_Ar_4h[i] <= 0 && Response_Ar_4h$DD_Resp_Ar_4h[i] >0){
    Response_Ar_4h$Class_OS_DD[i]= list.append("(OS-,DD+)")}
    if(Response_Ar_4h$OS_Resp_Ar_4h[i] > 0 && Response_Ar_4h$DD_Resp_Ar_4h[i] >0){
    Response_Ar_4h$Class_OS_DD[i]= list.append("(OS+,DD+)")}
    if(Response_Ar_4h$OS_Resp_Ar_4h[i] > 0 && Response_Ar_4h$DD_Resp_Ar_4h[i] <= 0){
    Response_Ar_4h$Class_OS_DD[i]= list.append("(OS+,DD-)")}
    if(Response_Ar_4h$OS_Resp_Ar_4h[i] <= 0 && Response_Ar_4h$DD_Resp_Ar_4h[i] <= 0){
    Response_Ar_4h$Class_OS_DD[i]= list.append("(OS-,DD-)")}}

OS_DD_Ar_4h <- ggplot(Response_Ar_4h) + xlim(-2,2.5) + ylim(-2,4) + geom_point(aes(x=OS_Resp_Ar_4h, y=DD_Resp_Ar_4h, color=Class_OS_DD))+ 
  geom_vline(xintercept=0,color="brown1", size=0.2) + geom_hline(yintercept =0, color="brown1", size=0.2) +
  scale_color_manual(breaks = c("(OS-,DD+)", "(OS+,DD+)", "(OS+,DD-)", "(OS-,DD-)"), values=c("#FF3333","#FF9900", "#3333FF", "#33CC99"))+
  labs(x = "Normalized Mean CellROX in live Cells difArrence between High and Low dose", y = "DifArrence of Normalized RIF/nucleus between High and Low dose ",colour="Dose responses", shape = "Transmission") + ggtitle("DD vs OS dose reponses for Ar at 4h") + theme(legend.position = 'bottom')+ theme(axis.title.x = element_text(size = 12, face = "bold")) + theme(axis.title.y = element_text(size = 12, face = "bold"))  + theme(legend.title = element_text(size = 12)) + theme(legend.text = element_text(size = 12))
ggsave("OS_DD_Dose_Response_Ar_4h.pdf", OS_DD_Ar_4h,width = 15, height=13)

############# Si 
Response_Si_4h=Dose_Response[,grepl("Sample_ID|_Si_4h|Gender|Age|BMI_group|Run_Set", colnames(Dose_Response))]
Response_Si_4h=NaRV.omit(Response_Si_4h)
# OSvsDD
for (i in 1:nrow(Response_Si_4h)){
  if(Response_Si_4h$OS_Resp_Si_4h[i] <= 0 && Response_Si_4h$DD_Resp_Si_4h[i] >0){
    Response_Si_4h$Class_OS_DD[i]= list.append("(OS-,DD+)")}
    if(Response_Si_4h$OS_Resp_Si_4h[i] > 0 && Response_Si_4h$DD_Resp_Si_4h[i] >0){
    Response_Si_4h$Class_OS_DD[i]= list.append("(OS+,DD+)")}
    if(Response_Si_4h$OS_Resp_Si_4h[i] > 0 && Response_Si_4h$DD_Resp_Si_4h[i] <= 0){
    Response_Si_4h$Class_OS_DD[i]= list.append("(OS+,DD-)")}
    if(Response_Si_4h$OS_Resp_Si_4h[i] <= 0 && Response_Si_4h$DD_Resp_Si_4h[i] <= 0){
    Response_Si_4h$Class_OS_DD[i]= list.append("(OS-,DD-)")}}

OS_DD_Si_4h <- ggplot(Response_Si_4h) + xlim(-2,2.5) + ylim(-2,4) + geom_point(aes(x=OS_Resp_Si_4h, y=DD_Resp_Si_4h, color=Class_OS_DD))+ 
  geom_vline(xintercept=0,color="brown1", size=0.2) + geom_hline(yintercept =0, color="brown1", size=0.2) +
  scale_color_manual(breaks = c("(OS-,DD+)", "(OS+,DD+)", "(OS+,DD-)", "(OS-,DD-)"), values=c("#FF3333","#FF9900", "#3333FF", "#33CC99"))+
  labs(x = "Normalized Mean CellROX in live Cells difSirence between High and Low dose", y = "DifSirence of Normalized RIF/nucleus between High and Low dose ",colour="Dose responses", shape = "Transmission") + ggtitle("DD vs OS dose reponses for Si at 4h") + theme(legend.position = 'bottom')+ theme(axis.title.x = element_text(size = 12, face = "bold")) + theme(axis.title.y = element_text(size = 12, face = "bold"))  + theme(legend.title = element_text(size = 12)) + theme(legend.text = element_text(size = 12))
ggsave("OS_DD_Dose_Response_Si_4h.pdf", OS_DD_Si_4h,width = 15, height=13)


############# Gamma 
Response_Gamma_4h=Dose_Response[,grepl("Sample_ID|_Gamma_4h|Gender|Age|BMI_group|Run_Set", colnames(Dose_Response))]
Response_Gamma_4h=NaRV.omit(Response_Gamma_4h)
# OSvsDD
for (i in 1:nrow(Response_Gamma_4h)){
  if(Response_Gamma_4h$OS_Resp_Gamma_4h[i] <= 0 && Response_Gamma_4h$DD_Resp_Gamma_4h[i] >0){
    Response_Gamma_4h$Class_OS_DD[i]= list.append("(OS-,DD+)")}
    if(Response_Gamma_4h$OS_Resp_Gamma_4h[i] > 0 && Response_Gamma_4h$DD_Resp_Gamma_4h[i] >0){
    Response_Gamma_4h$Class_OS_DD[i]= list.append("(OS+,DD+)")}
    if(Response_Gamma_4h$OS_Resp_Gamma_4h[i] > 0 && Response_Gamma_4h$DD_Resp_Gamma_4h[i] <= 0){
    Response_Gamma_4h$Class_OS_DD[i]= list.append("(OS+,DD-)")}
    if(Response_Gamma_4h$OS_Resp_Gamma_4h[i] <= 0 && Response_Gamma_4h$DD_Resp_Gamma_4h[i] <= 0){
    Response_Gamma_4h$Class_OS_DD[i]= list.append("(OS-,DD-)")}}

OS_DD_Gamma_4h <- ggplot(Response_Gamma_4h) + xlim(-2,2.5) + ylim(-2,4) + geom_point(aes(x=OS_Resp_Gamma_4h, y=DD_Resp_Gamma_4h, color=Class_OS_DD))+ 
  geom_vline(xintercept=0,color="brown1", size=0.2) + geom_hline(yintercept =0, color="brown1", size=0.2) +
  scale_color_manual(breaks = c("(OS-,DD+)", "(OS+,DD+)", "(OS+,DD-)", "(OS-,DD-)"), values=c("#FF3333","#FF9900", "#3333FF", "#33CC99"))+
  labs(x = "Normalized Mean CellROX in live Cells difGammarence between High and Low dose", y = "DifGammarence of Normalized RIF/nucleus between High and Low dose ",colour="Dose responses", shape = "Transmission") + ggtitle("DD vs OS dose reponses for Gamma at 4h") + theme(legend.position = 'bottom')+ theme(axis.title.x = element_text(size = 12, face = "bold")) + theme(axis.title.y = element_text(size = 12, face = "bold"))  + theme(legend.title = element_text(size = 12)) + theme(legend.text = element_text(size = 12))
ggsave("OS_DD_Dose_Response_Gamma_4h.pdf", OS_DD_Gamma_4h,width = 15, height=13)


########################## At _24h ##########################
############# Fe 
Response_Fe_24h=Dose_Response[,grepl("Sample_ID|_Fe_24h|Gender|Age|BMI_group|Run_Set", colnames(Dose_Response))]
Response_Fe_24h=NaRV.omit(Response_Fe_24h)
# OSvsDD
for (i in 1:nrow(Response_Fe_24h)){
  if(Response_Fe_24h$OS_Resp_Fe_24h[i] <= 0 && Response_Fe_24h$DD_Resp_Fe_24h[i] >0){
    Response_Fe_24h$Class_OS_DD[i]= list.append("(OS-,DD+)")}
    if(Response_Fe_24h$OS_Resp_Fe_24h[i] > 0 && Response_Fe_24h$DD_Resp_Fe_24h[i] >0){
    Response_Fe_24h$Class_OS_DD[i]= list.append("(OS+,DD+)")}
    if(Response_Fe_24h$OS_Resp_Fe_24h[i] > 0 && Response_Fe_24h$DD_Resp_Fe_24h[i] <= 0){
    Response_Fe_24h$Class_OS_DD[i]= list.append("(OS+,DD-)")}
    if(Response_Fe_24h$OS_Resp_Fe_24h[i] <= 0 && Response_Fe_24h$DD_Resp_Fe_24h[i] <= 0){
    Response_Fe_24h$Class_OS_DD[i]= list.append("(OS-,DD-)")}}

OS_DD_Fe_24h <- ggplot(Response_Fe_24h) + xlim(-2,2.5) + ylim(-2,4) + geom_point(aes(x=OS_Resp_Fe_24h, y=DD_Resp_Fe_24h, color=Class_OS_DD))+ 
  geom_vline(xintercept=0,color="brown1", size=0.2) + geom_hline(yintercept =0, color="brown1", size=0.2) +
  scale_color_manual(breaks = c("(OS-,DD+)", "(OS+,DD+)", "(OS+,DD-)", "(OS-,DD-)"), values=c("#FF3333","#FF9900", "#3333FF", "#33CC99"))+
  labs(x = "Normalized Mean CellROX in live Cells difference between High and Low dose", y = "Difference of Normalized RIF/nucleus between High and Low dose ",colour="Dose responses", shape = "Transmission") + ggtitle("DD vs OS dose reponses for Fe at 4h") + theme(legend.position = 'bottom')+ theme(axis.title.x = element_text(size = 12, face = "bold")) + theme(axis.title.y = element_text(size = 12, face = "bold"))  + theme(legend.title = element_text(size = 12)) + theme(legend.text = element_text(size = 12))
ggsave("OS_DD_Dose_Response_Fe_24h.pdf", OS_DD_Fe_24h,width = 15, height=13)


############# Ar 
Response_Ar_24h=Dose_Response[,grepl("Sample_ID|_Ar_24h|Gender|Age|BMI_group|Run_Set", colnames(Dose_Response))]
Response_Ar_24h=NaRV.omit(Response_Ar_24h)
# OSvsDD
for (i in 1:nrow(Response_Ar_24h)){
  if(Response_Ar_24h$OS_Resp_Ar_24h[i] <= 0 && Response_Ar_24h$DD_Resp_Ar_24h[i] >0){
    Response_Ar_24h$Class_OS_DD[i]= list.append("(OS-,DD+)")}
    if(Response_Ar_24h$OS_Resp_Ar_24h[i] > 0 && Response_Ar_24h$DD_Resp_Ar_24h[i] >0){
    Response_Ar_24h$Class_OS_DD[i]= list.append("(OS+,DD+)")}
    if(Response_Ar_24h$OS_Resp_Ar_24h[i] > 0 && Response_Ar_24h$DD_Resp_Ar_24h[i] <= 0){
    Response_Ar_24h$Class_OS_DD[i]= list.append("(OS+,DD-)")}
    if(Response_Ar_24h$OS_Resp_Ar_24h[i] <= 0 && Response_Ar_24h$DD_Resp_Ar_24h[i] <= 0){
    Response_Ar_24h$Class_OS_DD[i]= list.append("(OS-,DD-)")}}

OS_DD_Ar_24h <- ggplot(Response_Ar_24h) + xlim(-2,2.5) + ylim(-2,4) + geom_point(aes(x=OS_Resp_Ar_24h, y=DD_Resp_Ar_24h, color=Class_OS_DD))+ 
  geom_vline(xintercept=0,color="brown1", size=0.2) + geom_hline(yintercept =0, color="brown1", size=0.2) +
  scale_color_manual(breaks = c("(OS-,DD+)", "(OS+,DD+)", "(OS+,DD-)", "(OS-,DD-)"), values=c("#FF3333","#FF9900", "#3333FF", "#33CC99"))+
  labs(x = "Normalized Mean CellROX in live Cells difArrence between High and Low dose", y = "DifArrence of Normalized RIF/nucleus between High and Low dose ",colour="Dose responses", shape = "Transmission") + ggtitle("DD vs OS dose reponses for Ar at 4h") + theme(legend.position = 'bottom')+ theme(axis.title.x = element_text(size = 12, face = "bold")) + theme(axis.title.y = element_text(size = 12, face = "bold"))  + theme(legend.title = element_text(size = 12)) + theme(legend.text = element_text(size = 12))
ggsave("OS_DD_Dose_Response_Ar_24h.pdf", OS_DD_Ar_24h,width = 15, height=13)

############# Si 
Response_Si_24h=Dose_Response[,grepl("Sample_ID|_Si_24h|Gender|Age|BMI_group|Run_Set", colnames(Dose_Response))]
Response_Si_24h=NaRV.omit(Response_Si_24h)
# OSvsDD
for (i in 1:nrow(Response_Si_24h)){
  if(Response_Si_24h$OS_Resp_Si_24h[i] <= 0 && Response_Si_24h$DD_Resp_Si_24h[i] >0){
    Response_Si_24h$Class_OS_DD[i]= list.append("(OS-,DD+)")}
    if(Response_Si_24h$OS_Resp_Si_24h[i] > 0 && Response_Si_24h$DD_Resp_Si_24h[i] >0){
    Response_Si_24h$Class_OS_DD[i]= list.append("(OS+,DD+)")}
    if(Response_Si_24h$OS_Resp_Si_24h[i] > 0 && Response_Si_24h$DD_Resp_Si_24h[i] <= 0){
    Response_Si_24h$Class_OS_DD[i]= list.append("(OS+,DD-)")}
    if(Response_Si_24h$OS_Resp_Si_24h[i] <= 0 && Response_Si_24h$DD_Resp_Si_24h[i] <= 0){
    Response_Si_24h$Class_OS_DD[i]= list.append("(OS-,DD-)")}}

OS_DD_Si_24h <- ggplot(Response_Si_24h) + xlim(-2,2.5) + ylim(-2,4) + geom_point(aes(x=OS_Resp_Si_24h, y=DD_Resp_Si_24h, color=Class_OS_DD))+ 
  geom_vline(xintercept=0,color="brown1", size=0.2) + geom_hline(yintercept =0, color="brown1", size=0.2) +
  scale_color_manual(breaks = c("(OS-,DD+)", "(OS+,DD+)", "(OS+,DD-)", "(OS-,DD-)"), values=c("#FF3333","#FF9900", "#3333FF", "#33CC99"))+
  labs(x = "Normalized Mean CellROX in live Cells difSirence between High and Low dose", y = "DifSirence of Normalized RIF/nucleus between High and Low dose ",colour="Dose responses", shape = "Transmission") + ggtitle("DD vs OS dose reponses for Si at 4h") + theme(legend.position = 'bottom')+ theme(axis.title.x = element_text(size = 12, face = "bold")) + theme(axis.title.y = element_text(size = 12, face = "bold"))  + theme(legend.title = element_text(size = 12)) + theme(legend.text = element_text(size = 12))
ggsave("OS_DD_Dose_Response_Si_24h.pdf", OS_DD_Si_24h,width = 15, height=13)


############# Gamma 
Response_Gamma_24h=Dose_Response[,grepl("Sample_ID|_Gamma_24h|Gender|Age|BMI_group|Run_Set", colnames(Dose_Response))]
Response_Gamma_24h=NaRV.omit(Response_Gamma_24h)
# OSvsDD
for (i in 1:nrow(Response_Gamma_24h)){
  if(Response_Gamma_24h$OS_Resp_Gamma_24h[i] <= 0 && Response_Gamma_24h$DD_Resp_Gamma_24h[i] >0){
    Response_Gamma_24h$Class_OS_DD[i]= list.append("(OS-,DD+)")}
    if(Response_Gamma_24h$OS_Resp_Gamma_24h[i] > 0 && Response_Gamma_24h$DD_Resp_Gamma_24h[i] >0){
    Response_Gamma_24h$Class_OS_DD[i]= list.append("(OS+,DD+)")}
    if(Response_Gamma_24h$OS_Resp_Gamma_24h[i] > 0 && Response_Gamma_24h$DD_Resp_Gamma_24h[i] <= 0){
    Response_Gamma_24h$Class_OS_DD[i]= list.append("(OS+,DD-)")}
    if(Response_Gamma_24h$OS_Resp_Gamma_24h[i] <= 0 && Response_Gamma_24h$DD_Resp_Gamma_24h[i] <= 0){
    Response_Gamma_24h$Class_OS_DD[i]= list.append("(OS-,DD-)")}}

OS_DD_Gamma_24h <- ggplot(Response_Gamma_24h) + xlim(-2,2.5) + ylim(-2,4) + geom_point(aes(x=OS_Resp_Gamma_24h, y=DD_Resp_Gamma_24h, color=Class_OS_DD))+ 
  geom_vline(xintercept=0,color="brown1", size=0.2) + geom_hline(yintercept =0, color="brown1", size=0.2) +
  scale_color_manual(breaks = c("(OS-,DD+)", "(OS+,DD+)", "(OS+,DD-)", "(OS-,DD-)"), values=c("#FF3333","#FF9900", "#3333FF", "#33CC99"))+
  labs(x = "Normalized Mean CellROX in live Cells difGammarence between High and Low dose", y = "DifGammarence of Normalized RIF/nucleus between High and Low dose ",colour="Dose responses", shape = "Transmission") + ggtitle("DD vs OS dose reponses for Gamma at 4h") + theme(legend.position = 'bottom')+ theme(axis.title.x = element_text(size = 12, face = "bold")) + theme(axis.title.y = element_text(size = 12, face = "bold"))  + theme(legend.title = element_text(size = 12)) + theme(legend.text = element_text(size = 12))
ggsave("OS_DD_Dose_Response_Gamma_24h.pdf", OS_DD_Gamma_24h,width = 15, height=13)

```



```{r}
##################################################################################################
###################### Baselines & Radiation Responses: Combined Analysis  #######################
##################################################################################################
All_Pheno_baseline=merge(All_Pheno_Norm, Baseline_DNA_damage, by="Sample_ID")
All_Pheno_baseline_4h = All_Pheno_baseline[,grepl("Sample_ID|_4h", colnames(All_Pheno_baseline))]
All_Pheno_baseline_24h = All_Pheno_baseline[,grepl("Sample_ID|_24h", colnames(All_Pheno_baseline))]


############# at 4h post-irradiation
### DNA damage and baseline 
# Fe----------------
Fe_RIF_Baseline= All_Pheno_baseline_4h[, grepl("Sample_ID|avg_nfoci_Fe", colnames(All_Pheno_baseline_4h))]
Fe_RIF_Baseline=NaRV.omit(Fe_RIF_Baseline)
Fe_RIF_Baseline$DD_response <- NA

for(i in 1:nrow(Fe_RIF_Baseline)){ # We will only consider individuals with increasing RIF with dose
  if ((Fe_RIF_Baseline$avg_nfoci_Fe_HighDose_4h[i] - Fe_RIF_Baseline$avg_nfoci_Fe_LowDose_4h[i]) >= 0){
   Fe_RIF_Baseline$DD_response[i] = "DD+"
  }
}
Fe_RIF_Baseline=NaRV.omit(Fe_RIF_Baseline)
Fe_RIF_Baseline$DD_response=NULL

Fe_RIF_Baseline$DD_Ratio = Fe_RIF_Baseline$avg_nfoci_Fe_HighDose_4h/Fe_RIF_Baseline$avg_nfoci_Fe_LowDose_4h
Fe_RIF_Baseline=merge(Fe_RIF_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Fe_RIF_Baseline=NaRV.omit(Fe_RIF_Baseline)
Fe_RIF_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Fe_RIF_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Fe_RIF_Baseline)){
  if (Fe_RIF_Baseline$baseline_nfoci[i] <= LB){
    Fe_RIF_Baseline$baseline_Level[i] = "Low Baseline"
  }
  if (Fe_RIF_Baseline$baseline_nfoci[i] >= HB){
    Fe_RIF_Baseline$baseline_Level[i] = "High Baseline"
  }
}

Fe_RIF_Baseline= NaRV.omit(Fe_RIF_Baseline)
Fe_RIF_Baseline$Baseline_Level=factor(Fe_RIF_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

Ratio_DD_Baseline_Level_Fe <- plot_ly(data = Fe_RIF_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ DD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red")) %>% layout(title="56Fe", yaxis=list(title="Ratio of RIF at high versus low fluence",range=c(1,2), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE), xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
print(Ratio_DD_Baseline_Level_Fe)
hide_legend(Ratio_DD_Baseline_Level_Fe)
orca(Ratio_DD_Baseline_Level_Fe, "Ratio_DD_Baseline_Level_Fe_4h.pdf")

# Calculate median ratio
# Low Baseline group-------------------------------
Fe_RIF_Baseline_Low <- Fe_RIF_Baseline[Fe_RIF_Baseline$Baseline_Level == "Low Baseline",]
median_baseline_low = median(Fe_RIF_Baseline_Low$DD_Ratio)
print(median_baseline_low)
# Low Baseline group-------------------------------
Fe_RIF_Baseline_High <- Fe_RIF_Baseline[Fe_RIF_Baseline$Baseline_Level == "High Baseline",]
median_baseline_high = median(Fe_RIF_Baseline_High$DD_Ratio)
print(median_baseline_high)

###  Statistical analysis 
test_Fe <- t.test(Fe_RIF_Baseline$DD_Ratio ~Fe_RIF_Baseline$Baseline_Level)
print(test_Fe )

# Ar----------------
Ar_RIF_Baseline= All_Pheno_baseline_4h[, grepl("Sample_ID|avg_nfoci_Ar", colnames(All_Pheno_baseline_4h))]
Ar_RIF_Baseline=NaRV.omit(Ar_RIF_Baseline)
Ar_RIF_Baseline$DD_response <- NA

for(i in 1:nrow(Ar_RIF_Baseline)){ # We will only consider individuals with increasing RIF with dose
  if ((Ar_RIF_Baseline$avg_nfoci_Ar_HighDose_4h[i] - Ar_RIF_Baseline$avg_nfoci_Ar_LowDose_4h[i]) >= 0){
   Ar_RIF_Baseline$DD_response[i] = "DD+"
  }
}
Ar_RIF_Baseline=NaRV.omit(Ar_RIF_Baseline)
Ar_RIF_Baseline$DD_response=NULL

Ar_RIF_Baseline$DD_Ratio = Ar_RIF_Baseline$avg_nfoci_Ar_HighDose_4h/Ar_RIF_Baseline$avg_nfoci_Ar_LowDose_4h
Ar_RIF_Baseline=merge(Ar_RIF_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Ar_RIF_Baseline=NaRV.omit(Ar_RIF_Baseline)
Ar_RIF_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Ar_RIF_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Ar_RIF_Baseline)){
  if (Ar_RIF_Baseline$baseline_nfoci[i] <= LB){
    Ar_RIF_Baseline$baseline_Level[i] = "Low Baseline"
  }
  if (Ar_RIF_Baseline$baseline_nfoci[i] >= HB){
    Ar_RIF_Baseline$baseline_Level[i] = "High Baseline"
  }
}

Ar_RIF_Baseline= NaRV.omit(Ar_RIF_Baseline)
Ar_RIF_Baseline$Baseline_Level=factor(Ar_RIF_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

Ratio_DD_Baseline_Level_Ar <- plot_ly(data = Ar_RIF_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ DD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red")) %>% layout(title="56Ar", yaxis=list(title="Ratio of RIF at high versus low fluence",range=c(1,2), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE), xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
print(Ratio_DD_Baseline_Level_Ar)
hide_legend(Ratio_DD_Baseline_Level_Ar)
orca(Ratio_DD_Baseline_Level_Ar, "Ratio_DD_Baseline_Level_Ar_4h.pdf")

# Calculate median ratio
# Low Baseline group-------------------------------
Ar_RIF_Baseline_Low <- Ar_RIF_Baseline[Ar_RIF_Baseline$Baseline_Level == "Low Baseline",]
median_baseline_low = median(Ar_RIF_Baseline_Low$DD_Ratio)
print(median_baseline_low)
# Low Baseline group-------------------------------
Ar_RIF_Baseline_High <- Ar_RIF_Baseline[Ar_RIF_Baseline$Baseline_Level == "High Baseline",]
median_baseline_high = median(Ar_RIF_Baseline_High$DD_Ratio)
print(median_baseline_high)

###  Statistical analysis 
test_Ar <- t.test(Ar_RIF_Baseline$DD_Ratio ~Ar_RIF_Baseline$Baseline_Level)
print(test_Ar )


# Si----------------
Si_RIF_Baseline= All_Pheno_baseline_4h[, grepl("Sample_ID|avg_nfoci_Si", colnames(All_Pheno_baseline_4h))]
Si_RIF_Baseline=NaRV.omit(Si_RIF_Baseline)
Si_RIF_Baseline$DD_response <- NA

for(i in 1:nrow(Si_RIF_Baseline)){ # We will only consider individuals with increasing RIF with dose
  if ((Si_RIF_Baseline$avg_nfoci_Si_HighDose_4h[i] - Si_RIF_Baseline$avg_nfoci_Si_LowDose_4h[i]) >= 0){
   Si_RIF_Baseline$DD_response[i] = "DD+"
  }
}
Si_RIF_Baseline=NaRV.omit(Si_RIF_Baseline)
Si_RIF_Baseline$DD_response=NULL

Si_RIF_Baseline$DD_Ratio = Si_RIF_Baseline$avg_nfoci_Si_HighDose_4h/Si_RIF_Baseline$avg_nfoci_Si_LowDose_4h
Si_RIF_Baseline=merge(Si_RIF_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Si_RIF_Baseline=NaRV.omit(Si_RIF_Baseline)
Si_RIF_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Si_RIF_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Si_RIF_Baseline)){
  if (Si_RIF_Baseline$baseline_nfoci[i] <= LB){
    Si_RIF_Baseline$baseline_Level[i] = "Low Baseline"
  }
  if (Si_RIF_Baseline$baseline_nfoci[i] >= HB){
    Si_RIF_Baseline$baseline_Level[i] = "High Baseline"
  }
}

Si_RIF_Baseline= NaRV.omit(Si_RIF_Baseline)
Si_RIF_Baseline$Baseline_Level=factor(Si_RIF_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

Ratio_DD_Baseline_Level_Si <- plot_ly(data = Si_RIF_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ DD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red")) %>% layout(title="56Si", yaxis=list(title="Ratio of RIF at high versus low fluence",range=c(1,2), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE), xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
print(Ratio_DD_Baseline_Level_Si)
hide_legend(Ratio_DD_Baseline_Level_Si)
orca(Ratio_DD_Baseline_Level_Si, "Ratio_DD_Baseline_Level_Si_4h.pdf")

# Calculate median ratio
# Low Baseline group-------------------------------
Si_RIF_Baseline_Low <- Si_RIF_Baseline[Si_RIF_Baseline$Baseline_Level == "Low Baseline",]
median_baseline_low = median(Si_RIF_Baseline_Low$DD_Ratio)
print(median_baseline_low)
# Low Baseline group-------------------------------
Si_RIF_Baseline_High <- Si_RIF_Baseline[Si_RIF_Baseline$Baseline_Level == "High Baseline",]
median_baseline_high = median(Si_RIF_Baseline_High$DD_Ratio)
print(median_baseline_high)

###  Statistical analysis 
test_Si <- t.test(Si_RIF_Baseline$DD_Ratio ~Si_RIF_Baseline$Baseline_Level)
print(test_Si )

# Gamma----------------
Gamma_RIF_Baseline= All_Pheno_baseline_4h[, grepl("Sample_ID|avg_nfoci_Gamma", colnames(All_Pheno_baseline_4h))]
Gamma_RIF_Baseline=NaRV.omit(Gamma_RIF_Baseline)
Gamma_RIF_Baseline$DD_response <- NA

for(i in 1:nrow(Gamma_RIF_Baseline)){ # We will only consider individuals with increasing RIF with dose
  if ((Gamma_RIF_Baseline$avg_nfoci_Gamma_HighDose_4h[i] - Gamma_RIF_Baseline$avg_nfoci_Gamma_LowDose_4h[i]) >= 0){
   Gamma_RIF_Baseline$DD_response[i] = "DD+"
  }
}
Gamma_RIF_Baseline=NaRV.omit(Gamma_RIF_Baseline)
Gamma_RIF_Baseline$DD_response=NULL

Gamma_RIF_Baseline$DD_Ratio = Gamma_RIF_Baseline$avg_nfoci_Gamma_HighDose_4h/Gamma_RIF_Baseline$avg_nfoci_Gamma_LowDose_4h
Gamma_RIF_Baseline=merge(Gamma_RIF_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Gamma_RIF_Baseline=NaRV.omit(Gamma_RIF_Baseline)
Gamma_RIF_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Gamma_RIF_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Gamma_RIF_Baseline)){
  if (Gamma_RIF_Baseline$baseline_nfoci[i] <= LB){
    Gamma_RIF_Baseline$baseline_Level[i] = "Low Baseline"
  }
  if (Gamma_RIF_Baseline$baseline_nfoci[i] >= HB){
    Gamma_RIF_Baseline$baseline_Level[i] = "High Baseline"
  }
}

Gamma_RIF_Baseline= NaRV.omit(Gamma_RIF_Baseline)
Gamma_RIF_Baseline$Baseline_Level=factor(Gamma_RIF_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

Ratio_DD_Baseline_Level_Gamma <- plot_ly(data = Gamma_RIF_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ DD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red")) %>% layout(title="56Gamma", yaxis=list(title="Ratio of RIF at high versus low fluence",range=c(1,2), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE), xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
print(Ratio_DD_Baseline_Level_Gamma)
hide_legend(Ratio_DD_Baseline_Level_Gamma)
orca(Ratio_DD_Baseline_Level_Gamma, "Ratio_DD_Baseline_Level_Gamma_4h.pdf")

# Calculate median ratio
# Low Baseline group-------------------------------
Gamma_RIF_Baseline_Low <- Gamma_RIF_Baseline[Gamma_RIF_Baseline$Baseline_Level == "Low Baseline",]
median_baseline_low = median(Gamma_RIF_Baseline_Low$DD_Ratio)
print(median_baseline_low)
# Low Baseline group-------------------------------
Gamma_RIF_Baseline_High <- Gamma_RIF_Baseline[Gamma_RIF_Baseline$Baseline_Level == "High Baseline",]
median_baseline_high = median(Gamma_RIF_Baseline_High$DD_Ratio)
print(median_baseline_high)

###  Statistical analysis 
test_Gamma <- t.test(Gamma_RIF_Baseline$DD_Ratio ~Gamma_RIF_Baseline$Baseline_Level)
print(test_Gamma )



### Cell death and baseline 
# Fe----------------
Fe_CD_Baseline= All_Pheno_baseline_4h[, grepl("Sample_ID|avg_nfoci_Fe|Dead_Cells_Fe", colnames(All_Pheno_baseline_4h))]
#Selection of DD+ subjects 
Fe_CD_Baseline=NaRV.omit(Fe_CD_Baseline)
Fe_CD_Baseline$DD_response <- NA
#
for(i in 1:nrow(Fe_CD_Baseline)){
  if ((Fe_CD_Baseline$avg_nfoci_Fe_HighDose_4h[i] - Fe_CD_Baseline$avg_nfoci_Fe_LowDose_4h[i]) >= 0){
   Fe_CD_Baseline$DD_response[i] = "DD+"
  }
}

Fe_CD_Baseline=NaRV.omit(Fe_CD_Baseline)
Fe_CD_Baseline$DD_response=NULL

Fe_CD_Baseline$CD_Ratio = Fe_CD_Baseline$Dead_Cells_Fe_HighDose_4h/Fe_CD_Baseline$Dead_Cells_Fe_LowDose_4h

## For those interesting people we associate their baseline value
Fe_CD_Baseline=merge(Fe_CD_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Fe_CD_Baseline=NaRV.omit(Fe_CD_Baseline)
## Select high and low baselines 
Fe_CD_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Fe_CD_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Fe_CD_Baseline)){
  if (Fe_CD_Baseline$baseline_nfoci[i] <= LB){
    Fe_CD_Baseline$baseline_Level[i] = "Low Baseline"
  }
  if (Fe_CD_Baseline$baseline_nfoci[i] >= HB){
    Fe_CD_Baseline$baseline_Level[i] = "High Baseline"
  }
}

Fe_CD_Baseline= NaRV.omit(Fe_CD_Baseline)
Fe_CD_Baseline$Baseline_Level=factor(Fe_CD_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

### Calculate Median ratio
## Low Baseline group
Fe_CD_Baseline_Low = Fe_CD_Baseline
Fe_CD_Baseline_Low$Baseline_Level[Fe_CD_Baseline_Low$Baseline_Level =="High Baseline" ] <- NA
Fe_CD_Baseline_Low = NaRV.omit(Fe_CD_Baseline_Low)
median_baseline_low = median(Fe_CD_Baseline_Low$CD_Ratio)
print(median_baseline_low)
#High Baseline Group
Fe_CD_Baseline_High = Fe_CD_Baseline
Fe_CD_Baseline_High$Baseline_Level[Fe_CD_Baseline_High$Baseline_Level =="Low Baseline" ] <- NA
Fe_CD_Baseline_High = NaRV.omit(Fe_CD_Baseline_High)
median_baseline_High = median(Fe_CD_Baseline_High$CD_Ratio)
print(median_baseline_High)

###  t.test & P values 
test_Fe <- t.test(Fe_CD_Baseline$CD_Ratio ~ Fe_CD_Baseline$Baseline_Level)
print(test_Fe)

## Plot
Ratio_CD_Baseline_Level_Fe <- plot_ly(data = Fe_CD_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ CD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red"))
Ratio_CD_Baseline_Level_Fe <- Ratio_CD_Baseline_Level_Fe %>% layout(title="56Fe", yaxis=list(title="Ratio of Cell Death Percentage at high versus low fluence",range=c(0,5), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE),  
                                                                    xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))

Ratio_CD_Baseline_Level_Fe <- hide_legend(Ratio_CD_Baseline_Level_Fe)
print(Ratio_CD_Baseline_Level_Fe)
orca(Ratio_CD_Baseline_Level_Fe, "Ratio_CD_Baseline_Level_Fe_4h.pdf")

# Ar----------------
Ar_CD_Baseline= All_Pheno_baseline_4h[, grepl("Sample_ID|avg_nfoci_Ar|Dead_Cells_Ar", colnames(All_Pheno_baseline_4h))]
#Selection of DD+ subjects 
Ar_CD_Baseline=NaRV.omit(Ar_CD_Baseline)
Ar_CD_Baseline$DD_response <- NA
#
for(i in 1:nrow(Ar_CD_Baseline)){
  if ((Ar_CD_Baseline$avg_nfoci_Ar_HighDose_4h[i] - Ar_CD_Baseline$avg_nfoci_Ar_LowDose_4h[i]) >= 0){
   Ar_CD_Baseline$DD_response[i] = "DD+"
  }
}

Ar_CD_Baseline=NaRV.omit(Ar_CD_Baseline)
Ar_CD_Baseline$DD_response=NULL

Ar_CD_Baseline$CD_Ratio = Ar_CD_Baseline$Dead_Cells_Ar_HighDose_4h/Ar_CD_Baseline$Dead_Cells_Ar_LowDose_4h

## For those interesting people we associate their baseline value
Ar_CD_Baseline=merge(Ar_CD_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Ar_CD_Baseline=NaRV.omit(Ar_CD_Baseline)
## Select high and low baselines 
Ar_CD_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Ar_CD_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Ar_CD_Baseline)){
  if (Ar_CD_Baseline$baseline_nfoci[i] <= LB){
    Ar_CD_Baseline$baseline_Level[i] = "Low Baseline"
  }
  if (Ar_CD_Baseline$baseline_nfoci[i] >= HB){
    Ar_CD_Baseline$baseline_Level[i] = "High Baseline"
  }
}

Ar_CD_Baseline= NaRV.omit(Ar_CD_Baseline)
Ar_CD_Baseline$Baseline_Level=factor(Ar_CD_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

### Calculate Median ratio
## Low Baseline group
Ar_CD_Baseline_Low = Ar_CD_Baseline
Ar_CD_Baseline_Low$Baseline_Level[Ar_CD_Baseline_Low$Baseline_Level =="High Baseline" ] <- NA
Ar_CD_Baseline_Low = NaRV.omit(Ar_CD_Baseline_Low)
median_baseline_low = median(Ar_CD_Baseline_Low$CD_Ratio)
print(median_baseline_low)
#High Baseline Group
Ar_CD_Baseline_High = Ar_CD_Baseline
Ar_CD_Baseline_High$Baseline_Level[Ar_CD_Baseline_High$Baseline_Level =="Low Baseline" ] <- NA
Ar_CD_Baseline_High = NaRV.omit(Ar_CD_Baseline_High)
median_baseline_High = median(Ar_CD_Baseline_High$CD_Ratio)
print(median_baseline_High)

###  t.test & P values 
test_Ar <- t.test(Ar_CD_Baseline$CD_Ratio ~ Ar_CD_Baseline$Baseline_Level)
print(test_Ar)

## Plot
Ratio_CD_Baseline_Level_Ar <- plot_ly(data = Ar_CD_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ CD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red"))
Ratio_CD_Baseline_Level_Ar <- Ratio_CD_Baseline_Level_Ar %>% layout(title="56Ar", yaxis=list(title="Ratio of Cell Death Percentage at high versus low fluence",range=c(0,5), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE),  
                                                                    xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))

Ratio_CD_Baseline_Level_Ar <- hide_legend(Ratio_CD_Baseline_Level_Ar)
print(Ratio_CD_Baseline_Level_Ar)
orca(Ratio_CD_Baseline_Level_Ar, "Ratio_CD_Baseline_Level_Ar_4h.pdf")


# Si----------------
Si_CD_Baseline= All_Pheno_baseline_4h[, grepl("Sample_ID|avg_nfoci_Si|Dead_Cells_Si", colnames(All_Pheno_baseline_4h))]
#Selection of DD+ subjects 
Si_CD_Baseline=NaRV.omit(Si_CD_Baseline)
Si_CD_Baseline$DD_response <- NA
#
for(i in 1:nrow(Si_CD_Baseline)){
  if ((Si_CD_Baseline$avg_nfoci_Si_HighDose_4h[i] - Si_CD_Baseline$avg_nfoci_Si_LowDose_4h[i]) >= 0){
   Si_CD_Baseline$DD_response[i] = "DD+"
  }
}

Si_CD_Baseline=NaRV.omit(Si_CD_Baseline)
Si_CD_Baseline$DD_response=NULL

Si_CD_Baseline$CD_Ratio = Si_CD_Baseline$Dead_Cells_Si_HighDose_4h/Si_CD_Baseline$Dead_Cells_Si_LowDose_4h

## For those interesting people we associate their baseline value
Si_CD_Baseline=merge(Si_CD_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Si_CD_Baseline=NaRV.omit(Si_CD_Baseline)
## Select high and low baselines 
Si_CD_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Si_CD_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Si_CD_Baseline)){
  if (Si_CD_Baseline$baseline_nfoci[i] <= LB){
    Si_CD_Baseline$baseline_Level[i] = "Low Baseline"
  }
  if (Si_CD_Baseline$baseline_nfoci[i] >= HB){
    Si_CD_Baseline$baseline_Level[i] = "High Baseline"
  }
}

Si_CD_Baseline= NaRV.omit(Si_CD_Baseline)
Si_CD_Baseline$Baseline_Level=factor(Si_CD_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

### Calculate Median ratio
## Low Baseline group
Si_CD_Baseline_Low = Si_CD_Baseline
Si_CD_Baseline_Low$Baseline_Level[Si_CD_Baseline_Low$Baseline_Level =="High Baseline" ] <- NA
Si_CD_Baseline_Low = NaRV.omit(Si_CD_Baseline_Low)
median_baseline_low = median(Si_CD_Baseline_Low$CD_Ratio)
print(median_baseline_low)
#High Baseline Group
Si_CD_Baseline_High = Si_CD_Baseline
Si_CD_Baseline_High$Baseline_Level[Si_CD_Baseline_High$Baseline_Level =="Low Baseline" ] <- NA
Si_CD_Baseline_High = NaRV.omit(Si_CD_Baseline_High)
median_baseline_High = median(Si_CD_Baseline_High$CD_Ratio)
print(median_baseline_High)

###  t.test & P values 
test_Si <- t.test(Si_CD_Baseline$CD_Ratio ~ Si_CD_Baseline$Baseline_Level)
print(test_Si)

## Plot
Ratio_CD_Baseline_Level_Si <- plot_ly(data = Si_CD_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ CD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red"))
Ratio_CD_Baseline_Level_Si <- Ratio_CD_Baseline_Level_Si %>% layout(title="56Si", yaxis=list(title="Ratio of Cell Death Percentage at high versus low fluence",range=c(0,5), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE),  
                                                                    xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))

Ratio_CD_Baseline_Level_Si <- hide_legend(Ratio_CD_Baseline_Level_Si)
print(Ratio_CD_Baseline_Level_Si)
orca(Ratio_CD_Baseline_Level_Si, "Ratio_CD_Baseline_Level_Si_4h.pdf")

# Gamma----------------
Gamma_CD_Baseline= All_Pheno_baseline_4h[, grepl("Sample_ID|avg_nfoci_Gamma|Dead_Cells_Gamma", colnames(All_Pheno_baseline_4h))]
#Selection of DD+ subjects 
Gamma_CD_Baseline=NaRV.omit(Gamma_CD_Baseline)
Gamma_CD_Baseline$DD_response <- NA
#
for(i in 1:nrow(Gamma_CD_Baseline)){
  if ((Gamma_CD_Baseline$avg_nfoci_Gamma_HighDose_4h[i] - Gamma_CD_Baseline$avg_nfoci_Gamma_LowDose_4h[i]) >= 0){
   Gamma_CD_Baseline$DD_response[i] = "DD+"
  }
}

Gamma_CD_Baseline=NaRV.omit(Gamma_CD_Baseline)
Gamma_CD_Baseline$DD_response=NULL

Gamma_CD_Baseline$CD_Ratio = Gamma_CD_Baseline$Dead_Cells_Gamma_HighDose_4h/Gamma_CD_Baseline$Dead_Cells_Gamma_LowDose_4h

## For those interesting people we associate their baseline value
Gamma_CD_Baseline=merge(Gamma_CD_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Gamma_CD_Baseline=NaRV.omit(Gamma_CD_Baseline)
## Select high and low baselines 
Gamma_CD_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Gamma_CD_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Gamma_CD_Baseline)){
  if (Gamma_CD_Baseline$baseline_nfoci[i] <= LB){
    Gamma_CD_Baseline$baseline_Level[i] = "Low Baseline"
  }
  if (Gamma_CD_Baseline$baseline_nfoci[i] >= HB){
    Gamma_CD_Baseline$baseline_Level[i] = "High Baseline"
  }
}

Gamma_CD_Baseline= NaRV.omit(Gamma_CD_Baseline)
Gamma_CD_Baseline$Baseline_Level=factor(Gamma_CD_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

### Calculate Median ratio
## Low Baseline group
Gamma_CD_Baseline_Low = Gamma_CD_Baseline
Gamma_CD_Baseline_Low$Baseline_Level[Gamma_CD_Baseline_Low$Baseline_Level =="High Baseline" ] <- NA
Gamma_CD_Baseline_Low = NaRV.omit(Gamma_CD_Baseline_Low)
median_baseline_low = median(Gamma_CD_Baseline_Low$CD_Ratio)
print(median_baseline_low)
#High Baseline Group
Gamma_CD_Baseline_High = Gamma_CD_Baseline
Gamma_CD_Baseline_High$Baseline_Level[Gamma_CD_Baseline_High$Baseline_Level =="Low Baseline" ] <- NA
Gamma_CD_Baseline_High = NaRV.omit(Gamma_CD_Baseline_High)
median_baseline_High = median(Gamma_CD_Baseline_High$CD_Ratio)
print(median_baseline_High)

###  t.test & P values 
test_Gamma <- t.test(Gamma_CD_Baseline$CD_Ratio ~ Gamma_CD_Baseline$Baseline_Level)
print(test_Gamma)

## Plot
Ratio_CD_Baseline_Level_Gamma <- plot_ly(data = Gamma_CD_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ CD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red"))
Ratio_CD_Baseline_Level_Gamma <- Ratio_CD_Baseline_Level_Gamma %>% layout(title="56Gamma", yaxis=list(title="Ratio of Cell Death Percentage at high versus low fluence",range=c(0,5), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE),  
                                                                    xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))

Ratio_CD_Baseline_Level_Gamma <- hide_legend(Ratio_CD_Baseline_Level_Gamma)
print(Ratio_CD_Baseline_Level_Gamma)
orca(Ratio_CD_Baseline_Level_Gamma, "Ratio_CD_Baseline_Level_Gamma_4h.pdf")


### Oxidative stress and baseline 
#For each radiation type, we plot for "OS-" and "OS+" their baseline level (for "DD+" subjects only)
### Classes as defined on DD vs OS plots 
#### we class individual within four class depending on the sign of the difference between high dose and low dose
# (OS+,DD-) : oxidative stress increases with the dose and DNA decreases with the dose 
# (OS-,DD-) : Both oxidative stress and DNA damage decrease with the dose 
# (OS-,DD+) : oxidative stress decreases with the dose and DNA increases with the dose 
# (OS+,DD+) : Both oxidative stress and DNA damage increase with the dose

# Fe----------------
Fe_Response_OS_Class = All_Pheno_baseline_4h[, grepl("Sample_ID|avg_nfoci_Fe|Ox_Stress_Fe", colnames(All_Pheno_baseline_4h))]
Fe_Response_OS_Class = merge(Fe_Response_OS_Class, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE)

## Selection of DD+ subjects 
Fe_Response_OS_Class=NaRV.omit(Fe_Response_OS_Class)
Fe_Response_OS_Class$DD_response <- NA

for (i in 1:nrow(Fe_Response_OS_Class)){
  if ((Fe_Response_OS_Class$avg_nfoci_Fe_HighDose_4h[i] - Fe_Response_OS_Class$avg_nfoci_Fe_LowDose_4h[i]) >= 0){
    Fe_Response_OS_Class$DD_response[i] = "DD+"
  }
}
Fe_Response_OS_Class=NaRV.omit(Fe_Response_OS_Class)
Fe_Response_OS_Class$DD_response = NULL

## Create two class OS+ and OS- 
Fe_Response_OS_Class$OS_response <- NA

for ( i in 1:nrow(Fe_Response_OS_Class)){
  if ((Fe_Response_OS_Class$Ox_Stress_Fe_HighDose_4h[i] - Fe_Response_OS_Class$Ox_Stress_Fe_LowDose_4h[i]) >= 0){
    Fe_Response_OS_Class$OS_response[i] = "OS+"
  }
  if ((Fe_Response_OS_Class$Ox_Stress_Fe_HighDose_4h[i] - Fe_Response_OS_Class$Ox_Stress_Fe_LowDose_4h[i]) < 0){
    Fe_Response_OS_Class$OS_response[i] = "OS-"
  }
}

#Plot 
OS_Baseline_Fe_4h <- plot_ly(data = Fe_Response_OS_Class) %>% add_trace (x = ~ OS_response,
                                                                        y = ~ baseline_nfoci,
                                                                        type = "box", boxpoints = "all", 
                                                                        color=~ OS_response, colors=c("darkgreen", "blue"))
OS_Baseline_Fe_4h <- OS_Baseline_Fe_4h %>% layout(title="56Fe", yaxis=list(title="Baseline nb of foci/nucleus",range=c(0,2),zeroline = FALSE, titlefont = list(size = 25), tickfont = list(size = 20)), xaxis=list(title="Trend of mean CellROX with increasing dose", titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
OS_Baseline_Fe_4h <- hide_legend(OS_Baseline_Fe_4h)
print(OS_Baseline_Fe_4h)
orca(OS_Baseline_Fe_4h, "Baseline_OS_dose_response_Fe_4h.pdf")

###  t.test & P values 
test_Fe <- t.test(Fe_Response_OS_Class$baseline_nfoci ~ Fe_Response_OS_Class$OS_response)
print(test_Fe)

### Baseline median value for OS- and OS+  
Fe_Response_OS_Class_neg <- Fe_Response_OS_Class
Fe_Response_OS_Class_neg$OS_response[Fe_Response_OS_Class_neg$OS_response == "OS+"] <- NA
Fe_Response_OS_Class_neg=NaRV.omit(Fe_Response_OS_Class_neg)
median_OS_neg = median(Fe_Response_OS_Class_neg$baseline_nfoci)
print(median_OS_neg)

Fe_Response_OS_Class_pos <- Fe_Response_OS_Class
Fe_Response_OS_Class_pos$OS_response[Fe_Response_OS_Class_pos$OS_response == "OS-"] <- NA
Fe_Response_OS_Class_pos=NaRV.omit(Fe_Response_OS_Class_pos)
median_OS_pos = median(Fe_Response_OS_Class_pos$baseline_nfoci)
print(median_OS_pos)


# Ar----------------
Ar_Response_OS_Class = All_Pheno_baseline_4h[, grepl("Sample_ID|avg_nfoci_Ar|Ox_Stress_Ar", colnames(All_Pheno_baseline_4h))]
Ar_Response_OS_Class = merge(Ar_Response_OS_Class, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE)

## Selection of DD+ subjects 
Ar_Response_OS_Class=NaRV.omit(Ar_Response_OS_Class)
Ar_Response_OS_Class$DD_response <- NA

for (i in 1:nrow(Ar_Response_OS_Class)){
  if ((Ar_Response_OS_Class$avg_nfoci_Ar_HighDose_4h[i] - Ar_Response_OS_Class$avg_nfoci_Ar_LowDose_4h[i]) >= 0){
    Ar_Response_OS_Class$DD_response[i] = "DD+"
  }
}
Ar_Response_OS_Class=NaRV.omit(Ar_Response_OS_Class)
Ar_Response_OS_Class$DD_response = NULL

## Create two class OS+ and OS- 
Ar_Response_OS_Class$OS_response <- NA

for ( i in 1:nrow(Ar_Response_OS_Class)){
  if ((Ar_Response_OS_Class$Ox_Stress_Ar_HighDose_4h[i] - Ar_Response_OS_Class$Ox_Stress_Ar_LowDose_4h[i]) >= 0){
    Ar_Response_OS_Class$OS_response[i] = "OS+"
  }
  if ((Ar_Response_OS_Class$Ox_Stress_Ar_HighDose_4h[i] - Ar_Response_OS_Class$Ox_Stress_Ar_LowDose_4h[i]) < 0){
    Ar_Response_OS_Class$OS_response[i] = "OS-"
  }
}

#Plot 
OS_Baseline_Ar_4h <- plot_ly(data = Ar_Response_OS_Class) %>% add_trace (x = ~ OS_response,
                                                                        y = ~ baseline_nfoci,
                                                                        type = "box", boxpoints = "all", 
                                                                        color=~ OS_response, colors=c("darkgreen", "blue"))
OS_Baseline_Ar_4h <- OS_Baseline_Ar_4h %>% layout(title="56Ar", yaxis=list(title="Baseline nb of foci/nucleus",range=c(0,2),zeroline = FALSE, titlefont = list(size = 25), tickfont = list(size = 20)), xaxis=list(title="Trend of mean CellROX with increasing dose", titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
OS_Baseline_Ar_4h <- hide_legend(OS_Baseline_Ar_4h)
print(OS_Baseline_Ar_4h)
orca(OS_Baseline_Ar_4h, "Baseline_OS_dose_response_Ar_4h.pdf")

###  t.test & P values 
test_Ar <- t.test(Ar_Response_OS_Class$baseline_nfoci ~ Ar_Response_OS_Class$OS_response)
print(test_Ar)

### Baseline median value for OS- and OS+  
Ar_Response_OS_Class_neg <- Ar_Response_OS_Class
Ar_Response_OS_Class_neg$OS_response[Ar_Response_OS_Class_neg$OS_response == "OS+"] <- NA
Ar_Response_OS_Class_neg=NaRV.omit(Ar_Response_OS_Class_neg)
median_OS_neg = median(Ar_Response_OS_Class_neg$baseline_nfoci)
print(median_OS_neg)

Ar_Response_OS_Class_pos <- Ar_Response_OS_Class
Ar_Response_OS_Class_pos$OS_response[Ar_Response_OS_Class_pos$OS_response == "OS-"] <- NA
Ar_Response_OS_Class_pos=NaRV.omit(Ar_Response_OS_Class_pos)
median_OS_pos = median(Ar_Response_OS_Class_pos$baseline_nfoci)
print(median_OS_pos)


# Si----------------
Si_Response_OS_Class = All_Pheno_baseline_4h[, grepl("Sample_ID|avg_nfoci_Si|Ox_Stress_Si", colnames(All_Pheno_baseline_4h))]
Si_Response_OS_Class = merge(Si_Response_OS_Class, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE)

## Selection of DD+ subjects 
Si_Response_OS_Class=NaRV.omit(Si_Response_OS_Class)
Si_Response_OS_Class$DD_response <- NA

for (i in 1:nrow(Si_Response_OS_Class)){
  if ((Si_Response_OS_Class$avg_nfoci_Si_HighDose_4h[i] - Si_Response_OS_Class$avg_nfoci_Si_LowDose_4h[i]) >= 0){
    Si_Response_OS_Class$DD_response[i] = "DD+"
  }
}
Si_Response_OS_Class=NaRV.omit(Si_Response_OS_Class)
Si_Response_OS_Class$DD_response = NULL

## Create two class OS+ and OS- 
Si_Response_OS_Class$OS_response <- NA

for ( i in 1:nrow(Si_Response_OS_Class)){
  if ((Si_Response_OS_Class$Ox_Stress_Si_HighDose_4h[i] - Si_Response_OS_Class$Ox_Stress_Si_LowDose_4h[i]) >= 0){
    Si_Response_OS_Class$OS_response[i] = "OS+"
  }
  if ((Si_Response_OS_Class$Ox_Stress_Si_HighDose_4h[i] - Si_Response_OS_Class$Ox_Stress_Si_LowDose_4h[i]) < 0){
    Si_Response_OS_Class$OS_response[i] = "OS-"
  }
}

#Plot 
OS_Baseline_Si_4h <- plot_ly(data = Si_Response_OS_Class) %>% add_trace (x = ~ OS_response,
                                                                        y = ~ baseline_nfoci,
                                                                        type = "box", boxpoints = "all", 
                                                                        color=~ OS_response, colors=c("darkgreen", "blue"))
OS_Baseline_Si_4h <- OS_Baseline_Si_4h %>% layout(title="56Si", yaxis=list(title="Baseline nb of foci/nucleus",range=c(0,2),zeroline = FALSE, titlefont = list(size = 25), tickfont = list(size = 20)), xaxis=list(title="Trend of mean CellROX with increasing dose", titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
OS_Baseline_Si_4h <- hide_legend(OS_Baseline_Si_4h)
print(OS_Baseline_Si_4h)
orca(OS_Baseline_Si_4h, "Baseline_OS_dose_response_Si_4h.pdf")

###  t.test & P values 
test_Si <- t.test(Si_Response_OS_Class$baseline_nfoci ~ Si_Response_OS_Class$OS_response)
print(test_Si)

### Baseline median value for OS- and OS+  
Si_Response_OS_Class_neg <- Si_Response_OS_Class
Si_Response_OS_Class_neg$OS_response[Si_Response_OS_Class_neg$OS_response == "OS+"] <- NA
Si_Response_OS_Class_neg=NaRV.omit(Si_Response_OS_Class_neg)
median_OS_neg = median(Si_Response_OS_Class_neg$baseline_nfoci)
print(median_OS_neg)

Si_Response_OS_Class_pos <- Si_Response_OS_Class
Si_Response_OS_Class_pos$OS_response[Si_Response_OS_Class_pos$OS_response == "OS-"] <- NA
Si_Response_OS_Class_pos=NaRV.omit(Si_Response_OS_Class_pos)
median_OS_pos = median(Si_Response_OS_Class_pos$baseline_nfoci)
print(median_OS_pos)


# Gamma----------------
Gamma_Response_OS_Class = All_Pheno_baseline_4h[, grepl("Sample_ID|avg_nfoci_Gamma|Ox_Stress_Gamma", colnames(All_Pheno_baseline_4h))]
Gamma_Response_OS_Class = merge(Gamma_Response_OS_Class, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE)

## Selection of DD+ subjects 
Gamma_Response_OS_Class=NaRV.omit(Gamma_Response_OS_Class)
Gamma_Response_OS_Class$DD_response <- NA

for (i in 1:nrow(Gamma_Response_OS_Class)){
  if ((Gamma_Response_OS_Class$avg_nfoci_Gamma_HighDose_4h[i] - Gamma_Response_OS_Class$avg_nfoci_Gamma_LowDose_4h[i]) >= 0){
    Gamma_Response_OS_Class$DD_response[i] = "DD+"
  }
}
Gamma_Response_OS_Class=NaRV.omit(Gamma_Response_OS_Class)
Gamma_Response_OS_Class$DD_response = NULL

## Create two class OS+ and OS- 
Gamma_Response_OS_Class$OS_response <- NA

for ( i in 1:nrow(Gamma_Response_OS_Class)){
  if ((Gamma_Response_OS_Class$Ox_Stress_Gamma_HighDose_4h[i] - Gamma_Response_OS_Class$Ox_Stress_Gamma_LowDose_4h[i]) >= 0){
    Gamma_Response_OS_Class$OS_response[i] = "OS+"
  }
  if ((Gamma_Response_OS_Class$Ox_Stress_Gamma_HighDose_4h[i] - Gamma_Response_OS_Class$Ox_Stress_Gamma_LowDose_4h[i]) < 0){
    Gamma_Response_OS_Class$OS_response[i] = "OS-"
  }
}

#Plot 
OS_Baseline_Gamma_4h <- plot_ly(data = Gamma_Response_OS_Class) %>% add_trace (x = ~ OS_response,
                                                                        y = ~ baseline_nfoci,
                                                                        type = "box", boxpoints = "all", 
                                                                        color=~ OS_response, colors=c("darkgreen", "blue"))
OS_Baseline_Gamma_4h <- OS_Baseline_Gamma_4h %>% layout(title="56Gamma", yaxis=list(title="Baseline nb of foci/nucleus",range=c(0,2),zeroline = FALSE, titlefont = list(size = 25), tickfont = list(size = 20)), xaxis=list(title="Trend of mean CellROX with increasing dose", titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
OS_Baseline_Gamma_4h <- hide_legend(OS_Baseline_Gamma_4h)
print(OS_Baseline_Gamma_4h)
orca(OS_Baseline_Gamma_4h, "Baseline_OS_dose_response_Gamma_4h.pdf")

###  t.test & P values 
test_Gamma <- t.test(Gamma_Response_OS_Class$baseline_nfoci ~ Gamma_Response_OS_Class$OS_response)
print(test_Gamma)

### Baseline median value for OS- and OS+  
Gamma_Response_OS_Class_neg <- Gamma_Response_OS_Class
Gamma_Response_OS_Class_neg$OS_response[Gamma_Response_OS_Class_neg$OS_response == "OS+"] <- NA
Gamma_Response_OS_Class_neg=NaRV.omit(Gamma_Response_OS_Class_neg)
median_OS_neg = median(Gamma_Response_OS_Class_neg$baseline_nfoci)
print(median_OS_neg)

Gamma_Response_OS_Class_pos <- Gamma_Response_OS_Class
Gamma_Response_OS_Class_pos$OS_response[Gamma_Response_OS_Class_pos$OS_response == "OS-"] <- NA
Gamma_Response_OS_Class_pos=NaRV.omit(Gamma_Response_OS_Class_pos)
median_OS_pos = median(Gamma_Response_OS_Class_pos$baseline_nfoci)
print(median_OS_pos)



############# at 24h post-irradiation
### DNA damage and baseline 
# Fe----------------
Fe_RIF_Baseline= All_Pheno_baseline_24h[, grepl("Sample_ID|avg_nfoci_Fe", colnames(All_Pheno_baseline_24h))]
Fe_RIF_Baseline=NaRV.omit(Fe_RIF_Baseline)
Fe_RIF_Baseline$DD_response <- NA

for(i in 1:nrow(Fe_RIF_Baseline)){ # We will only consider individuals with increasing RIF with dose
  if ((Fe_RIF_Baseline$avg_nfoci_Fe_HighDose_24h[i] - avg_nfoci_Fe_LowDose_24h[i]) >= 0){
   Fe_RIF_Baseline$DD_response[i] = "DD+"
  }
}
Fe_RIF_Baseline=NaRV.omit(Fe_RIF_Baseline)
Fe_RIF_Baseline$DD_response=NULL

Fe_RIF_Baseline$DD_Ratio = Fe_RIF_Baseline$avg_nfoci_Fe_HighDose_24h/Fe_RIF_Baseline$avg_nfoci_Fe_LowDose_24h
Fe_RIF_Baseline=merge(Fe_RIF_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Fe_RIF_Baseline=NaRV.omit(Fe_RIF_Baseline)
Fe_RIF_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Fe_RIF_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Fe_RIF_Baseline)){
  if (Fe_RIF_Baseline$baseline_nfoci[i] <= LB){
    Fe_RIF_Baseline$Baseline_Level[i] = "Low Baseline"
  }
  if (Fe_RIF_Baseline$baseline_nfoci[i] >= HB){
    Fe_RIF_Baseline$Baseline_Level[i] = "High Baseline"
  }
}

Fe_RIF_Baseline= NaRV.omit(Fe_RIF_Baseline)
Fe_RIF_Baseline$Baseline_Level=factor(Fe_RIF_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

Ratio_DD_Baseline_Level_Fe <- plot_ly(data = Fe_RIF_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ DD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red")) %>% layout(title="56Fe", yaxis=list(title="Ratio of RIF at high versus low fluence",range=c(1,2), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE), xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
print(Ratio_DD_Baseline_Level_Fe)
hide_legend(Ratio_DD_Baseline_Level_Fe)
orca(Ratio_DD_Baseline_Level_Fe, "Ratio_DD_Baseline_Level_Fe_24h.pdf")

# Calculate median ratio
# Low Baseline group-------------------------------
Fe_RIF_Baseline_Low <- Fe_RIF_Baseline[Fe_RIF_Baseline$Baseline_Level == "Low Baseline",]
median_baseline_low = median(Fe_RIF_Baseline_Low$DD_Ratio)
print(median_baseline_low)
# Low Baseline group-------------------------------
Fe_RIF_Baseline_High <- Fe_RIF_Baseline[Fe_RIF_Baseline$Baseline_Level == "High Baseline",]
median_baseline_high = median(Fe_RIF_Baseline_High$DD_Ratio)
print(median_baseline_high)

###  Statistical analysis 
test_Fe <- t.test(Fe_RIF_Baseline$DD_Ratio ~Fe_RIF_Baseline$Baseline_Level)
print(test_Fe )

# Ar----------------
Ar_RIF_Baseline= All_Pheno_baseline_24h[, grepl("Sample_ID|avg_nfoci_Ar", colnames(All_Pheno_baseline_24h))]
Ar_RIF_Baseline=NaRV.omit(Ar_RIF_Baseline)
Ar_RIF_Baseline$DD_response <- NA

for(i in 1:nrow(Ar_RIF_Baseline)){ # We will only consider individuals with increasing RIF with dose
  if ((Ar_RIF_Baseline$avg_nfoci_Ar_HighDose_24h[i] - avg_nfoci_Ar_LowDose_24h[i]) >= 0){
   Ar_RIF_Baseline$DD_response[i] = "DD+"
  }
}
Ar_RIF_Baseline=NaRV.omit(Ar_RIF_Baseline)
Ar_RIF_Baseline$DD_response=NULL

Ar_RIF_Baseline$DD_Ratio = Ar_RIF_Baseline$avg_nfoci_Ar_HighDose_24h/Ar_RIF_Baseline$avg_nfoci_Ar_LowDose_24h
Ar_RIF_Baseline=merge(Ar_RIF_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Ar_RIF_Baseline=NaRV.omit(Ar_RIF_Baseline)
Ar_RIF_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Ar_RIF_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Ar_RIF_Baseline)){
  if (Ar_RIF_Baseline$baseline_nfoci[i] <= LB){
    Ar_RIF_Baseline$Baseline_Level[i] = "Low Baseline"
  }
  if (Ar_RIF_Baseline$baseline_nfoci[i] >= HB){
    Ar_RIF_Baseline$Baseline_Level[i] = "High Baseline"
  }
}

Ar_RIF_Baseline= NaRV.omit(Ar_RIF_Baseline)
Ar_RIF_Baseline$Baseline_Level=factor(Ar_RIF_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

Ratio_DD_Baseline_Level_Ar <- plot_ly(data = Ar_RIF_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ DD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red")) %>% layout(title="56Ar", yaxis=list(title="Ratio of RIF at high versus low fluence",range=c(1,2), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE), xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
print(Ratio_DD_Baseline_Level_Ar)
hide_legend(Ratio_DD_Baseline_Level_Ar)
orca(Ratio_DD_Baseline_Level_Ar, "Ratio_DD_Baseline_Level_Ar_24h.pdf")

# Calculate median ratio
# Low Baseline group-------------------------------
Ar_RIF_Baseline_Low <- Ar_RIF_Baseline[Ar_RIF_Baseline$Baseline_Level == "Low Baseline",]
median_baseline_low = median(Ar_RIF_Baseline_Low$DD_Ratio)
print(median_baseline_low)
# Low Baseline group-------------------------------
Ar_RIF_Baseline_High <- Ar_RIF_Baseline[Ar_RIF_Baseline$Baseline_Level == "High Baseline",]
median_baseline_high = median(Ar_RIF_Baseline_High$DD_Ratio)
print(median_baseline_high)

###  Statistical analysis 
test_Ar <- t.test(Ar_RIF_Baseline$DD_Ratio ~Ar_RIF_Baseline$Baseline_Level)
print(test_Ar )


# Si----------------
Si_RIF_Baseline= All_Pheno_baseline_24h[, grepl("Sample_ID|avg_nfoci_Si", colnames(All_Pheno_baseline_24h))]
Si_RIF_Baseline=NaRV.omit(Si_RIF_Baseline)
Si_RIF_Baseline$DD_response <- NA

for(i in 1:nrow(Si_RIF_Baseline)){ # We will only consider individuals with increasing RIF with dose
  if ((Si_RIF_Baseline$avg_nfoci_Si_HighDose_24h[i] - avg_nfoci_Si_LowDose_24h[i]) >= 0){
   Si_RIF_Baseline$DD_response[i] = "DD+"
  }
}
Si_RIF_Baseline=NaRV.omit(Si_RIF_Baseline)
Si_RIF_Baseline$DD_response=NULL

Si_RIF_Baseline$DD_Ratio = Si_RIF_Baseline$avg_nfoci_Si_HighDose_24h/Si_RIF_Baseline$avg_nfoci_Si_LowDose_24h
Si_RIF_Baseline=merge(Si_RIF_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Si_RIF_Baseline=NaRV.omit(Si_RIF_Baseline)
Si_RIF_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Si_RIF_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Si_RIF_Baseline)){
  if (Si_RIF_Baseline$baseline_nfoci[i] <= LB){
    Si_RIF_Baseline$Baseline_Level[i] = "Low Baseline"
  }
  if (Si_RIF_Baseline$baseline_nfoci[i] >= HB){
    Si_RIF_Baseline$Baseline_Level[i] = "High Baseline"
  }
}

Si_RIF_Baseline= NaRV.omit(Si_RIF_Baseline)
Si_RIF_Baseline$Baseline_Level=factor(Si_RIF_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

Ratio_DD_Baseline_Level_Si <- plot_ly(data = Si_RIF_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ DD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red")) %>% layout(title="56Si", yaxis=list(title="Ratio of RIF at high versus low fluence",range=c(1,2), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE), xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
print(Ratio_DD_Baseline_Level_Si)
hide_legend(Ratio_DD_Baseline_Level_Si)
orca(Ratio_DD_Baseline_Level_Si, "Ratio_DD_Baseline_Level_Si_24h.pdf")

# Calculate median ratio
# Low Baseline group-------------------------------
Si_RIF_Baseline_Low <- Si_RIF_Baseline[Si_RIF_Baseline$Baseline_Level == "Low Baseline",]
median_baseline_low = median(Si_RIF_Baseline_Low$DD_Ratio)
print(median_baseline_low)
# Low Baseline group-------------------------------
Si_RIF_Baseline_High <- Si_RIF_Baseline[Si_RIF_Baseline$Baseline_Level == "High Baseline",]
median_baseline_high = median(Si_RIF_Baseline_High$DD_Ratio)
print(median_baseline_high)

###  Statistical analysis 
test_Si <- t.test(Si_RIF_Baseline$DD_Ratio ~Si_RIF_Baseline$Baseline_Level)
print(test_Si )

# Gamma----------------
Gamma_RIF_Baseline= All_Pheno_baseline_24h[, grepl("Sample_ID|avg_nfoci_Gamma", colnames(All_Pheno_baseline_24h))]
Gamma_RIF_Baseline=NaRV.omit(Gamma_RIF_Baseline)
Gamma_RIF_Baseline$DD_response <- NA

for(i in 1:nrow(Gamma_RIF_Baseline)){ # We will only consider individuals with increasing RIF with dose
  if ((Gamma_RIF_Baseline$avg_nfoci_Gamma_HighDose_24h[i] - avg_nfoci_Gamma_LowDose_24h[i]) >= 0){
   Gamma_RIF_Baseline$DD_response[i] = "DD+"
  }
}
Gamma_RIF_Baseline=NaRV.omit(Gamma_RIF_Baseline)
Gamma_RIF_Baseline$DD_response=NULL

Gamma_RIF_Baseline$DD_Ratio = Gamma_RIF_Baseline$avg_nfoci_Gamma_HighDose_24h/Gamma_RIF_Baseline$avg_nfoci_Gamma_LowDose_24h
Gamma_RIF_Baseline=merge(Gamma_RIF_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Gamma_RIF_Baseline=NaRV.omit(Gamma_RIF_Baseline)
Gamma_RIF_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Gamma_RIF_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Gamma_RIF_Baseline)){
  if (Gamma_RIF_Baseline$baseline_nfoci[i] <= LB){
    Gamma_RIF_Baseline$Baseline_Level[i] = "Low Baseline"
  }
  if (Gamma_RIF_Baseline$baseline_nfoci[i] >= HB){
    Gamma_RIF_Baseline$Baseline_Level[i] = "High Baseline"
  }
}

Gamma_RIF_Baseline= NaRV.omit(Gamma_RIF_Baseline)
Gamma_RIF_Baseline$Baseline_Level=factor(Gamma_RIF_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

Ratio_DD_Baseline_Level_Gamma <- plot_ly(data = Gamma_RIF_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ DD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red")) %>% layout(title="56Gamma", yaxis=list(title="Ratio of RIF at high versus low fluence",range=c(1,2), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE), xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
print(Ratio_DD_Baseline_Level_Gamma)
hide_legend(Ratio_DD_Baseline_Level_Gamma)
orca(Ratio_DD_Baseline_Level_Gamma, "Ratio_DD_Baseline_Level_Gamma_24h.pdf")

# Calculate median ratio
# Low Baseline group-------------------------------
Gamma_RIF_Baseline_Low <- Gamma_RIF_Baseline[Gamma_RIF_Baseline$Baseline_Level == "Low Baseline",]
median_baseline_low = median(Gamma_RIF_Baseline_Low$DD_Ratio)
print(median_baseline_low)
# Low Baseline group-------------------------------
Gamma_RIF_Baseline_High <- Gamma_RIF_Baseline[Gamma_RIF_Baseline$Baseline_Level == "High Baseline",]
median_baseline_high = median(Gamma_RIF_Baseline_High$DD_Ratio)
print(median_baseline_high)

###  Statistical analysis 
test_Gamma <- t.test(Gamma_RIF_Baseline$DD_Ratio ~Gamma_RIF_Baseline$Baseline_Level)
print(test_Gamma )



### Cell death and baseline 
# Fe----------------
Fe_CD_Baseline= All_Pheno_baseline_24h[, grepl("Sample_ID|avg_nfoci_Fe|Dead_Cells_Fe", colnames(All_Pheno_baseline_24h))]
#Selection of DD+ subjects 
Fe_CD_Baseline=NaRV.omit(Fe_CD_Baseline)
Fe_CD_Baseline$DD_response <- NA
#
for(i in 1:nrow(Fe_CD_Baseline)){
  if ((Fe_CD_Baseline$avg_nfoci_Fe_HighDose_24h[i] - Fe_CD_Baseline$avg_nfoci_Fe_LowDose_24h[i]) >= 0){
   Fe_CD_Baseline$DD_response[i] = "DD+"
  }
}

Fe_CD_Baseline=NaRV.omit(Fe_CD_Baseline)
Fe_CD_Baseline$DD_response=NULL

Fe_CD_Baseline$CD_Ratio = Fe_CD_Baseline$Dead_Cells_Fe_HighDose_24h/Fe_CD_Baseline$Dead_Cells_Fe_LowDose_24h

## For those interesting people we associate their baseline value
Fe_CD_Baseline=merge(Fe_CD_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Fe_CD_Baseline=NaRV.omit(Fe_CD_Baseline)
## Select high and low baselines 
Fe_CD_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Fe_CD_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Fe_CD_Baseline)){
  if (Fe_CD_Baseline$baseline_nfoci[i] <= LB){
    Fe_CD_Baseline$Baseline_Level[i] = "Low Baseline"
  }
  if (Fe_CD_Baseline$baseline_nfoci[i] >= HB){
    Fe_CD_Baseline$Baseline_Level[i] = "High Baseline"
  }
}

Fe_CD_Baseline= NaRV.omit(Fe_CD_Baseline)
Fe_CD_Baseline$Baseline_Level=factor(Fe_CD_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

### Calculate Median ratio
## Low Baseline group
Fe_CD_Baseline_Low = Fe_CD_Baseline
Fe_CD_Baseline_Low$Baseline_Level[Fe_CD_Baseline_Low$Baseline_Level =="High Baseline" ] <- NA
Fe_CD_Baseline_Low = NaRV.omit(Fe_CD_Baseline_Low)
median_baseline_low = median(Fe_CD_Baseline_Low$CD_Ratio)
print(median_baseline_low)
#High Baseline Group
Fe_CD_Baseline_High = Fe_CD_Baseline
Fe_CD_Baseline_High$Baseline_Level[Fe_CD_Baseline_High$Baseline_Level =="Low Baseline" ] <- NA
Fe_CD_Baseline_High = NaRV.omit(Fe_CD_Baseline_High)
median_baseline_High = median(Fe_CD_Baseline_High$CD_Ratio)
print(median_baseline_High)

###  t.test & P values 
test_Fe <- t.test(Fe_CD_Baseline$CD_Ratio ~ Fe_CD_Baseline$Baseline_Level)
print(test_Fe)

## Plot
Ratio_CD_Baseline_Level_Fe <- plot_ly(data = Fe_CD_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ CD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red"))
Ratio_CD_Baseline_Level_Fe <- Ratio_CD_Baseline_Level_Fe %>% layout(title="56Fe", yaxis=list(title="Ratio of Cell Death Percentage at high versus low fluence",range=c(0,5), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE),  
                                                                    xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))

Ratio_CD_Baseline_Level_Fe <- hide_legend(Ratio_CD_Baseline_Level_Fe)
print(Ratio_CD_Baseline_Level_Fe)
orca(Ratio_CD_Baseline_Level_Fe, "Ratio_CD_Baseline_Level_Fe_24h.pdf")

# Ar----------------
Ar_CD_Baseline= All_Pheno_baseline_24h[, grepl("Sample_ID|avg_nfoci_Ar|Dead_Cells_Ar", colnames(All_Pheno_baseline_24h))]
#Selection of DD+ subjects 
Ar_CD_Baseline=NaRV.omit(Ar_CD_Baseline)
Ar_CD_Baseline$DD_response <- NA
#
for(i in 1:nrow(Ar_CD_Baseline)){
  if ((Ar_CD_Baseline$avg_nfoci_Ar_HighDose_24h[i] - Ar_CD_Baseline$avg_nfoci_Ar_LowDose_24h[i]) >= 0){
   Ar_CD_Baseline$DD_response[i] = "DD+"
  }
}

Ar_CD_Baseline=NaRV.omit(Ar_CD_Baseline)
Ar_CD_Baseline$DD_response=NULL

Ar_CD_Baseline$CD_Ratio = Ar_CD_Baseline$Dead_Cells_Ar_HighDose_24h/Ar_CD_Baseline$Dead_Cells_Ar_LowDose_24h

## For those interesting people we associate their baseline value
Ar_CD_Baseline=merge(Ar_CD_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Ar_CD_Baseline=NaRV.omit(Ar_CD_Baseline)
## Select high and low baselines 
Ar_CD_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Ar_CD_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Ar_CD_Baseline)){
  if (Ar_CD_Baseline$baseline_nfoci[i] <= LB){
    Ar_CD_Baseline$Baseline_Level[i] = "Low Baseline"
  }
  if (Ar_CD_Baseline$baseline_nfoci[i] >= HB){
    Ar_CD_Baseline$Baseline_Level[i] = "High Baseline"
  }
}

Ar_CD_Baseline= NaRV.omit(Ar_CD_Baseline)
Ar_CD_Baseline$Baseline_Level=factor(Ar_CD_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

### Calculate Median ratio
## Low Baseline group
Ar_CD_Baseline_Low = Ar_CD_Baseline
Ar_CD_Baseline_Low$Baseline_Level[Ar_CD_Baseline_Low$Baseline_Level =="High Baseline" ] <- NA
Ar_CD_Baseline_Low = NaRV.omit(Ar_CD_Baseline_Low)
median_baseline_low = median(Ar_CD_Baseline_Low$CD_Ratio)
print(median_baseline_low)
#High Baseline Group
Ar_CD_Baseline_High = Ar_CD_Baseline
Ar_CD_Baseline_High$Baseline_Level[Ar_CD_Baseline_High$Baseline_Level =="Low Baseline" ] <- NA
Ar_CD_Baseline_High = NaRV.omit(Ar_CD_Baseline_High)
median_baseline_High = median(Ar_CD_Baseline_High$CD_Ratio)
print(median_baseline_High)

###  t.test & P values 
test_Ar <- t.test(Ar_CD_Baseline$CD_Ratio ~ Ar_CD_Baseline$Baseline_Level)
print(test_Ar)

## Plot
Ratio_CD_Baseline_Level_Ar <- plot_ly(data = Ar_CD_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ CD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red"))
Ratio_CD_Baseline_Level_Ar <- Ratio_CD_Baseline_Level_Ar %>% layout(title="56Ar", yaxis=list(title="Ratio of Cell Death Percentage at high versus low fluence",range=c(0,5), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE),  
                                                                    xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))

Ratio_CD_Baseline_Level_Ar <- hide_legend(Ratio_CD_Baseline_Level_Ar)
print(Ratio_CD_Baseline_Level_Ar)
orca(Ratio_CD_Baseline_Level_Ar, "Ratio_CD_Baseline_Level_Ar_24h.pdf")


# Si----------------
Si_CD_Baseline= All_Pheno_baseline_24h[, grepl("Sample_ID|avg_nfoci_Si|Dead_Cells_Si", colnames(All_Pheno_baseline_24h))]
#Selection of DD+ subjects 
Si_CD_Baseline=NaRV.omit(Si_CD_Baseline)
Si_CD_Baseline$DD_response <- NA
#
for(i in 1:nrow(Si_CD_Baseline)){
  if ((Si_CD_Baseline$avg_nfoci_Si_HighDose_24h[i] - Si_CD_Baseline$avg_nfoci_Si_LowDose_24h[i]) >= 0){
   Si_CD_Baseline$DD_response[i] = "DD+"
  }
}

Si_CD_Baseline=NaRV.omit(Si_CD_Baseline)
Si_CD_Baseline$DD_response=NULL

Si_CD_Baseline$CD_Ratio = Si_CD_Baseline$Dead_Cells_Si_HighDose_24h/Si_CD_Baseline$Dead_Cells_Si_LowDose_24h

## For those interesting people we associate their baseline value
Si_CD_Baseline=merge(Si_CD_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Si_CD_Baseline=NaRV.omit(Si_CD_Baseline)
## Select high and low baselines 
Si_CD_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Si_CD_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Si_CD_Baseline)){
  if (Si_CD_Baseline$baseline_nfoci[i] <= LB){
    Si_CD_Baseline$Baseline_Level[i] = "Low Baseline"
  }
  if (Si_CD_Baseline$baseline_nfoci[i] >= HB){
    Si_CD_Baseline$Baseline_Level[i] = "High Baseline"
  }
}

Si_CD_Baseline= NaRV.omit(Si_CD_Baseline)
Si_CD_Baseline$Baseline_Level=factor(Si_CD_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

### Calculate Median ratio
## Low Baseline group
Si_CD_Baseline_Low = Si_CD_Baseline
Si_CD_Baseline_Low$Baseline_Level[Si_CD_Baseline_Low$Baseline_Level =="High Baseline" ] <- NA
Si_CD_Baseline_Low = NaRV.omit(Si_CD_Baseline_Low)
median_baseline_low = median(Si_CD_Baseline_Low$CD_Ratio)
print(median_baseline_low)
#High Baseline Group
Si_CD_Baseline_High = Si_CD_Baseline
Si_CD_Baseline_High$Baseline_Level[Si_CD_Baseline_High$Baseline_Level =="Low Baseline" ] <- NA
Si_CD_Baseline_High = NaRV.omit(Si_CD_Baseline_High)
median_baseline_High = median(Si_CD_Baseline_High$CD_Ratio)
print(median_baseline_High)

###  t.test & P values 
test_Si <- t.test(Si_CD_Baseline$CD_Ratio ~ Si_CD_Baseline$Baseline_Level)
print(test_Si)

## Plot
Ratio_CD_Baseline_Level_Si <- plot_ly(data = Si_CD_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ CD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red"))
Ratio_CD_Baseline_Level_Si <- Ratio_CD_Baseline_Level_Si %>% layout(title="56Si", yaxis=list(title="Ratio of Cell Death Percentage at high versus low fluence",range=c(0,5), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE),  
                                                                    xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))

Ratio_CD_Baseline_Level_Si <- hide_legend(Ratio_CD_Baseline_Level_Si)
print(Ratio_CD_Baseline_Level_Si)
orca(Ratio_CD_Baseline_Level_Si, "Ratio_CD_Baseline_Level_Si_24h.pdf")

# Gamma----------------
Gamma_CD_Baseline= All_Pheno_baseline_24h[, grepl("Sample_ID|avg_nfoci_Gamma|Dead_Cells_Gamma", colnames(All_Pheno_baseline_24h))]
#Selection of DD+ subjects 
Gamma_CD_Baseline=NaRV.omit(Gamma_CD_Baseline)
Gamma_CD_Baseline$DD_response <- NA
#
for(i in 1:nrow(Gamma_CD_Baseline)){
  if ((Gamma_CD_Baseline$avg_nfoci_Gamma_HighDose_24h[i] - Gamma_CD_Baseline$avg_nfoci_Gamma_LowDose_24h[i]) >= 0){
   Gamma_CD_Baseline$DD_response[i] = "DD+"
  }
}

Gamma_CD_Baseline=NaRV.omit(Gamma_CD_Baseline)
Gamma_CD_Baseline$DD_response=NULL

Gamma_CD_Baseline$CD_Ratio = Gamma_CD_Baseline$Dead_Cells_Gamma_HighDose_24h/Gamma_CD_Baseline$Dead_Cells_Gamma_LowDose_24h

## For those interesting people we associate their baseline value
Gamma_CD_Baseline=merge(Gamma_CD_Baseline, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE, all.y = FALSE)
Gamma_CD_Baseline=NaRV.omit(Gamma_CD_Baseline)
## Select high and low baselines 
Gamma_CD_Baseline$Baseline_Level <- NA

quantile_baseline = quantile(Gamma_CD_Baseline$baseline_nfoci)
LB = quantile_baseline[2]
HB = quantile_baseline[4]

for(i in 1:nrow(Gamma_CD_Baseline)){
  if (Gamma_CD_Baseline$baseline_nfoci[i] <= LB){
    Gamma_CD_Baseline$Baseline_Level[i] = "Low Baseline"
  }
  if (Gamma_CD_Baseline$baseline_nfoci[i] >= HB){
    Gamma_CD_Baseline$Baseline_Level[i] = "High Baseline"
  }
}

Gamma_CD_Baseline= NaRV.omit(Gamma_CD_Baseline)
Gamma_CD_Baseline$Baseline_Level=factor(Gamma_CD_Baseline$Baseline_Level, levels=c("Low Baseline", "High Baseline"))

### Calculate Median ratio
## Low Baseline group
Gamma_CD_Baseline_Low = Gamma_CD_Baseline
Gamma_CD_Baseline_Low$Baseline_Level[Gamma_CD_Baseline_Low$Baseline_Level =="High Baseline" ] <- NA
Gamma_CD_Baseline_Low = NaRV.omit(Gamma_CD_Baseline_Low)
median_baseline_low = median(Gamma_CD_Baseline_Low$CD_Ratio)
print(median_baseline_low)
#High Baseline Group
Gamma_CD_Baseline_High = Gamma_CD_Baseline
Gamma_CD_Baseline_High$Baseline_Level[Gamma_CD_Baseline_High$Baseline_Level =="Low Baseline" ] <- NA
Gamma_CD_Baseline_High = NaRV.omit(Gamma_CD_Baseline_High)
median_baseline_High = median(Gamma_CD_Baseline_High$CD_Ratio)
print(median_baseline_High)

###  t.test & P values 
test_Gamma <- t.test(Gamma_CD_Baseline$CD_Ratio ~ Gamma_CD_Baseline$Baseline_Level)
print(test_Gamma)

## Plot
Ratio_CD_Baseline_Level_Gamma <- plot_ly(data = Gamma_CD_Baseline, 
                       x= ~Baseline_Level,
                       y= ~ CD_Ratio, 
                       type = "box", boxpoints = "all", 
                       color = ~ Baseline_Level, colors=c("darkblue","red"))
Ratio_CD_Baseline_Level_Gamma <- Ratio_CD_Baseline_Level_Gamma %>% layout(title="56Gamma", yaxis=list(title="Ratio of Cell Death Percentage at high versus low fluence",range=c(0,5), titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE),  
                                                                    xaxis=list(titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))

Ratio_CD_Baseline_Level_Gamma <- hide_legend(Ratio_CD_Baseline_Level_Gamma)
print(Ratio_CD_Baseline_Level_Gamma)
orca(Ratio_CD_Baseline_Level_Gamma, "Ratio_CD_Baseline_Level_Gamma_24h.pdf")


### Oxidative stress and baseline 
#For each radiation type, we plot for "OS-" and "OS+" their baseline level (for "DD+" subjects only)
### Classes as defined on DD vs OS plots 
#### we class individual within four class depending on the sign of the difference between high dose and low dose
# (OS+,DD-) : oxidative stress increases with the dose and DNA decreases with the dose 
# (OS-,DD-) : Both oxidative stress and DNA damage decrease with the dose 
# (OS-,DD+) : oxidative stress decreases with the dose and DNA increases with the dose 
# (OS+,DD+) : Both oxidative stress and DNA damage increase with the dose

# Fe----------------
Fe_Response_OS_Class = All_Pheno_baseline_24h[, grepl("Sample_ID|avg_nfoci_Fe|Ox_Stress_Fe", colnames(All_Pheno_baseline_24h))]
Fe_Response_OS_Class = merge(Fe_Response_OS_Class, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE)

## Selection of DD+ subjects 
Fe_Response_OS_Class=NaRV.omit(Fe_Response_OS_Class)
Fe_Response_OS_Class$DD_response <- NA

for (i in 1:nrow(Fe_Response_OS_Class)){
  if ((Fe_Response_OS_Class$avg_nfoci_Fe_HighDose_24h[i] - Fe_Response_OS_Class$avg_nfoci_Fe_LowDose_24h[i]) >= 0){
    Fe_Response_OS_Class$DD_response[i] = "DD+"
  }
}
Fe_Response_OS_Class=NaRV.omit(Fe_Response_OS_Class)
Fe_Response_OS_Class$DD_response = NULL

## Create two class OS+ and OS- 
Fe_Response_OS_Class$OS_response <- NA

for ( i in 1:nrow(Fe_Response_OS_Class)){
  if ((Fe_Response_OS_Class$Ox_Stress_Fe_HighDose_24h[i] - Fe_Response_OS_Class$Ox_Stress_Fe_LowDose_24h[i]) >= 0){
    Fe_Response_OS_Class$OS_response[i] = "OS+"
  }
  if ((Fe_Response_OS_Class$Ox_Stress_Fe_HighDose_24h[i] - Fe_Response_OS_Class$Ox_Stress_Fe_LowDose_24h[i]) < 0){
    Fe_Response_OS_Class$OS_response[i] = "OS-"
  }
}

#Plot 
OS_Baseline_Fe_24h <- plot_ly(data = Fe_Response_OS_Class) %>% add_trace (x = ~ OS_response,
                                                                        y = ~ baseline_nfoci,
                                                                        type = "box", boxpoints = "all", 
                                                                        color=~ OS_response, colors=c("darkgreen", "blue"))
OS_Baseline_Fe_24h <- OS_Baseline_Fe_24h %>% layout(title="56Fe", yaxis=list(title="Baseline nb of foci/nucleus",range=c(0,2),zeroline = FALSE, titlefont = list(size = 25), tickfont = list(size = 20)), xaxis=list(title="Trend of mean CellROX with increasing dose", titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
OS_Baseline_Fe_24h <- hide_legend(OS_Baseline_Fe_24h)
print(OS_Baseline_Fe_24h)
orca(OS_Baseline_Fe_24h, "Baseline_OS_dose_response_Fe_24h.pdf")

###  t.test & P values 
test_Fe <- t.test(Fe_Response_OS_Class$baseline_nfoci ~ Fe_Response_OS_Class$OS_response)
print(test_Fe)

### Baseline median value for OS- and OS+  
Fe_Response_OS_Class_neg <- Fe_Response_OS_Class
Fe_Response_OS_Class_neg$OS_response[Fe_Response_OS_Class_neg$OS_response == "OS+"] <- NA
Fe_Response_OS_Class_neg=NaRV.omit(Fe_Response_OS_Class_neg)
median_OS_neg = median(Fe_Response_OS_Class_neg$baseline_nfoci)
print(median_OS_neg)

Fe_Response_OS_Class_pos <- Fe_Response_OS_Class
Fe_Response_OS_Class_pos$OS_response[Fe_Response_OS_Class_pos$OS_response == "OS-"] <- NA
Fe_Response_OS_Class_pos=NaRV.omit(Fe_Response_OS_Class_pos)
median_OS_pos = median(Fe_Response_OS_Class_pos$baseline_nfoci)
print(median_OS_pos)


# Ar----------------
Ar_Response_OS_Class = All_Pheno_baseline_24h[, grepl("Sample_ID|avg_nfoci_Ar|Ox_Stress_Ar", colnames(All_Pheno_baseline_24h))]
Ar_Response_OS_Class = merge(Ar_Response_OS_Class, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE)

## Selection of DD+ subjects 
Ar_Response_OS_Class=NaRV.omit(Ar_Response_OS_Class)
Ar_Response_OS_Class$DD_response <- NA

for (i in 1:nrow(Ar_Response_OS_Class)){
  if ((Ar_Response_OS_Class$avg_nfoci_Ar_HighDose_24h[i] - Ar_Response_OS_Class$avg_nfoci_Ar_LowDose_24h[i]) >= 0){
    Ar_Response_OS_Class$DD_response[i] = "DD+"
  }
}
Ar_Response_OS_Class=NaRV.omit(Ar_Response_OS_Class)
Ar_Response_OS_Class$DD_response = NULL

## Create two class OS+ and OS- 
Ar_Response_OS_Class$OS_response <- NA

for ( i in 1:nrow(Ar_Response_OS_Class)){
  if ((Ar_Response_OS_Class$Ox_Stress_Ar_HighDose_24h[i] - Ar_Response_OS_Class$Ox_Stress_Ar_LowDose_24h[i]) >= 0){
    Ar_Response_OS_Class$OS_response[i] = "OS+"
  }
  if ((Ar_Response_OS_Class$Ox_Stress_Ar_HighDose_24h[i] - Ar_Response_OS_Class$Ox_Stress_Ar_LowDose_24h[i]) < 0){
    Ar_Response_OS_Class$OS_response[i] = "OS-"
  }
}

#Plot 
OS_Baseline_Ar_24h <- plot_ly(data = Ar_Response_OS_Class) %>% add_trace (x = ~ OS_response,
                                                                        y = ~ baseline_nfoci,
                                                                        type = "box", boxpoints = "all", 
                                                                        color=~ OS_response, colors=c("darkgreen", "blue"))
OS_Baseline_Ar_24h <- OS_Baseline_Ar_24h %>% layout(title="56Ar", yaxis=list(title="Baseline nb of foci/nucleus",range=c(0,2),zeroline = FALSE, titlefont = list(size = 25), tickfont = list(size = 20)), xaxis=list(title="Trend of mean CellROX with increasing dose", titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
OS_Baseline_Ar_24h <- hide_legend(OS_Baseline_Ar_24h)
print(OS_Baseline_Ar_24h)
orca(OS_Baseline_Ar_24h, "Baseline_OS_dose_response_Ar_24h.pdf")

###  t.test & P values 
test_Ar <- t.test(Ar_Response_OS_Class$baseline_nfoci ~ Ar_Response_OS_Class$OS_response)
print(test_Ar)

### Baseline median value for OS- and OS+  
Ar_Response_OS_Class_neg <- Ar_Response_OS_Class
Ar_Response_OS_Class_neg$OS_response[Ar_Response_OS_Class_neg$OS_response == "OS+"] <- NA
Ar_Response_OS_Class_neg=NaRV.omit(Ar_Response_OS_Class_neg)
median_OS_neg = median(Ar_Response_OS_Class_neg$baseline_nfoci)
print(median_OS_neg)

Ar_Response_OS_Class_pos <- Ar_Response_OS_Class
Ar_Response_OS_Class_pos$OS_response[Ar_Response_OS_Class_pos$OS_response == "OS-"] <- NA
Ar_Response_OS_Class_pos=NaRV.omit(Ar_Response_OS_Class_pos)
median_OS_pos = median(Ar_Response_OS_Class_pos$baseline_nfoci)
print(median_OS_pos)


# Si----------------
Si_Response_OS_Class = All_Pheno_baseline_24h[, grepl("Sample_ID|avg_nfoci_Si|Ox_Stress_Si", colnames(All_Pheno_baseline_24h))]
Si_Response_OS_Class = merge(Si_Response_OS_Class, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE)

## Selection of DD+ subjects 
Si_Response_OS_Class=NaRV.omit(Si_Response_OS_Class)
Si_Response_OS_Class$DD_response <- NA

for (i in 1:nrow(Si_Response_OS_Class)){
  if ((Si_Response_OS_Class$avg_nfoci_Si_HighDose_24h[i] - Si_Response_OS_Class$avg_nfoci_Si_LowDose_24h[i]) >= 0){
    Si_Response_OS_Class$DD_response[i] = "DD+"
  }
}
Si_Response_OS_Class=NaRV.omit(Si_Response_OS_Class)
Si_Response_OS_Class$DD_response = NULL

## Create two class OS+ and OS- 
Si_Response_OS_Class$OS_response <- NA

for ( i in 1:nrow(Si_Response_OS_Class)){
  if ((Si_Response_OS_Class$Ox_Stress_Si_HighDose_24h[i] - Si_Response_OS_Class$Ox_Stress_Si_LowDose_24h[i]) >= 0){
    Si_Response_OS_Class$OS_response[i] = "OS+"
  }
  if ((Si_Response_OS_Class$Ox_Stress_Si_HighDose_24h[i] - Si_Response_OS_Class$Ox_Stress_Si_LowDose_24h[i]) < 0){
    Si_Response_OS_Class$OS_response[i] = "OS-"
  }
}

#Plot 
OS_Baseline_Si_24h <- plot_ly(data = Si_Response_OS_Class) %>% add_trace (x = ~ OS_response,
                                                                        y = ~ baseline_nfoci,
                                                                        type = "box", boxpoints = "all", 
                                                                        color=~ OS_response, colors=c("darkgreen", "blue"))
OS_Baseline_Si_24h <- OS_Baseline_Si_24h %>% layout(title="56Si", yaxis=list(title="Baseline nb of foci/nucleus",range=c(0,2),zeroline = FALSE, titlefont = list(size = 25), tickfont = list(size = 20)), xaxis=list(title="Trend of mean CellROX with increasing dose", titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
OS_Baseline_Si_24h <- hide_legend(OS_Baseline_Si_24h)
print(OS_Baseline_Si_24h)
orca(OS_Baseline_Si_24h, "Baseline_OS_dose_response_Si_24h.pdf")

###  t.test & P values 
test_Si <- t.test(Si_Response_OS_Class$baseline_nfoci ~ Si_Response_OS_Class$OS_response)
print(test_Si)

### Baseline median value for OS- and OS+  
Si_Response_OS_Class_neg <- Si_Response_OS_Class
Si_Response_OS_Class_neg$OS_response[Si_Response_OS_Class_neg$OS_response == "OS+"] <- NA
Si_Response_OS_Class_neg=NaRV.omit(Si_Response_OS_Class_neg)
median_OS_neg = median(Si_Response_OS_Class_neg$baseline_nfoci)
print(median_OS_neg)

Si_Response_OS_Class_pos <- Si_Response_OS_Class
Si_Response_OS_Class_pos$OS_response[Si_Response_OS_Class_pos$OS_response == "OS-"] <- NA
Si_Response_OS_Class_pos=NaRV.omit(Si_Response_OS_Class_pos)
median_OS_pos = median(Si_Response_OS_Class_pos$baseline_nfoci)
print(median_OS_pos)


# Gamma----------------
Gamma_Response_OS_Class = All_Pheno_baseline_24h[, grepl("Sample_ID|avg_nfoci_Gamma|Ox_Stress_Gamma", colnames(All_Pheno_baseline_24h))]
Gamma_Response_OS_Class = merge(Gamma_Response_OS_Class, Baseline_DNA_damage, by="Sample_ID", all.x = TRUE)

## Selection of DD+ subjects 
Gamma_Response_OS_Class=NaRV.omit(Gamma_Response_OS_Class)
Gamma_Response_OS_Class$DD_response <- NA

for (i in 1:nrow(Gamma_Response_OS_Class)){
  if ((Gamma_Response_OS_Class$avg_nfoci_Gamma_HighDose_24h[i] - Gamma_Response_OS_Class$avg_nfoci_Gamma_LowDose_24h[i]) >= 0){
    Gamma_Response_OS_Class$DD_response[i] = "DD+"
  }
}
Gamma_Response_OS_Class=NaRV.omit(Gamma_Response_OS_Class)
Gamma_Response_OS_Class$DD_response = NULL

## Create two class OS+ and OS- 
Gamma_Response_OS_Class$OS_response <- NA

for ( i in 1:nrow(Gamma_Response_OS_Class)){
  if ((Gamma_Response_OS_Class$Ox_Stress_Gamma_HighDose_24h[i] - Gamma_Response_OS_Class$Ox_Stress_Gamma_LowDose_24h[i]) >= 0){
    Gamma_Response_OS_Class$OS_response[i] = "OS+"
  }
  if ((Gamma_Response_OS_Class$Ox_Stress_Gamma_HighDose_24h[i] - Gamma_Response_OS_Class$Ox_Stress_Gamma_LowDose_24h[i]) < 0){
    Gamma_Response_OS_Class$OS_response[i] = "OS-"
  }
}

#Plot 
OS_Baseline_Gamma_24h <- plot_ly(data = Gamma_Response_OS_Class) %>% add_trace (x = ~ OS_response,
                                                                        y = ~ baseline_nfoci,
                                                                        type = "box", boxpoints = "all", 
                                                                        color=~ OS_response, colors=c("darkgreen", "blue"))
OS_Baseline_Gamma_24h <- OS_Baseline_Gamma_24h %>% layout(title="56Gamma", yaxis=list(title="Baseline nb of foci/nucleus",range=c(0,2),zeroline = FALSE, titlefont = list(size = 25), tickfont = list(size = 20)), xaxis=list(title="Trend of mean CellROX with increasing dose", titlefont = list(size = 25), tickfont = list(size = 20),zeroline = FALSE))
OS_Baseline_Gamma_24h <- hide_legend(OS_Baseline_Gamma_24h)
print(OS_Baseline_Gamma_24h)
orca(OS_Baseline_Gamma_24h, "Baseline_OS_dose_response_Gamma_24h.pdf")

###  t.test & P values 
test_Gamma <- t.test(Gamma_Response_OS_Class$baseline_nfoci ~ Gamma_Response_OS_Class$OS_response)
print(test_Gamma)

### Baseline median value for OS- and OS+  
Gamma_Response_OS_Class_neg <- Gamma_Response_OS_Class
Gamma_Response_OS_Class_neg$OS_response[Gamma_Response_OS_Class_neg$OS_response == "OS+"] <- NA
Gamma_Response_OS_Class_neg=NaRV.omit(Gamma_Response_OS_Class_neg)
median_OS_neg = median(Gamma_Response_OS_Class_neg$baseline_nfoci)
print(median_OS_neg)

Gamma_Response_OS_Class_pos <- Gamma_Response_OS_Class
Gamma_Response_OS_Class_pos$OS_response[Gamma_Response_OS_Class_pos$OS_response == "OS-"] <- NA
Gamma_Response_OS_Class_pos=NaRV.omit(Gamma_Response_OS_Class_pos)
median_OS_pos = median(Gamma_Response_OS_Class_pos$baseline_nfoci)
print(median_OS_pos)
```

